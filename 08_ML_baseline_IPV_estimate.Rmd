---
title: "Cash Plus, Safety Plus? Intimate Partner Violence and Productive Inclusion in Mauritania"
subtitle: "ML for baseline IPV"
author: "IBRAHIM KASSOUM Habibou"
date: '`r format (Sys.Date(), "%d %B %Y")`'
output: 
  officedown::rdocx_document:
    mapstyles:
      Normal: ['First Paragraph']
---

```{r setup, include=FALSE}
# Set random seed for reproducibility
set.seed(7654)

# Set number of decimal places to display
options(digits = 3)

# Configure knitr chunk options:
knitr::opts_chunk$set(
 echo = FALSE,          # Don't show R code in output
 message = FALSE,       # Don't show messages
 warning = FALSE,       # Don't show warnings
 cache = FALSE,         # Don't cache results
 fig.align = 'center',  # Center figures
 fig.width = 6,         # Figure width in inches
 fig.asp = 0.618,       # Figure aspect ratio (golden ratio)
 fig.show = "hold"      # Hold multiple plots until end of chunk
)

# Set dplyr print options to show 6 rows max
options(dplyr.print_min = 6, dplyr.print_max = 6)


```



```{r, include=FALSE, results='hide', echo=FALSE}

######################## Importing library and external files ##################
### List of required packages
required_packages <- c("tidyverse", "dplyr","officedown", "officer", "gtsummary", "flextable", "magrittr", 'VIM', # for Knn imputation
                      "data.table","lfe","labelled","car","broom","purrr","caret","gbm","rlang","glmnet",
                      "tibble","grf","causalweight","randomForest","lmtest","sandwich","grf")

### Check if packages are installed
missing_packages <- setdiff(required_packages, installed.packages()[,"Package"])

### Install missing packages
if (length(missing_packages) > 0) {
  install.packages(missing_packages)
}

### Load all packages
lapply(setdiff(required_packages, missing_packages), library, character.only = TRUE)

# Remove all objects
rm(list = ls())

# Source functions from external file
source("functions.R")

# Set random seed for reproducibility
set.seed(13111998)
```


```{r echo=F}

set_gtsummary_theme(theme_gtsummary_compact())

######### Create default BioAVR table from dataframe
#
# Dependencies : dplyr, flextable, officer
# source link : https://www.r-bloggers.com/2021/11/publication-ready-tables-with-flextable-and-own-theme-in-r/
customtab_defaults <- function(){
set_flextable_defaults(font.family = "Times New Roman",
font.size = 10,
border.color = "black")
}
FitFlextableToPage <- function(ft, pgwidth = 8){

  ft_out <- ft %>% autofit()

  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
}
custom_tab <- function(df, header, footer){
flextable(df) %>%
add_header_lines(header) %>%
add_footer_lines(footer) %>%
bold(i = 1, part = "header") %>%
hline_top(part = "header",
border = fp_border(color = "white",
width = 3,
style = "solid")) %>%
hline(i = 1,
part = "header",
border = fp_border(color = "black",
width = 0.25,
style = "solid")) %>%
hline_top(part = "body",
border = fp_border(color = "black",
width = 0.25,
style = "solid")) %>%
hline_bottom(part = "body",
border = fp_border(color = "black",
width = 0.25,
style = "solid")) %>%
hline_bottom(part = "footer",
border = fp_border(color = "black",
width = 0.25,
style = "solid")) %>%
border_inner_h(part = "body",
border = fp_border(color = "black",
width = 0.25,
style = "dotted")) %>%
autofit(part = "body") %>%
bg(part = "body", bg = "white") %>%
align(part = "all", align = "center") %>%
align(j = 1, part = "all", align = "left")
}
```


```{r}

######################## Loading the datasets ##################################
# Read the file containing the global dataframe into followup_MRT_hh
followup_MRT_hh <- readRDS(paste0(getwd(),"/output/data/followup_MRT_hh_and_ipv_MRT_hh.rds"))


# Convert treatment variables from numeric to factor variables for both datasets
# This is useful for regression analysis and plotting as factors are treated as categorical variables

 # Convert PM treatment to factor
followup_MRT_hh$treatment_pi <- haven::as_factor(followup_MRT_hh$treatment_pi)

# Convert cash transfer treatment to factor
followup_MRT_hh$treatment_csh_trnsfr <- haven::as_factor(followup_MRT_hh$treatment_csh_trnsfr)

# Filtering for control data
control_ipv_vars <- c("control_ipv_sev_12m","control_ipv_sev_index")
emotional_ipv_vars <- c("emo_ipv_sev_12m","emo_ipv_sev_index") #"emo_ipv_inten_index",
physical_ipv_vars <- c("phy_ipv_sev_12m","phy_ipv_sev_index") #"phy_ipv_inten_index",
sexual_ipv_vars <- c("sex_ipv_sev_12m","sex_ipv_sev_index") #,"sex_ipv_inten_index"
sexual_physical_ipv_vars  <- c("sex_phy_ipv_sev_12m","sex_phy_ipv_sev_index")
economic_ipv_vars <- c("eco_ipv_sev_12m","eco_ipv_sev_index") #,"eco_ipv_inten_index"
other_ipv_vars <- c("all_ipv_sev_12m","all_ipv_sev_index") # All type of IPV excluding eco

# List of outcome variables
lst_outcome_ml <- c(
  "control_ipv_sev_12m",
  "control_ipv_sev_index",
  "emo_ipv_sev_12m",
  "emo_ipv_sev_index",
  "phy_ipv_sev_12m",
  "phy_ipv_sev_index",
  "sex_ipv_sev_12m",
  "sex_ipv_sev_index",
  "sex_phy_ipv_sev_12m", 
  "sex_phy_ipv_sev_index",
  "eco_ipv_sev_12m",
  "eco_ipv_sev_index",
  "all_ipv_sev_12m",
  "all_ipv_sev_index"
)

# Define the two treatment variables 
#treatment_vars=c("treatment_csh_trnsfr","treatment_pi","treatment_pi_pool","type_treatment")
treatment_vars=c("treatment_csh_trnsfr","treatment_pi","treatment_pi_pool")

# All outcomes variables
listOutcomes=c(control_ipv_vars, emotional_ipv_vars, physical_ipv_vars, sexual_ipv_vars,sexual_physical_ipv_vars, economic_ipv_vars, other_ipv_vars)

# Define controls variables for the regression 
control_vars = c("hhh_fem_bl", 
            "mem_n_bl",
            "same_cb",
            "pben_handicap",
            "hhh_poly",
            "pben_poly",
            "hhh_age",
            "pben_age",
            "age_gap",
            "hhh_edu",
            "pben_edu",
            "hhh_lit",
            "pben_lit")

# Define cluster variables 
cluster_vars <- c("cluster")

# Define strata variables: strata
strata_vars <- c("") 


followup_MRT_hh <- followup_MRT_hh %>%
  dplyr::select(-c(starts_with("ipv"), ends_with("_ever"), ends_with("_index2"))) %>% 
  dplyr::select(-c(deviceid,subscriberid,allows_comment,devicephonenum,duration,surveyor)) 

# Variables that are not common to both baseline and followup surveys then can't be use for the ML model?"mr1", "mr2", "mr3", "mr4", "mr5", "mr6", "mr7",
vars_to_rm_ml <- c(
  "start_msr", 
  "end_msr", "start_ipv", "start_vioeco", "end_vioeco", "start_contj", "end_contj",
  "start_evm", "end_evm", "start_evp", "end_evp", "start_evs", "end_evs", "end_ipv",
  "language", "language_1", "language_2", "language_3", "language_4",
  "formdef_version", "key", "submissiondate",
  "starttime", "endtime",  "f_ipv_agemarr", "f_ipv_polyg", #"f_ipv_husb","age_ipv_module", "language__777", "language_o", "_IDENTIFICATION_","_DEMOG_", 
  "f_ipv_marrbefore", "f_ipv_everpreg", "f_ipv_preg_nb", "control_ipv_r0_12m",
  "control_ipv_r1_12m", "emo_ipv_r0_12m", "emo_ipv_r1_12m", "phy_ipv_r0_12m",
  "phy_ipv_r1_12m", "sex_ipv_r0_12m", "sex_ipv_r1_12m", "eco_ipv1", "eco_ipv2",
  "eco_ipv3", "eco_ipv_r0_12m", "eco_ipv_r1_12m", 
   "soc_prmtn", "cash_trsfr", 
  "childlist", "childlist15_25", "newkid_n", "newkid_d", "newmem_n",
  "newmem_d", "lostmem_s", "newmem_s", "new_mem1_n", "new_mem2_n", "new_mem4_n",
  "new_kid4_n", "new_mem5_n", "new_kid5_n", "new_mem6_n", "new_kid6_n",
  "new_mem7_n", "new_kid7_n", "new_mem8_n",  "new_mem9_n", #"new_kid8_n",
  "new_kid9_n", "new_mem10_n", "new_kid10_n", "new_mem11_n", "new_kid11_n",
  "new_mem12_n", "new_kid12_n", "new_mem13_n", "new_kid13_n", "new_mem14_n",
  "new_kid14_n", "new_mem15_n", "new_kid15_n", "new_mem16_n", "new_kid16_n",
  "new_mem17_n", "new_mem18_n", "new_kid18_n", "new_mem19_n", "new_mem20_n",
  "new_earlychild_n", "new_olderchild_n", "new_workage1_n", "new_workage2_n",
  "new_workage3_n", "new_workage4_n", "new_workage5_n", "new_elder_n",
  "new_male_n", "new_female_n", "new_workageo_n", "new_workageo_mal_n",
  "new_workageo_fem_n", "new_mem1_d", "new_mem2_d", "new_mem4_d", "new_kid4_d",
  "new_mem5_d", "new_kid5_d", "new_mem6_d", "new_kid6_d", "new_mem7_d",
  "new_kid7_d", "new_mem8_d",  "new_mem9_d", "new_kid9_d", #"new_kid8_d",
  "new_mem10_d", "new_kid10_d", "new_mem11_d", "new_kid11_d", "new_mem12_d",
  "new_kid12_d", "new_mem13_d", "new_kid13_d", "new_mem14_d", "new_kid14_d",
  "new_mem15_d", "new_kid15_d", "new_mem16_d", "new_kid16_d", "new_mem17_d",
  "new_mem18_d", "new_kid18_d", "new_mem19_d", "new_mem20_d", "new_earlychild_d",
  "new_olderchild_d", "new_workage1_d", "new_workage2_d", "new_workage3_d",
  "new_workage4_d", "new_workage5_d", "new_elder_d", "new_male_d", "new_female_d",
  "new_workageo_d", "new_workageo_mal_d", "new_workageo_fem_d", "newmem_y1_n",
  "newmem_y2_n", "newmem_y3_n", "newmem_y4_n", "newmem_y5_n", "newmem_y1_d",
  "newmem_y2_d", "newmem_y3_d", "newmem_y4_d", "newmem_y5_d", "stmem_ynot1_n",
  "stmem_ynot2_n", "stmem_ynot3_n", "stmem_ynot4_n", "stmem_ynot5_n",
  "stmem_ynot6_n", "stmem_ynot7_n", "stmem_ynot8_n", "stmem_ynot9_n",
  "stmem_ynot10_n", "stmem_ynot1_d", "stmem_ynot2_d", "stmem_ynot3_d",
  "stmem_ynot4_d", "stmem_ynot5_d", "stmem_ynot6_d", "stmem_ynot7_d",
  "stmem_ynot8_d", "stmem_ynot9_d", "stmem_ynot10_d", "lostmem_n",
  "lost_earlychild_n", "lost_olderchild_n", "lost_workage1_n", "lost_workage2_n",
  "lost_workage3_n", "lost_workage4_n", "lost_workage5_n", "lost_elder_n",
  "lost_workageo_n", "lostmem_d", "lost_earlychild_d", "lost_olderchild_d",
  "lost_workage1_d", "lost_workage2_d", "lost_workage3_d", "lost_workage4_d",
  "lost_workage5_d", "lost_elder_d", "lost_workageo_d", "gone_mem1_d",
  "gone_mem2_d", "gone_mem3_d", "gone_mem4_d", "gone_mem5_d", "gone_mem6_d",
  "gone_mem7_d", "gone_mem8_d", "gone_mem9_d", "gone_mem10_d", "gone_mem11_d",
  "gone_mem12_d", "gone_mem13_d", "gone_mem14_d", "gone_mem15_d", "gone_mem16_d",
  "gone_mem17_d", "gone_mem1_n", "gone_mem2_n", "gone_mem3_n", "gone_mem4_n",
  "gone_mem5_n", "gone_mem6_n", "gone_mem7_n", "gone_mem8_n", "gone_mem9_n",
  "gone_mem10_n", "gone_mem11_n", "gone_mem12_n", "gone_mem13_n", "gone_mem14_n",
  "gone_mem15_n", "gone_mem16_n", "gone_mem17_n", "gone_mem18_n", "gone_mem19_n",
  "_EMPLOYMENT_", "PAP_b3_5", "PAP_b2_2", "_madult", "_BUSINESS_",
  "act_main_nonag", "_mBus2", "bus2_abandon_24_dum", "bus2_abandon_24_dum_ben",
  "chef_ownmanage", "_mBus_B81_84", "b_fut_stpa", "b_fut_ninv", "b_fut_kinv",
  "_mBus_invest", "_mBus_estim", "_mBus_costs", "_mBus_divrse",
  "hh_has_bus_empl", "_mBus_workers", "bus_assval_ben_90_ppp",
  "bus_assval_ben_95_ppp", "bus_assval_ben_98_ppp", "bus2_invest_ppp",
  "bus2_profits_hh_ppp", "bus2_profits_hh_ppp_ben", "tot_bus_least_ppp",
  "tot_bus_most_ppp", "tot_put_1_ppp", "tot_put_4_ppp", "tot_put_6_ppp",
  "tot_put_others_ppp", "_FINANCE_", "ton_or_avec_hh", "ton_hh", "avec_hh",
  "saving_d", "saving_out_d", "saving_group_d", "dep_out_grp_ratio",
  "save_share_d", "save_goal", "tot_sav3_ppp", "tot_sav24_ppp",
  "tot_dep_out_ppp", "tot_dep_out_grp_ppp", "saving_out_ppp", "saving_ppp",
  "saving_inf_ppp", "saving_for_ppp", "saving_group_ppp", "_HOUSING_",
  "_CASH_TRANSFERS_", "mes_ctrans_d", "ctrans_whoelse", "ctrans_food_d",
  "ctrans_edu_d", "ctrans_hea_d", "ctrans_sav_d", "ctrans_inv_d",
  "ctrans_hh_d", "ctrans_outhh_d", "ctrans_debt_d", "ctrans_oth_d",
  "ctrans_total_90_ppp", "ctrans_total_95_ppp", "ctrans_total_98_ppp",
  "ctrans_food_ppp", "ctrans_edu_ppp", "ctrans_hea_ppp", "ctrans_debt_ppp",
  "_EMPOWERMENT_", "dec_weight_index", "dec_weight_index_1", "dec_pow_care",
  "dw_index_new", "dw_index_new_1_7", "dw_index_new_8_10", "dw_index_n_s",
  "dw_index_s_n", "dw_index_n_n", "dec_pow_care_fam_1", "dw_wid_0_ind",
  "dw_fam_1_ind", "dw_wid_0_ind_7", "dw_fam_1_ind_7", "dec_psblty_index",
  "dec_could_care", "ani_contr_ben_dum", "ani_contr_chef_dum",
  "prod_agency_index", "ctrl_earn_index", "ctrl_hh_index",
  "dec_pow_his_earn_d", "dec_pow_care_d", "dec_could_care_d",
  "dec_weight_index_d", "dec_psblty_index_d", "ctrl_hh_index_d",
  "_PSYCHOLOGY_", "stairs_peace", "health_ment_z", "ment_hlth_index",
  "ment_hlth_f_index", "gse2", "gse_sum", "gse_index", "stair_status_future",
  "stair_satis_future", "stair_status_child", "future_expct_index",
  "future_expct_f_index", "stair_status_child_30", "future_expct_30_index",
  "future_expct_30_f_index", "_SHOCKS_", "shock_worst6", "_PREFERENCE_",
  "_FOODSEC_", "FCS", "_CONSUMPTION_", "__FOOD_1__", "__FOOD_2__",
  "__NONFOOD__", "temp", "__CELEBRATION__", "__EDUCATION__", "__HEALTH__",
  "__EATOUT__", "__TOTAL_CONSUMPTION_1__", "food_1_year_s", "food_1_day_s",
  "food_1_day_pc_s", "food_1_day_eq_s", "__TOTAL_CONSUMPTION_2__",
  "food_2_year_s", "food_2_day_s", "food_2_day_pc_s", "food_2_day_eq_s",
  "health_4weeks_day_ppp", "health_12months_day_ppp", "health_day_ppp",
  "health_year_ppp", "health_day_pc_ppp", "health_day_eq_ppp",
  "eatout_day_ppp", "eatout_year_ppp", "eatout_day_pc_ppp", "eatout_day_eq_ppp",
  "consum_1_year_ppp", "consum_1_day_ppp", "consum_1_day_pc_ppp",
  "consum_1_day_eq_ppp", "consum_2_year_ppp", "consum_2_day_ppp",
  "consum_2_day_pc_ppp", "consum_2_day_eq_ppp", "_ASSETS_", "ag_val_98_ppp",
  "ag_val_95_ppp", "ag_val_90_ppp", "ag_val_ben_98_ppp", "ag_val_ben_95_ppp",
  "ag_val_ben_90_ppp", "_LIVESTOCK_", "PAP_d5", "tot_ani_n_diff_tlu",
  "tot_ani_ago_tlu", "tot_ani_guard_tlu", "tot_ani_gift_tlu",
  "tot_ani_stile_tlu", "tot_ani_cat_tlu", "tot_ani_slau_tlu",
  "tot_ani_bot_tlu", "tot_ani_sold_tlu", "PAP_b3", "PAP_b10_3_4",
  "PAP_b52_asset", "ani_val_bohh_90", "ani_val_bohh_95", "ani_val_bohh_98",
  "PAP_d5_bot_val", "PAP_b2_b1035", "tot_ani_bohh_contr_90",
  "tot_ani_bohh_contr_95", "tot_ani_bohh_contr_98", "_mergBEN",
  "tot_ani_botval_ppp", "tot_ani_ben_contr_98_ppp",
  "tot_ani_ben_contr_95_ppp", "tot_ani_ben_contr_90_ppp",
  "tot_ani_hh_contr_98_ppp", "tot_ani_hh_contr_95_ppp",
  "tot_ani_hh_contr_90_ppp", "tot_ani_hhlb_contr_98_ppp",
  "tot_ani_hhlb_contr_95_ppp", "tot_ani_hhlb_contr_90_ppp",
  "tot_ani_chef_contr_98_ppp", "tot_ani_chef_contr_95_ppp",
  "tot_ani_chef_contr_90_ppp", "ani_val_90_ppp", "ani_val_95_ppp",
  "ani_val_98_ppp", "ani_val_ben_90_ppp", "ani_val_ben_95_ppp",
  "ani_val_ben_98_ppp", "ani_val_hhlb_90_ppp",   "ani_val_hhlb_95_ppp", "ani_val_hhlb_98_ppp", "tot_ani_prod_hh_ppp",
  "ani_val_hh_bov_ppp", "ani_val_hh_equi_ppp", "ani_val_hh_ovi_ppp",
  "ani_val_hh_avi_ppp", "ani_val_ben_bov_ppp", "ani_val_ben_equi_ppp",
  "ani_val_ben_ovi_ppp", "ani_val_ben_avi_ppp", "ani_botval_hh_equi_ppp",
  "ani_botval_hh_ovi_ppp", "ani_botval_hh_avi_ppp", "ani_contr_hh_bov_90_ppp",
  "ani_contr_hh_equi_90_ppp", "ani_contr_hh_ovi_90_ppp",
  "ani_contr_hh_avi_90_ppp", "ani_contr_hh_bov_95_ppp",
  "ani_contr_hh_equi_95_ppp", "ani_contr_hh_ovi_95_ppp",
  "ani_contr_hh_avi_95_ppp", "ani_contr_hh_bov_98_ppp",
  "ani_contr_hh_equi_98_ppp", "ani_contr_hh_ovi_98_ppp",
  "ani_contr_hh_avi_98_ppp", "ani_contr_ben_bov_90_ppp",
  "ani_contr_ben_equi_90_ppp", "ani_contr_ben_ovi_90_ppp",
  "ani_contr_ben_avi_90_ppp", "ani_contr_ben_bov_95_ppp",
  "ani_contr_ben_equi_95_ppp", "ani_contr_ben_ovi_95_ppp",
  "ani_contr_ben_avi_95_ppp", "ani_contr_ben_bov_98_ppp",
  "ani_contr_ben_equi_98_ppp", "ani_contr_ben_ovi_98_ppp",
  "ani_contr_ben_avi_98_ppp", "ihs_tot_ani_botval_ppp",
  "ihs_tot_ani_ben_contr_98_ppp", "ihs_tot_ani_ben_contr_95_ppp",
  "ihs_tot_ani_ben_contr_90_ppp", "ihs_tot_ani_hh_contr_98_ppp",
  "ihs_tot_ani_hh_contr_95_ppp", "ihs_tot_ani_hh_contr_90_ppp",
  "_AGRICULTURE_", "ag_r_c11_comm", "ag_r_c11_comm_chef",
  "ag_r_c11_comm_ben", "ag_c11_hh_d", "ag_c11_chef_d", "ag_c11_ben_d",
  "ag_c11_hrv_qty", "ag_c11_plotsize", "ag_c12_hrv_qty", "ag_c12_plotsize",
  "ag_c16_hrv_qty", "ag_c16_plotsize", "ag_c40_hh_d", "ag_c40_chef_d",
  "ag_c40_ben_d", "ag_c49_hrv_qty", "ag_c49_plotsize", "ag_c11_hrv_qty_adult",
  "ag_c12_hrv_qty_adult", "ag_c16_hrv_qty_adult", "ag_c49_hrv_qty_adult",
  "ag_c11_hrv_imp_ppp", "ag_c40_hrv_imp_ppp", "ag_c11_hrv_chef_imp_ppp",
  "ag_c11_hrv_ben_imp_ppp", "ag_c40_hrv_chef_imp_ppp",
  "ag_c40_hrv_ben_imp_ppp", "ag_c11_sale_imp_ppp",
  "ag_c11_sale_chef_imp_ppp", "ag_c11_sale_ben_imp_ppp",
  "_OTHER_PROGRAMS_", "prog_1_ppp", "prog_2_ppp", "prog_3_ppp",
  "prog_4_ppp", "prog_5_ppp", "prog_6_ppp", "prog_8_ppp", "prog_9_ppp",
  "_TRANSFERS_", "trans_fam_send", "tot_trans_out_ppp", "gross_trans_ppp",
  "_MISC_", "rev_sum_hh_90", "rev_sum_hh_wemp_90", "rev_sum_ben_90",
  "rev_sum_ben_wemp_90", "rev_sum_hhlb_90", "rev_sum_hhlb_wemp_90",
  "rev_sum_chef_90", "rev_sum_chef_wemp_90", "rev_sum_hh_95",
  "rev_sum_hh_wemp_95", "rev_sum_ben_95", "rev_sum_ben_wemp_95",
  "rev_sum_hhlb_95", "rev_sum_hhlb_wemp_95", "rev_sum_chef_95",
  "rev_sum_chef_wemp_95", "rev_sum_hh_98", "rev_sum_hh_wemp_98",
  "rev_sum_ben_98", "rev_sum_ben_wemp_98", "rev_sum_hhlb_98",
  "rev_sum_hhlb_wemp_98", "rev_sum_chef_98", "rev_sum_chef_wemp_98",
  "mycons2_ihs", "mycons2_log", "mysumrev12_hh_ihs_98",
  "mysumrev12_hh_ihs_95", "mysumrev12_hh_ihs_90", "myanirev12_hh_ihs_98",
  "myanirev12_hh_ihs_95", "myanirev12_hh_ihs_90", "mysumrev12_ben_ihs_98",
  "mysumrev12_ben_ihs_95", "mysumrev12_ben_ihs_90", "myanirev12_ben_ihs_98",
  "myanirev12_ben_ihs_95", "myanirev12_ben_ihs_90", "rev_sum_hh_eq_wemp_98",
  "rev_sum_ben_eq_wemp_98", "rev_sum_hh_eq_wemp_95",
  "rev_sum_ben_eq_wemp_95", "rev_sum_hh_eq_wemp_90",
  "rev_sum_ben_eq_wemp_90", "consum_2_day_eq_ppp_std",
  "rev_sum_hh_wemp_98_std", "rev_sum_hh_wemp_95_std",
  "rev_sum_hh_wemp_90_std", "rev_sum_hh_eq_wemp_90_std",
  "rev_sum_hh_eq_wemp_95_std", "rev_sum_hh_eq_wemp_98_std",
  "rev_sum_ben_wemp_98_std", "rev_sum_ben_wemp_95_std",
  "rev_sum_ben_wemp_90_std", "rev_sum_ben_eq_wemp_98_std",
  "rev_sum_ben_eq_wemp_95_std", "rev_sum_ben_eq_wemp_90_std",
  "consum_2_day_eqbl_ppp", "t_exodamtsend_98_ppp",
  "ctrans_total_y_98_ppp", "tot_cash_inflow_ppp", "newmem_sbl",
  "lostmem_sbl", "_childlabHH_", "child_days_bus", "c15_25_days_bus",
  "child_days_ani", "child_lab_index", "_mC_3_2", "child_water_fire_d_hh",
  "child_laundry_d_hh", "child_shop_d_hh", "child_hh_lab_index", "_mC_3_3",
  "_lab_prtcp_", "tot_ben_bus_days", "tot_chef_bus_days", "tot_hh_bus_days",
  "tot_hhlb_bus_days", "_mben_lab3", "tot_hh_liv_days", "tot_chef_liv_days",
  "tot_ben_liv_days", "tot_hhlb_liv_days", "_gender_prcpt_",
  "gender_attitudes_index", "dom_burn_rvrs", "dom_kids_rvrs",
  "ten_violen_rvrs", "ten_men_rvrs", "ten_boys", "dom_relation_index",
  "ten_tension", "vill_burn", "vill_kids", "_social_", #"rel_disagree",
  "rel_interest", "los3", "partner_vars_index", "tens_house_rvrs",
  "hh_vars_index", "intrahh_vars_index", "ten_violen", "ten_men",
  "tens_house", "enemy", "tens_comm", "ten_mentravel", "ten_menown",
  "ten_womentravel", "ten_womenown", "social_support_index", "role",
  "soc_tips", "soc_tips_in", "soc_confl", "soc_confl_in", "other_market",
  "ask_siblings_w", "ask_sum1", "ask_sum2", "ask_sum1_w", "ask_siblings",
  "ask_otherfam", "ask_friends", "ask_otherknown", "ask_sum2_w", "aff_ieff",
  "for_trust_1", "enemy_rvrs", "tens_comm_rvrs", "soc_cohsn_index",
  "aut_fond_ppp", "collective_action_index", "partic", "soc_post",
  "aut_fond_ppp_w", "aut_volu", "soc_norms_index", "dscrptv_norms_index",
  "ten_support", "ten_loan", "ten_new", "ten_travel",
  "prscrptv_norms_index", "ten_mentravel_rvrs", "ten_menown_rvrs",
  "ten_womentravel_rvrs", "ten_womenown_rvrs", "_time_use_",
  "time_ben_nonag_d", "time_wk_ben_nonag", "time_ben_ag_d", "time_wk_ben_ag",
  "time_ben_study_coran_d", "time_wk_ben_study_coran",
  "time_ben_study_trad_d", "time_wk_ben_study_trad", "time_ben_water_d",
  "time_wk_ben_water", "time_ben_firewood_d", "time_wk_ben_firewood",
  "time_ben_laundry_d", "time_wk_ben_laundry", "time_ben_shop_d",
  "time_wk_ben_shop", "time_ben_cook_d", "time_wk_ben_cook",
  "time_ben_clean_d", "time_wk_ben_clean", "time_ben_liv_d",
  "time_wk_ben_liv", "time_ben_child_d", "time_wk_ben_child",
  "time_ben_handicap_d", "time_wk_ben_handicap", "time_ben_family_d",
  "time_wk_ben_family", "time_ben_radio_d", "time_wk_ben_radio",
  "time_ben_rest_d", "time_wk_ben_rest", "time_ben_pray_d",
  "time_wk_ben_pray", "_loans_", "lend_mem_times", "_measures_",
  "mes_video_d", "mes_avec_d", "mes_acv_d", "mes_acv_days", "mes_germe_d",
  "mes_germe_days", "mes_coach_d", "mes_coach_n", "mes_bourse_d", "_m_admin",
  "mes_bourse_ppp", "_fish_", "_exodus_", "t_exodamtsend_90",
  "t_exodamtsend_95", "t_exodamtsend_98", "t_exodamtsend_99",
  "t_exodamtsend_ben_90", "t_exodamtsend_ben_95", "t_exodamtsend_ben_98",
  "t_exodamtsend_ben_99", "t_exode_days", "t_exode_days_ben",
  "t_exodamtsend_90_ppp", "t_exodamtsend_95_ppp", "t_exodamtsend_99_ppp",
  "t_exodamtsend_ben_90_ppp", "t_exodamtsend_ben_95_ppp",
  "t_exode_days_d", "t_exode_days_ben_d", "t_exodamtsend_98_d", "t_exodamtsend_ben_98_d", "t_exodamtsend_95_d", "t_exodamtsend_ben_95_d", "t_exodamtsend_90_d",
  "t_exodamtsend_ben_90_d", "_mid", "_benrel_", "_gpsins_", "_storage_",
  "_childhealth_", "_socpro_", "benef_is_changed",
  "preg_k_breastfeed_childwants_v2", "preg_k_breastfeed_motherready_v2",
  "newborn_k_feeeding_dur_correct", "knowledge_kidi6_2",
  "knowledge_kidi8_2", "knowledge_talktochild", "knowledge_childcry",
  "knowledge_childcry_v2", "knowledge_childsick", "knowledge_ecd_theta",
  "knowledge_ecd_theta2", "rfall_alr_5_d", "temp_blr_25_d",
  "temp_blr_75sd_d", "temp_alr_75sd_d", "rfalldy_alr_5_d",
  "tempdy_alr_10_d", "tempdy_avg_mea_fmju01_lr_pct", "_urban_",
  "consum_2_day_ppp_tr_bd", "consum_2_day_pc_ppp_tr_bd",
  "consum_2_day_eq_ppp_tr_bd", "consum_2_day_eq_ppp_std_tr_bd",
  "nf_util_day_ppp_bd", "nf_util_day_eq_ppp_bd", "nf_trans_day_ppp_bd",
  "nf_trans_day_eq_ppp_bd", "nf_comm_day_ppp_bd", "nf_comm_day_eq_ppp_bd",
  "nf_toil_day_ppp_bd", "nf_toil_day_eq_ppp_bd", "nf_cloth_day_ppp_bd",
  "nf_cloth_day_eq_ppp_bd", "nf_hhmisc_day_ppp_bd",
  "nf_hhmisc_day_eq_ppp_bd", "nf_other_day_ppp_bd",
  "nf_other_day_eq_ppp_bd", "nonfood_day_ppp_bd",
  "nonfood_day_pc_ppp_bd", "nonfood_day_eq_ppp_bd", "treat_dum_pi",
  "treatment_1", "treatment_2", "treatment_3", "regprod_ben",  "hhh_fem_hte",
  "ben_fem_hte", "med_hhsize_dum_hte", "med_hhsize_dum_hte_2",
  "med_adult_fem_s_dum_hte", "med_adult_fem_s_dum_hte_2",
  "med_cons2deq_dum_hte", "med_cons2deq_dum_hte_2", "med_food2deq_dum_hte",
  "med_food2deq_dum_hte_2", "med_discom_dum_hte", "med_discom_dum_hte_2",
  "med_divinc_dum_hte", "med_divinc_dum_hte_2", "med_mendep_dum_hte",
  "med_mendep_dum_hte_2", "med_mendis_dum_hte", "med_mendis_dum_hte_2",
  "med_mendepdis_dum_hte", "med_mendepdis_dum_hte_2", "med_mensat_dum_hte",
  "med_mensat_dum_hte_2", "med_ment_hlth_dum_hte", "med_ment_hlth_dum_hte_2",
  "med_gse_index_dum_hte", "med_gse_index_dum_hte_2", "bus2_dum_hte",
  "pben_age_bins_bl_hte", "pben_edu_bins_bl_hte", "nmem_bins_bl_hte",
  "ru_gpssec_d10", "ru_gpssec_d20", "region_bl_hte", "rev_sum_hh_idle_hte", #"ag_c15_hrv_qty", "ag_c44_hh_d","ag_c44_chef_d", "ag_c44_ben_d", "ag_c15_hrv_qty_adult", "ag_c44_hrv_imp_ppp", "ag_c44_hrv_chef_imp_ppp", "ag_c44_hrv_ben_imp_ppp","mr1",
  "mem_n_bl_pct_ctrl", "rural_ag", "ru_lat_bl_tr", "ru_lon_bl_tr","gone_mem18_d","gone_mem19_d", "treatment_group", "het_save_share", "save_share", "country", "ccode","mr9a", "new_mem21_n", "new_kid21_n", "new_mem21_d", "new_kid21_d", "gone_mem20_d", "gone_mem20_n",    "age.x", "emo_severity_12m", "emo_severity_12m_z",
  "phy_severity_12m", "phy_severity_12m_z", "sex_severity_12m",
  "sex_severity_12m_z", "eco_severity_12m", "eco_severity_12m_z",
  "bus1_ben_7_d", "bus_rev12_ben_7_90_ppp", "bus_rev12_ben_7_95_ppp",
  "bus_rev12_ben_7_98_ppp", "bus_pro12_ben_7_90_ppp", "bus_pro12_ben_7_95_ppp",
  "bus_pro12_ben_7_98_ppp", "dec_pow_edu", "dec_pow_care_wid_0",
  "dec_pow_edu_wid_0", "dec_pow_edu_fam_1", "ag_c40_hrv_qty",
  "ag_c40_plotsize", "ag_cother_hrv_qty", "ag_cother_plotsize",
  "ag_c40_hrv_qty_adult", "ag_r_hrv_5_imp_ppp", "rel_disagree",  "mr2", "mr3", "mr4", "mr5", "mr6", "mr7"#,"type_treatment"
  )

# Create the vector of var to remove from the previous list
names_rm <- c("_IDENTIFICATION_", "_DEMOG_", "_EMPLOYMENT_", "_BUSINESS_", "_FINANCE_","_HOUSING_", "_CASH_TRANSFERS_", "_EMPOWERMENT_", "_PSYCHOLOGY_", "_SHOCKS_","_PREFERENCE_", "_FOODSEC_", "_CONSUMPTION_", "__FOOD_1__", "__FOOD_2__","__NONFOOD__", "__CELEBRATION__", "__EDUCATION__", "__HEALTH__", "__EATOUT__","__TOTAL_CONSUMPTION_1__", "__TOTAL_CONSUMPTION_2__", "_ASSETS_", "_LIVESTOCK_", "_AGRICULTURE_","_OTHER_PROGRAMS_", "_TRANSFERS_", "_MISC_", "_childlabHH_", "_lab_prtcp_","_gender_prcpt_", "_social_", "_time_use_", "_loans_", "_measures_", "_fish_", "_exodus_", "_benrel_", "_gpsins_", "_storage_","_childhealth_", "_socpro_", "_urban_", "country", "ccode","age_ipv_module","language__777","language_o","new_kid5_n","new_kid5_d","ag_r_c11_comm","ag_r_c11_comm_chef","ag_r_c11_comm_ben","ag_c40_chef_d","ag_c40_ben_d","ag_c40_hrv_chef_imp_ppp","ag_c40_hrv_ben_imp_ppp","ag_c11_sale_imp_ppp","ag_c11_sale_chef_imp_ppp","ag_c11_sale_ben_imp_ppp","t_exodamtsend_ben_90", "t_exodamtsend_ben_95","t_exodamtsend_ben_98","t_exodamtsend_ben_99","t_exodamtsend_ben_90_ppp","t_exodamtsend_ben_95_ppp", "t_exodamtsend_ben_98_d","t_exodamtsend_ben_95_d","t_exodamtsend_ben_90_d","treatment_group")




vars_to_rm_ml  <-  setdiff(vars_to_rm_ml, names_rm)

vars_to_keep_ml <- c("strata", "cluster", "p_region", "p_commune", 
                  "p_village", "commune", "village","het_pben_lit", "het_hhh_edu","het_pben_edu", "het_ctrl_earn_index",
                  "het_ctrl_hh_index", "het_intrahh_index", "intrahh_index", "het_pben_handicap",
                  "het_pben_poly","age_gap", "het_age_gap","het_hhh_fem",
                  "het_hhh_lit", "reg_hh_pi_mrt", "reg_hh_csh_mrt")


# Get names of variables to keep based on missing values, excluding treatment variables
non_treatment_vars <- setdiff(
  names(followup_MRT_hh),
  treatment_vars
)

# Keep variables with less than or equal to 10% missing (excluding treatment vars)
vars_to_keep <- non_treatment_vars[
  colMeans(is.na(followup_MRT_hh[non_treatment_vars])) <= 0.1
]

# Final dataset including treatment variables
followup_MRT_hh <- followup_MRT_hh %>%
  dplyr::select(
    all_of(vars_to_keep),
    all_of(treatment_vars),
  )


# Remove zero-variance columns (i.e., constants)
followup_MRT_hh <- followup_MRT_hh %>%
  dplyr::select(where(~ length(unique(na.omit(.))) > 1))


followup_MRT_hh_imptd <- readRDS("followup_MRT_hh_imptd.rds")

df_ML_results_final <- readRDS("df_ML_results_final.rds")


# Removing unwanted var
followup_MRT_hh_imptd <- followup_MRT_hh_imptd %>%
  dplyr::select(-all_of(vars_to_rm_ml)) 

followup_MRT_hh_imptd <- followup_MRT_hh_imptd %>%
  mutate(across(all_of(listOutcomes),~as.numeric(as.character(.))))

# Creates a new dataframe 'followup_MRT_hh_cntrl' from 'followup_MRT_hh' that contains only control groups
followup_MRT_hh_cntrl <- followup_MRT_hh_imptd %>%
  # Filters to keep only rows where either 'treatment_pi' or 'treatment_csh_trnsfr' is "Control"
  filter(treatment_pi == "Control" | treatment_csh_trnsfr == "Control") 



```

# ML algorithm  

It’s quite common to find in literature and algorithms, that covers this topic an univariate analysis, which is a ranking of variables given a particular metric.
We’re going to create two models: random forest and gradient boosting machine (GBM) using *caret* R package to cross-validate the data. Next, we’ll compare the best variable ranking that every model returns.



```{r}

# Define model methods - this creates a vector of machine learning algorithms to test
model_methods <- c("rf", "lm", "gbm", "glmnet", "svmRadial", "knn", "xgbTree", "treebag")

# Define model names for display - creates a named vector to use friendly names in output
model_names <- c(
  rf = "Random Forest",
  lm = "Linear Regression",
  gbm = "Gradient Boosting",
  glmnet = "Elastic Net",
  svmRadial = "Support Vector Machine",
  knn = "K-nearest Neighbors",
  xgbTree = "Extreme Gradient Boosting",
  treebag = "Bagging"
)

# Set up 10-fold cross-validation
fitControl = trainControl(method = "cv",
                          number = 10,
                          search = "grid",
                          classProbs = FALSE,  # Since this is regression
                          verboseIter = TRUE,
                          allowParallel = TRUE)



df_ML_results <- purrr::map_dfr(lst_outcome_ml, function(curr_ipv) {
  # Set the response variable
  bind_rows(
    getEstimateML_IPV(curr_ipv, listOutcomes, treatment_vars, followup_MRT_hh_cntrl, model_methods, fitControl)
  )
}, .progress = TRUE)

# Select the best scoring model - the one with lowest total rank score
# Model selection - rank and score models based on performance metrics
# Rank each metric: lower is better for RMSE and MAE, higher is better for Rsquared
best_model_ranked_all <- df_ML_results %>%
  group_by(curr_ipv) %>% # Analysis by outcome
  mutate(
    rank_rmse = rank(RMSE, ties.method = "min"),  # Rank by RMSE (lower is better)
    rank_mae = rank(MAE, ties.method = "min"),    # Rank by MAE (lower is better)
    rank_rsq = rank(-Rsquared, ties.method = "min"), # Rank by R² (higher is better, so invert)
    total_score = rank_rmse + rank_mae + rank_rsq # Sum ranks for overall score
  ) %>% 
  filter(total_score == min(total_score)) %>% 
  ungroup()

# Print the current contents of the 'best_model_ranked' dataframe
View(best_model_ranked_all)

# Group the data by the model names
best_model_ranked <- best_model_ranked_all %>% 
  group_by(Model_names) %>%        # Group data by the 'Model_names' column
  summarise(n = n()) %>%           # Count the number of occurrences for each model
  ungroup() %>%                    # Remove grouping to avoid affecting later operations
  filter(n == max(n, na.rm = TRUE)) # Keep only the model with the highest count

# Print the results of the best model
print(sprintf("Best model is %s based on combined metric ranks and has a number of best ranked model of %s", best_model_ranked$Model_names, best_model_ranked$n))


df_ML_results_final <- purrr::map_dfr(lst_outcome_ml, function(curr_ipv) {
  # Set the response variable
  bind_rows(
    getEstimatePred_IPV(curr_ipv, listOutcomes, treatment_vars,  vars_to_keep_ml, best_model_ranked$Model_names, fitControl, followup_MRT_hh_cntrl,  followup_MRT_hh_imptd)
  )
}, .progress = TRUE)

```



## Controlling behavior

### Binary for the last 12 months
```{r}
# Define the current IPV variable of interest
out_ipv = "control_ipv_sev_12m"

# Define the current list of heterogeneity variables of interest
lst_het_var = c("decile_baseline_ipv", "quartile_baseline_ipv","median_baseline_ipv")

# Creating the data for reg
df_curr <- df_ML_results_final %>%
  filter(type == "baseline", curr_ipv == out_ipv) %>%  # Keep only baseline predictions and  keeps rows of interest.
  dplyr::select(hhid, predicted_val) %>%  # Keep only household ID and predicted IPV at baseline
  distinct(hhid, predicted_val, .keep_all = TRUE) %>% 
  inner_join(
    followup_MRT_hh %>%
      dplyr::select(hhid, !!sym(out_ipv), treatment_pi_pool, 
                    all_of(control_vars), all_of(cluster_vars), 
                    all_of(treatment_vars), reg_hh_csh_mrt, 
                    reg_hh_pi_mrt, village) %>%  
      distinct(.keep_all = TRUE),  # Select some variables
    by = 'hhid',  # Merge on household ID
    multiple = "all"
  )   %>% 
  filter(reg_hh_pi_mrt==1 | reg_hh_csh_mrt==1) 

# Create df_curr1 by filtering households registered for the cash transfer program (reg_hh_csh_mrt == 1)
df_curr1 <- df_curr %>% 
  filter(reg_hh_csh_mrt == 1) %>%  # Keep only cash transfer treatment group
  mutate(
    decile_baseline_ipv = as.factor(ntile(predicted_val, 10)),   # Create decile factor based on predicted IPV at baseline
    quartile_baseline_ipv = as.factor(ntile(predicted_val, 5)),  # Create quartile factor
    median_baseline_ipv = as.factor(ntile(predicted_val, 2))     # Create median (binary high/low) factor
  )

# Create df_curr2 by filtering households registered for the productive inclusion program (reg_hh_pi_mrt == 1)
df_curr2 <- df_curr %>% 
  filter(reg_hh_pi_mrt == 1) %>%  # Keep only productive inclusion treatment group
  mutate(
    decile_baseline_ipv = as.factor(ntile(predicted_val, 10)),   # Create decile factor based on predicted IPV at baseline
    quartile_baseline_ipv = as.factor(ntile(predicted_val, 5)),  # Create quartile factor
    median_baseline_ipv = as.factor(ntile(predicted_val, 2))     # Create median (binary high/low) factor
  )

# Combine the two filtered datasets into a single dataframe (stacking them)
df_curr <- plyr::rbind.fill(df_curr1, df_curr2)  # Use plyr to bind rows even if columns slightly differ
```



#### First plot
```{r}

# Build the plot
df_curr %>%
  filter(!is.na(treatment_pi_pool)) %>% 
  ggplot(aes(
    x = predicted_val,  # X-axis: predicted IPV at baseline
    y = !!sym(out_ipv),  # Y-axis: observed IPV at follow-up
    color = treatment_pi_pool,  # Color lines by treatment group
    fill = treatment_pi_pool # Fill the color of lines by treatment group
  )) + 
  geom_point() + 
  geom_smooth(method = "loess", se = TRUE, alpha = 0.2, level=0.95) +  # Add linear fit with confidence interval
  scale_color_manual(values = c("Pool" = "#FAA43A", "Control" = "#5DA5DA")) +  # Custom line colors
  scale_fill_manual(values =  c("Pool" = "#FAA43A", "Control" = "#5DA5DA")) + # Custom confidence interval
  labs(
    x = "Predicted baseline IPV",  # X-axis label
    y = "IPV at follow-up",        # Y-axis label
    color = "",                    # Remove legend title for color
    caption = "The smooth function a local polynomial regression."  # Add caption to plot
  ) +
  theme_light(base_size = 8) + # Use light theme with base font size 8
  theme(
    legend.position = 'bottom',  # Place legend at bottom
    text = element_text(size = 8),  # General text size
    legend.direction = "horizontal",  # Horizontal layout of legend
    legend.box = "horizontal"        # Group legend items in a single line
  ) +
  guides(fill = "none")

# Save the plot as a JPEG image
ggsave(
  paste0("output/img/", out_ipv, "first_ML_all.jpeg"),
  width = 27, height = 16, units = "cm")
```



#### Second plot

```{r}
# Create a data frame of results examining heterogeneous treatment effects
# across different IPV outcomes, treatment variables, and heterogeneity dimensions
mainResults_het <- map_dfr(out_ipv, function(depvar) {
  
  # For each heterogeneity variable...
  tempResults1 <- map_dfr(lst_het_var, function(het_var) { 
    
    # For each treatment variable...
    tempResults2 <- map_dfr(treatment_vars, function(treat_var) {
      
      bind_rows(
        # Get estimates for heterogeneous treatment effects using the specified model
        getEstimateGlobal_ML_het(depvar, treat_var, het_var, control_vars, strata_vars, cluster_vars, df_curr) %>%
          # Add columns identifying which variables were used in this iteration
          mutate(depvar = depvar, outcome = depvar, treat_var = treat_var, het_var = het_var)
      )
    })
  })
})

# Filter results for the cash transfer program
mainResults_het_cash <- mainResults_het %>%
  filter(name=="cash")

# Filter results for the productive inclusion program
mainResults_het_pi <- mainResults_het %>%
  filter(name=="pi")

# Compute treatment group sizes and proportions for Tekavoul (cash)
mainResults_het_cash <- mainResults_het_cash %>%
  group_by(estimate_quant, het_var) %>%
  mutate(N_treat = sum(Ntype_treat)) %>%  # Total number treated in each heterogeneity group
  ungroup() %>%
  mutate(prop = round(N_treat * 100 / Ntype, 2))  # Proportion of treated out of total group

# Compute treatment group sizes and proportions for PI program, disaggregated by treatment arm
mainResults_het_pi <- mainResults_het_pi %>%
  group_by(estimate_quant, het_var, treat_var) %>%
  mutate(N_treat = sum(Ntype_treat)) %>%  # Total number treated in each subgroup
  ungroup() %>%
  mutate(prop = round(N_treat * 100 / Ntype, 2))  # Proportion of treated in group

# Calculate share within each treatment type
mainResults_het_pi <- mainResults_het_pi %>%
  mutate(prop_per_treat = round(Ntype_treat * 100 / N_treat, 2))

# Recode program names and variable labels for Tekavoul
mainResults_het_cash <- mainResults_het_cash %>%
  mutate(
    name = dplyr::recode(name,
                         cash = "(a) Tekavoul program",
                         pi = "(b) Productive inclusion program"),
    het_var = dplyr::recode(het_var,
                            decile_baseline_ipv = "decile",
                            quartile_baseline_ipv = "quartile",
                            median_baseline_ipv = "median"),
    depvar = dplyr::recode(depvar,
                  control_ipv_sev_12m = "Bin. for cntrl IPV in the last 12m",
                  control_ipv_sev_index = "Cntrl IPV inten. index z-scr",
                  emo_ipv_sev_12m = "Bin. for emo. IPV in the last 12m",
                  emo_ipv_sev_index = "Emo. IPV sever. index z-scr",
                  phy_ipv_sev_12m = "Bin. for phy. IPV in the last 12m",
                  phy_ipv_sev_index = "Phy. IPV sever. index z-scr",
                  sex_ipv_sev_12m = "Bin. for sex. IPV in the last 12m",
                  sex_ipv_sev_index = "Sex. IPV sever. index z-scr",
                  sex_phy_ipv_sev_12m = "Bin. for sex. or phy. IPV in the last 12m",
                  sex_phy_ipv_sev_index = "Sex. or phy. IPV sever. index z-scr",
                  eco_ipv_sev_12m = "Bin. for eco. IPV in the last 12m",
                  eco_ipv_sev_index = "Eco. IPV sever. index z-scr",
                  all_ipv_sev_12m = "Bin. for at least one type of IPV (exclud. eco.) in the last 12m",
                  all_ipv_sev_index = "All IPV sev. index z-scr")
  )

# Create label text summarizing N and proportion treated for Tekavoul
mainResults_het_cash <- mainResults_het_cash %>%
  group_by(estimate_quant, het_var) %>%
  mutate(
    lab = sprintf(
      "%s %s \n N treat (pct): %s (%s)",
      first(het_var),
      first(estimate_quant),
      scales::comma(first(N_treat)),
      scales::comma(first(prop))
    )
  ) %>%
  ungroup()

# Recode program names and variable labels for PI program
mainResults_het_pi <- mainResults_het_pi %>%
  mutate(
    name = dplyr::recode(name,
                         cash = "(a) Tekavoul program",
                         pi = "(b) Productive inclusion program"),
    het_var = dplyr::recode(het_var,
                            decile_baseline_ipv = "decile",
                            quartile_baseline_ipv = "quartile",
                            median_baseline_ipv = "median"),
    depvar = dplyr::recode(depvar,
                  control_ipv_sev_12m = "Bin. for cntrl IPV in the last 12m",
                  control_ipv_sev_index = "Cntrl IPV inten. index z-scr",
                  emo_ipv_sev_12m = "Bin. for emo. IPV in the last 12m",
                  emo_ipv_sev_index = "Emo. IPV sever. index z-scr",
                  phy_ipv_sev_12m = "Bin. for phy. IPV in the last 12m",
                  phy_ipv_sev_index = "Phy. IPV sever. index z-scr",
                  sex_ipv_sev_12m = "Bin. for sex. IPV in the last 12m",
                  sex_ipv_sev_index = "Sex. IPV sever. index z-scr",
                  sex_phy_ipv_sev_12m = "Bin. for sex. or phy. IPV in the last 12m",
                  sex_phy_ipv_sev_index = "Sex. or phy. IPV sever. index z-scr",
                  eco_ipv_sev_12m = "Bin. for eco. IPV in the last 12m",
                  eco_ipv_sev_index = "Eco. IPV sever. index z-scr",
                  all_ipv_sev_12m = "Bin. for at least one type of IPV (exclud. eco.) in the last 12m",
                  all_ipv_sev_index = "All IPV sev. index z-scr")
  )

# Create detailed label with counts and proportions per treatment arm for PI program
mainResults_het_pi <- mainResults_het_pi %>%
  group_by(estimate_quant, het_var) %>%
  mutate(
    lab = sprintf(
      "%s %s \n N treat (pct): %s (%s) \n N Capital (pct): %s (%s) \n N Psychosocial (pct): %s (%s) \n N Full (pct): %s (%s).",
      first(het_var),
      first(estimate_quant),
      scales::comma(first(N_treat)),
      scales::comma(first(prop)),
      scales::comma(first(Ntype_treat)),
      scales::comma(first(prop_per_treat)),
      scales::comma(nth(Ntype_treat, 2)),
      scales::comma(nth(prop_per_treat, 2)),
      scales::comma(nth(Ntype_treat,3)),
      scales::comma(nth(prop_per_treat,3))
    )
  ) %>%
  ungroup()

# Remove redundant prefixes from PI labels
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("decile", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("quartile", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("median", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N treat (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Capital (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Psychosocial (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Full (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)

# Remove redundant prefixes from Tekavoul labels
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("decile", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("quartile", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("median", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1)] <- gsub("N treat (pct): ", "", mainResults_het_cash$lab[-c(1)], fixed = T)

# Convert labels and factor variables to ordered factors for plotting
mainResults_het_cash$lab <- fct_inorder(mainResults_het_cash$lab)
mainResults_het_cash$typeTreat <- fct_inorder(mainResults_het_cash$typeTreat)
mainResults_het_cash$het_var <- fct_inorder(mainResults_het_cash$het_var)
mainResults_het_pi$lab <- fct_inorder(mainResults_het_pi$lab)
mainResults_het_pi$typeTreat <- fct_inorder(mainResults_het_pi$typeTreat)
mainResults_het_pi$het_var <- fct_inorder(mainResults_het_pi$het_var)

# Create plot for Tekavoul program
g1 <- mainResults_het_cash %>%
  ggplot(aes(x = lab, y = pe, shape = typeTreat, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_wrap(~het_var, scales = "free_x", shrink=TRUE, drop=TRUE) +
  labs(
    x = "", y = "Effect",
    subtitle = first(mainResults_het_cash$depvar),
    caption = sprintf("N = %s Tekavoul", first(mainResults_het_cash$N)),
    shape =""
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), legend.direction = "horizontal")

# Save plot for Tekavoul
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_cash$name),"_",first(mainResults_het_cash$depvar),"_ML.jpeg"), g1, width = 27, height = 16, units = "cm")

# Create plot for PI program
g2 <- mainResults_het_pi %>%
  ggplot(aes(x = lab, y = pe, shape = typeTreat, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_wrap(~het_var, scales = "free_x", shrink=TRUE, drop=TRUE) +
  labs(
    x = "", y = "Effect",
    subtitle = first(mainResults_het_pi$depvar),
    caption = sprintf("N = %s productive inclusion", first(mainResults_het_pi$N)),
    shape =""
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), legend.direction = "horizontal")

# Save plot for PI
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_pi$name),"_",first(mainResults_het_pi$depvar),"_ML.jpeg"), g2, width = 27, height = 16, units = "cm")

# Combine the two plots into a single figure
arrange_plot <- ggpubr::ggarrange(g1, g2, common.legend = FALSE, nrow = 2, ncol = 1)

# Printing the plot
arrange_plot

# Save the combined plot
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_cash$het_var),"_",out_ipv,"_ML_estimates.jpeg"), arrange_plot, width = 27, height = 16, units = "cm")

```

### Continuous index in the last 12 months
```{r}
# Define the current IPV variable of interest
out_ipv = "control_ipv_sev_index"

# Define the current list of heterogeneity variables of interest
lst_het_var = c("decile_baseline_ipv", "quartile_baseline_ipv","median_baseline_ipv")

# Creating the data for reg
df_curr <- df_ML_results_final %>%
  filter(type == "baseline", curr_ipv == out_ipv) %>%  # Keep only baseline predictions and  keeps rows of interest.
  dplyr::select(hhid, predicted_val) %>%  # Keep only household ID and predicted IPV at baseline
  distinct(hhid, predicted_val, .keep_all = TRUE) %>% 
  inner_join(
    followup_MRT_hh %>%
      dplyr::select(hhid, !!sym(out_ipv), treatment_pi_pool, 
                    all_of(control_vars), all_of(cluster_vars), 
                    all_of(treatment_vars), reg_hh_csh_mrt, 
                    reg_hh_pi_mrt, village) %>%  
      distinct(.keep_all = TRUE),  # Select some variables
    by = 'hhid',  # Merge on household ID
    multiple = "all"
  )   %>% 
  filter(reg_hh_pi_mrt==1 | reg_hh_csh_mrt==1) 

# Create df_curr1 by filtering households registered for the cash transfer program (reg_hh_csh_mrt == 1)
df_curr1 <- df_curr %>% 
  filter(reg_hh_csh_mrt == 1) %>%  # Keep only cash transfer treatment group
  mutate(
    decile_baseline_ipv = as.factor(ntile(predicted_val, 10)),   # Create decile factor based on predicted IPV at baseline
    quartile_baseline_ipv = as.factor(ntile(predicted_val, 5)),  # Create quartile factor
    median_baseline_ipv = as.factor(ntile(predicted_val, 2))     # Create median (binary high/low) factor
  )

# Create df_curr2 by filtering households registered for the productive inclusion program (reg_hh_pi_mrt == 1)
df_curr2 <- df_curr %>% 
  filter(reg_hh_pi_mrt == 1) %>%  # Keep only productive inclusion treatment group
  mutate(
    decile_baseline_ipv = as.factor(ntile(predicted_val, 10)),   # Create decile factor based on predicted IPV at baseline
    quartile_baseline_ipv = as.factor(ntile(predicted_val, 5)),  # Create quartile factor
    median_baseline_ipv = as.factor(ntile(predicted_val, 2))     # Create median (binary high/low) factor
  )

# Combine the two filtered datasets into a single dataframe (stacking them)
df_curr <- plyr::rbind.fill(df_curr1, df_curr2)  # Use plyr to bind rows even if columns slightly differ

```



#### First plot
```{r}

# Build the plot
df_curr %>%
  filter(!is.na(treatment_pi_pool)) %>% 
  ggplot(aes(
    x = predicted_val,  # X-axis: predicted IPV at baseline
    y = !!sym(out_ipv),  # Y-axis: observed IPV at follow-up
    color = treatment_pi_pool,  # Color lines by treatment group
    fill = treatment_pi_pool # Fill the color of lines by treatment group
  )) + 
  geom_point() + 
  geom_smooth(method = "loess", se = TRUE, alpha = 0.2, level=0.95) +  # Add linear fit with confidence interval
  scale_color_manual(values = c("Pool" = "#FAA43A", "Control" = "#5DA5DA")) +  # Custom line colors
  scale_fill_manual(values =  c("Pool" = "#FAA43A", "Control" = "#5DA5DA")) + # Custom confidence interval
  labs(
    x = "Predicted baseline IPV",  # X-axis label
    y = "IPV at follow-up",        # Y-axis label
    color = "",                    # Remove legend title for color
    caption = "The smooth function a local polynomial regression."  # Add caption to plot
  ) +
  theme_light(base_size = 8) + # Use light theme with base font size 8
  theme(
    legend.position = 'bottom',  # Place legend at bottom
    text = element_text(size = 8),  # General text size
    legend.direction = "horizontal",  # Horizontal layout of legend
    legend.box = "horizontal"        # Group legend items in a single line
  ) +
  guides(fill = "none")

# Save the plot as a JPEG image
ggsave(
  paste0("output/img/", out_ipv, "first_ML_all.jpeg"),
  width = 27, height = 16, units = "cm")
```



#### Second plot

```{r}
# Create a data frame of results examining heterogeneous treatment effects
# across different IPV outcomes, treatment variables, and heterogeneity dimensions
mainResults_het <- map_dfr(out_ipv, function(depvar) {
  
  # For each heterogeneity variable...
  tempResults1 <- map_dfr(lst_het_var, function(het_var) { 
    
    # For each treatment variable...
    tempResults2 <- map_dfr(treatment_vars, function(treat_var) {
      
      bind_rows(
        # Get estimates for heterogeneous treatment effects using the specified model
        getEstimateGlobal_ML_het(depvar, treat_var, het_var, control_vars, strata_vars, cluster_vars, df_curr) %>%
          # Add columns identifying which variables were used in this iteration
          mutate(depvar = depvar, outcome = depvar, treat_var = treat_var, het_var = het_var)
      )
    })
  })
})

# Filter results for the cash transfer program
mainResults_het_cash <- mainResults_het %>%
  filter(name=="cash")

# Filter results for the productive inclusion program
mainResults_het_pi <- mainResults_het %>%
  filter(name=="pi")

# Compute treatment group sizes and proportions for Tekavoul (cash)
mainResults_het_cash <- mainResults_het_cash %>%
  group_by(estimate_quant, het_var) %>%
  mutate(N_treat = sum(Ntype_treat)) %>%  # Total number treated in each heterogeneity group
  ungroup() %>%
  mutate(prop = round(N_treat * 100 / Ntype, 2))  # Proportion of treated out of total group

# Compute treatment group sizes and proportions for PI program, disaggregated by treatment arm
mainResults_het_pi <- mainResults_het_pi %>%
  group_by(estimate_quant, het_var, treat_var) %>%
  mutate(N_treat = sum(Ntype_treat)) %>%  # Total number treated in each subgroup
  ungroup() %>%
  mutate(prop = round(N_treat * 100 / Ntype, 2))  # Proportion of treated in group

# Calculate share within each treatment type
mainResults_het_pi <- mainResults_het_pi %>%
  mutate(prop_per_treat = round(Ntype_treat * 100 / N_treat, 2))

# Recode program names and variable labels for Tekavoul
mainResults_het_cash <- mainResults_het_cash %>%
  mutate(
    name = dplyr::recode(name,
                         cash = "(a) Tekavoul program",
                         pi = "(b) Productive inclusion program"),
    het_var = dplyr::recode(het_var,
                            decile_baseline_ipv = "decile",
                            quartile_baseline_ipv = "quartile",
                            median_baseline_ipv = "median"),
    depvar = dplyr::recode(depvar,
                           control_ipv_sev_12m = "Bin. for cntrl IPV in the last 12m",
                           control_ipv_sev_index = "Cntrl IPV inten. index z-scr",
                           emo_ipv_sev_12m = "Bin. for emo. IPV in the last 12m",
                           emo_ipv_sev_12m = "Emo. IPV sever. index z-scr",
                           phy_ipv_sev_12m = "Bin. for phy. IPV in the last 12m",
                           phy_ipv_sev_index = "Phy. IPV sever. index z-scr",
                           sex_ipv_sev_12m = "Bin. for sex. IPV in the last 12m",
                           sex_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           sex_phy_sev_12m = "Bin. for sex. and phy. IPV in the last 12m",
                           sex_phy_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           eco_ipv_sev_12m = "Bin. for eco. IPV in the last 12m",
                           eco_ipv_sev_index = "Eco. IPV sever. index z-scr",
                           all_ipv_sev_12m = "Bin. for at least one type of IPV (exclud. eco.) in the last 12m",
                           all_ipv_sev_index = "All IPV sev. index z-scr")
  )

# Create label text summarizing N and proportion treated for Tekavoul
mainResults_het_cash <- mainResults_het_cash %>%
  group_by(estimate_quant, het_var) %>%
  mutate(
    lab = sprintf(
      "%s %s \n N treat (pct): %s (%s)",
      first(het_var),
      first(estimate_quant),
      scales::comma(first(N_treat)),
      scales::comma(first(prop))
    )
  ) %>%
  ungroup()

# Recode program names and variable labels for PI program
mainResults_het_pi <- mainResults_het_pi %>%
  mutate(
    name = dplyr::recode(name,
                         cash = "(a) Tekavoul program",
                         pi = "(b) Productive inclusion program"),
    het_var = dplyr::recode(het_var,
                            decile_baseline_ipv = "decile",
                            quartile_baseline_ipv = "quartile",
                            median_baseline_ipv = "median"),
    depvar = dplyr::recode(depvar,
                           control_ipv_sev_12m = "Bin. for cntrl IPV in the last 12m",
                           control_ipv_sev_index = "Cntrl IPV inten. index z-scr",
                           emo_ipv_sev_12m = "Bin. for emo. IPV in the last 12m",
                           emo_ipv_sev_12m = "Emo. IPV sever. index z-scr",
                           phy_ipv_sev_12m = "Bin. for phy. IPV in the last 12m",
                           phy_ipv_sev_index = "Phy. IPV sever. index z-scr",
                           sex_ipv_sev_12m = "Bin. for sex. IPV in the last 12m",
                           sex_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           sex_phy_sev_12m = "Bin. for sex. and phy. IPV in the last 12m",
                           sex_phy_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           eco_ipv_sev_12m = "Bin. for eco. IPV in the last 12m",
                           eco_ipv_sev_index = "Eco. IPV sever. index z-scr",
                           all_ipv_sev_12m = "Bin. for at least one type of IPV (exclud. eco.) in the last 12m",
                           all_ipv_sev_index = "All IPV sev. index z-scr")
  )

# Create detailed label with counts and proportions per treatment arm for PI program
mainResults_het_pi <- mainResults_het_pi %>%
  group_by(estimate_quant, het_var) %>%
  mutate(
    lab = sprintf(
      "%s %s \n N treat (pct): %s (%s) \n N Capital (pct): %s (%s) \n N Psychosocial (pct): %s (%s) \n N Full (pct): %s (%s).",
      first(het_var),
      first(estimate_quant),
      scales::comma(first(N_treat)),
      scales::comma(first(prop)),
      scales::comma(first(Ntype_treat)),
      scales::comma(first(prop_per_treat)),
      scales::comma(nth(Ntype_treat, 2)),
      scales::comma(nth(prop_per_treat, 2)),
      scales::comma(nth(Ntype_treat,3)),
      scales::comma(nth(prop_per_treat,3))
    )
  ) %>%
  ungroup()

# Remove redundant prefixes from PI labels
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("decile", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("quartile", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("median", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N treat (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Capital (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Psychosocial (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Full (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)

# Remove redundant prefixes from Tekavoul labels
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("decile", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("quartile", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("median", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1)] <- gsub("N treat (pct): ", "", mainResults_het_cash$lab[-c(1)], fixed = T)

# Convert labels and factor variables to ordered factors for plotting
mainResults_het_cash$lab <- fct_inorder(mainResults_het_cash$lab)
mainResults_het_cash$typeTreat <- fct_inorder(mainResults_het_cash$typeTreat)
mainResults_het_cash$het_var <- fct_inorder(mainResults_het_cash$het_var)
mainResults_het_pi$lab <- fct_inorder(mainResults_het_pi$lab)
mainResults_het_pi$typeTreat <- fct_inorder(mainResults_het_pi$typeTreat)
mainResults_het_pi$het_var <- fct_inorder(mainResults_het_pi$het_var)

# Create plot for Tekavoul program
g1 <- mainResults_het_cash %>%
  ggplot(aes(x = lab, y = pe, shape = typeTreat, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_wrap(~het_var, scales = "free_x", shrink=TRUE, drop=TRUE) +
  labs(
    x = "", y = "Effect",
    subtitle = first(mainResults_het_cash$depvar),
    caption = sprintf("N = %s Tekavoul", first(mainResults_het_cash$N)),
    shape =""
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), legend.direction = "horizontal")

# Save plot for Tekavoul
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_cash$name),"_",first(mainResults_het_cash$depvar),"_ML.jpeg"), g1, width = 27, height = 16, units = "cm")

# Create plot for PI program
g2 <- mainResults_het_pi %>%
  ggplot(aes(x = lab, y = pe, shape = typeTreat, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_wrap(~het_var, scales = "free_x", shrink=TRUE, drop=TRUE) +
  labs(
    x = "", y = "Effect",
    subtitle = first(mainResults_het_pi$depvar),
    caption = sprintf("N = %s productive inclusion", first(mainResults_het_pi$N)),
    shape =""
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), legend.direction = "horizontal")

# Save plot for PI
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_pi$name),"_",first(mainResults_het_pi$depvar),"_ML.jpeg"), g2, width = 27, height = 16, units = "cm")

# Combine the two plots into a single figure
arrange_plot <- ggpubr::ggarrange(g1, g2, common.legend = FALSE, nrow = 2, ncol = 1)

# Printing the plot
arrange_plot

# Save the combined plot
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_cash$het_var),"_",out_ipv,"_ML_estimates.jpeg"), arrange_plot, width = 27, height = 16, units = "cm")

```




## Emotionnal violence
### Binary for the last 12 months
```{r}
# Define the current IPV variable of interest
out_ipv = "emo_ipv_sev_12m"

# Define the current list of heterogeneity variables of interest
lst_het_var = c("decile_baseline_ipv", "quartile_baseline_ipv","median_baseline_ipv")

# Creating the data for reg
df_curr <- df_ML_results_final %>%
  filter(type == "baseline", curr_ipv == out_ipv) %>%  # Keep only baseline predictions and  keeps rows of interest.
  dplyr::select(hhid, predicted_val) %>%  # Keep only household ID and predicted IPV at baseline
  distinct(hhid, predicted_val, .keep_all = TRUE) %>% 
  inner_join(
    followup_MRT_hh %>%
      dplyr::select(hhid, !!sym(out_ipv), treatment_pi_pool, 
                    all_of(control_vars), all_of(cluster_vars), 
                    all_of(treatment_vars), reg_hh_csh_mrt, 
                    reg_hh_pi_mrt, village) %>%  
      distinct(.keep_all = TRUE),  # Select some variables
    by = 'hhid',  # Merge on household ID
    multiple = "all"
  )   %>% 
  filter(reg_hh_pi_mrt==1 | reg_hh_csh_mrt==1) 

# Create df_curr1 by filtering households registered for the cash transfer program (reg_hh_csh_mrt == 1)
df_curr1 <- df_curr %>% 
  filter(reg_hh_csh_mrt == 1) %>%  # Keep only cash transfer treatment group
  mutate(
    decile_baseline_ipv = as.factor(ntile(predicted_val, 10)),   # Create decile factor based on predicted IPV at baseline
    quartile_baseline_ipv = as.factor(ntile(predicted_val, 5)),  # Create quartile factor
    median_baseline_ipv = as.factor(ntile(predicted_val, 2))     # Create median (binary high/low) factor
  )

# Create df_curr2 by filtering households registered for the productive inclusion program (reg_hh_pi_mrt == 1)
df_curr2 <- df_curr %>% 
  filter(reg_hh_pi_mrt == 1) %>%  # Keep only productive inclusion treatment group
  mutate(
    decile_baseline_ipv = as.factor(ntile(predicted_val, 10)),   # Create decile factor based on predicted IPV at baseline
    quartile_baseline_ipv = as.factor(ntile(predicted_val, 5)),  # Create quartile factor
    median_baseline_ipv = as.factor(ntile(predicted_val, 2))     # Create median (binary high/low) factor
  )

# Combine the two filtered datasets into a single dataframe (stacking them)
df_curr <- plyr::rbind.fill(df_curr1, df_curr2)  # Use plyr to bind rows even if columns slightly differ

```



#### First plot
```{r}

# Build the plot
df_curr %>%
  filter(!is.na(treatment_pi_pool)) %>% 
  ggplot(aes(
    x = predicted_val,  # X-axis: predicted IPV at baseline
    y = !!sym(out_ipv),  # Y-axis: observed IPV at follow-up
    color = treatment_pi_pool,  # Color lines by treatment group
    fill = treatment_pi_pool # Fill the color of lines by treatment group
  )) + 
  geom_point() + 
  geom_smooth(method = "loess", se = TRUE, alpha = 0.2, level=0.95) +  # Add linear fit with confidence interval
  scale_color_manual(values = c("Pool" = "#FAA43A", "Control" = "#5DA5DA")) +  # Custom line colors
  scale_fill_manual(values =  c("Pool" = "#FAA43A", "Control" = "#5DA5DA")) + # Custom confidence interval
  labs(
    x = "Predicted baseline IPV",  # X-axis label
    y = "IPV at follow-up",        # Y-axis label
    color = "",                    # Remove legend title for color
    caption = "The smooth function a local polynomial regression."  # Add caption to plot
  ) +
  theme_light(base_size = 8) + # Use light theme with base font size 8
  theme(
    legend.position = 'bottom',  # Place legend at bottom
    text = element_text(size = 8),  # General text size
    legend.direction = "horizontal",  # Horizontal layout of legend
    legend.box = "horizontal"        # Group legend items in a single line
  ) +
  guides(fill = "none")

# Save the plot as a JPEG image
ggsave(
  paste0("output/img/", out_ipv, "first_ML_all.jpeg"),
  width = 27, height = 16, units = "cm")
```



#### Second plot

```{r}
# Create a data frame of results examining heterogeneous treatment effects
# across different IPV outcomes, treatment variables, and heterogeneity dimensions
mainResults_het <- map_dfr(out_ipv, function(depvar) {
  
  # For each heterogeneity variable...
  tempResults1 <- map_dfr(lst_het_var, function(het_var) { 
    
    # For each treatment variable...
    tempResults2 <- map_dfr(treatment_vars, function(treat_var) {
      
      bind_rows(
        # Get estimates for heterogeneous treatment effects using the specified model
        getEstimateGlobal_ML_het(depvar, treat_var, het_var, control_vars, strata_vars, cluster_vars, df_curr) %>%
          # Add columns identifying which variables were used in this iteration
          mutate(depvar = depvar, outcome = depvar, treat_var = treat_var, het_var = het_var)
      )
    })
  })
})

# Filter results for the cash transfer program
mainResults_het_cash <- mainResults_het %>%
  filter(name=="cash")

# Filter results for the productive inclusion program
mainResults_het_pi <- mainResults_het %>%
  filter(name=="pi")

# Compute treatment group sizes and proportions for Tekavoul (cash)
mainResults_het_cash <- mainResults_het_cash %>%
  group_by(estimate_quant, het_var) %>%
  mutate(N_treat = sum(Ntype_treat)) %>%  # Total number treated in each heterogeneity group
  ungroup() %>%
  mutate(prop = round(N_treat * 100 / Ntype, 2))  # Proportion of treated out of total group

# Compute treatment group sizes and proportions for PI program, disaggregated by treatment arm
mainResults_het_pi <- mainResults_het_pi %>%
  group_by(estimate_quant, het_var, treat_var) %>%
  mutate(N_treat = sum(Ntype_treat)) %>%  # Total number treated in each subgroup
  ungroup() %>%
  mutate(prop = round(N_treat * 100 / Ntype, 2))  # Proportion of treated in group

# Calculate share within each treatment type
mainResults_het_pi <- mainResults_het_pi %>%
  mutate(prop_per_treat = round(Ntype_treat * 100 / N_treat, 2))

# Recode program names and variable labels for Tekavoul
mainResults_het_cash <- mainResults_het_cash %>%
  mutate(
    name = dplyr::recode(name,
                         cash = "(a) Tekavoul program",
                         pi = "(b) Productive inclusion program"),
    het_var = dplyr::recode(het_var,
                            decile_baseline_ipv = "decile",
                            quartile_baseline_ipv = "quartile",
                            median_baseline_ipv = "median"),
    depvar = dplyr::recode(depvar,
                           control_ipv_sev_12m = "Bin. for cntrl IPV in the last 12m",
                           control_ipv_sev_index = "Cntrl IPV inten. index z-scr",
                           emo_ipv_sev_12m = "Bin. for emo. IPV in the last 12m",
                           emo_ipv_sev_12m = "Emo. IPV sever. index z-scr",
                           phy_ipv_sev_12m = "Bin. for phy. IPV in the last 12m",
                           phy_ipv_sev_index = "Phy. IPV sever. index z-scr",
                           sex_ipv_sev_12m = "Bin. for sex. IPV in the last 12m",
                           sex_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           sex_phy_sev_12m = "Bin. for sex. and phy. IPV in the last 12m",
                           sex_phy_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           eco_ipv_sev_12m = "Bin. for eco. IPV in the last 12m",
                           eco_ipv_sev_index = "Eco. IPV sever. index z-scr",
                           all_ipv_sev_12m = "Bin. for at least one type of IPV (exclud. eco.) in the last 12m",
                           all_ipv_sev_index = "All IPV sev. index z-scr")
  )

# Create label text summarizing N and proportion treated for Tekavoul
mainResults_het_cash <- mainResults_het_cash %>%
  group_by(estimate_quant, het_var) %>%
  mutate(
    lab = sprintf(
      "%s %s \n N treat (pct): %s (%s)",
      first(het_var),
      first(estimate_quant),
      scales::comma(first(N_treat)),
      scales::comma(first(prop))
    )
  ) %>%
  ungroup()

# Recode program names and variable labels for PI program
mainResults_het_pi <- mainResults_het_pi %>%
  mutate(
    name = dplyr::recode(name,
                         cash = "(a) Tekavoul program",
                         pi = "(b) Productive inclusion program"),
    het_var = dplyr::recode(het_var,
                            decile_baseline_ipv = "decile",
                            quartile_baseline_ipv = "quartile",
                            median_baseline_ipv = "median"),
    depvar = dplyr::recode(depvar,
                           control_ipv_sev_12m = "Bin. for cntrl IPV in the last 12m",
                           control_ipv_sev_index = "Cntrl IPV inten. index z-scr",
                           emo_ipv_sev_12m = "Bin. for emo. IPV in the last 12m",
                           emo_ipv_sev_12m = "Emo. IPV sever. index z-scr",
                           phy_ipv_sev_12m = "Bin. for phy. IPV in the last 12m",
                           phy_ipv_sev_index = "Phy. IPV sever. index z-scr",
                           sex_ipv_sev_12m = "Bin. for sex. IPV in the last 12m",
                           sex_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           sex_phy_sev_12m = "Bin. for sex. and phy. IPV in the last 12m",
                           sex_phy_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           eco_ipv_sev_12m = "Bin. for eco. IPV in the last 12m",
                           eco_ipv_sev_index = "Eco. IPV sever. index z-scr",
                           all_ipv_sev_12m = "Bin. for at least one type of IPV (exclud. eco.) in the last 12m",
                           all_ipv_sev_index = "All IPV sev. index z-scr")
  )

# Create detailed label with counts and proportions per treatment arm for PI program
mainResults_het_pi <- mainResults_het_pi %>%
  group_by(estimate_quant, het_var) %>%
  mutate(
    lab = sprintf(
      "%s %s \n N treat (pct): %s (%s) \n N Capital (pct): %s (%s) \n N Psychosocial (pct): %s (%s) \n N Full (pct): %s (%s).",
      first(het_var),
      first(estimate_quant),
      scales::comma(first(N_treat)),
      scales::comma(first(prop)),
      scales::comma(first(Ntype_treat)),
      scales::comma(first(prop_per_treat)),
      scales::comma(nth(Ntype_treat, 2)),
      scales::comma(nth(prop_per_treat, 2)),
      scales::comma(nth(Ntype_treat,3)),
      scales::comma(nth(prop_per_treat,3))
    )
  ) %>%
  ungroup()

# Remove redundant prefixes from PI labels
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("decile", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("quartile", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("median", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N treat (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Capital (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Psychosocial (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Full (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)

# Remove redundant prefixes from Tekavoul labels
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("decile", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("quartile", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("median", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1)] <- gsub("N treat (pct): ", "", mainResults_het_cash$lab[-c(1)], fixed = T)

# Convert labels and factor variables to ordered factors for plotting
mainResults_het_cash$lab <- fct_inorder(mainResults_het_cash$lab)
mainResults_het_cash$typeTreat <- fct_inorder(mainResults_het_cash$typeTreat)
mainResults_het_cash$het_var <- fct_inorder(mainResults_het_cash$het_var)
mainResults_het_pi$lab <- fct_inorder(mainResults_het_pi$lab)
mainResults_het_pi$typeTreat <- fct_inorder(mainResults_het_pi$typeTreat)
mainResults_het_pi$het_var <- fct_inorder(mainResults_het_pi$het_var)

# Create plot for Tekavoul program
g1 <- mainResults_het_cash %>%
  ggplot(aes(x = lab, y = pe, shape = typeTreat, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_wrap(~het_var, scales = "free_x", shrink=TRUE, drop=TRUE) +
  labs(
    x = "", y = "Effect",
    subtitle = first(mainResults_het_cash$depvar),
    caption = sprintf("N = %s Tekavoul", first(mainResults_het_cash$N)),
    shape =""
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), legend.direction = "horizontal")

# Save plot for Tekavoul
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_cash$name),"_",first(mainResults_het_cash$depvar),"_ML.jpeg"), g1, width = 27, height = 16, units = "cm")

# Create plot for PI program
g2 <- mainResults_het_pi %>%
  ggplot(aes(x = lab, y = pe, shape = typeTreat, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_wrap(~het_var, scales = "free_x", shrink=TRUE, drop=TRUE) +
  labs(
    x = "", y = "Effect",
    subtitle = first(mainResults_het_pi$depvar),
    caption = sprintf("N = %s productive inclusion", first(mainResults_het_pi$N)),
    shape =""
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), legend.direction = "horizontal")

# Save plot for PI
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_pi$name),"_",first(mainResults_het_pi$depvar),"_ML.jpeg"), g2, width = 27, height = 16, units = "cm")

# Combine the two plots into a single figure
arrange_plot <- ggpubr::ggarrange(g1, g2, common.legend = FALSE, nrow = 2, ncol = 1)

# Printing the plot
arrange_plot

# Save the combined plot
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_cash$het_var),"_",out_ipv,"_ML_estimates.jpeg"), arrange_plot, width = 27, height = 16, units = "cm")

```

### Continuous index in the last 12 months
```{r}
# Define the current IPV variable of interest
out_ipv = "emo_ipv_sev_index"

# Define the current list of heterogeneity variables of interest
lst_het_var = c("decile_baseline_ipv", "quartile_baseline_ipv","median_baseline_ipv")

# Creating the data for reg
df_curr <- df_ML_results_final %>%
  filter(type == "baseline", curr_ipv == out_ipv) %>%  # Keep only baseline predictions and  keeps rows of interest.
  dplyr::select(hhid, predicted_val) %>%  # Keep only household ID and predicted IPV at baseline
  distinct(hhid, predicted_val, .keep_all = TRUE) %>% 
  inner_join(
    followup_MRT_hh %>%
      dplyr::select(hhid, !!sym(out_ipv), treatment_pi_pool, 
                    all_of(control_vars), all_of(cluster_vars), 
                    all_of(treatment_vars), reg_hh_csh_mrt, 
                    reg_hh_pi_mrt, village) %>%  
      distinct(.keep_all = TRUE),  # Select some variables
    by = 'hhid',  # Merge on household ID
    multiple = "all"
  )   %>% 
  filter(reg_hh_pi_mrt==1 | reg_hh_csh_mrt==1) 

# Create df_curr1 by filtering households registered for the cash transfer program (reg_hh_csh_mrt == 1)
df_curr1 <- df_curr %>% 
  filter(reg_hh_csh_mrt == 1) %>%  # Keep only cash transfer treatment group
  mutate(
    decile_baseline_ipv = as.factor(ntile(predicted_val, 10)),   # Create decile factor based on predicted IPV at baseline
    quartile_baseline_ipv = as.factor(ntile(predicted_val, 5)),  # Create quartile factor
    median_baseline_ipv = as.factor(ntile(predicted_val, 2))     # Create median (binary high/low) factor
  )

# Create df_curr2 by filtering households registered for the productive inclusion program (reg_hh_pi_mrt == 1)
df_curr2 <- df_curr %>% 
  filter(reg_hh_pi_mrt == 1) %>%  # Keep only productive inclusion treatment group
  mutate(
    decile_baseline_ipv = as.factor(ntile(predicted_val, 10)),   # Create decile factor based on predicted IPV at baseline
    quartile_baseline_ipv = as.factor(ntile(predicted_val, 5)),  # Create quartile factor
    median_baseline_ipv = as.factor(ntile(predicted_val, 2))     # Create median (binary high/low) factor
  )

# Combine the two filtered datasets into a single dataframe (stacking them)
df_curr <- plyr::rbind.fill(df_curr1, df_curr2)  # Use plyr to bind rows even if columns slightly differ

```



#### First plot
```{r}

# Build the plot
df_curr %>%
  filter(!is.na(treatment_pi_pool)) %>% 
  ggplot(aes(
    x = predicted_val,  # X-axis: predicted IPV at baseline
    y = !!sym(out_ipv),  # Y-axis: observed IPV at follow-up
    color = treatment_pi_pool,  # Color lines by treatment group
    fill = treatment_pi_pool # Fill the color of lines by treatment group
  )) + 
  geom_point() + 
  geom_smooth(method = "loess", se = TRUE, alpha = 0.2, level=0.95) +  # Add linear fit with confidence interval
  scale_color_manual(values = c("Pool" = "#FAA43A", "Control" = "#5DA5DA")) +  # Custom line colors
  scale_fill_manual(values =  c("Pool" = "#FAA43A", "Control" = "#5DA5DA")) + # Custom confidence interval
  labs(
    x = "Predicted baseline IPV",  # X-axis label
    y = "IPV at follow-up",        # Y-axis label
    color = "",                    # Remove legend title for color
    caption = "The smooth function a local polynomial regression."  # Add caption to plot
  ) +
  theme_light(base_size = 8) + # Use light theme with base font size 8
  theme(
    legend.position = 'bottom',  # Place legend at bottom
    text = element_text(size = 8),  # General text size
    legend.direction = "horizontal",  # Horizontal layout of legend
    legend.box = "horizontal"        # Group legend items in a single line
  ) +
  guides(fill = "none")

# Save the plot as a JPEG image
ggsave(
  paste0("output/img/", out_ipv, "first_ML_all.jpeg"),
  width = 27, height = 16, units = "cm")
```



#### Second plot

```{r}
# Create a data frame of results examining heterogeneous treatment effects
# across different IPV outcomes, treatment variables, and heterogeneity dimensions
mainResults_het <- map_dfr(out_ipv, function(depvar) {
  
  # For each heterogeneity variable...
  tempResults1 <- map_dfr(lst_het_var, function(het_var) { 
    
    # For each treatment variable...
    tempResults2 <- map_dfr(treatment_vars, function(treat_var) {
      
      bind_rows(
        # Get estimates for heterogeneous treatment effects using the specified model
        getEstimateGlobal_ML_het(depvar, treat_var, het_var, control_vars, strata_vars, cluster_vars, df_curr) %>%
          # Add columns identifying which variables were used in this iteration
          mutate(depvar = depvar, outcome = depvar, treat_var = treat_var, het_var = het_var)
      )
    })
  })
})

# Filter results for the cash transfer program
mainResults_het_cash <- mainResults_het %>%
  filter(name=="cash")

# Filter results for the productive inclusion program
mainResults_het_pi <- mainResults_het %>%
  filter(name=="pi")

# Compute treatment group sizes and proportions for Tekavoul (cash)
mainResults_het_cash <- mainResults_het_cash %>%
  group_by(estimate_quant, het_var) %>%
  mutate(N_treat = sum(Ntype_treat)) %>%  # Total number treated in each heterogeneity group
  ungroup() %>%
  mutate(prop = round(N_treat * 100 / Ntype, 2))  # Proportion of treated out of total group

# Compute treatment group sizes and proportions for PI program, disaggregated by treatment arm
mainResults_het_pi <- mainResults_het_pi %>%
  group_by(estimate_quant, het_var, treat_var) %>%
  mutate(N_treat = sum(Ntype_treat)) %>%  # Total number treated in each subgroup
  ungroup() %>%
  mutate(prop = round(N_treat * 100 / Ntype, 2))  # Proportion of treated in group

# Calculate share within each treatment type
mainResults_het_pi <- mainResults_het_pi %>%
  mutate(prop_per_treat = round(Ntype_treat * 100 / N_treat, 2))

# Recode program names and variable labels for Tekavoul
mainResults_het_cash <- mainResults_het_cash %>%
  mutate(
    name = dplyr::recode(name,
                         cash = "(a) Tekavoul program",
                         pi = "(b) Productive inclusion program"),
    het_var = dplyr::recode(het_var,
                            decile_baseline_ipv = "decile",
                            quartile_baseline_ipv = "quartile",
                            median_baseline_ipv = "median"),
    depvar = dplyr::recode(depvar,
                           control_ipv_sev_12m = "Bin. for cntrl IPV in the last 12m",
                           control_ipv_sev_index = "Cntrl IPV inten. index z-scr",
                           emo_ipv_sev_12m = "Bin. for emo. IPV in the last 12m",
                           emo_ipv_sev_12m = "Emo. IPV sever. index z-scr",
                           phy_ipv_sev_12m = "Bin. for phy. IPV in the last 12m",
                           phy_ipv_sev_index = "Phy. IPV sever. index z-scr",
                           sex_ipv_sev_12m = "Bin. for sex. IPV in the last 12m",
                           sex_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           sex_phy_sev_12m = "Bin. for sex. and phy. IPV in the last 12m",
                           sex_phy_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           eco_ipv_sev_12m = "Bin. for eco. IPV in the last 12m",
                           eco_ipv_sev_index = "Eco. IPV sever. index z-scr",
                           all_ipv_sev_12m = "Bin. for at least one type of IPV (exclud. eco.) in the last 12m",
                           all_ipv_sev_index = "All IPV sev. index z-scr")
  )

# Create label text summarizing N and proportion treated for Tekavoul
mainResults_het_cash <- mainResults_het_cash %>%
  group_by(estimate_quant, het_var) %>%
  mutate(
    lab = sprintf(
      "%s %s \n N treat (pct): %s (%s)",
      first(het_var),
      first(estimate_quant),
      scales::comma(first(N_treat)),
      scales::comma(first(prop))
    )
  ) %>%
  ungroup()

# Recode program names and variable labels for PI program
mainResults_het_pi <- mainResults_het_pi %>%
  mutate(
    name = dplyr::recode(name,
                         cash = "(a) Tekavoul program",
                         pi = "(b) Productive inclusion program"),
    het_var = dplyr::recode(het_var,
                            decile_baseline_ipv = "decile",
                            quartile_baseline_ipv = "quartile",
                            median_baseline_ipv = "median"),
    depvar = dplyr::recode(depvar,
                           control_ipv_sev_12m = "Bin. for cntrl IPV in the last 12m",
                           control_ipv_sev_index = "Cntrl IPV inten. index z-scr",
                           emo_ipv_sev_12m = "Bin. for emo. IPV in the last 12m",
                           emo_ipv_sev_12m = "Emo. IPV sever. index z-scr",
                           phy_ipv_sev_12m = "Bin. for phy. IPV in the last 12m",
                           phy_ipv_sev_index = "Phy. IPV sever. index z-scr",
                           sex_ipv_sev_12m = "Bin. for sex. IPV in the last 12m",
                           sex_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           sex_phy_sev_12m = "Bin. for sex. and phy. IPV in the last 12m",
                           sex_phy_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           eco_ipv_sev_12m = "Bin. for eco. IPV in the last 12m",
                           eco_ipv_sev_index = "Eco. IPV sever. index z-scr",
                           all_ipv_sev_12m = "Bin. for at least one type of IPV (exclud. eco.) in the last 12m",
                           all_ipv_sev_index = "All IPV sev. index z-scr")
  )

# Create detailed label with counts and proportions per treatment arm for PI program
mainResults_het_pi <- mainResults_het_pi %>%
  group_by(estimate_quant, het_var) %>%
  mutate(
    lab = sprintf(
      "%s %s \n N treat (pct): %s (%s) \n N Capital (pct): %s (%s) \n N Psychosocial (pct): %s (%s) \n N Full (pct): %s (%s).",
      first(het_var),
      first(estimate_quant),
      scales::comma(first(N_treat)),
      scales::comma(first(prop)),
      scales::comma(first(Ntype_treat)),
      scales::comma(first(prop_per_treat)),
      scales::comma(nth(Ntype_treat, 2)),
      scales::comma(nth(prop_per_treat, 2)),
      scales::comma(nth(Ntype_treat,3)),
      scales::comma(nth(prop_per_treat,3))
    )
  ) %>%
  ungroup()

# Remove redundant prefixes from PI labels
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("decile", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("quartile", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("median", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N treat (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Capital (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Psychosocial (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Full (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)

# Remove redundant prefixes from Tekavoul labels
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("decile", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("quartile", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("median", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1)] <- gsub("N treat (pct): ", "", mainResults_het_cash$lab[-c(1)], fixed = T)

# Convert labels and factor variables to ordered factors for plotting
mainResults_het_cash$lab <- fct_inorder(mainResults_het_cash$lab)
mainResults_het_cash$typeTreat <- fct_inorder(mainResults_het_cash$typeTreat)
mainResults_het_cash$het_var <- fct_inorder(mainResults_het_cash$het_var)
mainResults_het_pi$lab <- fct_inorder(mainResults_het_pi$lab)
mainResults_het_pi$typeTreat <- fct_inorder(mainResults_het_pi$typeTreat)
mainResults_het_pi$het_var <- fct_inorder(mainResults_het_pi$het_var)

# Create plot for Tekavoul program
g1 <- mainResults_het_cash %>%
  ggplot(aes(x = lab, y = pe, shape = typeTreat, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_wrap(~het_var, scales = "free_x", shrink=TRUE, drop=TRUE) +
  labs(
    x = "", y = "Effect",
    subtitle = first(mainResults_het_cash$depvar),
    caption = sprintf("N = %s Tekavoul", first(mainResults_het_cash$N)),
    shape =""
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), legend.direction = "horizontal")

# Save plot for Tekavoul
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_cash$name),"_",first(mainResults_het_cash$depvar),"_ML.jpeg"), g1, width = 27, height = 16, units = "cm")

# Create plot for PI program
g2 <- mainResults_het_pi %>%
  ggplot(aes(x = lab, y = pe, shape = typeTreat, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_wrap(~het_var, scales = "free_x", shrink=TRUE, drop=TRUE) +
  labs(
    x = "", y = "Effect",
    subtitle = first(mainResults_het_pi$depvar),
    caption = sprintf("N = %s productive inclusion", first(mainResults_het_pi$N)),
    shape =""
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), legend.direction = "horizontal")

# Save plot for PI
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_pi$name),"_",first(mainResults_het_pi$depvar),"_ML.jpeg"), g2, width = 27, height = 16, units = "cm")

# Combine the two plots into a single figure
arrange_plot <- ggpubr::ggarrange(g1, g2, common.legend = FALSE, nrow = 2, ncol = 1)

# Printing the plot
arrange_plot

# Save the combined plot
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_cash$het_var),"_",out_ipv,"_ML_estimates.jpeg"), arrange_plot, width = 27, height = 16, units = "cm")

```


## Physical violence
### Binary for the last 12 months
```{r}
# Define the current IPV variable of interest
out_ipv = "phy_ipv_sev_12m"

# Define the current list of heterogeneity variables of interest
lst_het_var = c("decile_baseline_ipv", "quartile_baseline_ipv","median_baseline_ipv")

# Creating the data for reg
df_curr <- df_ML_results_final %>%
  filter(type == "baseline", curr_ipv == out_ipv) %>%  # Keep only baseline predictions and  keeps rows of interest.
  dplyr::select(hhid, predicted_val) %>%  # Keep only household ID and predicted IPV at baseline
  distinct(hhid, predicted_val, .keep_all = TRUE) %>% 
  inner_join(
    followup_MRT_hh %>%
      dplyr::select(hhid, !!sym(out_ipv), treatment_pi_pool, 
                    all_of(control_vars), all_of(cluster_vars), 
                    all_of(treatment_vars), reg_hh_csh_mrt, 
                    reg_hh_pi_mrt, village) %>%  
      distinct(.keep_all = TRUE),  # Select some variables
    by = 'hhid',  # Merge on household ID
    multiple = "all"
  )   %>% 
  filter(reg_hh_pi_mrt==1 | reg_hh_csh_mrt==1) 

# Create df_curr1 by filtering households registered for the cash transfer program (reg_hh_csh_mrt == 1)
df_curr1 <- df_curr %>% 
  filter(reg_hh_csh_mrt == 1) %>%  # Keep only cash transfer treatment group
  mutate(
    decile_baseline_ipv = as.factor(ntile(predicted_val, 10)),   # Create decile factor based on predicted IPV at baseline
    quartile_baseline_ipv = as.factor(ntile(predicted_val, 5)),  # Create quartile factor
    median_baseline_ipv = as.factor(ntile(predicted_val, 2))     # Create median (binary high/low) factor
  )

# Create df_curr2 by filtering households registered for the productive inclusion program (reg_hh_pi_mrt == 1)
df_curr2 <- df_curr %>% 
  filter(reg_hh_pi_mrt == 1) %>%  # Keep only productive inclusion treatment group
  mutate(
    decile_baseline_ipv = as.factor(ntile(predicted_val, 10)),   # Create decile factor based on predicted IPV at baseline
    quartile_baseline_ipv = as.factor(ntile(predicted_val, 5)),  # Create quartile factor
    median_baseline_ipv = as.factor(ntile(predicted_val, 2))     # Create median (binary high/low) factor
  )

# Combine the two filtered datasets into a single dataframe (stacking them)
df_curr <- plyr::rbind.fill(df_curr1, df_curr2)  # Use plyr to bind rows even if columns slightly differ

```



#### First plot
```{r}

# Build the plot
df_curr %>%
  filter(!is.na(treatment_pi_pool)) %>% 
  ggplot(aes(
    x = predicted_val,  # X-axis: predicted IPV at baseline
    y = !!sym(out_ipv),  # Y-axis: observed IPV at follow-up
    color = treatment_pi_pool,  # Color lines by treatment group
    fill = treatment_pi_pool # Fill the color of lines by treatment group
  )) + 
  geom_point() + 
  geom_smooth(method = "loess", se = TRUE, alpha = 0.2, level=0.95) +  # Add linear fit with confidence interval
  scale_color_manual(values = c("Pool" = "#FAA43A", "Control" = "#5DA5DA")) +  # Custom line colors
  scale_fill_manual(values =  c("Pool" = "#FAA43A", "Control" = "#5DA5DA")) + # Custom confidence interval
  labs(
    x = "Predicted baseline IPV",  # X-axis label
    y = "IPV at follow-up",        # Y-axis label
    color = "",                    # Remove legend title for color
    caption = "The smooth function a local polynomial regression."  # Add caption to plot
  ) +
  theme_light(base_size = 8) + # Use light theme with base font size 8
  theme(
    legend.position = 'bottom',  # Place legend at bottom
    text = element_text(size = 8),  # General text size
    legend.direction = "horizontal",  # Horizontal layout of legend
    legend.box = "horizontal"        # Group legend items in a single line
  ) +
  guides(fill = "none")

# Save the plot as a JPEG image
ggsave(
  paste0("output/img/", out_ipv, "first_ML_all.jpeg"),
  width = 27, height = 16, units = "cm")
```



#### Second plot

```{r}
# Create a data frame of results examining heterogeneous treatment effects
# across different IPV outcomes, treatment variables, and heterogeneity dimensions
mainResults_het <- map_dfr(out_ipv, function(depvar) {
  
  # For each heterogeneity variable...
  tempResults1 <- map_dfr(lst_het_var, function(het_var) { 
    
    # For each treatment variable...
    tempResults2 <- map_dfr(treatment_vars, function(treat_var) {
      
      bind_rows(
        # Get estimates for heterogeneous treatment effects using the specified model
        getEstimateGlobal_ML_het(depvar, treat_var, het_var, control_vars, strata_vars, cluster_vars, df_curr) %>%
          # Add columns identifying which variables were used in this iteration
          mutate(depvar = depvar, outcome = depvar, treat_var = treat_var, het_var = het_var)
      )
    })
  })
})

# Filter results for the cash transfer program
mainResults_het_cash <- mainResults_het %>%
  filter(name=="cash")

# Filter results for the productive inclusion program
mainResults_het_pi <- mainResults_het %>%
  filter(name=="pi")

# Compute treatment group sizes and proportions for Tekavoul (cash)
mainResults_het_cash <- mainResults_het_cash %>%
  group_by(estimate_quant, het_var) %>%
  mutate(N_treat = sum(Ntype_treat)) %>%  # Total number treated in each heterogeneity group
  ungroup() %>%
  mutate(prop = round(N_treat * 100 / Ntype, 2))  # Proportion of treated out of total group

# Compute treatment group sizes and proportions for PI program, disaggregated by treatment arm
mainResults_het_pi <- mainResults_het_pi %>%
  group_by(estimate_quant, het_var, treat_var) %>%
  mutate(N_treat = sum(Ntype_treat)) %>%  # Total number treated in each subgroup
  ungroup() %>%
  mutate(prop = round(N_treat * 100 / Ntype, 2))  # Proportion of treated in group

# Calculate share within each treatment type
mainResults_het_pi <- mainResults_het_pi %>%
  mutate(prop_per_treat = round(Ntype_treat * 100 / N_treat, 2))

# Recode program names and variable labels for Tekavoul
mainResults_het_cash <- mainResults_het_cash %>%
  mutate(
    name = dplyr::recode(name,
                         cash = "(a) Tekavoul program",
                         pi = "(b) Productive inclusion program"),
    het_var = dplyr::recode(het_var,
                            decile_baseline_ipv = "decile",
                            quartile_baseline_ipv = "quartile",
                            median_baseline_ipv = "median"),
    depvar = dplyr::recode(depvar,
                control_ipv_sev_12m = "Bin. for cntrl IPV in the last 12m",
                control_ipv_sev_index = "Cntrl IPV inten. index z-scr",
                emo_ipv_sev_12m = "Bin. for emo. IPV in the last 12m",
                emo_ipv_sev_index = "Emo. IPV sever. index z-scr",
                phy_ipv_sev_12m = "Bin. for phy. IPV in the last 12m",
                phy_ipv_sev_index = "Phy. IPV sever. index z-scr",
                sex_ipv_sev_12m = "Bin. for sex. IPV in the last 12m",
                sex_ipv_sev_index = "Sex. IPV sever. index z-scr",
                sex_phy_ipv_sev_12m = "Bin. for sex. or phy. IPV in the last 12m",
                sex_phy_ipv_sev_index = "Sex. or phy. IPV sever. index z-scr",
                eco_ipv_sev_12m = "Bin. for eco. IPV in the last 12m",
                eco_ipv_sev_index = "Eco. IPV sever. index z-scr",
                all_ipv_sev_12m = "Bin. for at least one type of IPV (exclud. eco.) in the last 12m",
                all_ipv_sev_index = "All IPV sev. index z-scr")
  )

# Create label text summarizing N and proportion treated for Tekavoul
mainResults_het_cash <- mainResults_het_cash %>%
  group_by(estimate_quant, het_var) %>%
  mutate(
    lab = sprintf(
      "%s %s \n N treat (pct): %s (%s)",
      first(het_var),
      first(estimate_quant),
      scales::comma(first(N_treat)),
      scales::comma(first(prop))
    )
  ) %>%
  ungroup()

# Recode program names and variable labels for PI program
mainResults_het_pi <- mainResults_het_pi %>%
  mutate(
    name = dplyr::recode(name,
                         cash = "(a) Tekavoul program",
                         pi = "(b) Productive inclusion program"),
    het_var = dplyr::recode(het_var,
                            decile_baseline_ipv = "decile",
                            quartile_baseline_ipv = "quartile",
                            median_baseline_ipv = "median"),
    depvar = dplyr::recode(depvar,
                           control_ipv_sev_12m = "Bin. for cntrl IPV in the last 12m",
                           control_ipv_sev_index = "Cntrl IPV inten. index z-scr",
                           emo_ipv_sev_12m = "Bin. for emo. IPV in the last 12m",
                           emo_ipv_sev_12m = "Emo. IPV sever. index z-scr",
                           phy_ipv_sev_12m = "Bin. for phy. IPV in the last 12m",
                           phy_ipv_sev_index = "Phy. IPV sever. index z-scr",
                           sex_ipv_sev_12m = "Bin. for sex. IPV in the last 12m",
                           sex_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           sex_phy_sev_12m = "Bin. for sex. and phy. IPV in the last 12m",
                           sex_phy_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           eco_ipv_sev_12m = "Bin. for eco. IPV in the last 12m",
                           eco_ipv_sev_index = "Eco. IPV sever. index z-scr",
                           all_ipv_sev_12m = "Bin. for at least one type of IPV (exclud. eco.) in the last 12m",
                           all_ipv_sev_index = "All IPV sev. index z-scr")
  )

# Create detailed label with counts and proportions per treatment arm for PI program
mainResults_het_pi <- mainResults_het_pi %>%
  group_by(estimate_quant, het_var) %>%
  mutate(
    lab = sprintf(
      "%s %s \n N treat (pct): %s (%s) \n N Capital (pct): %s (%s) \n N Psychosocial (pct): %s (%s) \n N Full (pct): %s (%s).",
      first(het_var),
      first(estimate_quant),
      scales::comma(first(N_treat)),
      scales::comma(first(prop)),
      scales::comma(first(Ntype_treat)),
      scales::comma(first(prop_per_treat)),
      scales::comma(nth(Ntype_treat, 2)),
      scales::comma(nth(prop_per_treat, 2)),
      scales::comma(nth(Ntype_treat,3)),
      scales::comma(nth(prop_per_treat,3))
    )
  ) %>%
  ungroup()

# Remove redundant prefixes from PI labels
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("decile", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("quartile", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("median", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N treat (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Capital (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Psychosocial (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Full (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)

# Remove redundant prefixes from Tekavoul labels
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("decile", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("quartile", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("median", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1)] <- gsub("N treat (pct): ", "", mainResults_het_cash$lab[-c(1)], fixed = T)

# Convert labels and factor variables to ordered factors for plotting
mainResults_het_cash$lab <- fct_inorder(mainResults_het_cash$lab)
mainResults_het_cash$typeTreat <- fct_inorder(mainResults_het_cash$typeTreat)
mainResults_het_cash$het_var <- fct_inorder(mainResults_het_cash$het_var)
mainResults_het_pi$lab <- fct_inorder(mainResults_het_pi$lab)
mainResults_het_pi$typeTreat <- fct_inorder(mainResults_het_pi$typeTreat)
mainResults_het_pi$het_var <- fct_inorder(mainResults_het_pi$het_var)

# Create plot for Tekavoul program
g1 <- mainResults_het_cash %>%
  ggplot(aes(x = lab, y = pe, shape = typeTreat, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_wrap(~het_var, scales = "free_x", shrink=TRUE, drop=TRUE) +
  labs(
    x = "", y = "Effect",
    subtitle = first(mainResults_het_cash$depvar),
    caption = sprintf("N = %s Tekavoul", first(mainResults_het_cash$N)),
    shape =""
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), legend.direction = "horizontal")

# Save plot for Tekavoul
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_cash$name),"_",first(mainResults_het_cash$depvar),"_ML.jpeg"), g1, width = 27, height = 16, units = "cm")

# Create plot for PI program
g2 <- mainResults_het_pi %>%
  ggplot(aes(x = lab, y = pe, shape = typeTreat, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_wrap(~het_var, scales = "free_x", shrink=TRUE, drop=TRUE) +
  labs(
    x = "", y = "Effect",
    subtitle = first(mainResults_het_pi$depvar),
    caption = sprintf("N = %s productive inclusion", first(mainResults_het_pi$N)),
    shape =""
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), legend.direction = "horizontal")

# Save plot for PI
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_pi$name),"_",first(mainResults_het_pi$depvar),"_ML.jpeg"), g2, width = 27, height = 16, units = "cm")

# Combine the two plots into a single figure
arrange_plot <- ggpubr::ggarrange(g1, g2, common.legend = FALSE, nrow = 2, ncol = 1)

# Printing the plot
arrange_plot

# Save the combined plot
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_cash$het_var),"_",out_ipv,"_ML_estimates.jpeg"), arrange_plot, width = 27, height = 16, units = "cm")

```

### Continuous index in the last 12 months
```{r}
# Define the current IPV variable of interest
out_ipv = "phy_ipv_sev_index"

# Define the current list of heterogeneity variables of interest
lst_het_var = c("decile_baseline_ipv", "quartile_baseline_ipv","median_baseline_ipv")

# Creating the data for reg
df_curr <- df_ML_results_final %>%
  filter(type == "baseline", curr_ipv == out_ipv) %>%  # Keep only baseline predictions and  keeps rows of interest.
  dplyr::select(hhid, predicted_val) %>%  # Keep only household ID and predicted IPV at baseline
  distinct(hhid, predicted_val, .keep_all = TRUE) %>% 
  inner_join(
    followup_MRT_hh %>%
      dplyr::select(hhid, !!sym(out_ipv), treatment_pi_pool, 
                    all_of(control_vars), all_of(cluster_vars), 
                    all_of(treatment_vars), reg_hh_csh_mrt, 
                    reg_hh_pi_mrt, village) %>%  
      distinct(.keep_all = TRUE),  # Select some variables
    by = 'hhid',  # Merge on household ID
    multiple = "all"
  )   %>% 
  filter(reg_hh_pi_mrt==1 | reg_hh_csh_mrt==1) 

# Create df_curr1 by filtering households registered for the cash transfer program (reg_hh_csh_mrt == 1)
df_curr1 <- df_curr %>% 
  filter(reg_hh_csh_mrt == 1) %>%  # Keep only cash transfer treatment group
  mutate(
    decile_baseline_ipv = as.factor(ntile(predicted_val, 10)),   # Create decile factor based on predicted IPV at baseline
    quartile_baseline_ipv = as.factor(ntile(predicted_val, 5)),  # Create quartile factor
    median_baseline_ipv = as.factor(ntile(predicted_val, 2))     # Create median (binary high/low) factor
  )

# Create df_curr2 by filtering households registered for the productive inclusion program (reg_hh_pi_mrt == 1)
df_curr2 <- df_curr %>% 
  filter(reg_hh_pi_mrt == 1) %>%  # Keep only productive inclusion treatment group
  mutate(
    decile_baseline_ipv = as.factor(ntile(predicted_val, 10)),   # Create decile factor based on predicted IPV at baseline
    quartile_baseline_ipv = as.factor(ntile(predicted_val, 5)),  # Create quartile factor
    median_baseline_ipv = as.factor(ntile(predicted_val, 2))     # Create median (binary high/low) factor
  )

# Combine the two filtered datasets into a single dataframe (stacking them)
df_curr <- plyr::rbind.fill(df_curr1, df_curr2)  # Use plyr to bind rows even if columns slightly differ
```



#### First plot
```{r}

# Build the plot
df_curr %>%
  filter(!is.na(treatment_pi_pool)) %>% 
  ggplot(aes(
    x = predicted_val,  # X-axis: predicted IPV at baseline
    y = !!sym(out_ipv),  # Y-axis: observed IPV at follow-up
    color = treatment_pi_pool,  # Color lines by treatment group
    fill = treatment_pi_pool # Fill the color of lines by treatment group
  )) + 
  geom_point() + 
  geom_smooth(method = "loess", se = TRUE, alpha = 0.2, level=0.95) +  # Add linear fit with confidence interval
  scale_color_manual(values = c("Pool" = "#FAA43A", "Control" = "#5DA5DA")) +  # Custom line colors
  scale_fill_manual(values =  c("Pool" = "#FAA43A", "Control" = "#5DA5DA")) + # Custom confidence interval
  labs(
    x = "Predicted baseline IPV",  # X-axis label
    y = "IPV at follow-up",        # Y-axis label
    color = "",                    # Remove legend title for color
    caption = "The smooth function a local polynomial regression."  # Add caption to plot
  ) +
  theme_light(base_size = 8) + # Use light theme with base font size 8
  theme(
    legend.position = 'bottom',  # Place legend at bottom
    text = element_text(size = 8),  # General text size
    legend.direction = "horizontal",  # Horizontal layout of legend
    legend.box = "horizontal"        # Group legend items in a single line
  ) +
  guides(fill = "none")

# Save the plot as a JPEG image
ggsave(
  paste0("output/img/", out_ipv, "first_ML_all.jpeg"),
  width = 27, height = 16, units = "cm")
```



#### Second plot

```{r}
# Create a data frame of results examining heterogeneous treatment effects
# across different IPV outcomes, treatment variables, and heterogeneity dimensions
mainResults_het <- map_dfr(out_ipv, function(depvar) {
  
  # For each heterogeneity variable...
  tempResults1 <- map_dfr(lst_het_var, function(het_var) { 
    
    # For each treatment variable...
    tempResults2 <- map_dfr(treatment_vars, function(treat_var) {
      
      bind_rows(
        # Get estimates for heterogeneous treatment effects using the specified model
        getEstimateGlobal_ML_het(depvar, treat_var, het_var, control_vars, strata_vars, cluster_vars, df_curr) %>%
          # Add columns identifying which variables were used in this iteration
          mutate(depvar = depvar, outcome = depvar, treat_var = treat_var, het_var = het_var)
      )
    })
  })
})

# Filter results for the cash transfer program
mainResults_het_cash <- mainResults_het %>%
  filter(name=="cash")

# Filter results for the productive inclusion program
mainResults_het_pi <- mainResults_het %>%
  filter(name=="pi")

# Compute treatment group sizes and proportions for Tekavoul (cash)
mainResults_het_cash <- mainResults_het_cash %>%
  group_by(estimate_quant, het_var) %>%
  mutate(N_treat = sum(Ntype_treat)) %>%  # Total number treated in each heterogeneity group
  ungroup() %>%
  mutate(prop = round(N_treat * 100 / Ntype, 2))  # Proportion of treated out of total group

# Compute treatment group sizes and proportions for PI program, disaggregated by treatment arm
mainResults_het_pi <- mainResults_het_pi %>%
  group_by(estimate_quant, het_var, treat_var) %>%
  mutate(N_treat = sum(Ntype_treat)) %>%  # Total number treated in each subgroup
  ungroup() %>%
  mutate(prop = round(N_treat * 100 / Ntype, 2))  # Proportion of treated in group

# Calculate share within each treatment type
mainResults_het_pi <- mainResults_het_pi %>%
  mutate(prop_per_treat = round(Ntype_treat * 100 / N_treat, 2))

# Recode program names and variable labels for Tekavoul
mainResults_het_cash <- mainResults_het_cash %>%
  mutate(
    name = dplyr::recode(name,
                         cash = "(a) Tekavoul program",
                         pi = "(b) Productive inclusion program"),
    het_var = dplyr::recode(het_var,
                            decile_baseline_ipv = "decile",
                            quartile_baseline_ipv = "quartile",
                            median_baseline_ipv = "median"),
    depvar = dplyr::recode(depvar,
                           control_ipv_sev_12m = "Bin. for cntrl IPV in the last 12m",
                           control_ipv_sev_index = "Cntrl IPV inten. index z-scr",
                           emo_ipv_sev_12m = "Bin. for emo. IPV in the last 12m",
                           emo_ipv_sev_12m = "Emo. IPV sever. index z-scr",
                           phy_ipv_sev_12m = "Bin. for phy. IPV in the last 12m",
                           phy_ipv_sev_index = "Phy. IPV sever. index z-scr",
                           sex_ipv_sev_12m = "Bin. for sex. IPV in the last 12m",
                           sex_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           sex_phy_sev_12m = "Bin. for sex. and phy. IPV in the last 12m",
                           sex_phy_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           eco_ipv_sev_12m = "Bin. for eco. IPV in the last 12m",
                           eco_ipv_sev_index = "Eco. IPV sever. index z-scr",
                           all_ipv_sev_12m = "Bin. for at least one type of IPV (exclud. eco.) in the last 12m",
                           all_ipv_sev_index = "All IPV sev. index z-scr")
  )

# Create label text summarizing N and proportion treated for Tekavoul
mainResults_het_cash <- mainResults_het_cash %>%
  group_by(estimate_quant, het_var) %>%
  mutate(
    lab = sprintf(
      "%s %s \n N treat (pct): %s (%s)",
      first(het_var),
      first(estimate_quant),
      scales::comma(first(N_treat)),
      scales::comma(first(prop))
    )
  ) %>%
  ungroup()

# Recode program names and variable labels for PI program
mainResults_het_pi <- mainResults_het_pi %>%
  mutate(
    name = dplyr::recode(name,
                         cash = "(a) Tekavoul program",
                         pi = "(b) Productive inclusion program"),
    het_var = dplyr::recode(het_var,
                            decile_baseline_ipv = "decile",
                            quartile_baseline_ipv = "quartile",
                            median_baseline_ipv = "median"),
    depvar = dplyr::recode(depvar,
                           control_ipv_sev_12m = "Bin. for cntrl IPV in the last 12m",
                           control_ipv_sev_index = "Cntrl IPV inten. index z-scr",
                           emo_ipv_sev_12m = "Bin. for emo. IPV in the last 12m",
                           emo_ipv_sev_12m = "Emo. IPV sever. index z-scr",
                           phy_ipv_sev_12m = "Bin. for phy. IPV in the last 12m",
                           phy_ipv_sev_index = "Phy. IPV sever. index z-scr",
                           sex_ipv_sev_12m = "Bin. for sex. IPV in the last 12m",
                           sex_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           sex_phy_sev_12m = "Bin. for sex. and phy. IPV in the last 12m",
                           sex_phy_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           eco_ipv_sev_12m = "Bin. for eco. IPV in the last 12m",
                           eco_ipv_sev_index = "Eco. IPV sever. index z-scr",
                           all_ipv_sev_12m = "Bin. for at least one type of IPV (exclud. eco.) in the last 12m",
                           all_ipv_sev_index = "All IPV sev. index z-scr")
  )

# Create detailed label with counts and proportions per treatment arm for PI program
mainResults_het_pi <- mainResults_het_pi %>%
  group_by(estimate_quant, het_var) %>%
  mutate(
    lab = sprintf(
      "%s %s \n N treat (pct): %s (%s) \n N Capital (pct): %s (%s) \n N Psychosocial (pct): %s (%s) \n N Full (pct): %s (%s).",
      first(het_var),
      first(estimate_quant),
      scales::comma(first(N_treat)),
      scales::comma(first(prop)),
      scales::comma(first(Ntype_treat)),
      scales::comma(first(prop_per_treat)),
      scales::comma(nth(Ntype_treat, 2)),
      scales::comma(nth(prop_per_treat, 2)),
      scales::comma(nth(Ntype_treat,3)),
      scales::comma(nth(prop_per_treat,3))
    )
  ) %>%
  ungroup()

# Remove redundant prefixes from PI labels
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("decile", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("quartile", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("median", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N treat (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Capital (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Psychosocial (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Full (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)

# Remove redundant prefixes from Tekavoul labels
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("decile", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("quartile", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("median", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1)] <- gsub("N treat (pct): ", "", mainResults_het_cash$lab[-c(1)], fixed = T)

# Convert labels and factor variables to ordered factors for plotting
mainResults_het_cash$lab <- fct_inorder(mainResults_het_cash$lab)
mainResults_het_cash$typeTreat <- fct_inorder(mainResults_het_cash$typeTreat)
mainResults_het_cash$het_var <- fct_inorder(mainResults_het_cash$het_var)
mainResults_het_pi$lab <- fct_inorder(mainResults_het_pi$lab)
mainResults_het_pi$typeTreat <- fct_inorder(mainResults_het_pi$typeTreat)
mainResults_het_pi$het_var <- fct_inorder(mainResults_het_pi$het_var)

# Create plot for Tekavoul program
g1 <- mainResults_het_cash %>%
  ggplot(aes(x = lab, y = pe, shape = typeTreat, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_wrap(~het_var, scales = "free_x", shrink=TRUE, drop=TRUE) +
  labs(
    x = "", y = "Effect",
    subtitle = first(mainResults_het_cash$depvar),
    caption = sprintf("N = %s Tekavoul", first(mainResults_het_cash$N)),
    shape =""
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), legend.direction = "horizontal")

# Save plot for Tekavoul
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_cash$name),"_",first(mainResults_het_cash$depvar),"_ML.jpeg"), g1, width = 27, height = 16, units = "cm")

# Create plot for PI program
g2 <- mainResults_het_pi %>%
  ggplot(aes(x = lab, y = pe, shape = typeTreat, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_wrap(~het_var, scales = "free_x", shrink=TRUE, drop=TRUE) +
  labs(
    x = "", y = "Effect",
    subtitle = first(mainResults_het_pi$depvar),
    caption = sprintf("N = %s productive inclusion", first(mainResults_het_pi$N)),
    shape =""
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), legend.direction = "horizontal")

# Save plot for PI
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_pi$name),"_",first(mainResults_het_pi$depvar),"_ML.jpeg"), g2, width = 27, height = 16, units = "cm")

# Combine the two plots into a single figure
arrange_plot <- ggpubr::ggarrange(g1, g2, common.legend = FALSE, nrow = 2, ncol = 1)

# Printing the plot
arrange_plot

# Save the combined plot
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_cash$het_var),"_",out_ipv,"_ML_estimates.jpeg"), arrange_plot, width = 27, height = 16, units = "cm")

```

## Sexual violence
### Binary for the last 12 months
```{r}
# Define the current IPV variable of interest
out_ipv = "sex_ipv_sev_12m"

# Define the current list of heterogeneity variables of interest
lst_het_var = c("decile_baseline_ipv", "quartile_baseline_ipv","median_baseline_ipv")

# Creating the data for reg
df_curr <- df_ML_results_final %>%
  filter(type == "baseline", curr_ipv == out_ipv) %>%  # Keep only baseline predictions and  keeps rows of interest.
  dplyr::select(hhid, predicted_val) %>%  # Keep only household ID and predicted IPV at baseline
  distinct(hhid, predicted_val, .keep_all = TRUE) %>% 
  inner_join(
    followup_MRT_hh %>%
      dplyr::select(hhid, !!sym(out_ipv), treatment_pi_pool, 
                    all_of(control_vars), all_of(cluster_vars), 
                    all_of(treatment_vars), reg_hh_csh_mrt, 
                    reg_hh_pi_mrt, village) %>%  
      distinct(.keep_all = TRUE),  # Select some variables
    by = 'hhid',  # Merge on household ID
    multiple = "all"
  )   %>% 
  filter(reg_hh_pi_mrt==1 | reg_hh_csh_mrt==1) 

# Create df_curr1 by filtering households registered for the cash transfer program (reg_hh_csh_mrt == 1)
df_curr1 <- df_curr %>% 
  filter(reg_hh_csh_mrt == 1) %>%  # Keep only cash transfer treatment group
  mutate(
    decile_baseline_ipv = as.factor(ntile(predicted_val, 10)),   # Create decile factor based on predicted IPV at baseline
    quartile_baseline_ipv = as.factor(ntile(predicted_val, 5)),  # Create quartile factor
    median_baseline_ipv = as.factor(ntile(predicted_val, 2))     # Create median (binary high/low) factor
  )

# Create df_curr2 by filtering households registered for the productive inclusion program (reg_hh_pi_mrt == 1)
df_curr2 <- df_curr %>% 
  filter(reg_hh_pi_mrt == 1) %>%  # Keep only productive inclusion treatment group
  mutate(
    decile_baseline_ipv = as.factor(ntile(predicted_val, 10)),   # Create decile factor based on predicted IPV at baseline
    quartile_baseline_ipv = as.factor(ntile(predicted_val, 5)),  # Create quartile factor
    median_baseline_ipv = as.factor(ntile(predicted_val, 2))     # Create median (binary high/low) factor
  )

# Combine the two filtered datasets into a single dataframe (stacking them)
df_curr <- plyr::rbind.fill(df_curr1, df_curr2)  # Use plyr to bind rows even if columns slightly differ
```



#### First plot
```{r}

# Build the plot
df_curr %>%
  filter(!is.na(treatment_pi_pool)) %>% 
  ggplot(aes(
    x = predicted_val,  # X-axis: predicted IPV at baseline
    y = !!sym(out_ipv),  # Y-axis: observed IPV at follow-up
    color = treatment_pi_pool,  # Color lines by treatment group
    fill = treatment_pi_pool # Fill the color of lines by treatment group
  )) + 
  geom_point() + 
  geom_smooth(method = "loess", se = TRUE, alpha = 0.2, level=0.95) +  # Add linear fit with confidence interval
  scale_color_manual(values = c("Pool" = "#FAA43A", "Control" = "#5DA5DA")) +  # Custom line colors
  scale_fill_manual(values =  c("Pool" = "#FAA43A", "Control" = "#5DA5DA")) + # Custom confidence interval
  labs(
    x = "Predicted baseline IPV",  # X-axis label
    y = "IPV at follow-up",        # Y-axis label
    color = "",                    # Remove legend title for color
    caption = "The smooth function a local polynomial regression."  # Add caption to plot
  ) +
  theme_light(base_size = 8) + # Use light theme with base font size 8
  theme(
    legend.position = 'bottom',  # Place legend at bottom
    text = element_text(size = 8),  # General text size
    legend.direction = "horizontal",  # Horizontal layout of legend
    legend.box = "horizontal"        # Group legend items in a single line
  ) +
  guides(fill = "none")

# Save the plot as a JPEG image
ggsave(
  paste0("output/img/", out_ipv, "first_ML_all.jpeg"),
  width = 27, height = 16, units = "cm")
```



#### Second plot

```{r}
# Create a data frame of results examining heterogeneous treatment effects
# across different IPV outcomes, treatment variables, and heterogeneity dimensions
mainResults_het <- map_dfr(out_ipv, function(depvar) {
  
  # For each heterogeneity variable...
  tempResults1 <- map_dfr(lst_het_var, function(het_var) { 
    
    # For each treatment variable...
    tempResults2 <- map_dfr(treatment_vars, function(treat_var) {
      
      bind_rows(
        # Get estimates for heterogeneous treatment effects using the specified model
        getEstimateGlobal_ML_het(depvar, treat_var, het_var, control_vars, strata_vars, cluster_vars, df_curr) %>%
          # Add columns identifying which variables were used in this iteration
          mutate(depvar = depvar, outcome = depvar, treat_var = treat_var, het_var = het_var)
      )
    })
  })
})

# Filter results for the cash transfer program
mainResults_het_cash <- mainResults_het %>%
  filter(name=="cash")

# Filter results for the productive inclusion program
mainResults_het_pi <- mainResults_het %>%
  filter(name=="pi")

# Compute treatment group sizes and proportions for Tekavoul (cash)
mainResults_het_cash <- mainResults_het_cash %>%
  group_by(estimate_quant, het_var) %>%
  mutate(N_treat = sum(Ntype_treat)) %>%  # Total number treated in each heterogeneity group
  ungroup() %>%
  mutate(prop = round(N_treat * 100 / Ntype, 2))  # Proportion of treated out of total group

# Compute treatment group sizes and proportions for PI program, disaggregated by treatment arm
mainResults_het_pi <- mainResults_het_pi %>%
  group_by(estimate_quant, het_var, treat_var) %>%
  mutate(N_treat = sum(Ntype_treat)) %>%  # Total number treated in each subgroup
  ungroup() %>%
  mutate(prop = round(N_treat * 100 / Ntype, 2))  # Proportion of treated in group

# Calculate share within each treatment type
mainResults_het_pi <- mainResults_het_pi %>%
  mutate(prop_per_treat = round(Ntype_treat * 100 / N_treat, 2))

# Recode program names and variable labels for Tekavoul
mainResults_het_cash <- mainResults_het_cash %>%
  mutate(
    name = dplyr::recode(name,
                         cash = "(a) Tekavoul program",
                         pi = "(b) Productive inclusion program"),
    het_var = dplyr::recode(het_var,
                            decile_baseline_ipv = "decile",
                            quartile_baseline_ipv = "quartile",
                            median_baseline_ipv = "median"),
    depvar = dplyr::recode(depvar,
                           control_ipv_sev_12m = "Bin. for cntrl IPV in the last 12m",
                           control_ipv_sev_index = "Cntrl IPV inten. index z-scr",
                           emo_ipv_sev_12m = "Bin. for emo. IPV in the last 12m",
                           emo_ipv_sev_12m = "Emo. IPV sever. index z-scr",
                           phy_ipv_sev_12m = "Bin. for phy. IPV in the last 12m",
                           phy_ipv_sev_index = "Phy. IPV sever. index z-scr",
                           sex_ipv_sev_12m = "Bin. for sex. IPV in the last 12m",
                           sex_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           sex_phy_sev_12m = "Bin. for sex. and phy. IPV in the last 12m",
                           sex_phy_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           eco_ipv_sev_12m = "Bin. for eco. IPV in the last 12m",
                           eco_ipv_sev_index = "Eco. IPV sever. index z-scr",
                           all_ipv_sev_12m = "Bin. for at least one type of IPV (exclud. eco.) in the last 12m",
                           all_ipv_sev_index = "All IPV sev. index z-scr")
  )

# Create label text summarizing N and proportion treated for Tekavoul
mainResults_het_cash <- mainResults_het_cash %>%
  group_by(estimate_quant, het_var) %>%
  mutate(
    lab = sprintf(
      "%s %s \n N treat (pct): %s (%s)",
      first(het_var),
      first(estimate_quant),
      scales::comma(first(N_treat)),
      scales::comma(first(prop))
    )
  ) %>%
  ungroup()

# Recode program names and variable labels for PI program
mainResults_het_pi <- mainResults_het_pi %>%
  mutate(
    name = dplyr::recode(name,
                         cash = "(a) Tekavoul program",
                         pi = "(b) Productive inclusion program"),
    het_var = dplyr::recode(het_var,
                            decile_baseline_ipv = "decile",
                            quartile_baseline_ipv = "quartile",
                            median_baseline_ipv = "median"),
    depvar = dplyr::recode(depvar,
                           control_ipv_sev_12m = "Bin. for cntrl IPV in the last 12m",
                           control_ipv_sev_index = "Cntrl IPV inten. index z-scr",
                           emo_ipv_sev_12m = "Bin. for emo. IPV in the last 12m",
                           emo_ipv_sev_12m = "Emo. IPV sever. index z-scr",
                           phy_ipv_sev_12m = "Bin. for phy. IPV in the last 12m",
                           phy_ipv_sev_index = "Phy. IPV sever. index z-scr",
                           sex_ipv_sev_12m = "Bin. for sex. IPV in the last 12m",
                           sex_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           sex_phy_sev_12m = "Bin. for sex. and phy. IPV in the last 12m",
                           sex_phy_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           eco_ipv_sev_12m = "Bin. for eco. IPV in the last 12m",
                           eco_ipv_sev_index = "Eco. IPV sever. index z-scr",
                           all_ipv_sev_12m = "Bin. for at least one type of IPV (exclud. eco.) in the last 12m",
                           all_ipv_sev_index = "All IPV sev. index z-scr")
  )

# Create detailed label with counts and proportions per treatment arm for PI program
mainResults_het_pi <- mainResults_het_pi %>%
  group_by(estimate_quant, het_var) %>%
  mutate(
    lab = sprintf(
      "%s %s \n N treat (pct): %s (%s) \n N Capital (pct): %s (%s) \n N Psychosocial (pct): %s (%s) \n N Full (pct): %s (%s).",
      first(het_var),
      first(estimate_quant),
      scales::comma(first(N_treat)),
      scales::comma(first(prop)),
      scales::comma(first(Ntype_treat)),
      scales::comma(first(prop_per_treat)),
      scales::comma(nth(Ntype_treat, 2)),
      scales::comma(nth(prop_per_treat, 2)),
      scales::comma(nth(Ntype_treat,3)),
      scales::comma(nth(prop_per_treat,3))
    )
  ) %>%
  ungroup()

# Remove redundant prefixes from PI labels
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("decile", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("quartile", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("median", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N treat (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Capital (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Psychosocial (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Full (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)

# Remove redundant prefixes from Tekavoul labels
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("decile", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("quartile", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("median", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1)] <- gsub("N treat (pct): ", "", mainResults_het_cash$lab[-c(1)], fixed = T)

# Convert labels and factor variables to ordered factors for plotting
mainResults_het_cash$lab <- fct_inorder(mainResults_het_cash$lab)
mainResults_het_cash$typeTreat <- fct_inorder(mainResults_het_cash$typeTreat)
mainResults_het_cash$het_var <- fct_inorder(mainResults_het_cash$het_var)
mainResults_het_pi$lab <- fct_inorder(mainResults_het_pi$lab)
mainResults_het_pi$typeTreat <- fct_inorder(mainResults_het_pi$typeTreat)
mainResults_het_pi$het_var <- fct_inorder(mainResults_het_pi$het_var)

# Create plot for Tekavoul program
g1 <- mainResults_het_cash %>%
  ggplot(aes(x = lab, y = pe, shape = typeTreat, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_wrap(~het_var, scales = "free_x", shrink=TRUE, drop=TRUE) +
  labs(
    x = "", y = "Effect",
    subtitle = first(mainResults_het_cash$depvar),
    caption = sprintf("N = %s Tekavoul", first(mainResults_het_cash$N)),
    shape =""
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), legend.direction = "horizontal")

# Save plot for Tekavoul
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_cash$name),"_",first(mainResults_het_cash$depvar),"_ML.jpeg"), g1, width = 27, height = 16, units = "cm")

# Create plot for PI program
g2 <- mainResults_het_pi %>%
  ggplot(aes(x = lab, y = pe, shape = typeTreat, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_wrap(~het_var, scales = "free_x", shrink=TRUE, drop=TRUE) +
  labs(
    x = "", y = "Effect",
    subtitle = first(mainResults_het_pi$depvar),
    caption = sprintf("N = %s productive inclusion", first(mainResults_het_pi$N)),
    shape =""
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), legend.direction = "horizontal")

# Save plot for PI
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_pi$name),"_",first(mainResults_het_pi$depvar),"_ML.jpeg"), g2, width = 27, height = 16, units = "cm")

# Combine the two plots into a single figure
arrange_plot <- ggpubr::ggarrange(g1, g2, common.legend = FALSE, nrow = 2, ncol = 1)

# Printing the plot
arrange_plot

# Save the combined plot
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_cash$het_var),"_",out_ipv,"_ML_estimates.jpeg"), arrange_plot, width = 27, height = 16, units = "cm")

```

### Continuous index in the last 12 months
```{r}
# Define the current IPV variable of interest
out_ipv = "sex_ipv_sev_index"

# Define the current list of heterogeneity variables of interest
lst_het_var = c("decile_baseline_ipv", "quartile_baseline_ipv","median_baseline_ipv")

# Creating the data for reg
df_curr <- df_ML_results_final %>%
  filter(type == "baseline", curr_ipv == out_ipv) %>%  # Keep only baseline predictions and  keeps rows of interest.
  dplyr::select(hhid, predicted_val) %>%  # Keep only household ID and predicted IPV at baseline
  distinct(hhid, predicted_val, .keep_all = TRUE) %>% 
  inner_join(
    followup_MRT_hh %>%
      dplyr::select(hhid, !!sym(out_ipv), treatment_pi_pool, 
                    all_of(control_vars), all_of(cluster_vars), 
                    all_of(treatment_vars), reg_hh_csh_mrt, 
                    reg_hh_pi_mrt, village) %>%  
      distinct(.keep_all = TRUE),  # Select some variables
    by = 'hhid',  # Merge on household ID
    multiple = "all"
  )   %>% 
  filter(reg_hh_pi_mrt==1 | reg_hh_csh_mrt==1) 

# Create df_curr1 by filtering households registered for the cash transfer program (reg_hh_csh_mrt == 1)
df_curr1 <- df_curr %>% 
  filter(reg_hh_csh_mrt == 1) %>%  # Keep only cash transfer treatment group
  mutate(
    decile_baseline_ipv = as.factor(ntile(predicted_val, 10)),   # Create decile factor based on predicted IPV at baseline
    quartile_baseline_ipv = as.factor(ntile(predicted_val, 5)),  # Create quartile factor
    median_baseline_ipv = as.factor(ntile(predicted_val, 2))     # Create median (binary high/low) factor
  )

# Create df_curr2 by filtering households registered for the productive inclusion program (reg_hh_pi_mrt == 1)
df_curr2 <- df_curr %>% 
  filter(reg_hh_pi_mrt == 1) %>%  # Keep only productive inclusion treatment group
  mutate(
    decile_baseline_ipv = as.factor(ntile(predicted_val, 10)),   # Create decile factor based on predicted IPV at baseline
    quartile_baseline_ipv = as.factor(ntile(predicted_val, 5)),  # Create quartile factor
    median_baseline_ipv = as.factor(ntile(predicted_val, 2))     # Create median (binary high/low) factor
  )

# Combine the two filtered datasets into a single dataframe (stacking them)
df_curr <- plyr::rbind.fill(df_curr1, df_curr2)  # Use plyr to bind rows even if columns slightly differ

```



#### First plot
```{r}

# Build the plot
df_curr %>%
  filter(!is.na(treatment_pi_pool)) %>% 
  ggplot(aes(
    x = predicted_val,  # X-axis: predicted IPV at baseline
    y = !!sym(out_ipv),  # Y-axis: observed IPV at follow-up
    color = treatment_pi_pool,  # Color lines by treatment group
    fill = treatment_pi_pool # Fill the color of lines by treatment group
  )) + 
  geom_point() + 
  geom_smooth(method = "loess", se = TRUE, alpha = 0.2, level=0.95) +  # Add linear fit with confidence interval
  scale_color_manual(values = c("Pool" = "#FAA43A", "Control" = "#5DA5DA")) +  # Custom line colors
  scale_fill_manual(values =  c("Pool" = "#FAA43A", "Control" = "#5DA5DA")) + # Custom confidence interval
  labs(
    x = "Predicted baseline IPV",  # X-axis label
    y = "IPV at follow-up",        # Y-axis label
    color = "",                    # Remove legend title for color
    caption = "The smooth function a local polynomial regression."  # Add caption to plot
  ) +
  theme_light(base_size = 8) + # Use light theme with base font size 8
  theme(
    legend.position = 'bottom',  # Place legend at bottom
    text = element_text(size = 8),  # General text size
    legend.direction = "horizontal",  # Horizontal layout of legend
    legend.box = "horizontal"        # Group legend items in a single line
  ) +
  guides(fill = "none")

# Save the plot as a JPEG image
ggsave(
  paste0("output/img/", out_ipv, "first_ML_all.jpeg"),
  width = 27, height = 16, units = "cm")
```



#### Second plot

```{r}
# Create a data frame of results examining heterogeneous treatment effects
# across different IPV outcomes, treatment variables, and heterogeneity dimensions
mainResults_het <- map_dfr(out_ipv, function(depvar) {
  
  # For each heterogeneity variable...
  tempResults1 <- map_dfr(lst_het_var, function(het_var) { 
    
    # For each treatment variable...
    tempResults2 <- map_dfr(treatment_vars, function(treat_var) {
      
      bind_rows(
        # Get estimates for heterogeneous treatment effects using the specified model
        getEstimateGlobal_ML_het(depvar, treat_var, het_var, control_vars, strata_vars, cluster_vars, df_curr) %>%
          # Add columns identifying which variables were used in this iteration
          mutate(depvar = depvar, outcome = depvar, treat_var = treat_var, het_var = het_var)
      )
    })
  })
})

# Filter results for the cash transfer program
mainResults_het_cash <- mainResults_het %>%
  filter(name=="cash")

# Filter results for the productive inclusion program
mainResults_het_pi <- mainResults_het %>%
  filter(name=="pi")

# Compute treatment group sizes and proportions for Tekavoul (cash)
mainResults_het_cash <- mainResults_het_cash %>%
  group_by(estimate_quant, het_var) %>%
  mutate(N_treat = sum(Ntype_treat)) %>%  # Total number treated in each heterogeneity group
  ungroup() %>%
  mutate(prop = round(N_treat * 100 / Ntype, 2))  # Proportion of treated out of total group

# Compute treatment group sizes and proportions for PI program, disaggregated by treatment arm
mainResults_het_pi <- mainResults_het_pi %>%
  group_by(estimate_quant, het_var, treat_var) %>%
  mutate(N_treat = sum(Ntype_treat)) %>%  # Total number treated in each subgroup
  ungroup() %>%
  mutate(prop = round(N_treat * 100 / Ntype, 2))  # Proportion of treated in group

# Calculate share within each treatment type
mainResults_het_pi <- mainResults_het_pi %>%
  mutate(prop_per_treat = round(Ntype_treat * 100 / N_treat, 2))

# Recode program names and variable labels for Tekavoul
mainResults_het_cash <- mainResults_het_cash %>%
  mutate(
    name = dplyr::recode(name,
                         cash = "(a) Tekavoul program",
                         pi = "(b) Productive inclusion program"),
    het_var = dplyr::recode(het_var,
                            decile_baseline_ipv = "decile",
                            quartile_baseline_ipv = "quartile",
                            median_baseline_ipv = "median"),
    depvar = dplyr::recode(depvar,
                           control_ipv_sev_12m = "Bin. for cntrl IPV in the last 12m",
                           control_ipv_sev_index = "Cntrl IPV inten. index z-scr",
                           emo_ipv_sev_12m = "Bin. for emo. IPV in the last 12m",
                           emo_ipv_sev_12m = "Emo. IPV sever. index z-scr",
                           phy_ipv_sev_12m = "Bin. for phy. IPV in the last 12m",
                           phy_ipv_sev_index = "Phy. IPV sever. index z-scr",
                           sex_ipv_sev_12m = "Bin. for sex. IPV in the last 12m",
                           sex_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           sex_phy_sev_12m = "Bin. for sex. and phy. IPV in the last 12m",
                           sex_phy_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           eco_ipv_sev_12m = "Bin. for eco. IPV in the last 12m",
                           eco_ipv_sev_index = "Eco. IPV sever. index z-scr",
                           all_ipv_sev_12m = "Bin. for at least one type of IPV (exclud. eco.) in the last 12m",
                           all_ipv_sev_index = "All IPV sev. index z-scr")
  )

# Create label text summarizing N and proportion treated for Tekavoul
mainResults_het_cash <- mainResults_het_cash %>%
  group_by(estimate_quant, het_var) %>%
  mutate(
    lab = sprintf(
      "%s %s \n N treat (pct): %s (%s)",
      first(het_var),
      first(estimate_quant),
      scales::comma(first(N_treat)),
      scales::comma(first(prop))
    )
  ) %>%
  ungroup()

# Recode program names and variable labels for PI program
mainResults_het_pi <- mainResults_het_pi %>%
  mutate(
    name = dplyr::recode(name,
                         cash = "(a) Tekavoul program",
                         pi = "(b) Productive inclusion program"),
    het_var = dplyr::recode(het_var,
                            decile_baseline_ipv = "decile",
                            quartile_baseline_ipv = "quartile",
                            median_baseline_ipv = "median"),
    depvar = dplyr::recode(depvar,
                           control_ipv_sev_12m = "Bin. for cntrl IPV in the last 12m",
                           control_ipv_sev_index = "Cntrl IPV inten. index z-scr",
                           emo_ipv_sev_12m = "Bin. for emo. IPV in the last 12m",
                           emo_ipv_sev_12m = "Emo. IPV sever. index z-scr",
                           phy_ipv_sev_12m = "Bin. for phy. IPV in the last 12m",
                           phy_ipv_sev_index = "Phy. IPV sever. index z-scr",
                           sex_ipv_sev_12m = "Bin. for sex. IPV in the last 12m",
                           sex_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           sex_phy_sev_12m = "Bin. for sex. and phy. IPV in the last 12m",
                           sex_phy_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           eco_ipv_sev_12m = "Bin. for eco. IPV in the last 12m",
                           eco_ipv_sev_index = "Eco. IPV sever. index z-scr",
                           all_ipv_sev_12m = "Bin. for at least one type of IPV (exclud. eco.) in the last 12m",
                           all_ipv_sev_index = "All IPV sev. index z-scr")
  )

# Create detailed label with counts and proportions per treatment arm for PI program
mainResults_het_pi <- mainResults_het_pi %>%
  group_by(estimate_quant, het_var) %>%
  mutate(
    lab = sprintf(
      "%s %s \n N treat (pct): %s (%s) \n N Capital (pct): %s (%s) \n N Psychosocial (pct): %s (%s) \n N Full (pct): %s (%s).",
      first(het_var),
      first(estimate_quant),
      scales::comma(first(N_treat)),
      scales::comma(first(prop)),
      scales::comma(first(Ntype_treat)),
      scales::comma(first(prop_per_treat)),
      scales::comma(nth(Ntype_treat, 2)),
      scales::comma(nth(prop_per_treat, 2)),
      scales::comma(nth(Ntype_treat,3)),
      scales::comma(nth(prop_per_treat,3))
    )
  ) %>%
  ungroup()

# Remove redundant prefixes from PI labels
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("decile", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("quartile", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("median", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N treat (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Capital (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Psychosocial (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Full (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)

# Remove redundant prefixes from Tekavoul labels
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("decile", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("quartile", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("median", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1)] <- gsub("N treat (pct): ", "", mainResults_het_cash$lab[-c(1)], fixed = T)

# Convert labels and factor variables to ordered factors for plotting
mainResults_het_cash$lab <- fct_inorder(mainResults_het_cash$lab)
mainResults_het_cash$typeTreat <- fct_inorder(mainResults_het_cash$typeTreat)
mainResults_het_cash$het_var <- fct_inorder(mainResults_het_cash$het_var)
mainResults_het_pi$lab <- fct_inorder(mainResults_het_pi$lab)
mainResults_het_pi$typeTreat <- fct_inorder(mainResults_het_pi$typeTreat)
mainResults_het_pi$het_var <- fct_inorder(mainResults_het_pi$het_var)

# Create plot for Tekavoul program
g1 <- mainResults_het_cash %>%
  ggplot(aes(x = lab, y = pe, shape = typeTreat, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_wrap(~het_var, scales = "free_x", shrink=TRUE, drop=TRUE) +
  labs(
    x = "", y = "Effect",
    subtitle = first(mainResults_het_cash$depvar),
    caption = sprintf("N = %s Tekavoul", first(mainResults_het_cash$N)),
    shape =""
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), legend.direction = "horizontal")

# Save plot for Tekavoul
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_cash$name),"_",first(mainResults_het_cash$depvar),"_ML.jpeg"), g1, width = 27, height = 16, units = "cm")

# Create plot for PI program
g2 <- mainResults_het_pi %>%
  ggplot(aes(x = lab, y = pe, shape = typeTreat, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_wrap(~het_var, scales = "free_x", shrink=TRUE, drop=TRUE) +
  labs(
    x = "", y = "Effect",
    subtitle = first(mainResults_het_pi$depvar),
    caption = sprintf("N = %s productive inclusion", first(mainResults_het_pi$N)),
    shape =""
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), legend.direction = "horizontal")

# Save plot for PI
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_pi$name),"_",first(mainResults_het_pi$depvar),"_ML.jpeg"), g2, width = 27, height = 16, units = "cm")

# Combine the two plots into a single figure
arrange_plot <- ggpubr::ggarrange(g1, g2, common.legend = FALSE, nrow = 2, ncol = 1)

# Printing the plot
arrange_plot

# Save the combined plot
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_cash$het_var),"_",out_ipv,"_ML_estimates.jpeg"), arrange_plot, width = 27, height = 16, units = "cm")

```

## Sexual and physical violence
### Binary for the last 12 months
```{r}
# Define the current IPV variable of interest
out_ipv = "sex_phy_ipv_sev_12m"

# Define the current list of heterogeneity variables of interest
lst_het_var = c("decile_baseline_ipv", "quartile_baseline_ipv","median_baseline_ipv")

# Creating the data for reg
df_curr <- df_ML_results_final %>%
  filter(type == "baseline", curr_ipv == out_ipv) %>%  # Keep only baseline predictions and  keeps rows of interest.
  dplyr::select(hhid, predicted_val) %>%  # Keep only household ID and predicted IPV at baseline
  distinct(hhid, predicted_val, .keep_all = TRUE) %>% 
  inner_join(
    followup_MRT_hh %>%
      dplyr::select(hhid, !!sym(out_ipv), treatment_pi_pool, 
                    all_of(control_vars), all_of(cluster_vars), 
                    all_of(treatment_vars), reg_hh_csh_mrt, 
                    reg_hh_pi_mrt, village) %>%  
      distinct(.keep_all = TRUE),  # Select some variables
    by = 'hhid',  # Merge on household ID
    multiple = "all"
  )   %>% 
  filter(reg_hh_pi_mrt==1 | reg_hh_csh_mrt==1) 

# Create df_curr1 by filtering households registered for the cash transfer program (reg_hh_csh_mrt == 1)
df_curr1 <- df_curr %>% 
  filter(reg_hh_csh_mrt == 1) %>%  # Keep only cash transfer treatment group
  mutate(
    decile_baseline_ipv = as.factor(ntile(predicted_val, 10)),   # Create decile factor based on predicted IPV at baseline
    quartile_baseline_ipv = as.factor(ntile(predicted_val, 5)),  # Create quartile factor
    median_baseline_ipv = as.factor(ntile(predicted_val, 2))     # Create median (binary high/low) factor
  )

# Create df_curr2 by filtering households registered for the productive inclusion program (reg_hh_pi_mrt == 1)
df_curr2 <- df_curr %>% 
  filter(reg_hh_pi_mrt == 1) %>%  # Keep only productive inclusion treatment group
  mutate(
    decile_baseline_ipv = as.factor(ntile(predicted_val, 10)),   # Create decile factor based on predicted IPV at baseline
    quartile_baseline_ipv = as.factor(ntile(predicted_val, 5)),  # Create quartile factor
    median_baseline_ipv = as.factor(ntile(predicted_val, 2))     # Create median (binary high/low) factor
  )

# Combine the two filtered datasets into a single dataframe (stacking them)
df_curr <- plyr::rbind.fill(df_curr1, df_curr2)  # Use plyr to bind rows even if columns slightly differ
```



#### First plot
```{r}

# Build the plot
df_curr %>%
  filter(!is.na(treatment_pi_pool)) %>% 
  ggplot(aes(
    x = predicted_val,  # X-axis: predicted IPV at baseline
    y = !!sym(out_ipv),  # Y-axis: observed IPV at follow-up
    color = treatment_pi_pool,  # Color lines by treatment group
    fill = treatment_pi_pool # Fill the color of lines by treatment group
  )) + 
  geom_point() + 
  geom_smooth(method = "loess", se = TRUE, alpha = 0.2, level=0.95) +  # Add linear fit with confidence interval
  scale_color_manual(values = c("Pool" = "#FAA43A", "Control" = "#5DA5DA")) +  # Custom line colors
  scale_fill_manual(values =  c("Pool" = "#FAA43A", "Control" = "#5DA5DA")) + # Custom confidence interval
  labs(
    x = "Predicted baseline IPV",  # X-axis label
    y = "IPV at follow-up",        # Y-axis label
    color = "",                    # Remove legend title for color
    caption = "The smooth function a local polynomial regression."  # Add caption to plot
  ) +
  theme_light(base_size = 8) + # Use light theme with base font size 8
  theme(
    legend.position = 'bottom',  # Place legend at bottom
    text = element_text(size = 8),  # General text size
    legend.direction = "horizontal",  # Horizontal layout of legend
    legend.box = "horizontal"        # Group legend items in a single line
  ) +
  guides(fill = "none")

# Save the plot as a JPEG image
ggsave(
  paste0("output/img/", out_ipv, "first_ML_all.jpeg"),
  width = 27, height = 16, units = "cm")
```



#### Second plot

```{r}
# Create a data frame of results examining heterogeneous treatment effects
# across different IPV outcomes, treatment variables, and heterogeneity dimensions
mainResults_het <- map_dfr(out_ipv, function(depvar) {
  
  # For each heterogeneity variable...
  tempResults1 <- map_dfr(lst_het_var, function(het_var) { 
    
    # For each treatment variable...
    tempResults2 <- map_dfr(treatment_vars, function(treat_var) {
      
      bind_rows(
        # Get estimates for heterogeneous treatment effects using the specified model
        getEstimateGlobal_ML_het(depvar, treat_var, het_var, control_vars, strata_vars, cluster_vars, df_curr) %>%
          # Add columns identifying which variables were used in this iteration
          mutate(depvar = depvar, outcome = depvar, treat_var = treat_var, het_var = het_var)
      )
    })
  })
})

# Filter results for the cash transfer program
mainResults_het_cash <- mainResults_het %>%
  filter(name=="cash")

# Filter results for the productive inclusion program
mainResults_het_pi <- mainResults_het %>%
  filter(name=="pi")

# Compute treatment group sizes and proportions for Tekavoul (cash)
mainResults_het_cash <- mainResults_het_cash %>%
  group_by(estimate_quant, het_var) %>%
  mutate(N_treat = sum(Ntype_treat)) %>%  # Total number treated in each heterogeneity group
  ungroup() %>%
  mutate(prop = round(N_treat * 100 / Ntype, 2))  # Proportion of treated out of total group

# Compute treatment group sizes and proportions for PI program, disaggregated by treatment arm
mainResults_het_pi <- mainResults_het_pi %>%
  group_by(estimate_quant, het_var, treat_var) %>%
  mutate(N_treat = sum(Ntype_treat)) %>%  # Total number treated in each subgroup
  ungroup() %>%
  mutate(prop = round(N_treat * 100 / Ntype, 2))  # Proportion of treated in group

# Calculate share within each treatment type
mainResults_het_pi <- mainResults_het_pi %>%
  mutate(prop_per_treat = round(Ntype_treat * 100 / N_treat, 2))

# Recode program names and variable labels for Tekavoul
mainResults_het_cash <- mainResults_het_cash %>%
  mutate(
    name = dplyr::recode(name,
                         cash = "(a) Tekavoul program",
                         pi = "(b) Productive inclusion program"),
    het_var = dplyr::recode(het_var,
                            decile_baseline_ipv = "decile",
                            quartile_baseline_ipv = "quartile",
                            median_baseline_ipv = "median"),
    depvar = dplyr::recode(depvar,
                           control_ipv_sev_12m = "Bin. for cntrl IPV in the last 12m",
                           control_ipv_sev_index = "Cntrl IPV inten. index z-scr",
                           emo_ipv_sev_12m = "Bin. for emo. IPV in the last 12m",
                           emo_ipv_sev_12m = "Emo. IPV sever. index z-scr",
                           phy_ipv_sev_12m = "Bin. for phy. IPV in the last 12m",
                           phy_ipv_sev_index = "Phy. IPV sever. index z-scr",
                           sex_ipv_sev_12m = "Bin. for sex. IPV in the last 12m",
                           sex_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           sex_phy_sev_12m = "Bin. for sex. and phy. IPV in the last 12m",
                           sex_phy_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           eco_ipv_sev_12m = "Bin. for eco. IPV in the last 12m",
                           eco_ipv_sev_index = "Eco. IPV sever. index z-scr",
                           all_ipv_sev_12m = "Bin. for at least one type of IPV (exclud. eco.) in the last 12m",
                           all_ipv_sev_index = "All IPV sev. index z-scr")
  )

# Create label text summarizing N and proportion treated for Tekavoul
mainResults_het_cash <- mainResults_het_cash %>%
  group_by(estimate_quant, het_var) %>%
  mutate(
    lab = sprintf(
      "%s %s \n N treat (pct): %s (%s)",
      first(het_var),
      first(estimate_quant),
      scales::comma(first(N_treat)),
      scales::comma(first(prop))
    )
  ) %>%
  ungroup()

# Recode program names and variable labels for PI program
mainResults_het_pi <- mainResults_het_pi %>%
  mutate(
    name = dplyr::recode(name,
                         cash = "(a) Tekavoul program",
                         pi = "(b) Productive inclusion program"),
    het_var = dplyr::recode(het_var,
                            decile_baseline_ipv = "decile",
                            quartile_baseline_ipv = "quartile",
                            median_baseline_ipv = "median"),
    depvar = dplyr::recode(depvar,
                           control_ipv_sev_12m = "Bin. for cntrl IPV in the last 12m",
                           control_ipv_sev_index = "Cntrl IPV inten. index z-scr",
                           emo_ipv_sev_12m = "Bin. for emo. IPV in the last 12m",
                           emo_ipv_sev_12m = "Emo. IPV sever. index z-scr",
                           phy_ipv_sev_12m = "Bin. for phy. IPV in the last 12m",
                           phy_ipv_sev_index = "Phy. IPV sever. index z-scr",
                           sex_ipv_sev_12m = "Bin. for sex. IPV in the last 12m",
                           sex_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           sex_phy_sev_12m = "Bin. for sex. and phy. IPV in the last 12m",
                           sex_phy_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           eco_ipv_sev_12m = "Bin. for eco. IPV in the last 12m",
                           eco_ipv_sev_index = "Eco. IPV sever. index z-scr",
                           all_ipv_sev_12m = "Bin. for at least one type of IPV (exclud. eco.) in the last 12m",
                           all_ipv_sev_index = "All IPV sev. index z-scr")
  )

# Create detailed label with counts and proportions per treatment arm for PI program
mainResults_het_pi <- mainResults_het_pi %>%
  group_by(estimate_quant, het_var) %>%
  mutate(
    lab = sprintf(
      "%s %s \n N treat (pct): %s (%s) \n N Capital (pct): %s (%s) \n N Psychosocial (pct): %s (%s) \n N Full (pct): %s (%s).",
      first(het_var),
      first(estimate_quant),
      scales::comma(first(N_treat)),
      scales::comma(first(prop)),
      scales::comma(first(Ntype_treat)),
      scales::comma(first(prop_per_treat)),
      scales::comma(nth(Ntype_treat, 2)),
      scales::comma(nth(prop_per_treat, 2)),
      scales::comma(nth(Ntype_treat,3)),
      scales::comma(nth(prop_per_treat,3))
    )
  ) %>%
  ungroup()

# Remove redundant prefixes from PI labels
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("decile", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("quartile", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("median", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N treat (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Capital (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Psychosocial (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Full (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)

# Remove redundant prefixes from Tekavoul labels
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("decile", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("quartile", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("median", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1)] <- gsub("N treat (pct): ", "", mainResults_het_cash$lab[-c(1)], fixed = T)

# Convert labels and factor variables to ordered factors for plotting
mainResults_het_cash$lab <- fct_inorder(mainResults_het_cash$lab)
mainResults_het_cash$typeTreat <- fct_inorder(mainResults_het_cash$typeTreat)
mainResults_het_cash$het_var <- fct_inorder(mainResults_het_cash$het_var)
mainResults_het_pi$lab <- fct_inorder(mainResults_het_pi$lab)
mainResults_het_pi$typeTreat <- fct_inorder(mainResults_het_pi$typeTreat)
mainResults_het_pi$het_var <- fct_inorder(mainResults_het_pi$het_var)

# Create plot for Tekavoul program
g1 <- mainResults_het_cash %>%
  ggplot(aes(x = lab, y = pe, shape = typeTreat, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_wrap(~het_var, scales = "free_x", shrink=TRUE, drop=TRUE) +
  labs(
    x = "", y = "Effect",
    subtitle = first(mainResults_het_cash$depvar),
    caption = sprintf("N = %s Tekavoul", first(mainResults_het_cash$N)),
    shape =""
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), legend.direction = "horizontal")

# Save plot for Tekavoul
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_cash$name),"_",first(mainResults_het_cash$depvar),"_ML.jpeg"), g1, width = 27, height = 16, units = "cm")

# Create plot for PI program
g2 <- mainResults_het_pi %>%
  ggplot(aes(x = lab, y = pe, shape = typeTreat, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_wrap(~het_var, scales = "free_x", shrink=TRUE, drop=TRUE) +
  labs(
    x = "", y = "Effect",
    subtitle = first(mainResults_het_pi$depvar),
    caption = sprintf("N = %s productive inclusion", first(mainResults_het_pi$N)),
    shape =""
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), legend.direction = "horizontal")

# Save plot for PI
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_pi$name),"_",first(mainResults_het_pi$depvar),"_ML.jpeg"), g2, width = 27, height = 16, units = "cm")

# Combine the two plots into a single figure
arrange_plot <- ggpubr::ggarrange(g1, g2, common.legend = FALSE, nrow = 2, ncol = 1)

# Printing the plot
arrange_plot

# Save the combined plot
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_cash$het_var),"_",out_ipv,"_ML_estimates.jpeg"), arrange_plot, width = 27, height = 16, units = "cm")

```

### Continuous index in the last 12 months
```{r}
# Define the current IPV variable of interest
out_ipv = "sex_phy_ipv_sev_index"

# Define the current list of heterogeneity variables of interest
lst_het_var = c("decile_baseline_ipv", "quartile_baseline_ipv","median_baseline_ipv")

# Creating the data for reg
df_curr <- df_ML_results_final %>%
  filter(type == "baseline", curr_ipv == out_ipv) %>%  # Keep only baseline predictions and  keeps rows of interest.
  dplyr::select(hhid, predicted_val) %>%  # Keep only household ID and predicted IPV at baseline
  distinct(hhid, predicted_val, .keep_all = TRUE) %>% 
  inner_join(
    followup_MRT_hh %>%
      dplyr::select(hhid, !!sym(out_ipv), treatment_pi_pool, 
                    all_of(control_vars), all_of(cluster_vars), 
                    all_of(treatment_vars), reg_hh_csh_mrt, 
                    reg_hh_pi_mrt, village) %>%  
      distinct(.keep_all = TRUE),  # Select some variables
    by = 'hhid',  # Merge on household ID
    multiple = "all"
  )   %>% 
  filter(reg_hh_pi_mrt==1 | reg_hh_csh_mrt==1) 

# Create df_curr1 by filtering households registered for the cash transfer program (reg_hh_csh_mrt == 1)
df_curr1 <- df_curr %>% 
  filter(reg_hh_csh_mrt == 1) %>%  # Keep only cash transfer treatment group
  mutate(
    decile_baseline_ipv = as.factor(ntile(predicted_val, 10)),   # Create decile factor based on predicted IPV at baseline
    quartile_baseline_ipv = as.factor(ntile(predicted_val, 5)),  # Create quartile factor
    median_baseline_ipv = as.factor(ntile(predicted_val, 2))     # Create median (binary high/low) factor
  )

# Create df_curr2 by filtering households registered for the productive inclusion program (reg_hh_pi_mrt == 1)
df_curr2 <- df_curr %>% 
  filter(reg_hh_pi_mrt == 1) %>%  # Keep only productive inclusion treatment group
  mutate(
    decile_baseline_ipv = as.factor(ntile(predicted_val, 10)),   # Create decile factor based on predicted IPV at baseline
    quartile_baseline_ipv = as.factor(ntile(predicted_val, 5)),  # Create quartile factor
    median_baseline_ipv = as.factor(ntile(predicted_val, 2))     # Create median (binary high/low) factor
  )

# Combine the two filtered datasets into a single dataframe (stacking them)
df_curr <- plyr::rbind.fill(df_curr1, df_curr2)  # Use plyr to bind rows even if columns slightly differ

```



#### First plot
```{r}

# Build the plot
df_curr %>%
  filter(!is.na(treatment_pi_pool)) %>% 
  ggplot(aes(
    x = predicted_val,  # X-axis: predicted IPV at baseline
    y = !!sym(out_ipv),  # Y-axis: observed IPV at follow-up
    color = treatment_pi_pool,  # Color lines by treatment group
    fill = treatment_pi_pool # Fill the color of lines by treatment group
  )) + 
  geom_point() + 
  geom_smooth(method = "loess", se = TRUE, alpha = 0.2, level=0.95) +  # Add linear fit with confidence interval
  scale_color_manual(values = c("Pool" = "#FAA43A", "Control" = "#5DA5DA")) +  # Custom line colors
  scale_fill_manual(values =  c("Pool" = "#FAA43A", "Control" = "#5DA5DA")) + # Custom confidence interval
  labs(
    x = "Predicted baseline IPV",  # X-axis label
    y = "IPV at follow-up",        # Y-axis label
    color = "",                    # Remove legend title for color
    caption = "The smooth function a local polynomial regression."  # Add caption to plot
  ) +
  theme_light(base_size = 8) + # Use light theme with base font size 8
  theme(
    legend.position = 'bottom',  # Place legend at bottom
    text = element_text(size = 8),  # General text size
    legend.direction = "horizontal",  # Horizontal layout of legend
    legend.box = "horizontal"        # Group legend items in a single line
  ) +
  guides(fill = "none")

# Save the plot as a JPEG image
ggsave(
  paste0("output/img/", out_ipv, "first_ML_all.jpeg"),
  width = 27, height = 16, units = "cm")
```



#### Second plot

```{r}
# Create a data frame of results examining heterogeneous treatment effects
# across different IPV outcomes, treatment variables, and heterogeneity dimensions
mainResults_het <- map_dfr(out_ipv, function(depvar) {
  
  # For each heterogeneity variable...
  tempResults1 <- map_dfr(lst_het_var, function(het_var) { 
    
    # For each treatment variable...
    tempResults2 <- map_dfr(treatment_vars, function(treat_var) {
      
      bind_rows(
        # Get estimates for heterogeneous treatment effects using the specified model
        getEstimateGlobal_ML_het(depvar, treat_var, het_var, control_vars, strata_vars, cluster_vars, df_curr) %>%
          # Add columns identifying which variables were used in this iteration
          mutate(depvar = depvar, outcome = depvar, treat_var = treat_var, het_var = het_var)
      )
    })
  })
})

# Filter results for the cash transfer program
mainResults_het_cash <- mainResults_het %>%
  filter(name=="cash")

# Filter results for the productive inclusion program
mainResults_het_pi <- mainResults_het %>%
  filter(name=="pi")

# Compute treatment group sizes and proportions for Tekavoul (cash)
mainResults_het_cash <- mainResults_het_cash %>%
  group_by(estimate_quant, het_var) %>%
  mutate(N_treat = sum(Ntype_treat)) %>%  # Total number treated in each heterogeneity group
  ungroup() %>%
  mutate(prop = round(N_treat * 100 / Ntype, 2))  # Proportion of treated out of total group

# Compute treatment group sizes and proportions for PI program, disaggregated by treatment arm
mainResults_het_pi <- mainResults_het_pi %>%
  group_by(estimate_quant, het_var, treat_var) %>%
  mutate(N_treat = sum(Ntype_treat)) %>%  # Total number treated in each subgroup
  ungroup() %>%
  mutate(prop = round(N_treat * 100 / Ntype, 2))  # Proportion of treated in group

# Calculate share within each treatment type
mainResults_het_pi <- mainResults_het_pi %>%
  mutate(prop_per_treat = round(Ntype_treat * 100 / N_treat, 2))

# Recode program names and variable labels for Tekavoul
mainResults_het_cash <- mainResults_het_cash %>%
  mutate(
    name = dplyr::recode(name,
                         cash = "(a) Tekavoul program",
                         pi = "(b) Productive inclusion program"),
    het_var = dplyr::recode(het_var,
                            decile_baseline_ipv = "decile",
                            quartile_baseline_ipv = "quartile",
                            median_baseline_ipv = "median"),
    depvar = dplyr::recode(depvar,
                           control_ipv_sev_12m = "Bin. for cntrl IPV in the last 12m",
                           control_ipv_sev_index = "Cntrl IPV inten. index z-scr",
                           emo_ipv_sev_12m = "Bin. for emo. IPV in the last 12m",
                           emo_ipv_sev_12m = "Emo. IPV sever. index z-scr",
                           phy_ipv_sev_12m = "Bin. for phy. IPV in the last 12m",
                           phy_ipv_sev_index = "Phy. IPV sever. index z-scr",
                           sex_ipv_sev_12m = "Bin. for sex. IPV in the last 12m",
                           sex_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           sex_phy_sev_12m = "Bin. for sex. and phy. IPV in the last 12m",
                           sex_phy_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           eco_ipv_sev_12m = "Bin. for eco. IPV in the last 12m",
                           eco_ipv_sev_index = "Eco. IPV sever. index z-scr",
                           all_ipv_sev_12m = "Bin. for at least one type of IPV (exclud. eco.) in the last 12m",
                           all_ipv_sev_index = "All IPV sev. index z-scr")
  )

# Create label text summarizing N and proportion treated for Tekavoul
mainResults_het_cash <- mainResults_het_cash %>%
  group_by(estimate_quant, het_var) %>%
  mutate(
    lab = sprintf(
      "%s %s \n N treat (pct): %s (%s)",
      first(het_var),
      first(estimate_quant),
      scales::comma(first(N_treat)),
      scales::comma(first(prop))
    )
  ) %>%
  ungroup()

# Recode program names and variable labels for PI program
mainResults_het_pi <- mainResults_het_pi %>%
  mutate(
    name = dplyr::recode(name,
                         cash = "(a) Tekavoul program",
                         pi = "(b) Productive inclusion program"),
    het_var = dplyr::recode(het_var,
                            decile_baseline_ipv = "decile",
                            quartile_baseline_ipv = "quartile",
                            median_baseline_ipv = "median"),
    depvar = dplyr::recode(depvar,
                           control_ipv_sev_12m = "Bin. for cntrl IPV in the last 12m",
                           control_ipv_sev_index = "Cntrl IPV inten. index z-scr",
                           emo_ipv_sev_12m = "Bin. for emo. IPV in the last 12m",
                           emo_ipv_sev_12m = "Emo. IPV sever. index z-scr",
                           phy_ipv_sev_12m = "Bin. for phy. IPV in the last 12m",
                           phy_ipv_sev_index = "Phy. IPV sever. index z-scr",
                           sex_ipv_sev_12m = "Bin. for sex. IPV in the last 12m",
                           sex_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           sex_phy_sev_12m = "Bin. for sex. and phy. IPV in the last 12m",
                           sex_phy_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           eco_ipv_sev_12m = "Bin. for eco. IPV in the last 12m",
                           eco_ipv_sev_index = "Eco. IPV sever. index z-scr",
                           all_ipv_sev_12m = "Bin. for at least one type of IPV (exclud. eco.) in the last 12m",
                           all_ipv_sev_index = "All IPV sev. index z-scr")
  )

# Create detailed label with counts and proportions per treatment arm for PI program
mainResults_het_pi <- mainResults_het_pi %>%
  group_by(estimate_quant, het_var) %>%
  mutate(
    lab = sprintf(
      "%s %s \n N treat (pct): %s (%s) \n N Capital (pct): %s (%s) \n N Psychosocial (pct): %s (%s) \n N Full (pct): %s (%s).",
      first(het_var),
      first(estimate_quant),
      scales::comma(first(N_treat)),
      scales::comma(first(prop)),
      scales::comma(first(Ntype_treat)),
      scales::comma(first(prop_per_treat)),
      scales::comma(nth(Ntype_treat, 2)),
      scales::comma(nth(prop_per_treat, 2)),
      scales::comma(nth(Ntype_treat,3)),
      scales::comma(nth(prop_per_treat,3))
    )
  ) %>%
  ungroup()

# Remove redundant prefixes from PI labels
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("decile", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("quartile", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("median", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N treat (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Capital (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Psychosocial (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Full (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)

# Remove redundant prefixes from Tekavoul labels
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("decile", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("quartile", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("median", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1)] <- gsub("N treat (pct): ", "", mainResults_het_cash$lab[-c(1)], fixed = T)

# Convert labels and factor variables to ordered factors for plotting
mainResults_het_cash$lab <- fct_inorder(mainResults_het_cash$lab)
mainResults_het_cash$typeTreat <- fct_inorder(mainResults_het_cash$typeTreat)
mainResults_het_cash$het_var <- fct_inorder(mainResults_het_cash$het_var)
mainResults_het_pi$lab <- fct_inorder(mainResults_het_pi$lab)
mainResults_het_pi$typeTreat <- fct_inorder(mainResults_het_pi$typeTreat)
mainResults_het_pi$het_var <- fct_inorder(mainResults_het_pi$het_var)

# Create plot for Tekavoul program
g1 <- mainResults_het_cash %>%
  ggplot(aes(x = lab, y = pe, shape = typeTreat, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_wrap(~het_var, scales = "free_x", shrink=TRUE, drop=TRUE) +
  labs(
    x = "", y = "Effect",
    subtitle = first(mainResults_het_cash$depvar),
    caption = sprintf("N = %s Tekavoul", first(mainResults_het_cash$N)),
    shape =""
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), legend.direction = "horizontal")

# Save plot for Tekavoul
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_cash$name),"_",first(mainResults_het_cash$depvar),"_ML.jpeg"), g1, width = 27, height = 16, units = "cm")

# Create plot for PI program
g2 <- mainResults_het_pi %>%
  ggplot(aes(x = lab, y = pe, shape = typeTreat, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_wrap(~het_var, scales = "free_x", shrink=TRUE, drop=TRUE) +
  labs(
    x = "", y = "Effect",
    subtitle = first(mainResults_het_pi$depvar),
    caption = sprintf("N = %s productive inclusion", first(mainResults_het_pi$N)),
    shape =""
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), legend.direction = "horizontal")

# Save plot for PI
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_pi$name),"_",first(mainResults_het_pi$depvar),"_ML.jpeg"), g2, width = 27, height = 16, units = "cm")

# Combine the two plots into a single figure
arrange_plot <- ggpubr::ggarrange(g1, g2, common.legend = FALSE, nrow = 2, ncol = 1)

# Printing the plot
arrange_plot

# Save the combined plot
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_cash$het_var),"_",out_ipv,"_ML_estimates.jpeg"), arrange_plot, width = 27, height = 16, units = "cm")

```

## Economic violence
### Binary for the last 12 months
```{r}
# Define the current IPV variable of interest
out_ipv = "eco_ipv_sev_12m"

# Define the current list of heterogeneity variables of interest
lst_het_var = c("decile_baseline_ipv", "quartile_baseline_ipv","median_baseline_ipv")

# Creating the data for reg
df_curr <- df_ML_results_final %>%
  filter(type == "baseline", curr_ipv == out_ipv) %>%  # Keep only baseline predictions and  keeps rows of interest.
  dplyr::select(hhid, predicted_val) %>%  # Keep only household ID and predicted IPV at baseline
  distinct(hhid, predicted_val, .keep_all = TRUE) %>% 
  inner_join(
    followup_MRT_hh %>%
      dplyr::select(hhid, !!sym(out_ipv), treatment_pi_pool, 
                    all_of(control_vars), all_of(cluster_vars), 
                    all_of(treatment_vars), reg_hh_csh_mrt, 
                    reg_hh_pi_mrt, village) %>%  
      distinct(.keep_all = TRUE),  # Select some variables
    by = 'hhid',  # Merge on household ID
    multiple = "all"
  )   %>% 
  filter(reg_hh_pi_mrt==1 | reg_hh_csh_mrt==1) 

# Create df_curr1 by filtering households registered for the cash transfer program (reg_hh_csh_mrt == 1)
df_curr1 <- df_curr %>% 
  filter(reg_hh_csh_mrt == 1) %>%  # Keep only cash transfer treatment group
  mutate(
    decile_baseline_ipv = as.factor(ntile(predicted_val, 10)),   # Create decile factor based on predicted IPV at baseline
    quartile_baseline_ipv = as.factor(ntile(predicted_val, 5)),  # Create quartile factor
    median_baseline_ipv = as.factor(ntile(predicted_val, 2))     # Create median (binary high/low) factor
  )

# Create df_curr2 by filtering households registered for the productive inclusion program (reg_hh_pi_mrt == 1)
df_curr2 <- df_curr %>% 
  filter(reg_hh_pi_mrt == 1) %>%  # Keep only productive inclusion treatment group
  mutate(
    decile_baseline_ipv = as.factor(ntile(predicted_val, 10)),   # Create decile factor based on predicted IPV at baseline
    quartile_baseline_ipv = as.factor(ntile(predicted_val, 5)),  # Create quartile factor
    median_baseline_ipv = as.factor(ntile(predicted_val, 2))     # Create median (binary high/low) factor
  )

# Combine the two filtered datasets into a single dataframe (stacking them)
df_curr <- plyr::rbind.fill(df_curr1, df_curr2)  # Use plyr to bind rows even if columns slightly differ
```



#### First plot
```{r}

# Build the plot
df_curr %>%
  filter(!is.na(treatment_pi_pool)) %>% 
  ggplot(aes(
    x = predicted_val,  # X-axis: predicted IPV at baseline
    y = !!sym(out_ipv),  # Y-axis: observed IPV at follow-up
    color = treatment_pi_pool,  # Color lines by treatment group
    fill = treatment_pi_pool # Fill the color of lines by treatment group
  )) + 
  geom_point() + 
  geom_smooth(method = "loess", se = TRUE, alpha = 0.2, level=0.95) +  # Add linear fit with confidence interval
  scale_color_manual(values = c("Pool" = "#FAA43A", "Control" = "#5DA5DA")) +  # Custom line colors
  scale_fill_manual(values =  c("Pool" = "#FAA43A", "Control" = "#5DA5DA")) + # Custom confidence interval
  labs(
    x = "Predicted baseline IPV",  # X-axis label
    y = "IPV at follow-up",        # Y-axis label
    color = "",                    # Remove legend title for color
    caption = "The smooth function a local polynomial regression."  # Add caption to plot
  ) +
  theme_light(base_size = 8) + # Use light theme with base font size 8
  theme(
    legend.position = 'bottom',  # Place legend at bottom
    text = element_text(size = 8),  # General text size
    legend.direction = "horizontal",  # Horizontal layout of legend
    legend.box = "horizontal"        # Group legend items in a single line
  ) +
  guides(fill = "none")

# Save the plot as a JPEG image
ggsave(
  paste0("output/img/", out_ipv, "first_ML_all.jpeg"),
  width = 27, height = 16, units = "cm")
```



#### Second plot

```{r}
# Create a data frame of results examining heterogeneous treatment effects
# across different IPV outcomes, treatment variables, and heterogeneity dimensions
mainResults_het <- map_dfr(out_ipv, function(depvar) {
  
  # For each heterogeneity variable...
  tempResults1 <- map_dfr(lst_het_var, function(het_var) { 
    
    # For each treatment variable...
    tempResults2 <- map_dfr(treatment_vars, function(treat_var) {
      
      bind_rows(
        # Get estimates for heterogeneous treatment effects using the specified model
        getEstimateGlobal_ML_het(depvar, treat_var, het_var, control_vars, strata_vars, cluster_vars, df_curr) %>%
          # Add columns identifying which variables were used in this iteration
          mutate(depvar = depvar, outcome = depvar, treat_var = treat_var, het_var = het_var)
      )
    })
  })
})

# Filter results for the cash transfer program
mainResults_het_cash <- mainResults_het %>%
  filter(name=="cash")

# Filter results for the productive inclusion program
mainResults_het_pi <- mainResults_het %>%
  filter(name=="pi")

# Compute treatment group sizes and proportions for Tekavoul (cash)
mainResults_het_cash <- mainResults_het_cash %>%
  group_by(estimate_quant, het_var) %>%
  mutate(N_treat = sum(Ntype_treat)) %>%  # Total number treated in each heterogeneity group
  ungroup() %>%
  mutate(prop = round(N_treat * 100 / Ntype, 2))  # Proportion of treated out of total group

# Compute treatment group sizes and proportions for PI program, disaggregated by treatment arm
mainResults_het_pi <- mainResults_het_pi %>%
  group_by(estimate_quant, het_var, treat_var) %>%
  mutate(N_treat = sum(Ntype_treat)) %>%  # Total number treated in each subgroup
  ungroup() %>%
  mutate(prop = round(N_treat * 100 / Ntype, 2))  # Proportion of treated in group

# Calculate share within each treatment type
mainResults_het_pi <- mainResults_het_pi %>%
  mutate(prop_per_treat = round(Ntype_treat * 100 / N_treat, 2))

# Recode program names and variable labels for Tekavoul
mainResults_het_cash <- mainResults_het_cash %>%
  mutate(
    name = dplyr::recode(name,
                         cash = "(a) Tekavoul program",
                         pi = "(b) Productive inclusion program"),
    het_var = dplyr::recode(het_var,
                            decile_baseline_ipv = "decile",
                            quartile_baseline_ipv = "quartile",
                            median_baseline_ipv = "median"),
    depvar = dplyr::recode(depvar,
                           control_ipv_sev_12m = "Bin. for cntrl IPV in the last 12m",
                           control_ipv_sev_index = "Cntrl IPV inten. index z-scr",
                           emo_ipv_sev_12m = "Bin. for emo. IPV in the last 12m",
                           emo_ipv_sev_12m = "Emo. IPV sever. index z-scr",
                           phy_ipv_sev_12m = "Bin. for phy. IPV in the last 12m",
                           phy_ipv_sev_index = "Phy. IPV sever. index z-scr",
                           sex_ipv_sev_12m = "Bin. for sex. IPV in the last 12m",
                           sex_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           sex_phy_sev_12m = "Bin. for sex. and phy. IPV in the last 12m",
                           sex_phy_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           eco_ipv_sev_12m = "Bin. for eco. IPV in the last 12m",
                           eco_ipv_sev_index = "Eco. IPV sever. index z-scr",
                           all_ipv_sev_12m = "Bin. for at least one type of IPV (exclud. eco.) in the last 12m",
                           all_ipv_sev_index = "All IPV sev. index z-scr")
  )

# Create label text summarizing N and proportion treated for Tekavoul
mainResults_het_cash <- mainResults_het_cash %>%
  group_by(estimate_quant, het_var) %>%
  mutate(
    lab = sprintf(
      "%s %s \n N treat (pct): %s (%s)",
      first(het_var),
      first(estimate_quant),
      scales::comma(first(N_treat)),
      scales::comma(first(prop))
    )
  ) %>%
  ungroup()

# Recode program names and variable labels for PI program
mainResults_het_pi <- mainResults_het_pi %>%
  mutate(
    name = dplyr::recode(name,
                         cash = "(a) Tekavoul program",
                         pi = "(b) Productive inclusion program"),
    het_var = dplyr::recode(het_var,
                            decile_baseline_ipv = "decile",
                            quartile_baseline_ipv = "quartile",
                            median_baseline_ipv = "median"),
    depvar = dplyr::recode(depvar,
                           control_ipv_sev_12m = "Bin. for cntrl IPV in the last 12m",
                           control_ipv_sev_index = "Cntrl IPV inten. index z-scr",
                           emo_ipv_sev_12m = "Bin. for emo. IPV in the last 12m",
                           emo_ipv_sev_12m = "Emo. IPV sever. index z-scr",
                           phy_ipv_sev_12m = "Bin. for phy. IPV in the last 12m",
                           phy_ipv_sev_index = "Phy. IPV sever. index z-scr",
                           sex_ipv_sev_12m = "Bin. for sex. IPV in the last 12m",
                           sex_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           sex_phy_sev_12m = "Bin. for sex. and phy. IPV in the last 12m",
                           sex_phy_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           eco_ipv_sev_12m = "Bin. for eco. IPV in the last 12m",
                           eco_ipv_sev_index = "Eco. IPV sever. index z-scr",
                           all_ipv_sev_12m = "Bin. for at least one type of IPV (exclud. eco.) in the last 12m",
                           all_ipv_sev_index = "All IPV sev. index z-scr")
  )

# Create detailed label with counts and proportions per treatment arm for PI program
mainResults_het_pi <- mainResults_het_pi %>%
  group_by(estimate_quant, het_var) %>%
  mutate(
    lab = sprintf(
      "%s %s \n N treat (pct): %s (%s) \n N Capital (pct): %s (%s) \n N Psychosocial (pct): %s (%s) \n N Full (pct): %s (%s).",
      first(het_var),
      first(estimate_quant),
      scales::comma(first(N_treat)),
      scales::comma(first(prop)),
      scales::comma(first(Ntype_treat)),
      scales::comma(first(prop_per_treat)),
      scales::comma(nth(Ntype_treat, 2)),
      scales::comma(nth(prop_per_treat, 2)),
      scales::comma(nth(Ntype_treat,3)),
      scales::comma(nth(prop_per_treat,3))
    )
  ) %>%
  ungroup()

# Remove redundant prefixes from PI labels
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("decile", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("quartile", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("median", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N treat (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Capital (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Psychosocial (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Full (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)

# Remove redundant prefixes from Tekavoul labels
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("decile", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("quartile", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("median", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1)] <- gsub("N treat (pct): ", "", mainResults_het_cash$lab[-c(1)], fixed = T)

# Convert labels and factor variables to ordered factors for plotting
mainResults_het_cash$lab <- fct_inorder(mainResults_het_cash$lab)
mainResults_het_cash$typeTreat <- fct_inorder(mainResults_het_cash$typeTreat)
mainResults_het_cash$het_var <- fct_inorder(mainResults_het_cash$het_var)
mainResults_het_pi$lab <- fct_inorder(mainResults_het_pi$lab)
mainResults_het_pi$typeTreat <- fct_inorder(mainResults_het_pi$typeTreat)
mainResults_het_pi$het_var <- fct_inorder(mainResults_het_pi$het_var)

# Create plot for Tekavoul program
g1 <- mainResults_het_cash %>%
  ggplot(aes(x = lab, y = pe, shape = typeTreat, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_wrap(~het_var, scales = "free_x", shrink=TRUE, drop=TRUE) +
  labs(
    x = "", y = "Effect",
    subtitle = first(mainResults_het_cash$depvar),
    caption = sprintf("N = %s Tekavoul", first(mainResults_het_cash$N)),
    shape =""
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), legend.direction = "horizontal")

# Save plot for Tekavoul
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_cash$name),"_",first(mainResults_het_cash$depvar),"_ML.jpeg"), g1, width = 27, height = 16, units = "cm")

# Create plot for PI program
g2 <- mainResults_het_pi %>%
  ggplot(aes(x = lab, y = pe, shape = typeTreat, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_wrap(~het_var, scales = "free_x", shrink=TRUE, drop=TRUE) +
  labs(
    x = "", y = "Effect",
    subtitle = first(mainResults_het_pi$depvar),
    caption = sprintf("N = %s productive inclusion", first(mainResults_het_pi$N)),
    shape =""
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), legend.direction = "horizontal")

# Save plot for PI
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_pi$name),"_",first(mainResults_het_pi$depvar),"_ML.jpeg"), g2, width = 27, height = 16, units = "cm")

# Combine the two plots into a single figure
arrange_plot <- ggpubr::ggarrange(g1, g2, common.legend = FALSE, nrow = 2, ncol = 1)

# Printing the plot
arrange_plot

# Save the combined plot
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_cash$het_var),"_",out_ipv,"_ML_estimates.jpeg"), arrange_plot, width = 27, height = 16, units = "cm")

```

### Continuous index in the last 12 months
```{r}
# Define the current IPV variable of interest
out_ipv = "eco_ipv_sev_index"

# Define the current list of heterogeneity variables of interest
lst_het_var = c("decile_baseline_ipv", "quartile_baseline_ipv","median_baseline_ipv")

# Creating the data for reg
df_curr <- df_ML_results_final %>%
  filter(type == "baseline", curr_ipv == out_ipv) %>%  # Keep only baseline predictions and  keeps rows of interest.
  dplyr::select(hhid, predicted_val) %>%  # Keep only household ID and predicted IPV at baseline
  distinct(hhid, predicted_val, .keep_all = TRUE) %>% 
  inner_join(
    followup_MRT_hh %>%
      dplyr::select(hhid, !!sym(out_ipv), treatment_pi_pool, 
                    all_of(control_vars), all_of(cluster_vars), 
                    all_of(treatment_vars), reg_hh_csh_mrt, 
                    reg_hh_pi_mrt, village) %>%  
      distinct(.keep_all = TRUE),  # Select some variables
    by = 'hhid',  # Merge on household ID
    multiple = "all"
  )   %>% 
  filter(reg_hh_pi_mrt==1 | reg_hh_csh_mrt==1) 

# Create df_curr1 by filtering households registered for the cash transfer program (reg_hh_csh_mrt == 1)
df_curr1 <- df_curr %>% 
  filter(reg_hh_csh_mrt == 1) %>%  # Keep only cash transfer treatment group
  mutate(
    decile_baseline_ipv = as.factor(ntile(predicted_val, 10)),   # Create decile factor based on predicted IPV at baseline
    quartile_baseline_ipv = as.factor(ntile(predicted_val, 5)),  # Create quartile factor
    median_baseline_ipv = as.factor(ntile(predicted_val, 2))     # Create median (binary high/low) factor
  )

# Create df_curr2 by filtering households registered for the productive inclusion program (reg_hh_pi_mrt == 1)
df_curr2 <- df_curr %>% 
  filter(reg_hh_pi_mrt == 1) %>%  # Keep only productive inclusion treatment group
  mutate(
    decile_baseline_ipv = as.factor(ntile(predicted_val, 10)),   # Create decile factor based on predicted IPV at baseline
    quartile_baseline_ipv = as.factor(ntile(predicted_val, 5)),  # Create quartile factor
    median_baseline_ipv = as.factor(ntile(predicted_val, 2))     # Create median (binary high/low) factor
  )

# Combine the two filtered datasets into a single dataframe (stacking them)
df_curr <- plyr::rbind.fill(df_curr1, df_curr2)  # Use plyr to bind rows even if columns slightly differ
```



#### First plot
```{r}

# Build the plot
df_curr %>%
  filter(!is.na(treatment_pi_pool)) %>% 
  ggplot(aes(
    x = predicted_val,  # X-axis: predicted IPV at baseline
    y = !!sym(out_ipv),  # Y-axis: observed IPV at follow-up
    color = treatment_pi_pool,  # Color lines by treatment group
    fill = treatment_pi_pool # Fill the color of lines by treatment group
  )) + 
  geom_point() + 
  geom_smooth(method = "loess", se = TRUE, alpha = 0.2, level=0.95) +  # Add linear fit with confidence interval
  scale_color_manual(values = c("Pool" = "#FAA43A", "Control" = "#5DA5DA")) +  # Custom line colors
  scale_fill_manual(values =  c("Pool" = "#FAA43A", "Control" = "#5DA5DA")) + # Custom confidence interval
  labs(
    x = "Predicted baseline IPV",  # X-axis label
    y = "IPV at follow-up",        # Y-axis label
    color = "",                    # Remove legend title for color
    caption = "The smooth function a local polynomial regression."  # Add caption to plot
  ) +
  theme_light(base_size = 8) + # Use light theme with base font size 8
  theme(
    legend.position = 'bottom',  # Place legend at bottom
    text = element_text(size = 8),  # General text size
    legend.direction = "horizontal",  # Horizontal layout of legend
    legend.box = "horizontal"        # Group legend items in a single line
  ) +
  guides(fill = "none")

# Save the plot as a JPEG image
ggsave(
  paste0("output/img/", out_ipv, "first_ML_all.jpeg"),
  width = 27, height = 16, units = "cm")
```



#### Second plot

```{r}
# Create a data frame of results examining heterogeneous treatment effects
# across different IPV outcomes, treatment variables, and heterogeneity dimensions
mainResults_het <- map_dfr(out_ipv, function(depvar) {
  
  # For each heterogeneity variable...
  tempResults1 <- map_dfr(lst_het_var, function(het_var) { 
    
    # For each treatment variable...
    tempResults2 <- map_dfr(treatment_vars, function(treat_var) {
      
      bind_rows(
        # Get estimates for heterogeneous treatment effects using the specified model
        getEstimateGlobal_ML_het(depvar, treat_var, het_var, control_vars, strata_vars, cluster_vars, df_curr) %>%
          # Add columns identifying which variables were used in this iteration
          mutate(depvar = depvar, outcome = depvar, treat_var = treat_var, het_var = het_var)
      )
    })
  })
})

# Filter results for the cash transfer program
mainResults_het_cash <- mainResults_het %>%
  filter(name=="cash")

# Filter results for the productive inclusion program
mainResults_het_pi <- mainResults_het %>%
  filter(name=="pi")

# Compute treatment group sizes and proportions for Tekavoul (cash)
mainResults_het_cash <- mainResults_het_cash %>%
  group_by(estimate_quant, het_var) %>%
  mutate(N_treat = sum(Ntype_treat)) %>%  # Total number treated in each heterogeneity group
  ungroup() %>%
  mutate(prop = round(N_treat * 100 / Ntype, 2))  # Proportion of treated out of total group

# Compute treatment group sizes and proportions for PI program, disaggregated by treatment arm
mainResults_het_pi <- mainResults_het_pi %>%
  group_by(estimate_quant, het_var, treat_var) %>%
  mutate(N_treat = sum(Ntype_treat)) %>%  # Total number treated in each subgroup
  ungroup() %>%
  mutate(prop = round(N_treat * 100 / Ntype, 2))  # Proportion of treated in group

# Calculate share within each treatment type
mainResults_het_pi <- mainResults_het_pi %>%
  mutate(prop_per_treat = round(Ntype_treat * 100 / N_treat, 2))

# Recode program names and variable labels for Tekavoul
mainResults_het_cash <- mainResults_het_cash %>%
  mutate(
    name = dplyr::recode(name,
                         cash = "(a) Tekavoul program",
                         pi = "(b) Productive inclusion program"),
    het_var = dplyr::recode(het_var,
                            decile_baseline_ipv = "decile",
                            quartile_baseline_ipv = "quartile",
                            median_baseline_ipv = "median"),
    depvar = dplyr::recode(depvar,
                           control_ipv_sev_12m = "Bin. for cntrl IPV in the last 12m",
                           control_ipv_sev_index = "Cntrl IPV inten. index z-scr",
                           emo_ipv_sev_12m = "Bin. for emo. IPV in the last 12m",
                           emo_ipv_sev_12m = "Emo. IPV sever. index z-scr",
                           phy_ipv_sev_12m = "Bin. for phy. IPV in the last 12m",
                           phy_ipv_sev_index = "Phy. IPV sever. index z-scr",
                           sex_ipv_sev_12m = "Bin. for sex. IPV in the last 12m",
                           sex_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           sex_phy_sev_12m = "Bin. for sex. and phy. IPV in the last 12m",
                           sex_phy_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           eco_ipv_sev_12m = "Bin. for eco. IPV in the last 12m",
                           eco_ipv_sev_index = "Eco. IPV sever. index z-scr",
                           all_ipv_sev_12m = "Bin. for at least one type of IPV (exclud. eco.) in the last 12m",
                           all_ipv_sev_index = "All IPV sev. index z-scr")
  )

# Create label text summarizing N and proportion treated for Tekavoul
mainResults_het_cash <- mainResults_het_cash %>%
  group_by(estimate_quant, het_var) %>%
  mutate(
    lab = sprintf(
      "%s %s \n N treat (pct): %s (%s)",
      first(het_var),
      first(estimate_quant),
      scales::comma(first(N_treat)),
      scales::comma(first(prop))
    )
  ) %>%
  ungroup()

# Recode program names and variable labels for PI program
mainResults_het_pi <- mainResults_het_pi %>%
  mutate(
    name = dplyr::recode(name,
                         cash = "(a) Tekavoul program",
                         pi = "(b) Productive inclusion program"),
    het_var = dplyr::recode(het_var,
                            decile_baseline_ipv = "decile",
                            quartile_baseline_ipv = "quartile",
                            median_baseline_ipv = "median"),
    depvar = dplyr::recode(depvar,
                           control_ipv_sev_12m = "Bin. for cntrl IPV in the last 12m",
                           control_ipv_sev_index = "Cntrl IPV inten. index z-scr",
                           emo_ipv_sev_12m = "Bin. for emo. IPV in the last 12m",
                           emo_ipv_sev_12m = "Emo. IPV sever. index z-scr",
                           phy_ipv_sev_12m = "Bin. for phy. IPV in the last 12m",
                           phy_ipv_sev_index = "Phy. IPV sever. index z-scr",
                           sex_ipv_sev_12m = "Bin. for sex. IPV in the last 12m",
                           sex_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           sex_phy_sev_12m = "Bin. for sex. and phy. IPV in the last 12m",
                           sex_phy_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           eco_ipv_sev_12m = "Bin. for eco. IPV in the last 12m",
                           eco_ipv_sev_index = "Eco. IPV sever. index z-scr",
                           all_ipv_sev_12m = "Bin. for at least one type of IPV (exclud. eco.) in the last 12m",
                           all_ipv_sev_index = "All IPV sev. index z-scr")
  )

# Create detailed label with counts and proportions per treatment arm for PI program
mainResults_het_pi <- mainResults_het_pi %>%
  group_by(estimate_quant, het_var) %>%
  mutate(
    lab = sprintf(
      "%s %s \n N treat (pct): %s (%s) \n N Capital (pct): %s (%s) \n N Psychosocial (pct): %s (%s) \n N Full (pct): %s (%s).",
      first(het_var),
      first(estimate_quant),
      scales::comma(first(N_treat)),
      scales::comma(first(prop)),
      scales::comma(first(Ntype_treat)),
      scales::comma(first(prop_per_treat)),
      scales::comma(nth(Ntype_treat, 2)),
      scales::comma(nth(prop_per_treat, 2)),
      scales::comma(nth(Ntype_treat,3)),
      scales::comma(nth(prop_per_treat,3))
    )
  ) %>%
  ungroup()

# Remove redundant prefixes from PI labels
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("decile", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("quartile", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("median", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N treat (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Capital (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Psychosocial (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Full (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)

# Remove redundant prefixes from Tekavoul labels
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("decile", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("quartile", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("median", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1)] <- gsub("N treat (pct): ", "", mainResults_het_cash$lab[-c(1)], fixed = T)

# Convert labels and factor variables to ordered factors for plotting
mainResults_het_cash$lab <- fct_inorder(mainResults_het_cash$lab)
mainResults_het_cash$typeTreat <- fct_inorder(mainResults_het_cash$typeTreat)
mainResults_het_cash$het_var <- fct_inorder(mainResults_het_cash$het_var)
mainResults_het_pi$lab <- fct_inorder(mainResults_het_pi$lab)
mainResults_het_pi$typeTreat <- fct_inorder(mainResults_het_pi$typeTreat)
mainResults_het_pi$het_var <- fct_inorder(mainResults_het_pi$het_var)

# Create plot for Tekavoul program
g1 <- mainResults_het_cash %>%
  ggplot(aes(x = lab, y = pe, shape = typeTreat, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_wrap(~het_var, scales = "free_x", shrink=TRUE, drop=TRUE) +
  labs(
    x = "", y = "Effect",
    subtitle = first(mainResults_het_cash$depvar),
    caption = sprintf("N = %s Tekavoul", first(mainResults_het_cash$N)),
    shape =""
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), legend.direction = "horizontal")

# Save plot for Tekavoul
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_cash$name),"_",first(mainResults_het_cash$depvar),"_ML.jpeg"), g1, width = 27, height = 16, units = "cm")

# Create plot for PI program
g2 <- mainResults_het_pi %>%
  ggplot(aes(x = lab, y = pe, shape = typeTreat, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_wrap(~het_var, scales = "free_x", shrink=TRUE, drop=TRUE) +
  labs(
    x = "", y = "Effect",
    subtitle = first(mainResults_het_pi$depvar),
    caption = sprintf("N = %s productive inclusion", first(mainResults_het_pi$N)),
    shape =""
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), legend.direction = "horizontal")

# Save plot for PI
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_pi$name),"_",first(mainResults_het_pi$depvar),"_ML.jpeg"), g2, width = 27, height = 16, units = "cm")

# Combine the two plots into a single figure
arrange_plot <- ggpubr::ggarrange(g1, g2, common.legend = FALSE, nrow = 2, ncol = 1)

# Printing the plot
arrange_plot

# Save the combined plot
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_cash$het_var),"_",out_ipv,"_ML_estimates.jpeg"), arrange_plot, width = 27, height = 16, units = "cm")

```

## All type of violence
### Binary for the last 12 months
```{r}
# Define the current IPV variable of interest
out_ipv = "all_ipv_sev_12m"

# Define the current list of heterogeneity variables of interest
lst_het_var = c("decile_baseline_ipv", "quartile_baseline_ipv","median_baseline_ipv")

# Creating the data for reg
df_curr <- df_ML_results_final %>%
  filter(type == "baseline", curr_ipv == out_ipv) %>%  # Keep only baseline predictions and  keeps rows of interest.
  dplyr::select(hhid, predicted_val) %>%  # Keep only household ID and predicted IPV at baseline
  distinct(hhid, predicted_val, .keep_all = TRUE) %>% 
  inner_join(
    followup_MRT_hh %>%
      dplyr::select(hhid, !!sym(out_ipv), treatment_pi_pool, 
                    all_of(control_vars), all_of(cluster_vars), 
                    all_of(treatment_vars), reg_hh_csh_mrt, 
                    reg_hh_pi_mrt, village) %>%  
      distinct(.keep_all = TRUE),  # Select some variables
    by = 'hhid',  # Merge on household ID
    multiple = "all"
  )   %>% 
  filter(reg_hh_pi_mrt==1 | reg_hh_csh_mrt==1) 

# Create df_curr1 by filtering households registered for the cash transfer program (reg_hh_csh_mrt == 1)
df_curr1 <- df_curr %>% 
  filter(reg_hh_csh_mrt == 1) %>%  # Keep only cash transfer treatment group
  mutate(
    decile_baseline_ipv = as.factor(ntile(predicted_val, 10)),   # Create decile factor based on predicted IPV at baseline
    quartile_baseline_ipv = as.factor(ntile(predicted_val, 5)),  # Create quartile factor
    median_baseline_ipv = as.factor(ntile(predicted_val, 2))     # Create median (binary high/low) factor
  )

# Create df_curr2 by filtering households registered for the productive inclusion program (reg_hh_pi_mrt == 1)
df_curr2 <- df_curr %>% 
  filter(reg_hh_pi_mrt == 1) %>%  # Keep only productive inclusion treatment group
  mutate(
    decile_baseline_ipv = as.factor(ntile(predicted_val, 10)),   # Create decile factor based on predicted IPV at baseline
    quartile_baseline_ipv = as.factor(ntile(predicted_val, 5)),  # Create quartile factor
    median_baseline_ipv = as.factor(ntile(predicted_val, 2))     # Create median (binary high/low) factor
  )

# Combine the two filtered datasets into a single dataframe (stacking them)
df_curr <- plyr::rbind.fill(df_curr1, df_curr2)  # Use plyr to bind rows even if columns slightly differ

```



#### First plot
```{r}

# Build the plot
df_curr %>%
  filter(!is.na(treatment_pi_pool)) %>% 
  ggplot(aes(
    x = predicted_val,  # X-axis: predicted IPV at baseline
    y = !!sym(out_ipv),  # Y-axis: observed IPV at follow-up
    color = treatment_pi_pool,  # Color lines by treatment group
    fill = treatment_pi_pool # Fill the color of lines by treatment group
  )) + 
  geom_point() + 
  geom_smooth(method = "loess", se = TRUE, alpha = 0.2, level=0.95) +  # Add linear fit with confidence interval
  scale_color_manual(values = c("Pool" = "#FAA43A", "Control" = "#5DA5DA")) +  # Custom line colors
  scale_fill_manual(values =  c("Pool" = "#FAA43A", "Control" = "#5DA5DA")) + # Custom confidence interval
  labs(
    x = "Predicted baseline IPV",  # X-axis label
    y = "IPV at follow-up",        # Y-axis label
    color = "",                    # Remove legend title for color
    caption = "The smooth function a local polynomial regression."  # Add caption to plot
  ) +
  theme_light(base_size = 8) + # Use light theme with base font size 8
  theme(
    legend.position = 'bottom',  # Place legend at bottom
    text = element_text(size = 8),  # General text size
    legend.direction = "horizontal",  # Horizontal layout of legend
    legend.box = "horizontal"        # Group legend items in a single line
  ) +
  guides(fill = "none")

# Save the plot as a JPEG image
ggsave(
  paste0("output/img/", out_ipv, "first_ML_all.jpeg"),
  width = 27, height = 16, units = "cm")
```



#### Second plot

```{r}
# Create a data frame of results examining heterogeneous treatment effects
# across different IPV outcomes, treatment variables, and heterogeneity dimensions
mainResults_het <- map_dfr(out_ipv, function(depvar) {
  
  # For each heterogeneity variable...
  tempResults1 <- map_dfr(lst_het_var, function(het_var) { 
    
    # For each treatment variable...
    tempResults2 <- map_dfr(treatment_vars, function(treat_var) {
      
      bind_rows(
        # Get estimates for heterogeneous treatment effects using the specified model
        getEstimateGlobal_ML_het(depvar, treat_var, het_var, control_vars, strata_vars, cluster_vars, df_curr) %>%
          # Add columns identifying which variables were used in this iteration
          mutate(depvar = depvar, outcome = depvar, treat_var = treat_var, het_var = het_var)
      )
    })
  })
})

# Filter results for the cash transfer program
mainResults_het_cash <- mainResults_het %>%
  filter(name=="cash")

# Filter results for the productive inclusion program
mainResults_het_pi <- mainResults_het %>%
  filter(name=="pi")

# Compute treatment group sizes and proportions for Tekavoul (cash)
mainResults_het_cash <- mainResults_het_cash %>%
  group_by(estimate_quant, het_var) %>%
  mutate(N_treat = sum(Ntype_treat)) %>%  # Total number treated in each heterogeneity group
  ungroup() %>%
  mutate(prop = round(N_treat * 100 / Ntype, 2))  # Proportion of treated out of total group

# Compute treatment group sizes and proportions for PI program, disaggregated by treatment arm
mainResults_het_pi <- mainResults_het_pi %>%
  group_by(estimate_quant, het_var, treat_var) %>%
  mutate(N_treat = sum(Ntype_treat)) %>%  # Total number treated in each subgroup
  ungroup() %>%
  mutate(prop = round(N_treat * 100 / Ntype, 2))  # Proportion of treated in group

# Calculate share within each treatment type
mainResults_het_pi <- mainResults_het_pi %>%
  mutate(prop_per_treat = round(Ntype_treat * 100 / N_treat, 2))

# Recode program names and variable labels for Tekavoul
mainResults_het_cash <- mainResults_het_cash %>%
  mutate(
    name = dplyr::recode(name,
                         cash = "(a) Tekavoul program",
                         pi = "(b) Productive inclusion program"),
    het_var = dplyr::recode(het_var,
                            decile_baseline_ipv = "decile",
                            quartile_baseline_ipv = "quartile",
                            median_baseline_ipv = "median"),
    depvar = dplyr::recode(depvar,
                           control_ipv_sev_12m = "Bin. for cntrl IPV in the last 12m",
                           control_ipv_sev_index = "Cntrl IPV inten. index z-scr",
                           emo_ipv_sev_12m = "Bin. for emo. IPV in the last 12m",
                           emo_ipv_sev_12m = "Emo. IPV sever. index z-scr",
                           phy_ipv_sev_12m = "Bin. for phy. IPV in the last 12m",
                           phy_ipv_sev_index = "Phy. IPV sever. index z-scr",
                           sex_ipv_sev_12m = "Bin. for sex. IPV in the last 12m",
                           sex_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           sex_phy_sev_12m = "Bin. for sex. and phy. IPV in the last 12m",
                           sex_phy_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           eco_ipv_sev_12m = "Bin. for eco. IPV in the last 12m",
                           eco_ipv_sev_index = "Eco. IPV sever. index z-scr",
                           all_ipv_sev_12m = "Bin. for at least one type of IPV (exclud. eco.) in the last 12m",
                           all_ipv_sev_index = "All IPV sev. index z-scr")
  )

# Create label text summarizing N and proportion treated for Tekavoul
mainResults_het_cash <- mainResults_het_cash %>%
  group_by(estimate_quant, het_var) %>%
  mutate(
    lab = sprintf(
      "%s %s \n N treat (pct): %s (%s)",
      first(het_var),
      first(estimate_quant),
      scales::comma(first(N_treat)),
      scales::comma(first(prop))
    )
  ) %>%
  ungroup()

# Recode program names and variable labels for PI program
mainResults_het_pi <- mainResults_het_pi %>%
  mutate(
    name = dplyr::recode(name,
                         cash = "(a) Tekavoul program",
                         pi = "(b) Productive inclusion program"),
    het_var = dplyr::recode(het_var,
                            decile_baseline_ipv = "decile",
                            quartile_baseline_ipv = "quartile",
                            median_baseline_ipv = "median"),
    depvar = dplyr::recode(depvar,
                           control_ipv_sev_12m = "Bin. for cntrl IPV in the last 12m",
                           control_ipv_sev_index = "Cntrl IPV inten. index z-scr",
                           emo_ipv_sev_12m = "Bin. for emo. IPV in the last 12m",
                           emo_ipv_sev_12m = "Emo. IPV sever. index z-scr",
                           phy_ipv_sev_12m = "Bin. for phy. IPV in the last 12m",
                           phy_ipv_sev_index = "Phy. IPV sever. index z-scr",
                           sex_ipv_sev_12m = "Bin. for sex. IPV in the last 12m",
                           sex_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           sex_phy_sev_12m = "Bin. for sex. and phy. IPV in the last 12m",
                           sex_phy_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           eco_ipv_sev_12m = "Bin. for eco. IPV in the last 12m",
                           eco_ipv_sev_index = "Eco. IPV sever. index z-scr",
                           all_ipv_sev_12m = "Bin. for at least one type of IPV (exclud. eco.) in the last 12m",
                           all_ipv_sev_index = "All IPV sev. index z-scr")
  )

# Create detailed label with counts and proportions per treatment arm for PI program
mainResults_het_pi <- mainResults_het_pi %>%
  group_by(estimate_quant, het_var) %>%
  mutate(
    lab = sprintf(
      "%s %s \n N treat (pct): %s (%s) \n N Capital (pct): %s (%s) \n N Psychosocial (pct): %s (%s) \n N Full (pct): %s (%s).",
      first(het_var),
      first(estimate_quant),
      scales::comma(first(N_treat)),
      scales::comma(first(prop)),
      scales::comma(first(Ntype_treat)),
      scales::comma(first(prop_per_treat)),
      scales::comma(nth(Ntype_treat, 2)),
      scales::comma(nth(prop_per_treat, 2)),
      scales::comma(nth(Ntype_treat,3)),
      scales::comma(nth(prop_per_treat,3))
    )
  ) %>%
  ungroup()

# Remove redundant prefixes from PI labels
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("decile", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("quartile", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("median", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N treat (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Capital (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Psychosocial (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Full (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)

# Remove redundant prefixes from Tekavoul labels
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("decile", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("quartile", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("median", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1)] <- gsub("N treat (pct): ", "", mainResults_het_cash$lab[-c(1)], fixed = T)

# Convert labels and factor variables to ordered factors for plotting
mainResults_het_cash$lab <- fct_inorder(mainResults_het_cash$lab)
mainResults_het_cash$typeTreat <- fct_inorder(mainResults_het_cash$typeTreat)
mainResults_het_cash$het_var <- fct_inorder(mainResults_het_cash$het_var)
mainResults_het_pi$lab <- fct_inorder(mainResults_het_pi$lab)
mainResults_het_pi$typeTreat <- fct_inorder(mainResults_het_pi$typeTreat)
mainResults_het_pi$het_var <- fct_inorder(mainResults_het_pi$het_var)

# Create plot for Tekavoul program
g1 <- mainResults_het_cash %>%
  ggplot(aes(x = lab, y = pe, shape = typeTreat, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_wrap(~het_var, scales = "free_x", shrink=TRUE, drop=TRUE) +
  labs(
    x = "", y = "Effect",
    subtitle = first(mainResults_het_cash$depvar),
    caption = sprintf("N = %s Tekavoul", first(mainResults_het_cash$N)),
    shape =""
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), legend.direction = "horizontal")

# Save plot for Tekavoul
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_cash$name),"_",first(mainResults_het_cash$depvar),"_ML.jpeg"), g1, width = 27, height = 16, units = "cm")

# Create plot for PI program
g2 <- mainResults_het_pi %>%
  ggplot(aes(x = lab, y = pe, shape = typeTreat, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_wrap(~het_var, scales = "free_x", shrink=TRUE, drop=TRUE) +
  labs(
    x = "", y = "Effect",
    subtitle = first(mainResults_het_pi$depvar),
    caption = sprintf("N = %s productive inclusion", first(mainResults_het_pi$N)),
    shape =""
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), legend.direction = "horizontal")

# Save plot for PI
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_pi$name),"_",first(mainResults_het_pi$depvar),"_ML.jpeg"), g2, width = 27, height = 16, units = "cm")

# Combine the two plots into a single figure
arrange_plot <- ggpubr::ggarrange(g1, g2, common.legend = FALSE, nrow = 2, ncol = 1)

# Printing the plot
arrange_plot

# Save the combined plot
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_cash$het_var),"_",out_ipv,"_ML_estimates.jpeg"), arrange_plot, width = 27, height = 16, units = "cm")

```

### Continuous index in the last 12 months
```{r}
# Define the current IPV variable of interest
out_ipv = "all_ipv_sev_index"

# Define the current list of heterogeneity variables of interest
lst_het_var = c("decile_baseline_ipv", "quartile_baseline_ipv","median_baseline_ipv")

# Creating the data for reg
df_curr <- df_ML_results_final %>%
  filter(type == "baseline", curr_ipv == out_ipv) %>%  # Keep only baseline predictions and  keeps rows of interest.
  dplyr::select(hhid, predicted_val) %>%  # Keep only household ID and predicted IPV at baseline
  distinct(hhid, predicted_val, .keep_all = TRUE) %>% 
  inner_join(
    followup_MRT_hh %>%
      dplyr::select(hhid, !!sym(out_ipv), treatment_pi_pool, 
                    all_of(control_vars), all_of(cluster_vars), 
                    all_of(treatment_vars), reg_hh_csh_mrt, 
                    reg_hh_pi_mrt, village) %>%  
      distinct(.keep_all = TRUE),  # Select some variables
    by = 'hhid',  # Merge on household ID
    multiple = "all"
  )   %>% 
  filter(reg_hh_pi_mrt==1 | reg_hh_csh_mrt==1) 

# Create df_curr1 by filtering households registered for the cash transfer program (reg_hh_csh_mrt == 1)
df_curr1 <- df_curr %>% 
  filter(reg_hh_csh_mrt == 1) %>%  # Keep only cash transfer treatment group
  mutate(
    decile_baseline_ipv = as.factor(ntile(predicted_val, 10)),   # Create decile factor based on predicted IPV at baseline
    quartile_baseline_ipv = as.factor(ntile(predicted_val, 5)),  # Create quartile factor
    median_baseline_ipv = as.factor(ntile(predicted_val, 2))     # Create median (binary high/low) factor
  )

# Create df_curr2 by filtering households registered for the productive inclusion program (reg_hh_pi_mrt == 1)
df_curr2 <- df_curr %>% 
  filter(reg_hh_pi_mrt == 1) %>%  # Keep only productive inclusion treatment group
  mutate(
    decile_baseline_ipv = as.factor(ntile(predicted_val, 10)),   # Create decile factor based on predicted IPV at baseline
    quartile_baseline_ipv = as.factor(ntile(predicted_val, 5)),  # Create quartile factor
    median_baseline_ipv = as.factor(ntile(predicted_val, 2))     # Create median (binary high/low) factor
  )

# Combine the two filtered datasets into a single dataframe (stacking them)
df_curr <- plyr::rbind.fill(df_curr1, df_curr2)  # Use plyr to bind rows even if columns slightly differ
```



#### First plot
```{r}

# Build the plot
df_curr %>%
  filter(!is.na(treatment_pi_pool)) %>% 
  ggplot(aes(
    x = predicted_val,  # X-axis: predicted IPV at baseline
    y = !!sym(out_ipv),  # Y-axis: observed IPV at follow-up
    color = treatment_pi_pool,  # Color lines by treatment group
    fill = treatment_pi_pool # Fill the color of lines by treatment group
  )) + 
  geom_point() + 
  geom_smooth(method = "loess", se = TRUE, alpha = 0.2, level=0.95) +  # Add linear fit with confidence interval
  scale_color_manual(values = c("Pool" = "#FAA43A", "Control" = "#5DA5DA")) +  # Custom line colors
  scale_fill_manual(values =  c("Pool" = "#FAA43A", "Control" = "#5DA5DA")) + # Custom confidence interval
  labs(
    x = "Predicted baseline IPV",  # X-axis label
    y = "IPV at follow-up",        # Y-axis label
    color = "",                    # Remove legend title for color
    caption = "The smooth function a local polynomial regression."  # Add caption to plot
  ) +
  theme_light(base_size = 8) + # Use light theme with base font size 8
  theme(
    legend.position = 'bottom',  # Place legend at bottom
    text = element_text(size = 8),  # General text size
    legend.direction = "horizontal",  # Horizontal layout of legend
    legend.box = "horizontal"        # Group legend items in a single line
  ) +
  guides(fill = "none")

# Save the plot as a JPEG image
ggsave(
  paste0("output/img/", out_ipv, "first_ML_all.jpeg"),
  width = 27, height = 16, units = "cm")
```



#### Second plot

```{r}
# Create a data frame of results examining heterogeneous treatment effects
# across different IPV outcomes, treatment variables, and heterogeneity dimensions
mainResults_het <- map_dfr(out_ipv, function(depvar) {
  
  # For each heterogeneity variable...
  tempResults1 <- map_dfr(lst_het_var, function(het_var) { 
    
    # For each treatment variable...
    tempResults2 <- map_dfr(treatment_vars, function(treat_var) {
      
      bind_rows(
        # Get estimates for heterogeneous treatment effects using the specified model
        getEstimateGlobal_ML_het(depvar, treat_var, het_var, control_vars, strata_vars, cluster_vars, df_curr) %>%
          # Add columns identifying which variables were used in this iteration
          mutate(depvar = depvar, outcome = depvar, treat_var = treat_var, het_var = het_var)
      )
    })
  })
})

# Filter results for the cash transfer program
mainResults_het_cash <- mainResults_het %>%
  filter(name=="cash")

# Filter results for the productive inclusion program
mainResults_het_pi <- mainResults_het %>%
  filter(name=="pi")

# Compute treatment group sizes and proportions for Tekavoul (cash)
mainResults_het_cash <- mainResults_het_cash %>%
  group_by(estimate_quant, het_var) %>%
  mutate(N_treat = sum(Ntype_treat)) %>%  # Total number treated in each heterogeneity group
  ungroup() %>%
  mutate(prop = round(N_treat * 100 / Ntype, 2))  # Proportion of treated out of total group

# Compute treatment group sizes and proportions for PI program, disaggregated by treatment arm
mainResults_het_pi <- mainResults_het_pi %>%
  group_by(estimate_quant, het_var, treat_var) %>%
  mutate(N_treat = sum(Ntype_treat)) %>%  # Total number treated in each subgroup
  ungroup() %>%
  mutate(prop = round(N_treat * 100 / Ntype, 2))  # Proportion of treated in group

# Calculate share within each treatment type
mainResults_het_pi <- mainResults_het_pi %>%
  mutate(prop_per_treat = round(Ntype_treat * 100 / N_treat, 2))

# Recode program names and variable labels for Tekavoul
mainResults_het_cash <- mainResults_het_cash %>%
  mutate(
    name = dplyr::recode(name,
                         cash = "(a) Tekavoul program",
                         pi = "(b) Productive inclusion program"),
    het_var = dplyr::recode(het_var,
                            decile_baseline_ipv = "decile",
                            quartile_baseline_ipv = "quartile",
                            median_baseline_ipv = "median"),
    depvar = dplyr::recode(depvar,
                           control_ipv_sev_12m = "Bin. for cntrl IPV in the last 12m",
                           control_ipv_sev_index = "Cntrl IPV inten. index z-scr",
                           emo_ipv_sev_12m = "Bin. for emo. IPV in the last 12m",
                           emo_ipv_sev_12m = "Emo. IPV sever. index z-scr",
                           phy_ipv_sev_12m = "Bin. for phy. IPV in the last 12m",
                           phy_ipv_sev_index = "Phy. IPV sever. index z-scr",
                           sex_ipv_sev_12m = "Bin. for sex. IPV in the last 12m",
                           sex_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           sex_phy_sev_12m = "Bin. for sex. and phy. IPV in the last 12m",
                           sex_phy_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           eco_ipv_sev_12m = "Bin. for eco. IPV in the last 12m",
                           eco_ipv_sev_index = "Eco. IPV sever. index z-scr",
                           all_ipv_sev_12m = "Bin. for at least one type of IPV (exclud. eco.) in the last 12m",
                           all_ipv_sev_index = "All IPV sev. index z-scr")
  )

# Create label text summarizing N and proportion treated for Tekavoul
mainResults_het_cash <- mainResults_het_cash %>%
  group_by(estimate_quant, het_var) %>%
  mutate(
    lab = sprintf(
      "%s %s \n N treat (pct): %s (%s)",
      first(het_var),
      first(estimate_quant),
      scales::comma(first(N_treat)),
      scales::comma(first(prop))
    )
  ) %>%
  ungroup()

# Recode program names and variable labels for PI program
mainResults_het_pi <- mainResults_het_pi %>%
  mutate(
    name = dplyr::recode(name,
                         cash = "(a) Tekavoul program",
                         pi = "(b) Productive inclusion program"),
    het_var = dplyr::recode(het_var,
                            decile_baseline_ipv = "decile",
                            quartile_baseline_ipv = "quartile",
                            median_baseline_ipv = "median"),
    depvar = dplyr::recode(depvar,
                           control_ipv_sev_12m = "Bin. for cntrl IPV in the last 12m",
                           control_ipv_sev_index = "Cntrl IPV inten. index z-scr",
                           emo_ipv_sev_12m = "Bin. for emo. IPV in the last 12m",
                           emo_ipv_sev_12m = "Emo. IPV sever. index z-scr",
                           phy_ipv_sev_12m = "Bin. for phy. IPV in the last 12m",
                           phy_ipv_sev_index = "Phy. IPV sever. index z-scr",
                           sex_ipv_sev_12m = "Bin. for sex. IPV in the last 12m",
                           sex_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           sex_phy_sev_12m = "Bin. for sex. and phy. IPV in the last 12m",
                           sex_phy_ipv_sev_index = "Sex. IPV sever. index z-scr",
                           eco_ipv_sev_12m = "Bin. for eco. IPV in the last 12m",
                           eco_ipv_sev_index = "Eco. IPV sever. index z-scr",
                           all_ipv_sev_12m = "Bin. for at least one type of IPV (exclud. eco.) in the last 12m",
                           all_ipv_sev_index = "All IPV sev. index z-scr")
  )

# Create detailed label with counts and proportions per treatment arm for PI program
mainResults_het_pi <- mainResults_het_pi %>%
  group_by(estimate_quant, het_var) %>%
  mutate(
    lab = sprintf(
      "%s %s \n N treat (pct): %s (%s) \n N Capital (pct): %s (%s) \n N Psychosocial (pct): %s (%s) \n N Full (pct): %s (%s).",
      first(het_var),
      first(estimate_quant),
      scales::comma(first(N_treat)),
      scales::comma(first(prop)),
      scales::comma(first(Ntype_treat)),
      scales::comma(first(prop_per_treat)),
      scales::comma(nth(Ntype_treat, 2)),
      scales::comma(nth(prop_per_treat, 2)),
      scales::comma(nth(Ntype_treat,3)),
      scales::comma(nth(prop_per_treat,3))
    )
  ) %>%
  ungroup()

# Remove redundant prefixes from PI labels
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("decile", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("quartile", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)] <- gsub("median", "", mainResults_het_pi$lab[-c(1:3,31, 41:43, 56, 61:63, 67)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N treat (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Capital (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Psychosocial (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)
mainResults_het_pi$lab[-c(1:3,31)] <- gsub("N Full (pct): ", "", mainResults_het_pi$lab[-c(1:3,31)], fixed = T)

# Remove redundant prefixes from Tekavoul labels
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("decile", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("quartile", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1,11,16)] <- gsub("median", "", mainResults_het_cash$lab[-c(1,11,16)], fixed = T)
mainResults_het_cash$lab[-c(1)] <- gsub("N treat (pct): ", "", mainResults_het_cash$lab[-c(1)], fixed = T)

# Convert labels and factor variables to ordered factors for plotting
mainResults_het_cash$lab <- fct_inorder(mainResults_het_cash$lab)
mainResults_het_cash$typeTreat <- fct_inorder(mainResults_het_cash$typeTreat)
mainResults_het_cash$het_var <- fct_inorder(mainResults_het_cash$het_var)
mainResults_het_pi$lab <- fct_inorder(mainResults_het_pi$lab)
mainResults_het_pi$typeTreat <- fct_inorder(mainResults_het_pi$typeTreat)
mainResults_het_pi$het_var <- fct_inorder(mainResults_het_pi$het_var)

# Create plot for Tekavoul program
g1 <- mainResults_het_cash %>%
  ggplot(aes(x = lab, y = pe, shape = typeTreat, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_wrap(~het_var, scales = "free_x", shrink=TRUE, drop=TRUE) +
  labs(
    x = "", y = "Effect",
    subtitle = first(mainResults_het_cash$depvar),
    caption = sprintf("N = %s Tekavoul", first(mainResults_het_cash$N)),
    shape =""
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), legend.direction = "horizontal")

# Save plot for Tekavoul
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_cash$name),"_",first(mainResults_het_cash$depvar),"_ML.jpeg"), g1, width = 27, height = 16, units = "cm")

# Create plot for PI program
g2 <- mainResults_het_pi %>%
  ggplot(aes(x = lab, y = pe, shape = typeTreat, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_wrap(~het_var, scales = "free_x", shrink=TRUE, drop=TRUE) +
  labs(
    x = "", y = "Effect",
    subtitle = first(mainResults_het_pi$depvar),
    caption = sprintf("N = %s productive inclusion", first(mainResults_het_pi$N)),
    shape =""
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), legend.direction = "horizontal")

# Save plot for PI
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_pi$name),"_",first(mainResults_het_pi$depvar),"_ML.jpeg"), g2, width = 27, height = 16, units = "cm")

# Combine the two plots into a single figure
arrange_plot <- ggpubr::ggarrange(g1, g2, common.legend = FALSE, nrow = 2, ncol = 1)

# Printing the plot
arrange_plot

# Save the combined plot
ggsave(paste0("output/heterogeneity/predicted ml/",first(mainResults_het_cash$het_var),"_",out_ipv,"_ML_estimates.jpeg"), arrange_plot, width = 27, height = 16, units = "cm")

```

```{r}
# remove data to free space
rm(list = ls())
```

