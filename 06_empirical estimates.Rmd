---
title: "Cash Plus, Safety Plus? Intimate Partner Violence and Productive Inclusion in Mauritania"
subtitle: "Empirical strategy & Results"
author: "IBRAHIM KASSOUM Habibou"
date: '`r format (Sys.Date(), "%d %B %Y")`'
output: 
  officedown::rdocx_document:
    mapstyles:
      Normal: ['First Paragraph']
---


```{r setup, include=FALSE}
# Set random seed for reproducibility
set.seed(7654)

# Set number of decimal places to display
options(digits = 3)

# Configure knitr chunk options:
knitr::opts_chunk$set(
 echo = FALSE,          # Don't show R code in output
 message = FALSE,       # Don't show messages
 warning = FALSE,       # Don't show warnings
 cache = FALSE,         # Don't cache results
 fig.align = 'center',  # Center figures
 fig.width = 6.3,         # Figure width in inches
 fig.height= 7,          # Figure height in inches
 fig.asp = 0.8,       # Figure aspect ratio (golden ratio)
 fig.show = "hold"      # Hold multiple plots until end of chunk
)

# Set dplyr print options to show 6 rows max
options(dplyr.print_min = 6, dplyr.print_max = 6)

```


```{r, include=FALSE, results='hide', echo=FALSE}

######################## Importing library and external files ##################
### List of required packages
required_packages <- c("tidyverse", "dplyr","officedown", "officer", "gtsummary",
                       "stargazer", "lfe","labelled","car","broom","purrr",
                       "flextable")

### Check if packages are installed
missing_packages <- setdiff(required_packages, installed.packages()[,"Package"])

### Install missing packages
if (length(missing_packages) > 0) {
  install.packages(missing_packages)
}

### Load all packages
lapply(required_packages, library, character.only = TRUE)

# Remove all objects
rm(list = ls())

# Source functions from external file
source("functions.R")
```


```{r echo=F}

set_gtsummary_theme(theme_gtsummary_compact())

######### Create default BioAVR table from dataframe
#
# Dependencies : dplyr, flextable, officer
# source link : https://www.r-bloggers.com/2021/11/publication-ready-tables-with-flextable-and-own-theme-in-r/
customtab_defaults <- function(){
set_flextable_defaults(font.family = "Times New Roman",
font.size = 10,
border.color = "black")
}
FitFlextableToPage <- function(ft, pgwidth = 8){

  ft_out <- ft %>% autofit()

  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
}
custom_tab <- function(df, header, footer){
flextable(df) %>%
add_header_lines(header) %>%
add_footer_lines(footer) %>%
bold(i = 1, part = "header") %>%
hline_top(part = "header",
border = fp_border(color = "white",
width = 3,
style = "solid")) %>%
hline(i = 1,
part = "header",
border = fp_border(color = "black",
width = 0.25,
style = "solid")) %>%
hline_top(part = "body",
border = fp_border(color = "black",
width = 0.25,
style = "solid")) %>%
hline_bottom(part = "body",
border = fp_border(color = "black",
width = 0.25,
style = "solid")) %>%
hline_bottom(part = "footer",
border = fp_border(color = "black",
width = 0.25,
style = "solid")) %>%
border_inner_h(part = "body",
border = fp_border(color = "black",
width = 0.25,
style = "dotted")) %>%
autofit(part = "body") %>%
bg(part = "body", bg = "white") %>%
align(part = "all", align = "center") %>%
align(j = 1, part = "all", align = "left")
}
```


```{r}

######################## Loading the datasets ##################################
# Read the file containing the global dataframe into followup_MRT_hh

#allrounds_MRT_hh <-  readRDS(paste0(getwd(),"/output/data/allrounds_MRT_hh.rds"))

#baseline_MRT_hh <- readRDS(paste0(getwd(),"/output/data/baseline_MRT_hh.rds"))

followup_MRT_hh <- readRDS(paste0(getwd(),"/output/data/followup_MRT_hh_and_ipv_MRT_hh.rds"))
followup_MRT_hh_spill <- readRDS(paste0(getwd(),"/output/data/followup_MRT_hh_spill_and_ipv_MRT.rds"))

# Convert treatment variables from numeric to factor variables for both datasets
# This is useful for regression analysis and plotting as factors are treated as categorical variables

 # Convert PM treatment to factor
#baseline_MRT_hh$treatment_pi <- haven::as_factor(baseline_MRT_hh$treatment_pi)          
followup_MRT_hh$treatment_pi <- haven::as_factor(followup_MRT_hh$treatment_pi)
followup_MRT_hh_spill$treatment_pi_spill <- haven::as_factor(followup_MRT_hh_spill$treatment_pi_spill) 
followup_MRT_hh_spill$treatment_pi_pool_spill <- haven::as_factor(followup_MRT_hh_spill$treatment_pi_pool_spill) 
# Convert cash transfer treatment to factor
#baseline_MRT_hh$treatment_csh_trnsfr <- haven::as_factor(baseline_MRT_hh$treatment_csh_trnsfr) 
followup_MRT_hh$treatment_csh_trnsfr <- haven::as_factor(followup_MRT_hh$treatment_csh_trnsfr)

```

<!---BLOCK_TOC--->




<!---BLOCK_LANDSCAPE_START--->
\newpage
# Summary


**Overall Effects**

* Most coefficients across all intervention types and IPV measures are statistically non-significant, suggesting that the interventions generally had limited measurable impact on reducing intimate partner violence.
* For some types of violence, especially physical violence and sexual violence, the baseline prevalence is quite low (approximately 1 percent and 4.5 percent respectively), which creates a "floor effect" making detection of significant effects statistically challenging.
* Comparisons between treatment arms (Full vs. Psychosocial, Full vs. Capital, Psychosocial vs. Capital) revealed no statistically significant differences, indicating no clear advantage of one intervention approach over others.


**Heterogeneity Analysis Findings**

The heterogeneity analysis revealed several important differential effects:

* Partner-Controlling Behavior: the Tekavoul cash transfer program increased the risk of partner-controlling behavior specifically for female-headed households. Conversely, partner-controlling behavior decreased for beneficiaries of the productive inclusion program among women with above-median baseline control over household resources.

* Emotional Violence: the productive inclusion program slightly increased the risk of emotional violence for women with low baseline control over household resources, while showing no significant effects for women with high control. Emotional violence increased among Tekavoul program beneficiaries with above-median years of education compared to the control group.

* Physical Violence: no significant effects were detected on physical violence risk, likely due to the low baseline prevalence limiting statistical power.

* Sexual Violence: sexual violence decreased for recipients of the capital and full packages with the highest share of resources owned by their partner. Sexual violence increased for Tekavoul program beneficiaries with above-median years of education compared to the control group.

* Economic Violence: the full package slightly increased the risk of economic violence for productive inclusion program beneficiaries with low baseline control over household resources.

* Other IPV Indicators: little to no effect was found on other IPV indicators across the intervention groups.

\newpage

# Empirical strategy 

**Productive inclusion Program**

We are interested in measuring the causal effect of the productive inclusion on IPV risk at the second follow up survey, which is three years after the start of the intervention. In our base estimation, we take into account the study design and control for the level of stratification by estimating the following model:


$$
Y_{ic} = \beta_0 + \beta_1 Capital_{c} + \beta_2 Psychosocial_{c} + \beta_3 Full_{c} + \beta_4 SP_{c} + \delta_{i} + \epsilon_{i} (1)
$$

$Y_{ic}$ is the IPV outcome of interest for woman *i* from cluster *c* at the second follow up survey, and $SP_{c}$ is a control for the social promotion space which is the level of stratification. $Capital_{c}$, $Phychosocial_{c}$ and $Full_{c}$ are indicators for the treatment group of the cluster *c*. We also include enumerator fixed effect $\delta_{i}$ to control for potential biases that might arise from differences in enumerators characteristics or how they conduct interviews and build rapport with respondents. This is particularly important when measuring sensitive outcomes such as IPV, as reports can vary depending on the interviewer's approach to the respondent. The error term $\epsilon_{i}$ captures unobserved factors affecting IPV outcomes. 
The coefficients $\beta_1$, $\beta_2$ and $\beta_3$ represent the intent-to-treat (ITT) effects of the *capital*, *psychosocial*, and *full* treatment respectively. These coefficients measure the average effect of being assigned to each treatment group compared to the control group. Given the randomized design, these estimates can be interpreted as causal effects as long as the randomization was properly implemented and there are no systematic differences in attrition across treatment arms. To account for the clustered nature of our data and potential correlation of outcomes within clusters, we compute standard errors clustered at the cluster level, which is the unit of randomization. 

**Additionally, we will present results both with and without baseline covariates and variables that are significantly different between treatment and control at baseline at the 10 percent level or lower to check the robustness of our findings and potentially improve precision.** (upcoming)



**Tekavoul Program** 

To estimate the impact of the national cash transfer program (Tekavoul) on IPV risk, the previous equation (1) is modified to the following equation:

$$
Y_{ic} = \theta_0 + \theta_1 CashAssignment_{c} + \theta_2 SP_{c} + \delta_{i} + \epsilon_{i} (2)
$$

Where \( \text{CashAssignment}_{c} \) is an indicator for the assignment to the Tekavoul cash transfer beneficiary of cluster \( c \). The coefficient \( \theta_1 \) represents the intent-to-treat (ITT) effect of the *cash assignment*.


# Results


```{r}

#####################################################################################
######################### Regression on the nbr of event ############################
#####################################################################################

# Define the list of outcomes variables

control_ipv_vars <- c("control_ipv_sev_12m","control_ipv_sev_index")
emotional_ipv_vars <- c("emo_ipv_sev_12m", "emo_ipv_sev_index") #"emo_ipv_inten_index","emo_sev_12m",
physical_ipv_vars <- c("phy_ipv_sev_12m","phy_ipv_sev_index")
sexual_ipv_vars <- c("sex_ipv_sev_12m", "sex_ipv_sev_index") #"sex_ipv_inten_index","sex_sev_12m",
sexual_physical_ipv_vars  <- c("sex_phy_ipv_sev_12m","sex_phy_ipv_sev_index")
economic_ipv_vars <- c("eco_ipv_sev_12m", "eco_ipv_sev_index") #"eco_ipv_inten_index","eco_sev_12m",
other_ipv_vars <- c("all_ipv_sev_12m","all_ipv_sev_index") #,"all2_ipv_12m"

# All outcomes variables
listOutcomes=c(control_ipv_vars, emotional_ipv_vars, physical_ipv_vars, sexual_ipv_vars, sexual_physical_ipv_vars, economic_ipv_vars, other_ipv_vars)


# Define the two treatment variables ("treatment_csh_trnsfr",)
treatment_vars=c("treatment_csh_trnsfr","treatment_pi","treatment_pi_pool")

# Label for the treatment variables
labels_vars = c("Cash transfert","Capital","Psychosocial","Full")

# Define controls variables for the regression 
control_vars = c(
                "pben_handicap_bl", 
                #"hhh_edu_bl", 
                #"pben_edu_bl", 
                "hhh_prim_bl",
                "pben_prim_bl", 
                #"age_at_mrrg", 
                #"het_nbr_elder",
                #"age_gap",
                "het_wtht_adult_mal", 
                #"pben_lit_bl", 
                "hhh_fem_bl",
                #"mem_n_bl",
                "same_cb",
                #"hhh_poly",
                #"pben_poly",
                #"hhh_age",
                "pben_age_bl",
                "hhh_edu_bl",
                "pben_edu_bl",
                "hhh_lit_bl",
                "pben_lit_bl"
            # 
            # "ctrl_hh_index_tr_bl",
            # "consum",
            # "ctrl_earn_index_tr_bl",
            # "tot_hh_rev",
            # "hhh_age_bl",
            # "soc_cohsn_index_tr_bl",
            # "intrahh_vars_index_tr_bl",
            # "soc_stand_index_bl",
            # ##"rev_sum_bohh",
            # #"pben_age_bl",
            # # "age_gap",
            # # "nbr_hh_number",
            # "age_at_mrrg",
            # "region",
            #  "gse_index_tr_bl",
            #  "shr_adult",
            # "tot_ben_rev12_98_ppp_bl", 
            # "bus_assval_98_ppp_bl", 
            # "nbr_kid", 
            # "shr_adult_fem",
            # "tot_ben_pro12_98_ppp_bl", 
            # "nbr_adult_tot", 
            # #"hhh_edu_bl", 
            # #"shr_adult_mal", 
            # "nbr_adult",
            # "los1_bl", 
            # "shr_adult_fem_mal", 
            # "los2_bl", 
            # "dec_pow_bus_d_bl", 
            # "nbr_adult_fem_tot"
            )


# Define strata variables: strata
strata_vars <- c("") 

# Define cluster variables 
cluster_vars <- c("cluster")

followup_MRT_hh_control_pi <- followup_MRT_hh %>% filter(treatment_pi=="Control") %>% 
      filter(reg_hh_pi_mrt==1)

followup_MRT_hh_control_csh_trnsfr <- followup_MRT_hh %>% filter(treatment_csh_trnsfr=="Control") %>% 
      filter(reg_hh_csh_mrt==1)
# Title for each index
control_ipv_title = "**Table : effect of the program on controlling Behavior**"
emotional_ipv_title = "**Table : effect of the program on emotional violence**"
physical_ipv_title = "**Table : effect of the program on physical violence**"
sexual_ipv_title = "**Table : effect of the program on sexual violence**"
economic_ipv_title = "**Table : effect of the program on economic violence**"
other_ipv_title = "**Table : effect of the program on other ipv index**"
```

## Controlling Behavior

```{r}
######################## Fist estimate ##########################################


# Use map_dfr to iterate over each outcome and estimate effects for different treatment variables
mainResults <- map_dfr(treatment_vars, function(curr_treat_var) {
  tempResults <- map_dfr(control_ipv_vars, function(depvar) {    
    bind_rows(
      getEstimateGlobal(depvar, curr_treat_var, control_vars, strata_vars, cluster_vars, followup_MRT_hh) %>%
        mutate(depvar = depvar, curr_treat_var = curr_treat_var)
    )
  })
})

# Extract results for different outcomes variables 
## Cash transfer regression models
# Extract specific models for cash transfer from the main results
m11 <- mainResults$results_base[[1]]  # First cash transfer model
m12 <- mainResults$results_base[[2]]  # Second cash transfer model
# Alternative way to filter cash transfer models from the dataset
m1 <- mainResults %>% 
  filter(curr_treat_var=="treatment_csh_trnsfr") %>% 
  select(results_base) %>% 
  as.list()

## Productive inclusion regression models
# Extract specific models for productive inclusion from the main results
m21 <- mainResults$results_base[[3]]  # First productive inclusion model
m22 <- mainResults$results_base[[4]]  # Second productive inclusion model
m31 <- mainResults$results_base[[5]]  # First pool productive inclusion model
m32 <- mainResults$results_base[[6]]  # Second pool productive inclusion model
# Alternative way to filter productive inclusion models from the dataset
m2 <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi") %>% 
  select(results_base) %>% 
  as.list()

# Extract interaction terms for productive inclusion treatments
# Full Psychosocial interaction term
full_Psychosocial <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi") %>% 
  select(full_Psychosocial) %>% 
  pull() %>% 
  as.numeric()

# Full Capital interaction term
full_Capital <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi") %>% 
  select(full_Capital) %>% 
  pull() %>% 
  as.numeric()

# Psychosocial and Capital interaction term
psychosocial_Capital <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi") %>% 
  select(psychosocial_Capital) %>% 
  pull() %>% 
  as.numeric()

# Initialize empty vectors to store descriptive statistics
# These will store mean and standard deviation for each outcome variable
mean_values_pi <- c()  # Vector to store mean values
sd_values_pi <- c()   # Vector to store standard deviation values
mean_values_csh_trnsfr <- c()  
sd_values_csh_trnsfr <- c()   

# Calculate descriptive statistics for each outcome variable
# Loop through the list of outcome variables
for (depvar in control_ipv_vars) {
  # Calculate and round mean, ignoring NA values
  mean_values_pi <- c(mean_values_pi,  round(mean(followup_MRT_hh_control_pi[[depvar]], na.rm = TRUE), 3))
  mean_values_csh_trnsfr <- c(mean_values_csh_trnsfr,  round(mean(followup_MRT_hh_control_csh_trnsfr[[depvar]], na.rm = TRUE), 3))
  # Calculate and round standard deviation, ignoring NA values
  sd_values_pi <- c(sd_values_pi,  round(sd(followup_MRT_hh_control_pi[[depvar]], na.rm = TRUE), 3))
  sd_values_csh_trnsfr <- c(sd_values_csh_trnsfr,  round(sd(followup_MRT_hh_control_csh_trnsfr[[depvar]], na.rm = TRUE), 3))
}

# Create lists of models for easier processing
models_pi <- list(m21, m22)  # Productive inclusion models
models_pi_pool <- list(m31, m32)  # Productive inclusion models pool
models_csh_trnsfr <- list(m11, m12)  # Cash transfer models

# Create regression tables for Productive Inclusion models
tbl_list_pi <- map(models_pi, ~ tbl_regression(.x, 
                                         exponentiate = FALSE,  # Keep coefficients as-is 
                                         estimate_fun = ~ style_number(.x, digits = 2),
                                         include="treatment_pi")  %>% 
                  add_significance_stars(pattern = "{estimate}{stars} \n ({std.error})",
                         hide_se = TRUE) %>%
  add_glance_table(include = c(nobs, r.squared)))

tbl_list_pi_pool <- map(models_pi_pool, ~ tbl_regression(.x, 
                                         exponentiate = FALSE,  # Keep coefficients as-is 
                                         estimate_fun = ~ style_number(.x, digits = 2),
                                         include="treatment_pi_pool")  %>% 
                  add_significance_stars(pattern = "{estimate}{stars} \n ({std.error})",
                         hide_se = TRUE)%>%
  add_glance_table(include = c(nobs, r.squared)))

# Create regression tables for Cash Transfer models
tbl_list_csh_trnsfr <- map(models_csh_trnsfr, ~ tbl_regression(.x, 
                                         exponentiate = FALSE,  # Keep coefficients as-is
                                         estimate_fun = ~ style_number(.x, digits = 2),
                                         include="treatment_csh_trnsfr")  %>% 
                  add_significance_stars(pattern = "{estimate}{stars} \n ({std.error})",
                         hide_se = TRUE)%>%
  add_glance_table(include = c(nobs, r.squared)))

# Modify headers for the Productive Inclusion and Cash Transfer models

tbl_list_pi[[1]] <- tbl_list_pi[[1]] %>%
   modify_header(estimate = "Binary for \n control IPV In the \n last 12 months")

tbl_list_csh_trnsfr[[1]] <- tbl_list_csh_trnsfr[[1]] %>%
   modify_header(estimate = "Binary for \n control IPV In the \n last 12 months")

tbl_list_pi_pool[[1]] <- tbl_list_pi_pool[[1]] %>%
   modify_header(estimate = "Binary for \n control IPV In the \n last 12 months")

## Refusal = 0
tbl_list_pi[[2]] <- tbl_list_pi[[2]] %>%
   modify_header(estimate = "Control \n IPV sev. \n index")

tbl_list_csh_trnsfr[[2]] <- tbl_list_csh_trnsfr[[2]] %>%
   modify_header(estimate = "Control \n IPV sev. \n index")

tbl_list_pi_pool[[2]] <- tbl_list_pi_pool[[2]] %>%
   modify_header(estimate = "Control \n IPV sev. \n index")
 


# Merge the stacked tables into a single table with column headers
## Cash transfert
tbl_csh_trnsfr <- tbl_merge(
  tbls = list(tbl_list_csh_trnsfr[[1]],# First models (Refusal = missing)
              tbl_list_csh_trnsfr[[2]] # Second models (Refusal = 0)
              ),  # Third models (Refusal = 1)
  tab_spanner = c("(1)", "(2)")
)

## Productive inclusion
tbl_pi <- tbl_merge(
  tbls = list(tbl_list_pi[[1]], # First models (Refusal = missing)
              tbl_list_pi[[2]] # Second models (Refusal = 0)
              ), # Third models (Refusal = 1)
  tab_spanner = c("(1)", "(2)")
)

## Pool Productive inclusion
tbl_pi_pool <- tbl_merge(
  tbls = list(tbl_list_pi_pool[[1]], # First models (Refusal = missing)
              tbl_list_pi_pool[[2]] # Second models (Refusal = 0)
              ), # Third models (Refusal = 1)
  tab_spanner = c("(1)", "(2)")
)

# Create a list of stacked tables combining Cash Transfer and Productive Inclusion models
# Each list element combines the corresponding models from both treatment types
tbl <- tbl_stack(list(tbl_csh_trnsfr, tbl_pi, tbl_pi_pool))

# Modify table body to customize variable labels
tbl <- tbl %>%
  modify_table_body(~ .x %>%
                      mutate(label = case_when(
                        # Rename specific treatment variables
                        variable == "treatment_piCapital" ~ "Capital",
                        variable == "treatment_piPsychosocial" ~ "Psychosocial",
                        variable == "treatment_piFull" ~ "Full",
                        variable == "treatment_pi_poolPool" ~ "Full",
                        # Label cash transfer and productive inclusion treatments
                        variable == "treatment_csh_trnsfr" & is.na(term_1) ~ "Tekavoul",
                        variable == "treatment_pi"& is.na(term_1) ~ "Productive Inclusion",
                        variable == "treatment_pi_pool"& is.na(term_1) ~ "Productive Inclusion (Pool)",
                        TRUE ~ label  # Keep original labels for other variables
                      )))

# Create a tribble (transposed tibble) with additional rows for the table
# These rows include control mean, standard deviation, and interaction terms _csh_trnsfr
additional_rows <- tribble(
  ~variable,  ~var_label, ~label, ~estimate_1, ~estimate_2, 
  
  "Control mean @ follow up Tekavoul","Control mean @ follow up Tekavoul","Control mean @ follow up Tekavoul",mean_values_csh_trnsfr[1], mean_values_csh_trnsfr[2], 
  "Control SD @ follow up Tekavoul","Control SD @ follow up Tekavoul","Control SD @ follow up Tekavoul",  sd_values_csh_trnsfr[1], sd_values_csh_trnsfr[2],   
  
  "Control mean @ follow up PI","Control mean @ follow up PI","Control mean @ follow up PI",mean_values_pi[1], mean_values_pi[2], 
  "Control SD @ follow up PI","Control SD @ follow up PI","Control SD @ follow up PI",  sd_values_pi[1], sd_values_pi[2], 
  
  "Full - Psychosocial","Full - Psychosocial","Full - Psychosocial",   full_Psychosocial[1], full_Psychosocial[2], 
  "Full - Capital","Full - Capital", "Full - Capital", full_Capital[1], full_Capital[2], 
  "Psychosocial - Capital","Psychosocial - Capital","Psychosocial - Capital",  psychosocial_Capital[1], psychosocial_Capital[2]
)

# Append the additional rows to the table body
tbl$table_body <- bind_rows(tbl$table_body, additional_rows)

# Final table formatting
tbl <- tbl %>%
  # Set table caption
  modify_caption(control_ipv_title) %>%
  # Modify header for the label column
  modify_header(label = "**Outcome**") %>%
  # Remove all existing footnotes
  modify_footnote(everything() ~ NA) %>%
  modify_footnote(all_stat_cols() ~ NA) %>%
  # Add custom footnote with methodological details
  modify_footnote(label = "Notes: Results presented are OLS estimates that include controls for randomization strata (commune) and, where possible, baseline outcomes.  We control for social promotion intervention. Enumerator fixed effects are included in all regression. We estimate the regressions for the productive beneficiaries aged 18-49 only. Robust standard errors are shown in parentheses, clustered at the village proxy level. *** p < 0.01, ** p < 0.05, * p < 0.1.")

# Print the final table
tbl

```

## Emotional Violence

```{r}
######################## Fist estimate ##########################################


# Use map_dfr to iterate over each outcome and estimate effects for different treatment variables
mainResults <- map_dfr(treatment_vars, function(curr_treat_var) {
  tempResults <- map_dfr(emotional_ipv_vars, function(depvar) {    
    bind_rows(
      getEstimateGlobal(depvar, curr_treat_var, control_vars, strata_vars, cluster_vars, followup_MRT_hh) %>%
        mutate(depvar = depvar, curr_treat_var = curr_treat_var)
    )
  })
})

# Extract results for different outcomes variables 
## Cash transfer regression models
# Extract specific models for cash transfer from the main results
m11 <- mainResults$results_base[[1]]  # First cash transfer model
m12 <- mainResults$results_base[[2]]  # Second cash transfer model

# Alternative way to filter cash transfer models from the dataset
m1 <- mainResults %>% 
  filter(curr_treat_var=="treatment_csh_trnsfr") %>% 
  select(results_base) %>% 
  as.list()

## Productive inclusion regression models
# Extract specific models for productive inclusion from the main results
m21 <- mainResults$results_base[[3]]  # First productive inclusion model
m22 <- mainResults$results_base[[4]]  # Second productive inclusion model

m31 <- mainResults$results_base[[5]]  # First pool productive inclusion model
m32 <- mainResults$results_base[[6]]  # Second pool productive inclusion model

# Alternative way to filter productive inclusion models from the dataset
m2 <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi") %>% 
  select(results_base) %>% 
  as.list()

# Extract interaction terms for productive inclusion treatments
# Full Psychosocial interaction term
full_Psychosocial <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi") %>% 
  select(full_Psychosocial) %>% 
  pull() %>% 
  as.numeric()

# Full Capital interaction term
full_Capital <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi") %>% 
  select(full_Capital) %>% 
  pull() %>% 
  as.numeric()

# Psychosocial and Capital interaction term
psychosocial_Capital <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi") %>% 
  select(psychosocial_Capital) %>% 
  pull() %>% 
  as.numeric()

# Initialize empty vectors to store descriptive statistics
# These will store mean and standard deviation for each outcome variable
mean_values_pi <- c()  # Vector to store mean values
sd_values_pi <- c()   # Vector to store standard deviation values
mean_values_csh_trnsfr <- c()  
sd_values_csh_trnsfr <- c()   
# Calculate descriptive statistics for each outcome variable
# Loop through the list of outcome variables
for (depvar in emotional_ipv_vars) {
   # Calculate and round mean, ignoring NA values
  mean_values_pi <- c(mean_values_pi,  round(mean(followup_MRT_hh_control_pi[[depvar]], na.rm = TRUE), 3))
  mean_values_csh_trnsfr <- c(mean_values_csh_trnsfr,  round(mean(followup_MRT_hh_control_csh_trnsfr[[depvar]], na.rm = TRUE), 3))
  # Calculate and round standard deviation, ignoring NA values
  sd_values_pi <- c(sd_values_pi,  round(sd(followup_MRT_hh_control_pi[[depvar]], na.rm = TRUE), 3))
  sd_values_csh_trnsfr <- c(sd_values_csh_trnsfr,  round(sd(followup_MRT_hh_control_csh_trnsfr[[depvar]], na.rm = TRUE), 3))
}

# Create lists of models for easier processing
models_pi <- list(m21, m22)  # Productive inclusion models
models_pi_pool <- list(m31, m32)  # Productive inclusion models pool
models_csh_trnsfr <- list(m11, m12)  # Cash transfer models

# Create regression tables for Productive Inclusion models
tbl_list_pi <- map(models_pi, ~ tbl_regression(.x, 
                                         exponentiate = FALSE,  # Keep coefficients as-is 
                                         estimate_fun = ~ style_number(.x, digits = 2),
                                         include="treatment_pi")  %>% 
                  add_significance_stars(pattern = "{estimate}{stars} \n ({std.error})",
                         hide_se = TRUE) %>%
  add_glance_table(include = c(nobs, r.squared)))

tbl_list_pi_pool <- map(models_pi_pool, ~ tbl_regression(.x, 
                                         exponentiate = FALSE,  # Keep coefficients as-is 
                                         estimate_fun = ~ style_number(.x, digits = 2),
                                         include="treatment_pi_pool")  %>% 
                  add_significance_stars(pattern = "{estimate}{stars} \n ({std.error})",
                         hide_se = TRUE)%>%
  add_glance_table(include = c(nobs, r.squared)))

# Create regression tables for Cash Transfer models
tbl_list_csh_trnsfr <- map(models_csh_trnsfr, ~ tbl_regression(.x, 
                                         exponentiate = FALSE,  # Keep coefficients as-is
                                         estimate_fun = ~ style_number(.x, digits = 2),
                                         include="treatment_csh_trnsfr")  %>% 
                  add_significance_stars(pattern = "{estimate}{stars} \n ({std.error})",
                         hide_se = TRUE)%>%
  add_glance_table(include = c(nobs, r.squared)))

# Modify headers for the Productive Inclusion and Cash Transfer models

tbl_list_pi[[1]] <- tbl_list_pi[[1]] %>%
   modify_header(estimate = "Binary \n for emo. IPV \n in the last 12 months")

tbl_list_csh_trnsfr[[1]] <- tbl_list_csh_trnsfr[[1]] %>%
   modify_header(estimate = "Binary \n for emo. IPV \n in the last 12 months")

tbl_list_pi_pool[[1]] <- tbl_list_pi_pool[[1]] %>%
   modify_header(estimate = "Binary \n for emo. IPV \n in the last 12 months")
 

tbl_list_pi[[2]] <- tbl_list_pi[[2]] %>%
   modify_header(estimate = "Emo. \n IPV s \n index")

tbl_list_csh_trnsfr[[2]] <- tbl_list_csh_trnsfr[[2]] %>%
   modify_header(estimate = "Emo. \n IPV sev. \n index")

tbl_list_pi_pool[[2]] <- tbl_list_pi_pool[[2]] %>%
   modify_header(estimate = "Emo. \n IPV sev. \n index")


# Merge the stacked tables into a single table with column headers

tbl_csh_trnsfr <- tbl_merge(
  tbls = list(tbl_list_csh_trnsfr[[1]],# 
              tbl_list_csh_trnsfr[[2]] # continous
              ),  # lst 12 mnths: Third models (Refusal = 1)
  tab_spanner = c("(1)", "(2)")
)

## Productive inclusion
tbl_pi <- tbl_merge(
  tbls = list(tbl_list_pi[[1]],# Ever: First models (Refusal = missing)
              tbl_list_pi[[2]] # Ever: Second models (Refusal = 0)
              ),# Severity index
  tab_spanner = c("(1)", "(2)")
)

## Pool Productive inclusion
tbl_pi_pool <- tbl_merge(
  tbls = list(tbl_list_pi_pool[[1]],# Ever: First models (Refusal = missing)
              tbl_list_pi_pool[[2]] # Ever: Second models (Refusal = 0)
              ),# Severity index
  tab_spanner = c("(1)", "(2)")
)

# Create a list of stacked tables combining Cash Transfer and Productive Inclusion models
# Each list element combines the corresponding models from both treatment types
tbl <- tbl_stack(list(tbl_csh_trnsfr, tbl_pi, tbl_pi_pool))

# Modify table body to customize variable labels
tbl <- tbl %>%
  modify_table_body(~ .x %>%
                      mutate(label = case_when(
                        # Rename specific treatment variables
                        variable == "treatment_piCapital" ~ "Capital",
                        variable == "treatment_piPsychosocial" ~ "Psychosocial",
                        variable == "treatment_piFull" ~ "Full",
                        variable == "treatment_pi_poolPool" ~ "Full",
                        # Label cash transfer and productive inclusion treatments
                        variable == "treatment_csh_trnsfr" & is.na(term_1) ~ "Tekavoul",
                        variable == "treatment_pi"& is.na(term_1) ~ "Productive Inclusion",
                        variable == "treatment_pi_pool"& is.na(term_1) ~ "Productive Inclusion (Pool)",
                        TRUE ~ label  # Keep original labels for other variables
                      )))

# Create a tribble (transposed tibble) with additional rows for the table
# These rows include control mean, standard deviation, and interaction terms
additional_rows <- tribble(
  ~variable,  ~var_label, ~label, ~estimate_1, ~estimate_2, 
  "Control mean @ follow up Tekavoul","Control mean @ follow up Tekavoul","Control mean @ follow up Tekavoul",mean_values_csh_trnsfr[1], mean_values_csh_trnsfr[2], 
  "Control SD @ follow up Tekavoul","Control SD @ follow up Tekavoul","Control SD @ follow up Tekavoul",  sd_values_csh_trnsfr[1], sd_values_csh_trnsfr[2],   
  
  "Control mean @ follow up PI","Control mean @ follow up PI","Control mean @ follow up PI",mean_values_pi[1], mean_values_pi[2], 
  "Control SD @ follow up PI","Control SD @ follow up PI","Control SD @ follow up PI",  sd_values_pi[1], sd_values_pi[2], 
  
  "Full - Psychosocial","Full - Psychosocial","Full - Psychosocial",   full_Psychosocial[1], full_Psychosocial[2], 
  "Full - Capital","Full - Capital", "Full - Capital", full_Capital[1], full_Capital[2], 
  "Psychosocial - Capital","Psychosocial - Capital","Psychosocial - Capital",  psychosocial_Capital[1], psychosocial_Capital[2]
)
# Append the additional rows to the table body
tbl$table_body <- bind_rows(tbl$table_body, additional_rows)

# Final table formatting
tbl <- tbl %>%
  # Set table caption
  modify_caption(emotional_ipv_title) %>%
  # Modify header for the label column
  modify_header(label = "**Outcome**") %>%
  # Remove all existing footnotes
  modify_footnote(everything() ~ NA) %>%
  modify_footnote(all_stat_cols() ~ NA) %>%
  # Add custom footnote with methodological details
  modify_footnote(label = "Notes: Results presented are OLS estimates that include controls for randomization strata (commune) and, where possible, baseline outcomes.  We control for social promotion intervention. Enumerator fixed effects are included in all regression. We estimate the regressions for the productive beneficiaries aged 18-49 only. Robust standard errors are shown in parentheses, clustered at the village proxy level. *** p < 0.01, ** p < 0.05, * p < 0.1.")

# Print the final table
tbl

```


## Physical Violence

```{r}
######################## Fist estimate ##########################################

# Use map_dfr to iterate over each outcome and estimate effects for different treatment variables
mainResults <- map_dfr(treatment_vars, function(curr_treat_var) {
  tempResults <- map_dfr(physical_ipv_vars, function(depvar) {    
    bind_rows(
      getEstimateGlobal(depvar, curr_treat_var, control_vars, strata_vars, cluster_vars, followup_MRT_hh) %>%
        mutate(depvar = depvar, curr_treat_var = curr_treat_var)
    )
  })
})

# Extract results for different outcomes variables 
## Cash transfer regression models
# Extract specific models for cash transfer from the main results
m11 <- mainResults$results_base[[1]]  # First cash transfer model
m12 <- mainResults$results_base[[2]]  # Second cash transfer model

## Productive inclusion regression models
# Extract specific models for productive inclusion from the main results
m21 <- mainResults$results_base[[3]]  # First productive inclusion model
m22 <- mainResults$results_base[[4]]  # Second productive inclusion model


m31 <- mainResults$results_base[[5]]  # First pool productive inclusion model
m32 <- mainResults$results_base[[6]]  # Second pool productive inclusion model


# Alternative way to filter cash transfer models from the dataset
m1 <- mainResults %>% 
  filter(curr_treat_var=="treatment_csh_trnsfr") %>% 
  select(results_base) %>% 
  as.list()

# Alternative way to filter productive inclusion models from the dataset
m2 <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi") %>% 
  select(results_base) %>% 
  as.list()

# Extract interaction terms for productive inclusion treatments
# Full Psychosocial interaction term
full_Psychosocial <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi") %>% 
  select(full_Psychosocial) %>% 
  pull() %>% 
  as.numeric()

# Full Capital interaction term
full_Capital <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi") %>% 
  select(full_Capital) %>% 
  pull() %>% 
  as.numeric()

# Psychosocial and Capital interaction term
psychosocial_Capital <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi") %>% 
  select(psychosocial_Capital) %>% 
  pull() %>% 
  as.numeric()

# Initialize empty vectors to store descriptive statistics
# These will store mean and standard deviation for each outcome variable
mean_values_pi <- c()  # Vector to store mean values
sd_values_pi <- c()   # Vector to store standard deviation values
mean_values_csh_trnsfr <- c()  
sd_values_csh_trnsfr <- c()   
# Calculate descriptive statistics for each outcome variable
# Loop through the list of outcome variables
for (depvar in physical_ipv_vars) {
 # Calculate and round mean, ignoring NA values
  mean_values_pi <- c(mean_values_pi,  round(mean(followup_MRT_hh_control_pi[[depvar]], na.rm = TRUE), 3))
  mean_values_csh_trnsfr <- c(mean_values_csh_trnsfr,  round(mean(followup_MRT_hh_control_csh_trnsfr[[depvar]], na.rm = TRUE), 3))
  # Calculate and round standard deviation, ignoring NA values
  sd_values_pi <- c(sd_values_pi,  round(sd(followup_MRT_hh_control_pi[[depvar]], na.rm = TRUE), 3))
  sd_values_csh_trnsfr <- c(sd_values_csh_trnsfr,  round(sd(followup_MRT_hh_control_csh_trnsfr[[depvar]], na.rm = TRUE), 3))
}

# Create lists of models for easier processing
models_pi <- list(m21, m22)  # Productive inclusion models
models_pi_pool <- list(m31, m32)  # Productive inclusion models pool
models_csh_trnsfr <- list(m11, m12)  # Cash transfer models

# Create regression tables for Productive Inclusion models
tbl_list_pi <- map(models_pi, ~ tbl_regression(.x, 
                                         exponentiate = FALSE,  # Keep coefficients as-is 
                                         estimate_fun = ~ style_number(.x, digits = 2),
                                         include="treatment_pi")  %>% 
                  add_significance_stars(pattern = "{estimate}{stars} \n ({std.error})",
                         hide_se = TRUE) %>%
  add_glance_table(include = c(nobs, r.squared)))

tbl_list_pi_pool <- map(models_pi_pool, ~ tbl_regression(.x, 
                                         exponentiate = FALSE,  # Keep coefficients as-is 
                                         estimate_fun = ~ style_number(.x, digits = 2),
                                         include="treatment_pi_pool")  %>% 
                  add_significance_stars(pattern = "{estimate}{stars} \n ({std.error})",
                         hide_se = TRUE)%>%
  add_glance_table(include = c(nobs, r.squared)))

# Create regression tables for Cash Transfer models
tbl_list_csh_trnsfr <- map(models_csh_trnsfr, ~ tbl_regression(.x, 
                                         exponentiate = FALSE,  # Keep coefficients as-is
                                         estimate_fun = ~ style_number(.x, digits = 2),
                                         include="treatment_csh_trnsfr")  %>% 
                  add_significance_stars(pattern = "{estimate}{stars} \n ({std.error})",
                         hide_se = TRUE)%>%
  add_glance_table(include = c(nobs, r.squared)))

# Modify headers for the Productive Inclusion and Cash Transfer models

tbl_list_pi[[1]] <- tbl_list_pi[[1]] %>%
   modify_header(estimate = "Binary \n for phy. IPV \n in the last 12 months")

tbl_list_csh_trnsfr[[1]] <- tbl_list_csh_trnsfr[[1]] %>%
   modify_header(estimate = "Binary \n for phy. IPV \n in the last 12 months")

tbl_list_pi_pool[[1]] <- tbl_list_pi_pool[[1]] %>%
   modify_header(estimate = "Binary \n for phy. IPV \n in the last 12 months")
 

tbl_list_pi[[2]] <- tbl_list_pi[[2]] %>%
   modify_header(estimate = "Phy. \n IPV sev. \n index")

tbl_list_csh_trnsfr[[2]] <- tbl_list_csh_trnsfr[[2]] %>%
   modify_header(estimate = "Phy. \n IPV sev. \n index")

tbl_list_pi_pool[[2]] <- tbl_list_pi_pool[[2]] %>%
   modify_header(estimate = "Phy. \n IPV sev. \n index")


# Merge the stacked tables into a single table with column headers

tbl_csh_trnsfr <- tbl_merge(
  tbls = list(tbl_list_csh_trnsfr[[1]],# 
              tbl_list_csh_trnsfr[[2]] #
              ),  # lst 12 mnths: Third models (Refusal = 1)
  tab_spanner = c("(1)", "(2)")
)

## Productive inclusion
tbl_pi <- tbl_merge(
  tbls = list(tbl_list_pi[[1]],
              tbl_list_pi[[2]] 

              ),# Severity index
  tab_spanner = c("(1)", "(2)")
)

## Pool Productive inclusion
tbl_pi_pool <- tbl_merge(
  tbls = list(tbl_list_pi_pool[[1]],
              tbl_list_pi_pool[[2]]
              ),# Severity index
  tab_spanner = c("(1)", "(2)")
)

# Create a list of stacked tables combining Cash Transfer and Productive Inclusion models
# Each list element combines the corresponding models from both treatment types
tbl <- tbl_stack(list(tbl_csh_trnsfr, tbl_pi, tbl_pi_pool))

# Modify table body to customize variable labels
tbl <- tbl %>%
  modify_table_body(~ .x %>%
                      mutate(label = case_when(
                        # Rename specific treatment variables
                        variable == "treatment_piCapital" ~ "Capital",
                        variable == "treatment_piPsychosocial" ~ "Psychosocial",
                        variable == "treatment_piFull" ~ "Full",
                        variable == "treatment_pi_poolPool" ~ "Full",
                        # Label cash transfer and productive inclusion treatments
                        variable == "treatment_csh_trnsfr" & is.na(term_1) ~ "Tekavoul",
                        variable == "treatment_pi"& is.na(term_1) ~ "Productive Inclusion",
                        variable == "treatment_pi_pool"& is.na(term_1) ~ "Productive Inclusion (Pool)",
                        TRUE ~ label  # Keep original labels for other variables
                      )))

# Create a tribble (transposed tibble) with additional rows for the table
# These rows include control mean, standard deviation, and interaction terms
additional_rows <- tribble(
  ~variable,  ~var_label, ~label, ~estimate_1, ~estimate_2, 
  "Control mean @ follow up Tekavoul","Control mean @ follow up Tekavoul","Control mean @ follow up Tekavoul",mean_values_csh_trnsfr[1], mean_values_csh_trnsfr[2], 
  "Control SD @ follow up Tekavoul","Control SD @ follow up Tekavoul","Control SD @ follow up Tekavoul",  sd_values_csh_trnsfr[1], sd_values_csh_trnsfr[2],   
  
  "Control mean @ follow up PI","Control mean @ follow up PI","Control mean @ follow up PI",mean_values_pi[1], mean_values_pi[2], 
  "Control SD @ follow up PI","Control SD @ follow up PI","Control SD @ follow up PI",  sd_values_pi[1], sd_values_pi[2], 
  
  "Full - Psychosocial","Full - Psychosocial","Full - Psychosocial",   full_Psychosocial[1], full_Psychosocial[2], 
  "Full - Capital","Full - Capital", "Full - Capital", full_Capital[1], full_Capital[2], 
  "Psychosocial - Capital","Psychosocial - Capital","Psychosocial - Capital",  psychosocial_Capital[1], psychosocial_Capital[2]
)

# Append the additional rows to the table body
tbl$table_body <- bind_rows(tbl$table_body, additional_rows)

# Final table formatting
tbl <- tbl %>%
  # Set table caption
  modify_caption(physical_ipv_title) %>%
  # Modify header for the label column
  modify_header(label = "**Outcome**") %>%
  # Remove all existing footnotes
  modify_footnote(everything() ~ NA) %>%
  modify_footnote(all_stat_cols() ~ NA) %>%
  # Add custom footnote with methodological details
  modify_footnote(label = "Notes: Results presented are OLS estimates that include controls for randomization strata (commune) and, where possible, baseline outcomes.  We control for social promotion intervention. Enumerator fixed effects are included in all regression. We estimate the regressions for the productive beneficiaries aged 18-49 only. Robust standard errors are shown in parentheses, clustered at the village proxy level. *** p < 0.01, ** p < 0.05, * p < 0.1.")

# Print the final table
tbl


```

## Sexual Violence

```{r}
######################## Fist estimate ##########################################

# Use map_dfr to iterate over each outcome and estimate effects for different treatment variables
mainResults <- map_dfr(treatment_vars, function(curr_treat_var) {
  tempResults <- map_dfr(sexual_ipv_vars, function(depvar) {    
    bind_rows(
      getEstimateGlobal(depvar, curr_treat_var, control_vars, strata_vars, cluster_vars, followup_MRT_hh) %>%
        mutate(depvar = depvar, curr_treat_var = curr_treat_var)
    )
  })
})

# Extract results for different outcomes variables 
## Cash transfer regression models
# Extract specific models for cash transfer from the main results
m11 <- mainResults$results_base[[1]]  # First cash transfer model
m12 <- mainResults$results_base[[2]]  


## Productive inclusion regression models
# Extract specific models for productive inclusion from the main results
m21 <- mainResults$results_base[[3]]  # First productive inclusion model
m22 <- mainResults$results_base[[4]]  # Second productive inclusion model


m31 <- mainResults$results_base[[5]]  # First pool productive inclusion model
m32 <- mainResults$results_base[[6]]  # Second pool productive inclusion model



# Alternative way to filter cash transfer models from the dataset
m1 <- mainResults %>% 
  filter(curr_treat_var=="treatment_csh_trnsfr") %>% 
  select(results_base) %>% 
  as.list()

# Alternative way to filter productive inclusion models from the dataset
m2 <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi") %>% 
  select(results_base) %>% 
  as.list()

# Extract interaction terms for productive inclusion treatments
# Full Psychosocial interaction term
full_Psychosocial <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi") %>% 
  select(full_Psychosocial) %>% 
  pull() %>% 
  as.numeric()

# Full Capital interaction term
full_Capital <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi") %>% 
  select(full_Capital) %>% 
  pull() %>% 
  as.numeric()

# Psychosocial and Capital interaction term
psychosocial_Capital <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi") %>% 
  select(psychosocial_Capital) %>% 
  pull() %>% 
  as.numeric()

# Initialize empty vectors to store descriptive statistics
# These will store mean and standard deviation for each outcome variable
mean_values_pi <- c()  # Vector to store mean values
sd_values_pi <- c()   # Vector to store standard deviation values
mean_values_csh_trnsfr <- c()  
sd_values_csh_trnsfr <- c()   
# Calculate descriptive statistics for each outcome variable
# Loop through the list of outcome variables
for (depvar in sexual_ipv_vars) {
 # Calculate and round mean, ignoring NA values
  mean_values_pi <- c(mean_values_pi,  round(mean(followup_MRT_hh_control_pi[[depvar]], na.rm = TRUE), 3))
  mean_values_csh_trnsfr <- c(mean_values_csh_trnsfr,  round(mean(followup_MRT_hh_control_csh_trnsfr[[depvar]], na.rm = TRUE), 3))
  # Calculate and round standard deviation, ignoring NA values
  sd_values_pi <- c(sd_values_pi,  round(sd(followup_MRT_hh_control_pi[[depvar]], na.rm = TRUE), 3))
  sd_values_csh_trnsfr <- c(sd_values_csh_trnsfr,  round(sd(followup_MRT_hh_control_csh_trnsfr[[depvar]], na.rm = TRUE), 3))
}

# Create lists of models for easier processing
models_pi <- list(m21, m22)  # Productive inclusion models
models_pi_pool <- list(m31, m32)  # Productive inclusion models pool
models_csh_trnsfr <- list(m11, m12)  # Cash transfer models

# Create regression tables for Productive Inclusion models
tbl_list_pi <- map(models_pi, ~ tbl_regression(.x, 
                                         exponentiate = FALSE,  # Keep coefficients as-is 
                                         estimate_fun = ~ style_number(.x, digits = 2),
                                         include="treatment_pi")  %>% 
                  add_significance_stars(pattern = "{estimate}{stars} \n ({std.error})",
                         hide_se = TRUE) %>%
  add_glance_table(include = c(nobs, r.squared)))

tbl_list_pi_pool <- map(models_pi_pool, ~ tbl_regression(.x, 
                                         exponentiate = FALSE,  # Keep coefficients as-is 
                                         estimate_fun = ~ style_number(.x, digits = 2),
                                         include="treatment_pi_pool")  %>% 
                  add_significance_stars(pattern = "{estimate}{stars} \n ({std.error})",
                         hide_se = TRUE)%>%
  add_glance_table(include = c(nobs, r.squared)))

# Create regression tables for Cash Transfer models
tbl_list_csh_trnsfr <- map(models_csh_trnsfr, ~ tbl_regression(.x, 
                                         exponentiate = FALSE,  # Keep coefficients as-is
                                         estimate_fun = ~ style_number(.x, digits = 2),
                                         include="treatment_csh_trnsfr")  %>% 
                  add_significance_stars(pattern = "{estimate}{stars} \n ({std.error})",
                         hide_se = TRUE)%>%
  add_glance_table(include = c(nobs, r.squared)))

# Modify headers for the Productive Inclusion and Cash Transfer models

tbl_list_pi[[1]] <- tbl_list_pi[[1]] %>%
   modify_header(estimate = "Binary \n for sex. IPV \n in the last 12 months")

tbl_list_csh_trnsfr[[1]] <- tbl_list_csh_trnsfr[[1]] %>%
   modify_header(estimate = "Binary \n for sex. IPV \n in the last 12 months")

tbl_list_pi_pool[[1]] <- tbl_list_pi_pool[[1]] %>%
   modify_header(estimate = "Binary \n for sex. IPV \n in the last 12 months")
 

tbl_list_pi[[2]] <- tbl_list_pi[[2]] %>%
   modify_header(estimate = "Sex. \n IPV sev. \n index")

tbl_list_csh_trnsfr[[2]] <- tbl_list_csh_trnsfr[[2]] %>%
   modify_header(estimate = "Sex. \n IPV sev. \n index")

tbl_list_pi_pool[[2]] <- tbl_list_pi_pool[[2]] %>%
   modify_header(estimate = "Sex. \n IPV sev. \n index")


# Merge the stacked tables into a single table with column headers

tbl_csh_trnsfr <- tbl_merge(
  tbls = list(tbl_list_csh_trnsfr[[1]],# Ever: First models (Refusal = missing)
              tbl_list_csh_trnsfr[[2]] # Ever: Second models (Refusal = 0)
              ),  # lst 12 mnths: Third models (Refusal = 1)
  tab_spanner = c("(1)", "(2)")
)

## Productive inclusion
tbl_pi <- tbl_merge(
  tbls = list(tbl_list_pi[[1]],# Ever: First models (Refusal = missing)
              tbl_list_pi[[2]]
              ),# Severity index
  tab_spanner = c("(1)", "(2)")
)

## Pool Productive inclusion
tbl_pi_pool <- tbl_merge(
  tbls = list(tbl_list_pi_pool[[1]],# Ever: First models (Refusal = missing)
              tbl_list_pi_pool[[2]]
              ),# Severity index
  tab_spanner = c("(1)", "(2)")
)

# Create a list of stacked tables combining Cash Transfer and Productive Inclusion models
# Each list element combines the corresponding models from both treatment types
tbl <- tbl_stack(list(tbl_csh_trnsfr, tbl_pi, tbl_pi_pool))

# Modify table body to customize variable labels
tbl <- tbl %>%
  modify_table_body(~ .x %>%
                      mutate(label = case_when(
                        # Rename specific treatment variables
                        variable == "treatment_piCapital" ~ "Capital",
                        variable == "treatment_piPsychosocial" ~ "Psychosocial",
                        variable == "treatment_piFull" ~ "Full",
                        variable == "treatment_pi_poolPool" ~ "Full",
                        # Label cash transfer and productive inclusion treatments
                        variable == "treatment_csh_trnsfr" & is.na(term_1) ~ "Tekavoul",
                        variable == "treatment_pi"& is.na(term_1) ~ "Productive Inclusion",
                        variable == "treatment_pi_pool"& is.na(term_1) ~ "Productive Inclusion (Pool)",
                        TRUE ~ label  # Keep original labels for other variables
                      )))

# Create a tribble (transposed tibble) with additional rows for the table
# These rows include control mean, standard deviation, and interaction terms
additional_rows <- tribble(
  ~variable,  ~var_label, ~label, ~estimate_1, ~estimate_2, 
  "Control mean @ follow up Tekavoul","Control mean @ follow up Tekavoul","Control mean @ follow up Tekavoul",mean_values_csh_trnsfr[1], mean_values_csh_trnsfr[2], 
  "Control SD @ follow up Tekavoul","Control SD @ follow up Tekavoul","Control SD @ follow up Tekavoul",  sd_values_csh_trnsfr[1], sd_values_csh_trnsfr[2],   
  
  "Control mean @ follow up PI","Control mean @ follow up PI","Control mean @ follow up PI",mean_values_pi[1], mean_values_pi[2], 
  "Control SD @ follow up PI","Control SD @ follow up PI","Control SD @ follow up PI",  sd_values_pi[1], sd_values_pi[2], 
  
  "Full - Psychosocial","Full - Psychosocial","Full - Psychosocial",   full_Psychosocial[1], full_Psychosocial[2], 
  "Full - Capital","Full - Capital", "Full - Capital", full_Capital[1], full_Capital[2], 
  "Psychosocial - Capital","Psychosocial - Capital","Psychosocial - Capital",  psychosocial_Capital[1], psychosocial_Capital[2]
)

# Append the additional rows to the table body
tbl$table_body <- bind_rows(tbl$table_body, additional_rows)

# Final table formatting
tbl <- tbl %>%
  # Set table caption
  modify_caption(sexual_ipv_title) %>%
  # Modify header for the label column
  modify_header(label = "**Outcome**") %>%
  # Remove all existing footnotes
  modify_footnote(everything() ~ NA) %>%
  modify_footnote(all_stat_cols() ~ NA) %>%
  # Add custom footnote with methodological details
  modify_footnote(label = "Notes: Results presented are OLS estimates that include controls for randomization strata (commune) and, where possible, baseline outcomes.  We control for social promotion intervention. Enumerator fixed effects are included in all regression. We estimate the regressions for the productive beneficiaries aged 18-49 only. Robust standard errors are shown in parentheses, clustered at the village proxy level. *** p < 0.01, ** p < 0.05, * p < 0.1.")

# Print the final table
tbl



```




## Sexual and physical violence

```{r}
######################## Fist estimate ##########################################

# Use map_dfr to iterate over each outcome and estimate effects for different treatment variables
mainResults <- map_dfr(treatment_vars, function(curr_treat_var) {
  tempResults <- map_dfr(sexual_physical_ipv_vars, function(depvar) {    
    bind_rows(
      getEstimateGlobal(depvar, curr_treat_var, control_vars, strata_vars, cluster_vars, followup_MRT_hh) %>%
        mutate(depvar = depvar, curr_treat_var = curr_treat_var)
    )
  })
})

# Extract results for different outcomes variables 
## Cash transfer regression models
# Extract specific models for cash transfer from the main results
m11 <- mainResults$results_base[[1]]  # First cash transfer model
m12 <- mainResults$results_base[[2]]  


## Productive inclusion regression models
# Extract specific models for productive inclusion from the main results
m21 <- mainResults$results_base[[3]]  # First productive inclusion model
m22 <- mainResults$results_base[[4]]  # Second productive inclusion model


m31 <- mainResults$results_base[[5]]  # First pool productive inclusion model
m32 <- mainResults$results_base[[6]]  # Second pool productive inclusion model



# Alternative way to filter cash transfer models from the dataset
m1 <- mainResults %>% 
  filter(curr_treat_var=="treatment_csh_trnsfr") %>% 
  select(results_base) %>% 
  as.list()

# Alternative way to filter productive inclusion models from the dataset
m2 <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi") %>% 
  select(results_base) %>% 
  as.list()

# Extract interaction terms for productive inclusion treatments
# Full Psychosocial interaction term
full_Psychosocial <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi") %>% 
  select(full_Psychosocial) %>% 
  pull() %>% 
  as.numeric()

# Full Capital interaction term
full_Capital <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi") %>% 
  select(full_Capital) %>% 
  pull() %>% 
  as.numeric()

# Psychosocial and Capital interaction term
psychosocial_Capital <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi") %>% 
  select(psychosocial_Capital) %>% 
  pull() %>% 
  as.numeric()

# Initialize empty vectors to store descriptive statistics
# These will store mean and standard deviation for each outcome variable
mean_values_pi <- c()  # Vector to store mean values
sd_values_pi <- c()   # Vector to store standard deviation values
mean_values_csh_trnsfr <- c()  
sd_values_csh_trnsfr <- c()   
# Calculate descriptive statistics for each outcome variable
# Loop through the list of outcome variables
for (depvar in sexual_physical_ipv_vars) {
 # Calculate and round mean, ignoring NA values
  mean_values_pi <- c(mean_values_pi,  round(mean(followup_MRT_hh_control_pi[[depvar]], na.rm = TRUE), 3))
  mean_values_csh_trnsfr <- c(mean_values_csh_trnsfr,  round(mean(followup_MRT_hh_control_csh_trnsfr[[depvar]], na.rm = TRUE), 3))
  # Calculate and round standard deviation, ignoring NA values
  sd_values_pi <- c(sd_values_pi,  round(sd(followup_MRT_hh_control_pi[[depvar]], na.rm = TRUE), 3))
  sd_values_csh_trnsfr <- c(sd_values_csh_trnsfr,  round(sd(followup_MRT_hh_control_csh_trnsfr[[depvar]], na.rm = TRUE), 3))
}

# Create lists of models for easier processing
models_pi <- list(m21, m22)  # Productive inclusion models
models_pi_pool <- list(m31, m32)  # Productive inclusion models pool
models_csh_trnsfr <- list(m11, m12)  # Cash transfer models

# Create regression tables for Productive Inclusion models
tbl_list_pi <- map(models_pi, ~ tbl_regression(.x, 
                                         exponentiate = FALSE,  # Keep coefficients as-is 
                                         estimate_fun = ~ style_number(.x, digits = 2),
                                         include="treatment_pi")  %>% 
                  add_significance_stars(pattern = "{estimate}{stars} \n ({std.error})",
                         hide_se = TRUE) %>%
  add_glance_table(include = c(nobs, r.squared)))

tbl_list_pi_pool <- map(models_pi_pool, ~ tbl_regression(.x, 
                                         exponentiate = FALSE,  # Keep coefficients as-is 
                                         estimate_fun = ~ style_number(.x, digits = 2),
                                         include="treatment_pi_pool")  %>% 
                  add_significance_stars(pattern = "{estimate}{stars} \n ({std.error})",
                         hide_se = TRUE)%>%
  add_glance_table(include = c(nobs, r.squared)))

# Create regression tables for Cash Transfer models
tbl_list_csh_trnsfr <- map(models_csh_trnsfr, ~ tbl_regression(.x, 
                                         exponentiate = FALSE,  # Keep coefficients as-is
                                         estimate_fun = ~ style_number(.x, digits = 2),
                                         include="treatment_csh_trnsfr")  %>% 
                  add_significance_stars(pattern = "{estimate}{stars} \n ({std.error})",
                         hide_se = TRUE)%>%
  add_glance_table(include = c(nobs, r.squared)))

# Modify headers for the Productive Inclusion and Cash Transfer models

tbl_list_pi[[1]] <- tbl_list_pi[[1]] %>%
   modify_header(estimate = "Binary \n for phy. or sex. IPV \n in the last 12 months")

tbl_list_csh_trnsfr[[1]] <- tbl_list_csh_trnsfr[[1]] %>%
   modify_header(estimate = "Binary \n for phy. or sex. IPV \n in the last 12 months")

tbl_list_pi_pool[[1]] <- tbl_list_pi_pool[[1]] %>%
   modify_header(estimate = "Binary \n for phy. or sex. IPV \n in the last 12 months")
 

tbl_list_pi[[2]] <- tbl_list_pi[[2]] %>%
   modify_header(estimate = "Phy. or sex. \n IPV sev. \n index")

tbl_list_csh_trnsfr[[2]] <- tbl_list_csh_trnsfr[[2]] %>%
   modify_header(estimate = "Phy. or sex. \n IPV sev. \n index")

tbl_list_pi_pool[[2]] <- tbl_list_pi_pool[[2]] %>%
   modify_header(estimate = "Phy. or sex. \n IPV sev. \n index")


# Merge the stacked tables into a single table with column headers

tbl_csh_trnsfr <- tbl_merge(
  tbls = list(tbl_list_csh_trnsfr[[1]],# Ever: First models (Refusal = missing)
              tbl_list_csh_trnsfr[[2]] # Ever: Second models (Refusal = 0)
              ),  # lst 12 mnths: Third models (Refusal = 1)
  tab_spanner = c("(1)", "(2)")
)

## Productive inclusion
tbl_pi <- tbl_merge(
  tbls = list(tbl_list_pi[[1]],# Ever: First models (Refusal = missing)
              tbl_list_pi[[2]]
              ),# Severity index
  tab_spanner = c("(1)", "(2)")
)

## Pool Productive inclusion
tbl_pi_pool <- tbl_merge(
  tbls = list(tbl_list_pi_pool[[1]],# Ever: First models (Refusal = missing)
              tbl_list_pi_pool[[2]]
              ),# Severity index
  tab_spanner = c("(1)", "(2)")
)

# Create a list of stacked tables combining Cash Transfer and Productive Inclusion models
# Each list element combines the corresponding models from both treatment types
tbl <- tbl_stack(list(tbl_csh_trnsfr, tbl_pi, tbl_pi_pool))

# Modify table body to customize variable labels
tbl <- tbl %>%
  modify_table_body(~ .x %>%
                      mutate(label = case_when(
                        # Rename specific treatment variables
                        variable == "treatment_piCapital" ~ "Capital",
                        variable == "treatment_piPsychosocial" ~ "Psychosocial",
                        variable == "treatment_piFull" ~ "Full",
                        variable == "treatment_pi_poolPool" ~ "Full",
                        # Label cash transfer and productive inclusion treatments
                        variable == "treatment_csh_trnsfr" & is.na(term_1) ~ "Tekavoul",
                        variable == "treatment_pi"& is.na(term_1) ~ "Productive Inclusion",
                        variable == "treatment_pi_pool"& is.na(term_1) ~ "Productive Inclusion (Pool)",
                        TRUE ~ label  # Keep original labels for other variables
                      )))

# Create a tribble (transposed tibble) with additional rows for the table
# These rows include control mean, standard deviation, and interaction terms
additional_rows <- tribble(
  ~variable,  ~var_label, ~label, ~estimate_1, ~estimate_2, 
  "Control mean @ follow up Tekavoul","Control mean @ follow up Tekavoul","Control mean @ follow up Tekavoul",mean_values_csh_trnsfr[1], mean_values_csh_trnsfr[2], 
  "Control SD @ follow up Tekavoul","Control SD @ follow up Tekavoul","Control SD @ follow up Tekavoul",  sd_values_csh_trnsfr[1], sd_values_csh_trnsfr[2],   
  
  "Control mean @ follow up PI","Control mean @ follow up PI","Control mean @ follow up PI",mean_values_pi[1], mean_values_pi[2], 
  "Control SD @ follow up PI","Control SD @ follow up PI","Control SD @ follow up PI",  sd_values_pi[1], sd_values_pi[2], 
  
  "Full - Psychosocial","Full - Psychosocial","Full - Psychosocial",   full_Psychosocial[1], full_Psychosocial[2], 
  "Full - Capital","Full - Capital", "Full - Capital", full_Capital[1], full_Capital[2], 
  "Psychosocial - Capital","Psychosocial - Capital","Psychosocial - Capital",  psychosocial_Capital[1], psychosocial_Capital[2]
)

# Append the additional rows to the table body
tbl$table_body <- bind_rows(tbl$table_body, additional_rows)

# Final table formatting
tbl <- tbl %>%
  # Set table caption
  modify_caption(sexual_ipv_title) %>%
  # Modify header for the label column
  modify_header(label = "**Outcome**") %>%
  # Remove all existing footnotes
  modify_footnote(everything() ~ NA) %>%
  modify_footnote(all_stat_cols() ~ NA) %>%
  # Add custom footnote with methodological details
  modify_footnote(label = "Notes: Results presented are OLS estimates that include controls for randomization strata (commune) and, where possible, baseline outcomes.  We control for social promotion intervention. Enumerator fixed effects are included in all regression. We estimate the regressions for the productive beneficiaries aged 18-49 only. Robust standard errors are shown in parentheses, clustered at the village proxy level. *** p < 0.01, ** p < 0.05, * p < 0.1.")

# Print the final table
tbl



```

## Economic Violence

```{r}
######################## Fist estimate ##########################################

# Use map_dfr to iterate over each outcome and estimate effects for different treatment variables
mainResults <- map_dfr(treatment_vars, function(curr_treat_var) {
  tempResults <- map_dfr(economic_ipv_vars, function(depvar) {    
    bind_rows(
      getEstimateGlobal(depvar, curr_treat_var, control_vars, strata_vars, cluster_vars, followup_MRT_hh) %>%
        mutate(depvar = depvar, curr_treat_var = curr_treat_var)
    )
  })
})

# Extract results for different outcomes variables 
## Cash transfer regression models
# Extract specific models for cash transfer from the main results
m11 <- mainResults$results_base[[1]]  # First cash transfer model
m12 <- mainResults$results_base[[2]]  # Second cash transfer model

## Productive inclusion regression models
# Extract specific models for productive inclusion from the main results
m21 <- mainResults$results_base[[3]]  # First productive inclusion model
m22 <- mainResults$results_base[[4]]  # Second productive inclusion model


m31 <- mainResults$results_base[[5]]  # First pool productive inclusion model
m32 <- mainResults$results_base[[6]]  # Second pool productive inclusion model


# Alternative way to filter cash transfer models from the dataset
m1 <- mainResults %>% 
  filter(curr_treat_var=="treatment_csh_trnsfr") %>% 
  select(results_base) %>% 
  as.list()

# Alternative way to filter productive inclusion models from the dataset
m2 <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi") %>% 
  select(results_base) %>% 
  as.list()

# Extract interaction terms for productive inclusion treatments
# Full Psychosocial interaction term
full_Psychosocial <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi") %>% 
  select(full_Psychosocial) %>% 
  pull() %>% 
  as.numeric()

# Full Capital interaction term
full_Capital <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi") %>% 
  select(full_Capital) %>% 
  pull() %>% 
  as.numeric()

# Psychosocial and Capital interaction term
psychosocial_Capital <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi") %>% 
  select(psychosocial_Capital) %>% 
  pull() %>% 
  as.numeric()

# Initialize empty vectors to store descriptive statistics
# These will store mean and standard deviation for each outcome variable
mean_values_pi <- c()  # Vector to store mean values
sd_values_pi <- c()   # Vector to store standard deviation values
mean_values_csh_trnsfr <- c()  
sd_values_csh_trnsfr <- c()   
# Calculate descriptive statistics for each outcome variable
# Loop through the list of outcome variables
for (depvar in economic_ipv_vars) {
 # Calculate and round mean, ignoring NA values
  mean_values_pi <- c(mean_values_pi,  round(mean(followup_MRT_hh_control_pi[[depvar]], na.rm = TRUE), 3))
  mean_values_csh_trnsfr <- c(mean_values_csh_trnsfr,  round(mean(followup_MRT_hh_control_csh_trnsfr[[depvar]], na.rm = TRUE), 3))
  # Calculate and round standard deviation, ignoring NA values
  sd_values_pi <- c(sd_values_pi,  round(sd(followup_MRT_hh_control_pi[[depvar]], na.rm = TRUE), 3))
  sd_values_csh_trnsfr <- c(sd_values_csh_trnsfr,  round(sd(followup_MRT_hh_control_csh_trnsfr[[depvar]], na.rm = TRUE), 3))
}

# Create lists of models for easier processing
models_pi <- list(m21, m22)  # Productive inclusion models
models_pi_pool <- list(m31, m32)  # Productive inclusion models pool
models_csh_trnsfr <- list(m11, m12)  # Cash transfer models

# Create regression tables for Productive Inclusion models
tbl_list_pi <- map(models_pi, ~ tbl_regression(.x, 
                                         exponentiate = FALSE,  # Keep coefficients as-is 
                                         estimate_fun = ~ style_number(.x, digits = 2),
                                         include="treatment_pi")  %>% 
                  add_significance_stars(pattern = "{estimate}{stars} \n ({std.error})",
                         hide_se = TRUE) %>%
  add_glance_table(include = c(nobs, r.squared)))

tbl_list_pi_pool <- map(models_pi_pool, ~ tbl_regression(.x, 
                                         exponentiate = FALSE,  # Keep coefficients as-is 
                                         estimate_fun = ~ style_number(.x, digits = 2),
                                         include="treatment_pi_pool")  %>% 
                  add_significance_stars(pattern = "{estimate}{stars} \n ({std.error})",
                         hide_se = TRUE)%>%
  add_glance_table(include = c(nobs, r.squared)))

# Create regression tables for Cash Transfer models
tbl_list_csh_trnsfr <- map(models_csh_trnsfr, ~ tbl_regression(.x, 
                                         exponentiate = FALSE,  # Keep coefficients as-is
                                         estimate_fun = ~ style_number(.x, digits = 2),
                                         include="treatment_csh_trnsfr")  %>% 
                  add_significance_stars(pattern = "{estimate}{stars} \n ({std.error})",
                         hide_se = TRUE)%>%
  add_glance_table(include = c(nobs, r.squared)))

# Modify headers for the Productive Inclusion and Cash Transfer models

tbl_list_pi[[1]] <- tbl_list_pi[[1]] %>%
   modify_header(estimate = "Binary \n for eco. IPV \n in the last 12 months")

tbl_list_csh_trnsfr[[1]] <- tbl_list_csh_trnsfr[[1]] %>%
   modify_header(estimate = "Binary \n for eco. IPV \n in the last 12 months")

tbl_list_pi_pool[[1]] <- tbl_list_pi_pool[[1]] %>%
   modify_header(estimate = "Binary \n for eco. IPV \n in the last 12 months")
 

tbl_list_pi[[2]] <- tbl_list_pi[[2]] %>%
   modify_header(estimate = "Eco. \n IPV sev. \n index")

tbl_list_csh_trnsfr[[2]] <- tbl_list_csh_trnsfr[[2]] %>%
   modify_header(estimate = "Eco. \n IPV sev. \n index")

tbl_list_pi_pool[[2]] <- tbl_list_pi_pool[[2]] %>%
   modify_header(estimate = "Eco. \n IPV sev. \n index")


# Merge the stacked tables into a single table with column headers

tbl_csh_trnsfr <- tbl_merge(
  tbls = list(tbl_list_csh_trnsfr[[1]],
              tbl_list_csh_trnsfr[[2]]
              ),  
  tab_spanner = c("(1)", "(2)")
)

## Productive inclusion
tbl_pi <- tbl_merge(
  tbls = list(tbl_list_pi[[1]],
              tbl_list_pi[[2]]
              ),# Severity index
  tab_spanner = c("(1)", "(2)")
)

## Pool Productive inclusion
tbl_pi_pool <- tbl_merge(
  tbls = list(tbl_list_pi_pool[[1]],
              tbl_list_pi_pool[[2]]
              ),# Severity index
  tab_spanner = c("(1)", "(2)")
)

# Create a list of stacked tables combining Cash Transfer and Productive Inclusion models
# Each list element combines the corresponding models from both treatment types
tbl <- tbl_stack(list(tbl_csh_trnsfr, tbl_pi, tbl_pi_pool))

# Modify table body to customize variable labels
tbl <- tbl %>%
  modify_table_body(~ .x %>%
                      mutate(label = case_when(
                        # Rename specific treatment variables
                        variable == "treatment_piCapital" ~ "Capital",
                        variable == "treatment_piPsychosocial" ~ "Psychosocial",
                        variable == "treatment_piFull" ~ "Full",
                        variable == "treatment_pi_poolPool" ~ "Full",
                        # Label cash transfer and productive inclusion treatments
                        variable == "treatment_csh_trnsfr" & is.na(term_1) ~ "Tekavoul",
                        variable == "treatment_pi"& is.na(term_1) ~ "Productive Inclusion",
                        variable == "treatment_pi_pool"& is.na(term_1) ~ "Productive Inclusion (Pool)",
                        TRUE ~ label  # Keep original labels for other variables
                      )))

# Create a tribble (transposed tibble) with additional rows for the table
# These rows include control mean, standard deviation, and interaction terms
additional_rows <- tribble(
  ~variable,  ~var_label, ~label, ~estimate_1, ~estimate_2, 
  "Control mean @ follow up Tekavoul","Control mean @ follow up Tekavoul","Control mean @ follow up Tekavoul",mean_values_csh_trnsfr[1], mean_values_csh_trnsfr[2], 
  "Control SD @ follow up Tekavoul","Control SD @ follow up Tekavoul","Control SD @ follow up Tekavoul",  sd_values_csh_trnsfr[1], sd_values_csh_trnsfr[2],   
  
  "Control mean @ follow up PI","Control mean @ follow up PI","Control mean @ follow up PI",mean_values_pi[1], mean_values_pi[2], 
  "Control SD @ follow up PI","Control SD @ follow up PI","Control SD @ follow up PI",  sd_values_pi[1], sd_values_pi[2], 
  
  "Full - Psychosocial","Full - Psychosocial","Full - Psychosocial",   full_Psychosocial[1], full_Psychosocial[2], 
  "Full - Capital","Full - Capital", "Full - Capital", full_Capital[1], full_Capital[2], 
  "Psychosocial - Capital","Psychosocial - Capital","Psychosocial - Capital",  psychosocial_Capital[1], psychosocial_Capital[2]
)

# Append the additional rows to the table body
tbl$table_body <- bind_rows(tbl$table_body, additional_rows)

# Final table formatting
tbl <- tbl %>%
  # Set table caption
  modify_caption(economic_ipv_title) %>%
  # Modify header for the label column
  modify_header(label = "**Outcome**") %>%
  # Remove all existing footnotes
  modify_footnote(everything() ~ NA) %>%
  modify_footnote(all_stat_cols() ~ NA) %>%
  # Add custom footnote with methodological details
  modify_footnote(label = "Notes: Results presented are OLS estimates that include controls for randomization strata (commune) and, where possible, baseline outcomes.  We control for social promotion intervention. Enumerator fixed effects are included in all regression. We estimate the regressions for the productive beneficiaries aged 18-49 only. Robust standard errors are shown in parentheses, clustered at the village proxy level. *** p < 0.01, ** p < 0.05, * p < 0.1.")

# Print the final table
tbl

```


## Any type of violence

```{r}
######################## Fist estimate ##########################################

# Use map_dfr to iterate over each outcome and estimate effects for different treatment variables
mainResults <- map_dfr(treatment_vars, function(curr_treat_var) {
  tempResults <- map_dfr(other_ipv_vars, function(depvar) {    
    bind_rows(
      getEstimateGlobal(depvar, curr_treat_var, control_vars, strata_vars, cluster_vars, followup_MRT_hh) %>%
        mutate(depvar = depvar, curr_treat_var = curr_treat_var)
    )
  })
})

# Extract results for different outcomes variables 
## Cash transfer regression models
# Extract specific models for cash transfer from the main results
m11 <- mainResults$results_base[[1]]  # First cash transfer model
m12 <- mainResults$results_base[[2]]  # Second cash transfer model


# Alternative way to filter cash transfer models from the dataset
m1 <- mainResults %>% 
  filter(curr_treat_var=="treatment_csh_trnsfr") %>% 
  select(results_base) %>% 
  as.list()

## Productive inclusion regression models
# Extract specific models for productive inclusion from the main results
m21 <- mainResults$results_base[[3]]  # First productive inclusion model
m22 <- mainResults$results_base[[4]]  # Second productive inclusion model

m31 <- mainResults$results_base[[5]]  # First pool productive inclusion model
m32 <- mainResults$results_base[[6]]  # Second pool productive inclusion model



# Alternative way to filter productive inclusion models from the dataset
m2 <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi") %>% 
  select(results_base) %>% 
  as.list()

# Extract interaction terms for productive inclusion treatments
# Full Psychosocial interaction term
full_Psychosocial <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi") %>% 
  select(full_Psychosocial) %>% 
  pull() %>% 
  as.numeric()

# Full Capital interaction term
full_Capital <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi") %>% 
  select(full_Capital) %>% 
  pull() %>% 
  as.numeric()

# Psychosocial and Capital interaction term
psychosocial_Capital <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi") %>% 
  select(psychosocial_Capital) %>% 
  pull() %>% 
  as.numeric()

# Initialize empty vectors to store descriptive statistics
# These will store mean and standard deviation for each outcome variable
mean_values_pi <- c()  # Vector to store mean values
sd_values_pi <- c()   # Vector to store standard deviation values
mean_values_csh_trnsfr <- c()  
sd_values_csh_trnsfr <- c()   
# Calculate descriptive statistics for each outcome variable
# Loop through the list of outcome variables
for (depvar in other_ipv_vars) {
 # Calculate and round mean, ignoring NA values
  mean_values_pi <- c(mean_values_pi,  round(mean(followup_MRT_hh_control_pi[[depvar]], na.rm = TRUE), 3))
  mean_values_csh_trnsfr <- c(mean_values_csh_trnsfr,  round(mean(followup_MRT_hh_control_csh_trnsfr[[depvar]], na.rm = TRUE), 3))
  # Calculate and round standard deviation, ignoring NA values
  sd_values_pi <- c(sd_values_pi,  round(sd(followup_MRT_hh_control_pi[[depvar]], na.rm = TRUE), 3))
  sd_values_csh_trnsfr <- c(sd_values_csh_trnsfr,  round(sd(followup_MRT_hh_control_csh_trnsfr[[depvar]], na.rm = TRUE), 3))
}

# Transform to character

# Create lists of models for easier processing
models_pi <- list(m21, m22)  # Productive inclusion models
models_pi_pool <- list(m31, m32)  # Productive inclusion models pool
models_csh_trnsfr <- list(m11, m12)  # Cash transfer models

# Create regression tables for Productive Inclusion models
tbl_list_pi <- map(models_pi, ~ tbl_regression(.x, 
                                         exponentiate = FALSE,  # Keep coefficients as-is 
                                         estimate_fun = ~ style_number(.x, digits = 2),
                                         include="treatment_pi")  %>% 
                  add_significance_stars(pattern = "{estimate}{stars} \n ({std.error})", 
                                         thresholds = c(0.001, 0.01, 0.05),hide_se = TRUE) %>%
  add_glance_table(include = c(nobs, r.squared)))

tbl_list_pi_pool <- map(models_pi_pool, ~ tbl_regression(.x, 
                                         exponentiate = FALSE,  # Keep coefficients as-is 
                                         estimate_fun = ~ style_number(.x, digits = 2),
                                         include="treatment_pi_pool")  %>% 
                  add_significance_stars(pattern = "{estimate}{stars} \n ({std.error})", 
                                         thresholds = c(0.001, 0.01, 0.05),hide_se = TRUE)%>%
  add_glance_table(include = c(nobs, r.squared))) 

# Create regression tables for Cash Transfer models
tbl_list_csh_trnsfr <- map(models_csh_trnsfr, ~ tbl_regression(.x, 
                                         exponentiate = FALSE,  # Keep coefficients as-is
                                         estimate_fun = ~ style_number(.x, digits = 2),
                                         include="treatment_csh_trnsfr")  %>% 
                  add_significance_stars(pattern = "{estimate}{stars} \n ({std.error})", 
                                         thresholds = c(0.001, 0.01, 0.05),hide_se = TRUE)%>%
  add_glance_table(include = c(nobs, r.squared)))

# Modify headers for the Productive Inclusion and Cash Transfer models
## fAt least one type of violence incl. other Last 12 months 
### Refusal = missing

tbl_list_pi[[1]] <- tbl_list_pi[[1]] %>%
   modify_header(estimate = "Binary for at \n least one type of \n IPV (exclu. eco. and control) \n in the last 12 months")

tbl_list_csh_trnsfr[[1]] <- tbl_list_csh_trnsfr[[1]] %>%
   modify_header(estimate = "Binary for at \n least one type of \n IPV (exclu. eco. and control) \n in the last 12 months")

tbl_list_pi_pool[[1]] <- tbl_list_pi_pool[[1]] %>%
   modify_header(estimate = "Binary for at \n least one type of \n IPV (exclu. eco. and control) \n in the last 12 months")

## At least one type of violence Last 12 months (Refusal = \"missing\")
tbl_list_pi[[2]] <- tbl_list_pi[[2]] %>%
   modify_header(estimate = "All IPV \n sev. index \n")

tbl_list_csh_trnsfr[[2]] <- tbl_list_csh_trnsfr[[2]] %>%
   modify_header(estimate = "All IPV \n sev. index \n")

tbl_list_pi_pool[[2]] <- tbl_list_pi_pool[[2]] %>%
   modify_header(estimate = "All IPV \n sev. index \n")


# Merge the stacked tables into a single table with column headers
## Cash transfert
tbl_csh_trnsfr <- tbl_merge(
  tbls = list(tbl_list_csh_trnsfr[[1]],
              tbl_list_csh_trnsfr[[2]]
              ),  
  tab_spanner = c("(1)", "(2)")
)

## Productive inclusion
tbl_pi <- tbl_merge(
  tbls = list(tbl_list_pi[[1]],
              tbl_list_pi[[2]]
                ),# Severity index
  tab_spanner = c("(1)", "(2)")
)

## Pool Productive inclusion
tbl_pi_pool <- tbl_merge(
  tbls = list(tbl_list_pi_pool[[1]], 
              tbl_list_pi_pool[[2]]
             ),# Severity index
  tab_spanner = c("(1)", "(2)")
)



# Create a list of stacked tables combining Cash Transfer and Productive Inclusion models
# Each list element combines the corresponding models from both treatment types
tbl <- tbl_stack(list(tbl_csh_trnsfr, tbl_pi, tbl_pi_pool))

# Modify table body to customize variable labels
tbl <- tbl %>%
  modify_table_body(~ .x %>%
                      mutate(label = case_when(
                        # Rename specific treatment variables
                        variable == "treatment_piCapital" ~ "Capital",
                        variable == "treatment_piPsychosocial" ~ "Psychosocial",
                        variable == "treatment_piFull" ~ "Full",
                        variable == "treatment_pi_poolPool" ~ "Full",
                        # Label cash transfer and productive inclusion treatments
                        variable == "treatment_csh_trnsfr" & is.na(term_1) ~ "Tekavoul",
                        variable == "treatment_pi"& is.na(term_1) ~ "Productive Inclusion",
                        variable == "treatment_pi_pool"& is.na(term_1) ~ "Productive Inclusion (Pool)",
                        TRUE ~ label  # Keep original labels for other variables
                      )))

# Create a tribble (transposed tibble) with additional rows for the table
# These rows include control mean, standard deviation, and interaction terms
additional_rows <- tribble(
  ~variable,  ~var_label, ~label, ~estimate_1, ~estimate_2, 
  "Control mean @ follow up Tekavoul","Control mean @ follow up Tekavoul","Control mean @ follow up Tekavoul",mean_values_csh_trnsfr[1], mean_values_csh_trnsfr[2], 
  "Control SD @ follow up Tekavoul","Control SD @ follow up Tekavoul","Control SD @ follow up Tekavoul",  sd_values_csh_trnsfr[1], sd_values_csh_trnsfr[2],   
  
  "Control mean @ follow up PI","Control mean @ follow up PI","Control mean @ follow up PI",mean_values_pi[1], mean_values_pi[2], 
  "Control SD @ follow up PI","Control SD @ follow up PI","Control SD @ follow up PI",  sd_values_pi[1], sd_values_pi[2], 
  
  "Full - Psychosocial","Full - Psychosocial","Full - Psychosocial",   full_Psychosocial[1], full_Psychosocial[2], 
  "Full - Capital","Full - Capital", "Full - Capital", full_Capital[1], full_Capital[2], 
  "Psychosocial - Capital","Psychosocial - Capital","Psychosocial - Capital",  psychosocial_Capital[1], psychosocial_Capital[2]
)

# Append the additional rows to the table body
tbl$table_body <- bind_rows(tbl$table_body, additional_rows)

# Final table formatting
tbl <- tbl %>%
  # Set table caption
  modify_caption(other_ipv_title) %>%
  # Modify header for the label column
  modify_header(label = "**Outcome**") %>%
  # Remove all existing footnotes
  modify_footnote(everything() ~ NA) %>%
  modify_footnote(all_stat_cols() ~ NA) %>%
  # Add custom footnote with methodological details
  modify_footnote(label = "Notes: Results presented are OLS estimates that include controls for randomization strata (commune) and, where possible, baseline outcomes. We control for social promotion intervention. Enumerator fixed effects are included in all regression. We estimate the regressions for the productive beneficiaries aged 18-49 only. Robust standard errors are shown in parentheses, clustered at the village proxy level. *** p < 0.01, ** p < 0.05, * p < 0.1.")

# Print the final table
tbl

```

# Heterogenous effect



```{r}

####################### Second estimate #########################################
# lst_outcomes=c("olderchild_s","earlychild_s", "adult_fem_s")

# Define a list of heterogeneity variables to examine for differential treatment effects
lst_het_var <- c(
  "het_pben_edu",         # Beneficiary nbr. year of education
  "het_prtnr_lit",          # Partner literacy
  "het_prtnr_edu",             # 1 = Partner education above median
  "het_pben_lit",          # Beneficiary literacy
  "het_save_share",         # Share of saving own by partner
  "het_ctrl_earn_index",  # Beneficiary control over earnings index
  "het_ctrl_hh_index",    # Control over household decisions index
  "het_intrahh_index",    # Beneficiary intra-household dynamics index
  "het_age_gap",           # Age gap between partners
  "het_consum",   # Consumption
  "het_rev_sum_bohh",          # 1 = Household revenue above median
  "het_age_at_mrrg_above18",   # Married after 18
  "het_age_at_mrrg"   # Married after median age of marriage
)

# Create a data frame of results examining heterogeneous treatment effects
# across different economic IPV outcomes, treatment variables, and heterogeneity dimensions
mainResults_het <- map_dfr(listOutcomes, function(depvar) {
 
   # For each heterogeneity variable...
  tempResults1 <- map_dfr(lst_het_var, function(het_var) { 
  
    # For each treatment variable...
    tempResults2 <- map_dfr(treatment_vars, function(treat_var) {

      bind_rows(
        # Get estimates for heterogeneous treatment effects using the specified model
        getEstimateGlobal_het(depvar, treat_var, het_var, control_vars, strata_vars, cluster_vars, followup_MRT_hh) %>%
          # Add columns identifying which variables were used in this iteration
          mutate(depvar = depvar, outcome = depvar, treat_var = treat_var, het_var = het_var)
        )
    })
  })
})

#  Mutate and recode variables for better readability
mainResults_het <- mainResults_het %>%
    mutate(
        # Recode 'name' variable
      name = dplyr::recode(name,
        cash = "(a) Tekavoul program",
        pi = "(b) Productive inclusion program"
      ),
      het_var = dplyr::recode(het_var,
# Demographics & Education (Individual characteristics)
  het_hhh_fem       = "HH head is female",                            # 1 if the household head is female
  het_hhh_edu       = "HH head years of education",                  # Number of years of education (HH head)
  het_pben_edu      = "Benef. educ. (above median)",             # Number of years of education (beneficiary)
  het_prtnr_edu     = "Partner educ. (above median)",                 # Number of years of education (partner)

  het_pben_lit      = "Benef. literacy",                   # 1 if beneficiary can read/write
  het_prtnr_lit     = "Partner literacy",                       # 1 if partner can read/write

  # Marriage & Age-related characteristics
  het_age_gap             = "Age gap (partner - benef.)",    # 1 if age gap is above the median
  het_age_at_mrrg         = "Benef. age at marriage (above median)",             # 1 if age at marriage is above the median
  het_age_at_mrrg_above18 =   "Benef. married after 18",               # 1 if beneficiary married at 18 or older

  # Empowerment & intra-household dynamics
  het_ctrl_earn_index  = "Cntrl earn. index (above median)",   # 1 if control over own earnings index is above median
  het_ctrl_hh_index    =  "Cntrl hh. resources index (above median)", # 1 if control over HH resources index is above median
  het_intrahh_index    = "Intra-hh. dynamics index (above median)",       # 1 if intra-household dynamics index is above median

  # Household economic status
  het_rev_sum_bohh     = "Benef. share of total HH revenue (above median)",      # Share of total HH revenue earned by the beneficiary
  het_tot_hh_rev       = "Total HH revenue (above median)",              # 1 if total household revenue is above median
  het_consum           = "Consumption eq. PPP (above median)",           # 1 if HH consumption (PPP-adjusted) is above median

  # Location
  het_region           = "Household in Sélibaby"                 # 1 if household is in Sélibaby region

      ),
        # Recode 'estimate' variable
      estimate = dplyr::recode(
        estimate,
        No = "low",
        Yes = "high"
      ),
        depvar = dplyr::recode(depvar,
              control_ipv_sev_12m = "Bin. for cntrl IPV",
              control_ipv_sev_index = "Cntrl IPV sev. index",
              emo_ipv_sev_12m = "Bin. for emo IPV",
              emo_ipv_sev_index = "Emo. IPV sever. index",
              phy_ipv_sev_12m = "Bin. for phy. IPV", 
              phy_ipv_sev_index = "Phy. IPV sev. index",
              sex_ipv_sev_index = "Sex. IPV sev. index",
              sex_ipv_sev_12m = "Bin. for sex. IPV", 
              sex_phy_ipv_sev_index = "Sex. or phy. IPV sev. index",
              sex_phy_ipv_sev_12m = "Bin. for sex. or phy. IPV", 
              eco_ipv_sev_12m = "Bin. for eco. IPV", 
              eco_ipv_sev_index = "Eco. IPV sever. index",
              all_ipv_sev_12m = "Bin. for at least one type of IPV (exclu. eco. and control)", 
              all_ipv_sev_index = "Any IPV inten. index (exclu. eco. and control)"
      )
      )


    # Compute proportions by category
mainResults_het <- mainResults_het %>%
  group_by(depvar, name, het_var, typeTreat) %>%
  mutate(N_treat = sum(Ntype_treat)) %>%
  ungroup() %>%
  mutate(prop = round(Ntype_treat * 100 / N_treat, 2))

# Generate labels for the plot
  mainResults_het <- mainResults_het %>%
    group_by(depvar, name, het_var, typeTreat) %>%
    mutate(
      lab = sprintf(
        "%s \n N high treat (pct): %s (%s)\n N low treat (pct): %s (%s)",
        first(typeTreat),
        scales::comma(last(Ntype_treat)),
        scales::comma(last(prop)),
        scales::comma(first(Ntype_treat)),
        scales::comma(first(prop))
      )
    ) %>%
    ungroup()


  # Generate unique label for every one
  mainResults_het <- mainResults_het %>%
    group_by(name, het_var, typeTreat) %>%
    mutate(
      lab = first(lab)
      )%>%
    ungroup()
  
median_val <- map_dfr(gsub("het_", "", lst_het_var, fixed = TRUE), ~{
    followup_MRT_hh %>% 
        summarize(
            het_var = .x,  # Add het variable name for clarity in output
            median_value = round(median(!!sym(.x), na.rm = TRUE), 2)
        )}) %>%
  mutate(      
  het_var = dplyr::recode(het_var,
                      hhh_fem = "Hh. head is female",
                      hhh_edu="Hh. head nbr. yrs of educ.",
                      pben_edu="Benef. educ. (above median)",
                      pben_lit = "Benef. literacy",
                      save_share = "Shr of resources own by prtnr",
                      ctrl_earn_index = "Cntrl earn. index (above median)",
                      ctrl_hh_index = "Cntrl hh. resources index (above median)",
                      intrahh_index = "Intra-hh. dynamics index (above median)",
                      rev_sum_bohh = "Benef. share of total hh. rev.",
                      age_gap = "Age gap (partner - benef.)",
                      region = "Household in Sélibaby",
                      tot_hh_rev = "Tot. hh. revenue",
                      consum = "Consumption eq. PPP (above median)",
                      age_at_mrrg_above18 =   "Benef. married after 18",
                      age_at_mrrg = "Benef. age at marriage (above median)",
                      prtnr_edu = "Partner educ. (above median)",
                      prtnr_lit = "Partner literacy"
      ))
```

## Controlling Behavior 

### Partner literacy
```{r}

curr_het_var = "Partner literacy"

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% control_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))

# "Ever (Refusal = \"missing\")","Ever (Refusal = \"0\")","Ever (Refusal = \"1\")", "Last 12 months (Refusal = \"missing\")", "Last 12 months (Refusal = \"0\")", "Last 12 months (Refusal = \"1\")", "Severity index (last 12 months)", "Severity (last 12 months)"

# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s Tekavoul, %s productive inclusion."), 
                     first(mainResults_reg_group$N), last(mainResults_reg_group$N))
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"),  width = 10, height = 14, units = "cm")
```

### Beneficiary literacy

```{r}
 
curr_het_var = "Benef. literacy"

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% control_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)
    
    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)

#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s Tekavoul, %s productive inclusion."), 
                     first(mainResults_reg_group$N), last(mainResults_reg_group$N))
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```

### Partner educ. 

```{r}

curr_het_var = "Partner educ. (above median)" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% control_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
    
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
    
```

### Beneficiary educ.

```{r}

curr_het_var = "Benef. educ. (above median)" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()


mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% control_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)
    
    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)

#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het)
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
    

```




### Beneficiary control over earnings

```{r}
 
curr_het_var = "Cntrl earn. index (above median)"
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()


mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% control_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
    
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```

### Beneficiary control over hh. resources

```{r}
curr_het_var = "Cntrl hh. resources index (above median)"
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()


mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% control_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```

### Beneficiary intra-household dynamics 

```{r}

curr_het_var = "Intra-hh. dynamics index (above median)" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% control_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```


### Spousal age gap

```{r}

curr_het_var = "Age gap (partner - benef.)" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% control_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("high" = "grey69", "low" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```


### Beneficiary age at marriage 

```{r}

curr_het_var = "Benef. age at marriage (above median)" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% control_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
    
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```


### Beneficiary married after 18 

```{r}

curr_het_var =   "Benef. married after 18" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% control_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```


### Consumption at baseline

```{r}

curr_het_var = "Consumption eq. PPP (above median)"

median_het = median_val %>% 
  filter(het_var==curr_het_var) %>% 
  select(median_value) %>% 
  as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% control_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)
    
    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)

#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")

```

## Emotional Violence


### Partner literacy
```{r}

curr_het_var = "Partner literacy"

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% emotional_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))

# "Ever (Refusal = \"missing\")","Ever (Refusal = \"0\")","Ever (Refusal = \"1\")", "Last 12 months (Refusal = \"missing\")", "Last 12 months (Refusal = \"0\")", "Last 12 months (Refusal = \"1\")", "Severity index (last 12 months)", "Severity (last 12 months)"

# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s Tekavoul, %s productive inclusion."), 
                     first(mainResults_reg_group$N), last(mainResults_reg_group$N))
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"),  width = 10, height = 14, units = "cm")
```

### Beneficiary literacy

```{r}
 
curr_het_var = "Benef. literacy"

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% emotional_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)
    
    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)

#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s Tekavoul, %s productive inclusion."), 
                     first(mainResults_reg_group$N), last(mainResults_reg_group$N))
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```

### Partner educ. 

```{r}

curr_het_var = "Partner educ. (above median)" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% emotional_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
    
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
    
```

### Beneficiary educ.

```{r}

curr_het_var = "Benef. educ. (above median)" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()


mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% emotional_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)
    
    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)

#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het)
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
    

```




### Beneficiary control over earnings

```{r}
 
curr_het_var = "Cntrl earn. index (above median)"
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()


mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% emotional_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
    
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```

### Beneficiary control over hh. resources

```{r}
curr_het_var = "Cntrl hh. resources index (above median)"
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()


mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% emotional_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```

### Beneficiary intra-household dynamics 

```{r}

curr_het_var = "Intra-hh. dynamics index (above median)" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% emotional_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```


### Spousal age gap

```{r}

curr_het_var = "Age gap (partner - benef.)" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% emotional_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("high" = "grey69", "low" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```


### Beneficiary age at marriage 

```{r}

curr_het_var = "Benef. age at marriage (above median)" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% emotional_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
    
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```


### Beneficiary married after 18 

```{r}

curr_het_var =   "Benef. married after 18" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% emotional_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```


### Consumption at baseline

```{r}

curr_het_var = "Consumption eq. PPP (above median)"

median_het = median_val %>% 
  filter(het_var==curr_het_var) %>% 
  select(median_value) %>% 
  as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% emotional_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)
    
    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)

#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")

```


## Physical violence


### Partner literacy
```{r}

curr_het_var = "Partner literacy"

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% physical_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))

# "Ever (Refusal = \"missing\")","Ever (Refusal = \"0\")","Ever (Refusal = \"1\")", "Last 12 months (Refusal = \"missing\")", "Last 12 months (Refusal = \"0\")", "Last 12 months (Refusal = \"1\")", "Severity index (last 12 months)", "Severity (last 12 months)"

# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s Tekavoul, %s productive inclusion."), 
                     first(mainResults_reg_group$N), last(mainResults_reg_group$N))
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"),  width = 10, height = 14, units = "cm")
```

### Beneficiary literacy

```{r}
 
curr_het_var = "Benef. literacy"

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% physical_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)
    
    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)

#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s Tekavoul, %s productive inclusion."), 
                     first(mainResults_reg_group$N), last(mainResults_reg_group$N))
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```

### Partner educ. 

```{r}

curr_het_var = "Partner educ. (above median)" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% physical_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
    
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
    
```

### Beneficiary educ.

```{r}

curr_het_var = "Benef. educ. (above median)" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()


mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% physical_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)
    
    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)

#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het)
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
    

```




### Beneficiary control over earnings

```{r}
 
curr_het_var = "Cntrl earn. index (above median)"
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()


mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% physical_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
    
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```

### Beneficiary control over hh. resources

```{r}
curr_het_var = "Cntrl hh. resources index (above median)"
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()


mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% physical_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```

### Beneficiary intra-household dynamics 

```{r}

curr_het_var = "Intra-hh. dynamics index (above median)" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% physical_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```


### Spousal age gap

```{r}

curr_het_var = "Age gap (partner - benef.)" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% physical_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("high" = "grey69", "low" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```


### Beneficiary age at marriage 

```{r}

curr_het_var = "Benef. age at marriage (above median)" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% physical_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
    
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```


### Beneficiary married after 18 

```{r}

curr_het_var =   "Benef. married after 18" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% physical_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```


### Consumption at baseline

```{r}

curr_het_var = "Consumption eq. PPP (above median)"

median_het = median_val %>% 
  filter(het_var==curr_het_var) %>% 
  select(median_value) %>% 
  as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% physical_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)
    
    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)

#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")

```

## Sexual Violence 

### Partner literacy
```{r}

curr_het_var = "Partner literacy"

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% sexual_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))

# "Ever (Refusal = \"missing\")","Ever (Refusal = \"0\")","Ever (Refusal = \"1\")", "Last 12 months (Refusal = \"missing\")", "Last 12 months (Refusal = \"0\")", "Last 12 months (Refusal = \"1\")", "Severity index (last 12 months)", "Severity (last 12 months)"

# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s Tekavoul, %s productive inclusion."), 
                     first(mainResults_reg_group$N), last(mainResults_reg_group$N))
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"),  width = 10, height = 14, units = "cm")
```

### Beneficiary literacy

```{r}
 
curr_het_var = "Benef. literacy"

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% sexual_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)
    
    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)

#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s Tekavoul, %s productive inclusion."), 
                     first(mainResults_reg_group$N), last(mainResults_reg_group$N))
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```

### Partner educ. 

```{r}

curr_het_var = "Partner educ. (above median)" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% sexual_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
    
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
    
```

### Beneficiary educ.

```{r}

curr_het_var = "Benef. educ. (above median)" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()


mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% sexual_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)
    
    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)

#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het)
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
    

```




### Beneficiary control over earnings

```{r}
 
curr_het_var = "Cntrl earn. index (above median)"
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()


mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% sexual_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
    
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```

### Beneficiary control over hh. resources

```{r}
curr_het_var = "Cntrl hh. resources index (above median)"
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()


mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% sexual_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```

### Beneficiary intra-household dynamics 

```{r}

curr_het_var = "Intra-hh. dynamics index (above median)" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% sexual_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```


### Spousal age gap

```{r}

curr_het_var = "Age gap (partner - benef.)" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% sexual_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("high" = "grey69", "low" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```


### Beneficiary age at marriage 

```{r}

curr_het_var = "Benef. age at marriage (above median)" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% sexual_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
    
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```


### Beneficiary married after 18 

```{r}

curr_het_var =   "Benef. married after 18" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% sexual_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```


### Consumption at baseline

```{r}

curr_het_var = "Consumption eq. PPP (above median)"

median_het = median_val %>% 
  filter(het_var==curr_het_var) %>% 
  select(median_value) %>% 
  as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% sexual_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)
    
    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)

#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")

```



## Physical and sexual violence 

### Partner literacy
```{r}

curr_het_var = "Partner literacy"

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% sexual_physical_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))

# "Ever (Refusal = \"missing\")","Ever (Refusal = \"0\")","Ever (Refusal = \"1\")", "Last 12 months (Refusal = \"missing\")", "Last 12 months (Refusal = \"0\")", "Last 12 months (Refusal = \"1\")", "Severity index (last 12 months)", "Severity (last 12 months)"

# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s Tekavoul, %s productive inclusion."), 
                     first(mainResults_reg_group$N), last(mainResults_reg_group$N))
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"),  width = 10, height = 14, units = "cm")
```

### Beneficiary literacy

```{r}
 
curr_het_var = "Benef. literacy"

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% sexual_physical_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)
    
    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)

#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s Tekavoul, %s productive inclusion."), 
                     first(mainResults_reg_group$N), last(mainResults_reg_group$N))
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```

### Partner educ. 

```{r}

curr_het_var = "Partner educ. (above median)" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% sexual_physical_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
    
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
    
```

### Beneficiary educ.

```{r}

curr_het_var = "Benef. educ. (above median)" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()


mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% sexual_physical_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)
    
    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)

#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het)
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
    

```




### Beneficiary control over earnings

```{r}
 
curr_het_var = "Cntrl earn. index (above median)"
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()


mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% sexual_physical_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
    
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```

### Beneficiary control over hh. resources

```{r}
curr_het_var = "Cntrl hh. resources index (above median)"
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()


mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% sexual_physical_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```

### Beneficiary intra-household dynamics 

```{r}

curr_het_var = "Intra-hh. dynamics index (above median)" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% sexual_physical_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```


### Spousal age gap

```{r}

curr_het_var = "Age gap (partner - benef.)" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% sexual_physical_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("high" = "grey69", "low" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```


### Beneficiary age at marriage 

```{r}

curr_het_var = "Benef. age at marriage (above median)" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% sexual_physical_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
    
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```


### Beneficiary married after 18 

```{r}

curr_het_var =   "Benef. married after 18" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% sexual_physical_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```


### Consumption at baseline

```{r}

curr_het_var = "Consumption eq. PPP (above median)"

median_het = median_val %>% 
  filter(het_var==curr_het_var) %>% 
  select(median_value) %>% 
  as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% sexual_physical_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)
    
    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)

#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")

```


## Economic Violence 

### Partner literacy
```{r}

curr_het_var = "Partner literacy"

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% economic_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))

# "Ever (Refusal = \"missing\")","Ever (Refusal = \"0\")","Ever (Refusal = \"1\")", "Last 12 months (Refusal = \"missing\")", "Last 12 months (Refusal = \"0\")", "Last 12 months (Refusal = \"1\")", "Severity index (last 12 months)", "Severity (last 12 months)"

# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s Tekavoul, %s productive inclusion."), 
                     first(mainResults_reg_group$N), last(mainResults_reg_group$N))
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"),  width = 10, height = 14, units = "cm")
```

### Beneficiary literacy

```{r}
 
curr_het_var = "Benef. literacy"

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% economic_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)
    
    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)

#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s Tekavoul, %s productive inclusion."), 
                     first(mainResults_reg_group$N), last(mainResults_reg_group$N))
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```

### Partner educ. 

```{r}

curr_het_var = "Partner educ. (above median)" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% economic_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
    
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
    
```

### Beneficiary educ.

```{r}

curr_het_var = "Benef. educ. (above median)" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()


mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% economic_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)
    
    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)

#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het)
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
    

```




### Beneficiary control over earnings

```{r}
 
curr_het_var = "Cntrl earn. index (above median)"
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()


mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% economic_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
    
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```

### Beneficiary control over hh. resources

```{r}
curr_het_var = "Cntrl hh. resources index (above median)"
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()


mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% economic_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```

### Beneficiary intra-household dynamics 

```{r}

curr_het_var = "Intra-hh. dynamics index (above median)" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% economic_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```


### Spousal age gap

```{r}

curr_het_var = "Age gap (partner - benef.)" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% economic_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("high" = "grey69", "low" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```


### Beneficiary age at marriage 

```{r}

curr_het_var = "Benef. age at marriage (above median)" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% economic_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
    
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```


### Beneficiary married after 18 

```{r}

curr_het_var =   "Benef. married after 18" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% economic_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```


### Consumption at baseline

```{r}

curr_het_var = "Consumption eq. PPP (above median)"

median_het = median_val %>% 
  filter(het_var==curr_het_var) %>% 
  select(median_value) %>% 
  as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% economic_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)
    
    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)

#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")

```

## Any type of violence

### Partner literacy
```{r}

curr_het_var = "Partner literacy"

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% other_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))

# "Ever (Refusal = \"missing\")","Ever (Refusal = \"0\")","Ever (Refusal = \"1\")", "Last 12 months (Refusal = \"missing\")", "Last 12 months (Refusal = \"0\")", "Last 12 months (Refusal = \"1\")", "Severity index (last 12 months)", "Severity (last 12 months)"

# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s Tekavoul, %s productive inclusion."), 
                     first(mainResults_reg_group$N), last(mainResults_reg_group$N))
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"),  width = 10, height = 14, units = "cm")
```

### Beneficiary literacy

```{r}
 
curr_het_var = "Benef. literacy"

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% other_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)
    
    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)

#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s Tekavoul, %s productive inclusion."), 
                     first(mainResults_reg_group$N), last(mainResults_reg_group$N))
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```

### Partner educ. 

```{r}

curr_het_var = "Partner educ. (above median)" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% other_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
    
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
    
```

### Beneficiary educ.

```{r}

curr_het_var = "Benef. educ. (above median)" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()


mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% other_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)
    
    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)

#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het)
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
    

```




### Beneficiary control over earnings

```{r}
 
curr_het_var = "Cntrl earn. index (above median)"
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()


mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% other_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
    
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```

### Beneficiary control over hh. resources

```{r}
curr_het_var = "Cntrl hh. resources index (above median)"
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()


mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% other_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```

### Beneficiary intra-household dynamics 

```{r}

curr_het_var = "Intra-hh. dynamics index (above median)" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% other_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```


### Spousal age gap

```{r}

curr_het_var = "Age gap (partner - benef.)" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% other_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("high" = "grey69", "low" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```


### Beneficiary age at marriage 

```{r}

curr_het_var = "Benef. age at marriage (above median)" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% other_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
    
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```


### Beneficiary married after 18 

```{r}

curr_het_var =   "Benef. married after 18" 
median_het = median_val %>% filter(het_var==curr_het_var) %>% select(median_value) %>% as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% other_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")
```


### Consumption at baseline

```{r}

curr_het_var = "Consumption eq. PPP (above median)"

median_het = median_val %>% 
  filter(het_var==curr_het_var) %>% 
  select(median_value) %>% 
  as.numeric()

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% other_ipv_vars, het_var==curr_het_var) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))


# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()


# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)
    
    mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)

#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
    facet_grid(depvar~name, scales = "free", space="free_x", shrink=TRUE, drop=TRUE) +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s for Tekavoul and %s for productive inclusion. Beneficiaries were divided into two groups based on the median value of %s (low ≤ %s and high > %s). "), 
   first(mainResults_reg_group$N), 
   last(mainResults_reg_group$N), 
   median_het, median_het, median_het
)) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"), width = 10, height = 14, units = "cm")

```

# Spillover effect

## Controlling Behavior

```{r}
######################## Fist estimate ##########################################
treatment_vars=c("treatment_pi_spill","treatment_pi_pool_spill")

# Define controls variables for the regression 
control_vars = c(
                "pben_handicap_bl", 
                "hhh_prim_bl",
                "pben_prim_bl", 
                "het_wtht_adult_mal", 
                "hhh_fem_bl",
                "same_cb",
                "pben_age_bl",
                "hhh_edu_bl",
                "pben_edu_bl",
                "hhh_lit_bl",
                "pben_lit_bl"
            )

followup_MRT_hh_spill_control_pi <- followup_MRT_hh_spill %>% filter(treatment_pi_spill=="Control") 

followup_MRT_hh_spill <- followup_MRT_hh_spill %>% 
  select(all_of(listOutcomes), all_of(treatment_vars), all_of(control_vars) ,village)


# Use map_dfr to iterate over each outcome and estimate effects for different treatment variables
mainResults <- map_dfr(treatment_vars, function(curr_treat_var) {
  tempResults <- map_dfr(control_ipv_vars, function(depvar) {    
    bind_rows(
      getEstimateGlobal_spill(depvar, curr_treat_var, control_vars, strata_vars, cluster_vars, followup_MRT_hh_spill) %>%
        mutate(depvar = depvar, curr_treat_var = curr_treat_var)
    )
  })
})

## Productive inclusion regression models
# Extract specific models for productive inclusion from the main results
m21 <- mainResults$results_base[[1]]  # First productive inclusion model
m22 <- mainResults$results_base[[2]]  # Second productive inclusion model
m31 <- mainResults$results_base[[3]]  # First pool productive inclusion model
m32 <- mainResults$results_base[[4]]  # Second pool productive inclusion model
# Alternative way to filter productive inclusion models from the dataset
m2 <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi_spill") %>% 
  select(results_base) %>% 
  as.list()

# Extract interaction terms for productive inclusion treatments
# Full Psychosocial interaction term
full_Psychosocial <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi_spill") %>% 
  select(full_Psychosocial) %>% 
  pull() %>% 
  as.numeric()

# Full Capital interaction term
full_Capital <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi_spill") %>% 
  select(full_Capital) %>% 
  pull() %>% 
  as.numeric()

# Psychosocial and Capital interaction term
psychosocial_Capital <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi_spill") %>% 
  select(psychosocial_Capital) %>% 
  pull() %>% 
  as.numeric()

# Initialize empty vectors to store descriptive statistics
# These will store mean and standard deviation for each outcome variable
mean_values_pi <- c()  # Vector to store mean values
sd_values_pi <- c()   # Vector to store standard deviation values
 

# Calculate descriptive statistics for each outcome variable
# Loop through the list of outcome variables
for (depvar in control_ipv_vars) {
  # Calculate and round mean, ignoring NA values
  mean_values_pi <- c(mean_values_pi,  round(mean(followup_MRT_hh_spill_control_pi[[depvar]], na.rm = TRUE), 3))

  # Calculate and round standard deviation, ignoring NA values
  sd_values_pi <- c(sd_values_pi,  round(sd(followup_MRT_hh_spill_control_pi[[depvar]], na.rm = TRUE), 3))
}

# Create lists of models for easier processing
models_pi <- list(m21, m22)  # Productive inclusion models
models_pi_pool <- list(m31, m32)  # Productive inclusion models pool

# Create regression tables for Productive Inclusion models
tbl_list_pi <- map(models_pi, ~ tbl_regression(.x, 
                                         exponentiate = FALSE,  # Keep coefficients as-is 
                                         estimate_fun = ~ style_number(.x, digits = 2),
                                         include="treatment_pi_spill")  %>% 
                  add_significance_stars(pattern = "{estimate}{stars} \n ({std.error})",
                         hide_se = TRUE) %>%
  add_glance_table(include = c(nobs, r.squared)))

tbl_list_pi_pool <- map(models_pi_pool, ~ tbl_regression(.x, 
                                         exponentiate = FALSE,  # Keep coefficients as-is 
                                         estimate_fun = ~ style_number(.x, digits = 2),
                                         include="treatment_pi_pool_spill")  %>% 
                  add_significance_stars(pattern = "{estimate}{stars} \n ({std.error})",
                         hide_se = TRUE)%>%
  add_glance_table(include = c(nobs, r.squared)))


# Modify headers for the Productive Inclusion and Cash Transfer models

tbl_list_pi[[1]] <- tbl_list_pi[[1]] %>%
   modify_header(estimate = "Binary for \n control IPV In the \n last 12 months")

tbl_list_pi_pool[[1]] <- tbl_list_pi_pool[[1]] %>%
   modify_header(estimate = "Binary for \n control IPV In the \n last 12 months")

## Refusal = 0
tbl_list_pi[[2]] <- tbl_list_pi[[2]] %>%
   modify_header(estimate = "Control \n IPV sev. \n index")


tbl_list_pi_pool[[2]] <- tbl_list_pi_pool[[2]] %>%
   modify_header(estimate = "Control \n IPV sev. \n index")
 


# Merge the stacked tables into a single table with column headers

## Productive inclusion
tbl_pi <- tbl_merge(
  tbls = list(tbl_list_pi[[1]], # First models (Refusal = missing)
              tbl_list_pi[[2]] # Second models (Refusal = 0)
              ), # Third models (Refusal = 1)
  tab_spanner = c("(1)", "(2)")
)

## Pool Productive inclusion
tbl_pi_pool <- tbl_merge(
  tbls = list(tbl_list_pi_pool[[1]], # First models (Refusal = missing)
              tbl_list_pi_pool[[2]] # Second models (Refusal = 0)
              ), # Third models (Refusal = 1)
  tab_spanner = c("(1)", "(2)")
)

# Create a list of stacked tables combining Cash Transfer and Productive Inclusion models
# Each list element combines the corresponding models from both treatment types
tbl <- tbl_stack(list(tbl_pi, tbl_pi_pool))

# Modify table body to customize variable labels
tbl <- tbl %>%
  modify_table_body(~ .x %>%
                      mutate(label = case_when(
                        # Rename specific treatment variables
                        variable == "treatment_pi_spillCapital" ~ "Capital",
                        variable == "treatment_pi_spillPsychosocial" ~ "Psychosocial",
                        variable == "treatment_pi_spillFull" ~ "Full",
                        # Label cash transfer and productive inclusion treatments
                        variable == "treatment_pi_spill"& is.na(term_1) ~ "Productive Inclusion",
                        variable == "treatment_pi_pool_spill"& is.na(term_1) ~ "Productive Inclusion (Pool)",
                        TRUE ~ label  # Keep original labels for other variables
                      )))

# Create a tribble (transposed tibble) with additional rows for the table
# These rows include control mean, standard deviation, and interaction terms _csh_trnsfr
additional_rows <- tribble(
  ~variable,  ~var_label, ~label, ~estimate_1, ~estimate_2, 
  "Control mean @ follow up PI","Control mean @ follow up PI","Control mean @ follow up PI",mean_values_pi[1], mean_values_pi[2], 
  "Control SD @ follow up PI","Control SD @ follow up PI","Control SD @ follow up PI",  sd_values_pi[1], sd_values_pi[2], 
  
  "Full - Psychosocial","Full - Psychosocial","Full - Psychosocial",   full_Psychosocial[1], full_Psychosocial[2], 
  "Full - Capital","Full - Capital", "Full - Capital", full_Capital[1], full_Capital[2], 
  "Psychosocial - Capital","Psychosocial - Capital","Psychosocial - Capital",  psychosocial_Capital[1], psychosocial_Capital[2]
)

# Append the additional rows to the table body
tbl$table_body <- bind_rows(tbl$table_body, additional_rows)

# Final table formatting
tbl <- tbl %>%
  # Set table caption
  modify_caption(control_ipv_title) %>%
  # Modify header for the label column
  modify_header(label = "**Outcome**") %>%
  # Remove all existing footnotes
  modify_footnote(everything() ~ NA) %>%
  modify_footnote(all_stat_cols() ~ NA) %>%
  # Add custom footnote with methodological details
  modify_footnote(label = "Notes: Results presented are OLS estimates that include controls for randomization strata (commune) and, where possible, baseline outcomes.  We control for social promotion intervention. Enumerator fixed effects are included in all regression. We estimate the regressions for the productive beneficiaries aged 18-49 only. Robust standard errors are shown in parentheses, clustered at the village proxy level. *** p < 0.01, ** p < 0.05, * p < 0.1.")

# Print the final table
tbl

```

## Emotional Violence

```{r}
######################## Fist estimate ##########################################


# Use map_dfr to iterate over each outcome and estimate effects for different treatment variables
mainResults <- map_dfr(treatment_vars, function(curr_treat_var) {
  tempResults <- map_dfr(emotional_ipv_vars, function(depvar) {    
    bind_rows(
      getEstimateGlobal_spill(depvar, curr_treat_var, control_vars, strata_vars, cluster_vars, followup_MRT_hh_spill) %>%
        mutate(depvar = depvar, curr_treat_var = curr_treat_var)
    )
  })
})
## Productive inclusion regression models
# Extract specific models for productive inclusion from the main results
m21 <- mainResults$results_base[[1]]  # First productive inclusion model
m22 <- mainResults$results_base[[2]]  # Second productive inclusion model
m31 <- mainResults$results_base[[3]]  # First pool productive inclusion model
m32 <- mainResults$results_base[[4]]  # Second pool productive inclusion model
# Alternative way to filter productive inclusion models from the dataset
m2 <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi_spill") %>% 
  select(results_base) %>% 
  as.list()

# Extract interaction terms for productive inclusion treatments
# Full Psychosocial interaction term
full_Psychosocial <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi_spill") %>% 
  select(full_Psychosocial) %>% 
  pull() %>% 
  as.numeric()

# Full Capital interaction term
full_Capital <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi_spill") %>% 
  select(full_Capital) %>% 
  pull() %>% 
  as.numeric()

# Psychosocial and Capital interaction term
psychosocial_Capital <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi_spill") %>% 
  select(psychosocial_Capital) %>% 
  pull() %>% 
  as.numeric()

# Initialize empty vectors to store descriptive statistics
# These will store mean and standard deviation for each outcome variable
mean_values_pi <- c()  # Vector to store mean values
sd_values_pi <- c()   # Vector to store standard deviation values
 

# Calculate descriptive statistics for each outcome variable
# Loop through the list of outcome variables
for (depvar in control_ipv_vars) {
  # Calculate and round mean, ignoring NA values
  mean_values_pi <- c(mean_values_pi,  round(mean(followup_MRT_hh_spill_control_pi[[depvar]], na.rm = TRUE), 3))

  # Calculate and round standard deviation, ignoring NA values
  sd_values_pi <- c(sd_values_pi,  round(sd(followup_MRT_hh_spill_control_pi[[depvar]], na.rm = TRUE), 3))
}

# Create lists of models for easier processing
models_pi <- list(m21, m22)  # Productive inclusion models
models_pi_pool <- list(m31, m32)  # Productive inclusion models pool

# Create regression tables for Productive Inclusion models
tbl_list_pi <- map(models_pi, ~ tbl_regression(.x, 
                                         exponentiate = FALSE,  # Keep coefficients as-is 
                                         estimate_fun = ~ style_number(.x, digits = 2),
                                         include="treatment_pi_spill")  %>% 
                  add_significance_stars(pattern = "{estimate}{stars} \n ({std.error})",
                         hide_se = TRUE) %>%
  add_glance_table(include = c(nobs, r.squared)))

tbl_list_pi_pool <- map(models_pi_pool, ~ tbl_regression(.x, 
                                         exponentiate = FALSE,  # Keep coefficients as-is 
                                         estimate_fun = ~ style_number(.x, digits = 2),
                                         include="treatment_pi_pool_spill")  %>% 
                  add_significance_stars(pattern = "{estimate}{stars} \n ({std.error})",
                         hide_se = TRUE)%>%
  add_glance_table(include = c(nobs, r.squared)))


# Modify headers for the Productive Inclusion and Cash Transfer models

# Modify headers for the Productive Inclusion and Cash Transfer models

tbl_list_pi[[1]] <- tbl_list_pi[[1]] %>%
   modify_header(estimate = "Binary \n for emo. IPV \n in the last 12 months")

tbl_list_pi_pool[[1]] <- tbl_list_pi_pool[[1]] %>%
   modify_header(estimate = "Binary \n for emo. IPV \n in the last 12 months")
 

tbl_list_pi[[2]] <- tbl_list_pi[[2]] %>%
   modify_header(estimate = "Emo. \n IPV s \n index")

tbl_list_pi_pool[[2]] <- tbl_list_pi_pool[[2]] %>%
   modify_header(estimate = "Emo. \n IPV sev. \n index")


# Merge the stacked tables into a single table with column headers

## Productive inclusion
tbl_pi <- tbl_merge(
  tbls = list(tbl_list_pi[[1]], # First models (Refusal = missing)
              tbl_list_pi[[2]] # Second models (Refusal = 0)
              ), # Third models (Refusal = 1)
  tab_spanner = c("(1)", "(2)")
)

## Pool Productive inclusion
tbl_pi_pool <- tbl_merge(
  tbls = list(tbl_list_pi_pool[[1]], # First models (Refusal = missing)
              tbl_list_pi_pool[[2]] # Second models (Refusal = 0)
              ), # Third models (Refusal = 1)
  tab_spanner = c("(1)", "(2)")
)

# Create a list of stacked tables combining Cash Transfer and Productive Inclusion models
# Each list element combines the corresponding models from both treatment types
tbl <- tbl_stack(list(tbl_pi, tbl_pi_pool))

# Modify table body to customize variable labels
tbl <- tbl %>%
  modify_table_body(~ .x %>%
                      mutate(label = case_when(
                        # Rename specific treatment variables
                        variable == "treatment_pi_spillCapital" ~ "Capital",
                        variable == "treatment_pi_spillPsychosocial" ~ "Psychosocial",
                        variable == "treatment_pi_spillFull" ~ "Full",
                        # Label cash transfer and productive inclusion treatments
                        variable == "treatment_pi_spill"& is.na(term_1) ~ "Productive Inclusion",
                        variable == "treatment_pi_pool_spill"& is.na(term_1) ~ "Productive Inclusion (Pool)",
                        TRUE ~ label  # Keep original labels for other variables
                      )))

# Create a tribble (transposed tibble) with additional rows for the table
# These rows include control mean, standard deviation, and interaction terms _csh_trnsfr
additional_rows <- tribble(
  ~variable,  ~var_label, ~label, ~estimate_1, ~estimate_2, 
  "Control mean @ follow up PI","Control mean @ follow up PI","Control mean @ follow up PI",mean_values_pi[1], mean_values_pi[2], 
  "Control SD @ follow up PI","Control SD @ follow up PI","Control SD @ follow up PI",  sd_values_pi[1], sd_values_pi[2], 
  
  "Full - Psychosocial","Full - Psychosocial","Full - Psychosocial",   full_Psychosocial[1], full_Psychosocial[2], 
  "Full - Capital","Full - Capital", "Full - Capital", full_Capital[1], full_Capital[2], 
  "Psychosocial - Capital","Psychosocial - Capital","Psychosocial - Capital",  psychosocial_Capital[1], psychosocial_Capital[2]
)

# Append the additional rows to the table body
tbl$table_body <- bind_rows(tbl$table_body, additional_rows)

# Final table formatting
tbl <- tbl %>%
  # Set table caption
  modify_caption(control_ipv_title) %>%
  # Modify header for the label column
  modify_header(label = "**Outcome**") %>%
  # Remove all existing footnotes
  modify_footnote(everything() ~ NA) %>%
  modify_footnote(all_stat_cols() ~ NA) %>%
  # Add custom footnote with methodological details
  modify_footnote(label = "Notes: Results presented are OLS estimates that include controls for randomization strata (commune) and, where possible, baseline outcomes.  We control for social promotion intervention. Enumerator fixed effects are included in all regression. We estimate the regressions for the productive beneficiaries aged 18-49 only. Robust standard errors are shown in parentheses, clustered at the village proxy level. *** p < 0.01, ** p < 0.05, * p < 0.1.")

# Print the final table
tbl


```


## Physical Violence

```{r}
######################## Fist estimate ##########################################

# Use map_dfr to iterate over each outcome and estimate effects for different treatment variables
mainResults <- map_dfr(treatment_vars, function(curr_treat_var) {
  tempResults <- map_dfr(physical_ipv_vars, function(depvar) {    
    bind_rows(
      getEstimateGlobal_spill(depvar, curr_treat_var, control_vars, strata_vars, cluster_vars, followup_MRT_hh_spill) %>%
        mutate(depvar = depvar, curr_treat_var = curr_treat_var)
    )
  })
})

## Productive inclusion regression models
# Extract specific models for productive inclusion from the main results
m21 <- mainResults$results_base[[1]]  # First productive inclusion model
m22 <- mainResults$results_base[[2]]  # Second productive inclusion model
m31 <- mainResults$results_base[[3]]  # First pool productive inclusion model
m32 <- mainResults$results_base[[4]]  # Second pool productive inclusion model
# Alternative way to filter productive inclusion models from the dataset
m2 <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi_spill") %>% 
  select(results_base) %>% 
  as.list()

# Extract interaction terms for productive inclusion treatments
# Full Psychosocial interaction term
full_Psychosocial <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi_spill") %>% 
  select(full_Psychosocial) %>% 
  pull() %>% 
  as.numeric()

# Full Capital interaction term
full_Capital <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi_spill") %>% 
  select(full_Capital) %>% 
  pull() %>% 
  as.numeric()

# Psychosocial and Capital interaction term
psychosocial_Capital <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi_spill") %>% 
  select(psychosocial_Capital) %>% 
  pull() %>% 
  as.numeric()

# Initialize empty vectors to store descriptive statistics
# These will store mean and standard deviation for each outcome variable
mean_values_pi <- c()  # Vector to store mean values
sd_values_pi <- c()   # Vector to store standard deviation values
 

# Calculate descriptive statistics for each outcome variable
# Loop through the list of outcome variables
for (depvar in control_ipv_vars) {
  # Calculate and round mean, ignoring NA values
  mean_values_pi <- c(mean_values_pi,  round(mean(followup_MRT_hh_spill_control_pi[[depvar]], na.rm = TRUE), 3))

  # Calculate and round standard deviation, ignoring NA values
  sd_values_pi <- c(sd_values_pi,  round(sd(followup_MRT_hh_spill_control_pi[[depvar]], na.rm = TRUE), 3))
}

# Create lists of models for easier processing
models_pi <- list(m21, m22)  # Productive inclusion models
models_pi_pool <- list(m31, m32)  # Productive inclusion models pool

# Create regression tables for Productive Inclusion models
tbl_list_pi <- map(models_pi, ~ tbl_regression(.x, 
                                         exponentiate = FALSE,  # Keep coefficients as-is 
                                         estimate_fun = ~ style_number(.x, digits = 2),
                                         include="treatment_pi_spill")  %>% 
                  add_significance_stars(pattern = "{estimate}{stars} \n ({std.error})",
                         hide_se = TRUE) %>%
  add_glance_table(include = c(nobs, r.squared)))

tbl_list_pi_pool <- map(models_pi_pool, ~ tbl_regression(.x, 
                                         exponentiate = FALSE,  # Keep coefficients as-is 
                                         estimate_fun = ~ style_number(.x, digits = 2),
                                         include="treatment_pi_pool_spill")  %>% 
                  add_significance_stars(pattern = "{estimate}{stars} \n ({std.error})",
                         hide_se = TRUE)%>%
  add_glance_table(include = c(nobs, r.squared)))


# Modify headers for the Productive Inclusion and Cash Transfer models
tbl_list_pi[[1]] <- tbl_list_pi[[1]] %>%
   modify_header(estimate = "Binary \n for phy. IPV \n in the last 12 months")

tbl_list_pi_pool[[1]] <- tbl_list_pi_pool[[1]] %>%
   modify_header(estimate = "Binary \n for phy. IPV \n in the last 12 months")
 

tbl_list_pi[[2]] <- tbl_list_pi[[2]] %>%
   modify_header(estimate = "Phy. \n IPV sev. \n index")

tbl_list_pi_pool[[2]] <- tbl_list_pi_pool[[2]] %>%
   modify_header(estimate = "Phy. \n IPV sev. \n index")

 


# Merge the stacked tables into a single table with column headers

## Productive inclusion
tbl_pi <- tbl_merge(
  tbls = list(tbl_list_pi[[1]], # First models (Refusal = missing)
              tbl_list_pi[[2]] # Second models (Refusal = 0)
              ), # Third models (Refusal = 1)
  tab_spanner = c("(1)", "(2)")
)

## Pool Productive inclusion
tbl_pi_pool <- tbl_merge(
  tbls = list(tbl_list_pi_pool[[1]], # First models (Refusal = missing)
              tbl_list_pi_pool[[2]] # Second models (Refusal = 0)
              ), # Third models (Refusal = 1)
  tab_spanner = c("(1)", "(2)")
)

# Create a list of stacked tables combining Cash Transfer and Productive Inclusion models
# Each list element combines the corresponding models from both treatment types
tbl <- tbl_stack(list(tbl_pi, tbl_pi_pool))

# Modify table body to customize variable labels
tbl <- tbl %>%
  modify_table_body(~ .x %>%
                      mutate(label = case_when(
                        # Rename specific treatment variables
                        variable == "treatment_pi_spillCapital" ~ "Capital",
                        variable == "treatment_pi_spillPsychosocial" ~ "Psychosocial",
                        variable == "treatment_pi_spillFull" ~ "Full",
                        # Label cash transfer and productive inclusion treatments
                        variable == "treatment_pi_spill"& is.na(term_1) ~ "Productive Inclusion",
                        variable == "treatment_pi_pool_spill"& is.na(term_1) ~ "Productive Inclusion (Pool)",
                        TRUE ~ label  # Keep original labels for other variables
                      )))

# Create a tribble (transposed tibble) with additional rows for the table
# These rows include control mean, standard deviation, and interaction terms _csh_trnsfr
additional_rows <- tribble(
  ~variable,  ~var_label, ~label, ~estimate_1, ~estimate_2, 
  "Control mean @ follow up PI","Control mean @ follow up PI","Control mean @ follow up PI",mean_values_pi[1], mean_values_pi[2], 
  "Control SD @ follow up PI","Control SD @ follow up PI","Control SD @ follow up PI",  sd_values_pi[1], sd_values_pi[2], 
  
  "Full - Psychosocial","Full - Psychosocial","Full - Psychosocial",   full_Psychosocial[1], full_Psychosocial[2], 
  "Full - Capital","Full - Capital", "Full - Capital", full_Capital[1], full_Capital[2], 
  "Psychosocial - Capital","Psychosocial - Capital","Psychosocial - Capital",  psychosocial_Capital[1], psychosocial_Capital[2]
)

# Append the additional rows to the table body
tbl$table_body <- bind_rows(tbl$table_body, additional_rows)

# Final table formatting
tbl <- tbl %>%
  # Set table caption
  modify_caption(control_ipv_title) %>%
  # Modify header for the label column
  modify_header(label = "**Outcome**") %>%
  # Remove all existing footnotes
  modify_footnote(everything() ~ NA) %>%
  modify_footnote(all_stat_cols() ~ NA) %>%
  # Add custom footnote with methodological details
  modify_footnote(label = "Notes: Results presented are OLS estimates that include controls for randomization strata (commune) and, where possible, baseline outcomes.  We control for social promotion intervention. Enumerator fixed effects are included in all regression. We estimate the regressions for the productive beneficiaries aged 18-49 only. Robust standard errors are shown in parentheses, clustered at the village proxy level. *** p < 0.01, ** p < 0.05, * p < 0.1.")

# Print the final table
tbl


```

## Sexual Violence

```{r}
######################## Fist estimate ##########################################

# Use map_dfr to iterate over each outcome and estimate effects for different treatment variables
mainResults <- map_dfr(treatment_vars, function(curr_treat_var) {
  tempResults <- map_dfr(sexual_ipv_vars, function(depvar) {    
    bind_rows(
      getEstimateGlobal_spill(depvar, curr_treat_var, control_vars, strata_vars, cluster_vars, followup_MRT_hh_spill) %>%
        mutate(depvar = depvar, curr_treat_var = curr_treat_var)
    )
  })
})

## Productive inclusion regression models
# Extract specific models for productive inclusion from the main results
m21 <- mainResults$results_base[[1]]  # First productive inclusion model
m22 <- mainResults$results_base[[2]]  # Second productive inclusion model
m31 <- mainResults$results_base[[3]]  # First pool productive inclusion model
m32 <- mainResults$results_base[[4]]  # Second pool productive inclusion model
# Alternative way to filter productive inclusion models from the dataset
m2 <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi_spill") %>% 
  select(results_base) %>% 
  as.list()

# Extract interaction terms for productive inclusion treatments
# Full Psychosocial interaction term
full_Psychosocial <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi_spill") %>% 
  select(full_Psychosocial) %>% 
  pull() %>% 
  as.numeric()

# Full Capital interaction term
full_Capital <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi_spill") %>% 
  select(full_Capital) %>% 
  pull() %>% 
  as.numeric()

# Psychosocial and Capital interaction term
psychosocial_Capital <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi_spill") %>% 
  select(psychosocial_Capital) %>% 
  pull() %>% 
  as.numeric()

# Initialize empty vectors to store descriptive statistics
# These will store mean and standard deviation for each outcome variable
mean_values_pi <- c()  # Vector to store mean values
sd_values_pi <- c()   # Vector to store standard deviation values
 

# Calculate descriptive statistics for each outcome variable
# Loop through the list of outcome variables
for (depvar in control_ipv_vars) {
  # Calculate and round mean, ignoring NA values
  mean_values_pi <- c(mean_values_pi,  round(mean(followup_MRT_hh_spill_control_pi[[depvar]], na.rm = TRUE), 3))

  # Calculate and round standard deviation, ignoring NA values
  sd_values_pi <- c(sd_values_pi,  round(sd(followup_MRT_hh_spill_control_pi[[depvar]], na.rm = TRUE), 3))
}

# Create lists of models for easier processing
models_pi <- list(m21, m22)  # Productive inclusion models
models_pi_pool <- list(m31, m32)  # Productive inclusion models pool

# Create regression tables for Productive Inclusion models
tbl_list_pi <- map(models_pi, ~ tbl_regression(.x, 
                                         exponentiate = FALSE,  # Keep coefficients as-is 
                                         estimate_fun = ~ style_number(.x, digits = 2),
                                         include="treatment_pi_spill")  %>% 
                  add_significance_stars(pattern = "{estimate}{stars} \n ({std.error})",
                         hide_se = TRUE) %>%
  add_glance_table(include = c(nobs, r.squared)))

tbl_list_pi_pool <- map(models_pi_pool, ~ tbl_regression(.x, 
                                         exponentiate = FALSE,  # Keep coefficients as-is 
                                         estimate_fun = ~ style_number(.x, digits = 2),
                                         include="treatment_pi_pool_spill")  %>% 
                  add_significance_stars(pattern = "{estimate}{stars} \n ({std.error})",
                         hide_se = TRUE)%>%
  add_glance_table(include = c(nobs, r.squared)))


# Modify headers for the Productive Inclusion and Cash Transfer models
tbl_list_pi[[1]] <- tbl_list_pi[[1]] %>%
   modify_header(estimate = "Binary \n for sex. IPV \n in the last 12 months")

tbl_list_pi_pool[[1]] <- tbl_list_pi_pool[[1]] %>%
   modify_header(estimate = "Binary \n for sex. IPV \n in the last 12 months")
 

tbl_list_pi[[2]] <- tbl_list_pi[[2]] %>%
   modify_header(estimate = "Sex. \n IPV sev. \n index")

tbl_list_pi_pool[[2]] <- tbl_list_pi_pool[[2]] %>%
   modify_header(estimate = "Sex. \n IPV sev. \n index")

 


# Merge the stacked tables into a single table with column headers

## Productive inclusion
tbl_pi <- tbl_merge(
  tbls = list(tbl_list_pi[[1]], # First models (Refusal = missing)
              tbl_list_pi[[2]] # Second models (Refusal = 0)
              ), # Third models (Refusal = 1)
  tab_spanner = c("(1)", "(2)")
)

## Pool Productive inclusion
tbl_pi_pool <- tbl_merge(
  tbls = list(tbl_list_pi_pool[[1]], # First models (Refusal = missing)
              tbl_list_pi_pool[[2]] # Second models (Refusal = 0)
              ), # Third models (Refusal = 1)
  tab_spanner = c("(1)", "(2)")
)

# Create a list of stacked tables combining Cash Transfer and Productive Inclusion models
# Each list element combines the corresponding models from both treatment types
tbl <- tbl_stack(list(tbl_pi, tbl_pi_pool))

# Modify table body to customize variable labels
tbl <- tbl %>%
  modify_table_body(~ .x %>%
                      mutate(label = case_when(
                        # Rename specific treatment variables
                        variable == "treatment_pi_spillCapital" ~ "Capital",
                        variable == "treatment_pi_spillPsychosocial" ~ "Psychosocial",
                        variable == "treatment_pi_spillFull" ~ "Full",
                        # Label cash transfer and productive inclusion treatments
                        variable == "treatment_pi_spill"& is.na(term_1) ~ "Productive Inclusion",
                        variable == "treatment_pi_pool_spill"& is.na(term_1) ~ "Productive Inclusion (Pool)",
                        TRUE ~ label  # Keep original labels for other variables
                      )))

# Create a tribble (transposed tibble) with additional rows for the table
# These rows include control mean, standard deviation, and interaction terms _csh_trnsfr
additional_rows <- tribble(
  ~variable,  ~var_label, ~label, ~estimate_1, ~estimate_2, 
  "Control mean @ follow up PI","Control mean @ follow up PI","Control mean @ follow up PI",mean_values_pi[1], mean_values_pi[2], 
  "Control SD @ follow up PI","Control SD @ follow up PI","Control SD @ follow up PI",  sd_values_pi[1], sd_values_pi[2], 
  
  "Full - Psychosocial","Full - Psychosocial","Full - Psychosocial",   full_Psychosocial[1], full_Psychosocial[2], 
  "Full - Capital","Full - Capital", "Full - Capital", full_Capital[1], full_Capital[2], 
  "Psychosocial - Capital","Psychosocial - Capital","Psychosocial - Capital",  psychosocial_Capital[1], psychosocial_Capital[2]
)

# Append the additional rows to the table body
tbl$table_body <- bind_rows(tbl$table_body, additional_rows)

# Final table formatting
tbl <- tbl %>%
  # Set table caption
  modify_caption(control_ipv_title) %>%
  # Modify header for the label column
  modify_header(label = "**Outcome**") %>%
  # Remove all existing footnotes
  modify_footnote(everything() ~ NA) %>%
  modify_footnote(all_stat_cols() ~ NA) %>%
  # Add custom footnote with methodological details
  modify_footnote(label = "Notes: Results presented are OLS estimates that include controls for randomization strata (commune) and, where possible, baseline outcomes.  We control for social promotion intervention. Enumerator fixed effects are included in all regression. We estimate the regressions for the productive beneficiaries aged 18-49 only. Robust standard errors are shown in parentheses, clustered at the village proxy level. *** p < 0.01, ** p < 0.05, * p < 0.1.")

# Print the final table
tbl


```




## Sexual and physical violence

```{r}
######################## Fist estimate ##########################################

# Use map_dfr to iterate over each outcome and estimate effects for different treatment variables
mainResults <- map_dfr(treatment_vars, function(curr_treat_var) {
  tempResults <- map_dfr(sexual_physical_ipv_vars, function(depvar) {    
    bind_rows(
      getEstimateGlobal_spill(depvar, curr_treat_var, control_vars, strata_vars, cluster_vars, followup_MRT_hh_spill) %>%
        mutate(depvar = depvar, curr_treat_var = curr_treat_var)
    )
  })
})

## Productive inclusion regression models
# Extract specific models for productive inclusion from the main results
m21 <- mainResults$results_base[[1]]  # First productive inclusion model
m22 <- mainResults$results_base[[2]]  # Second productive inclusion model
m31 <- mainResults$results_base[[3]]  # First pool productive inclusion model
m32 <- mainResults$results_base[[4]]  # Second pool productive inclusion model
# Alternative way to filter productive inclusion models from the dataset
m2 <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi_spill") %>% 
  select(results_base) %>% 
  as.list()

# Extract interaction terms for productive inclusion treatments
# Full Psychosocial interaction term
full_Psychosocial <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi_spill") %>% 
  select(full_Psychosocial) %>% 
  pull() %>% 
  as.numeric()

# Full Capital interaction term
full_Capital <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi_spill") %>% 
  select(full_Capital) %>% 
  pull() %>% 
  as.numeric()

# Psychosocial and Capital interaction term
psychosocial_Capital <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi_spill") %>% 
  select(psychosocial_Capital) %>% 
  pull() %>% 
  as.numeric()

# Initialize empty vectors to store descriptive statistics
# These will store mean and standard deviation for each outcome variable
mean_values_pi <- c()  # Vector to store mean values
sd_values_pi <- c()   # Vector to store standard deviation values
 

# Calculate descriptive statistics for each outcome variable
# Loop through the list of outcome variables
for (depvar in control_ipv_vars) {
  # Calculate and round mean, ignoring NA values
  mean_values_pi <- c(mean_values_pi,  round(mean(followup_MRT_hh_spill_control_pi[[depvar]], na.rm = TRUE), 3))

  # Calculate and round standard deviation, ignoring NA values
  sd_values_pi <- c(sd_values_pi,  round(sd(followup_MRT_hh_spill_control_pi[[depvar]], na.rm = TRUE), 3))
}

# Create lists of models for easier processing
models_pi <- list(m21, m22)  # Productive inclusion models
models_pi_pool <- list(m31, m32)  # Productive inclusion models pool

# Create regression tables for Productive Inclusion models
tbl_list_pi <- map(models_pi, ~ tbl_regression(.x, 
                                         exponentiate = FALSE,  # Keep coefficients as-is 
                                         estimate_fun = ~ style_number(.x, digits = 2),
                                         include="treatment_pi_spill")  %>% 
                  add_significance_stars(pattern = "{estimate}{stars} \n ({std.error})",
                         hide_se = TRUE) %>%
  add_glance_table(include = c(nobs, r.squared)))

tbl_list_pi_pool <- map(models_pi_pool, ~ tbl_regression(.x, 
                                         exponentiate = FALSE,  # Keep coefficients as-is 
                                         estimate_fun = ~ style_number(.x, digits = 2),
                                         include="treatment_pi_pool_spill")  %>% 
                  add_significance_stars(pattern = "{estimate}{stars} \n ({std.error})",
                         hide_se = TRUE)%>%
  add_glance_table(include = c(nobs, r.squared)))


# Modify headers for the Productive Inclusion and Cash Transfer models

# Modify headers for the Productive Inclusion and Cash Transfer models

tbl_list_pi[[1]] <- tbl_list_pi[[1]] %>%
   modify_header(estimate = "Binary \n for phy. or sex. IPV \n in the last 12 months")

tbl_list_pi_pool[[1]] <- tbl_list_pi_pool[[1]] %>%
   modify_header(estimate = "Binary \n for phy. or sex. IPV \n in the last 12 months")
 

tbl_list_pi[[2]] <- tbl_list_pi[[2]] %>%
   modify_header(estimate = "Phy. or sex. \n IPV sev. \n index")

tbl_list_pi_pool[[2]] <- tbl_list_pi_pool[[2]] %>%
   modify_header(estimate = "Phy. or sex. \n IPV sev. \n index")
 


# Merge the stacked tables into a single table with column headers

## Productive inclusion
tbl_pi <- tbl_merge(
  tbls = list(tbl_list_pi[[1]], # First models (Refusal = missing)
              tbl_list_pi[[2]] # Second models (Refusal = 0)
              ), # Third models (Refusal = 1)
  tab_spanner = c("(1)", "(2)")
)

## Pool Productive inclusion
tbl_pi_pool <- tbl_merge(
  tbls = list(tbl_list_pi_pool[[1]], # First models (Refusal = missing)
              tbl_list_pi_pool[[2]] # Second models (Refusal = 0)
              ), # Third models (Refusal = 1)
  tab_spanner = c("(1)", "(2)")
)

# Create a list of stacked tables combining Cash Transfer and Productive Inclusion models
# Each list element combines the corresponding models from both treatment types
tbl <- tbl_stack(list(tbl_pi, tbl_pi_pool))

# Modify table body to customize variable labels
tbl <- tbl %>%
  modify_table_body(~ .x %>%
                      mutate(label = case_when(
                        # Rename specific treatment variables
                        variable == "treatment_pi_spillCapital" ~ "Capital",
                        variable == "treatment_pi_spillPsychosocial" ~ "Psychosocial",
                        variable == "treatment_pi_spillFull" ~ "Full",
                        # Label cash transfer and productive inclusion treatments
                        variable == "treatment_pi_spill"& is.na(term_1) ~ "Productive Inclusion",
                        variable == "treatment_pi_pool_spill"& is.na(term_1) ~ "Productive Inclusion (Pool)",
                        TRUE ~ label  # Keep original labels for other variables
                      )))

# Create a tribble (transposed tibble) with additional rows for the table
# These rows include control mean, standard deviation, and interaction terms _csh_trnsfr
additional_rows <- tribble(
  ~variable,  ~var_label, ~label, ~estimate_1, ~estimate_2, 
  "Control mean @ follow up PI","Control mean @ follow up PI","Control mean @ follow up PI",mean_values_pi[1], mean_values_pi[2], 
  "Control SD @ follow up PI","Control SD @ follow up PI","Control SD @ follow up PI",  sd_values_pi[1], sd_values_pi[2], 
  
  "Full - Psychosocial","Full - Psychosocial","Full - Psychosocial",   full_Psychosocial[1], full_Psychosocial[2], 
  "Full - Capital","Full - Capital", "Full - Capital", full_Capital[1], full_Capital[2], 
  "Psychosocial - Capital","Psychosocial - Capital","Psychosocial - Capital",  psychosocial_Capital[1], psychosocial_Capital[2]
)

# Append the additional rows to the table body
tbl$table_body <- bind_rows(tbl$table_body, additional_rows)

# Final table formatting
tbl <- tbl %>%
  # Set table caption
  modify_caption(control_ipv_title) %>%
  # Modify header for the label column
  modify_header(label = "**Outcome**") %>%
  # Remove all existing footnotes
  modify_footnote(everything() ~ NA) %>%
  modify_footnote(all_stat_cols() ~ NA) %>%
  # Add custom footnote with methodological details
  modify_footnote(label = "Notes: Results presented are OLS estimates that include controls for randomization strata (commune) and, where possible, baseline outcomes.  We control for social promotion intervention. Enumerator fixed effects are included in all regression. We estimate the regressions for the productive beneficiaries aged 18-49 only. Robust standard errors are shown in parentheses, clustered at the village proxy level. *** p < 0.01, ** p < 0.05, * p < 0.1.")

# Print the final table
tbl

```

## Economic Violence

```{r}
######################## Fist estimate ##########################################

# Use map_dfr to iterate over each outcome and estimate effects for different treatment variables
mainResults <- map_dfr(treatment_vars, function(curr_treat_var) {
  tempResults <- map_dfr(economic_ipv_vars, function(depvar) {    
    bind_rows(
      getEstimateGlobal_spill(depvar, curr_treat_var, control_vars, strata_vars, cluster_vars, followup_MRT_hh_spill) %>%
        mutate(depvar = depvar, curr_treat_var = curr_treat_var)
    )
  })
})

## Productive inclusion regression models
# Extract specific models for productive inclusion from the main results
m21 <- mainResults$results_base[[1]]  # First productive inclusion model
m22 <- mainResults$results_base[[2]]  # Second productive inclusion model
m31 <- mainResults$results_base[[3]]  # First pool productive inclusion model
m32 <- mainResults$results_base[[4]]  # Second pool productive inclusion model
# Alternative way to filter productive inclusion models from the dataset
m2 <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi_spill") %>% 
  select(results_base) %>% 
  as.list()

# Extract interaction terms for productive inclusion treatments
# Full Psychosocial interaction term
full_Psychosocial <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi_spill") %>% 
  select(full_Psychosocial) %>% 
  pull() %>% 
  as.numeric()

# Full Capital interaction term
full_Capital <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi_spill") %>% 
  select(full_Capital) %>% 
  pull() %>% 
  as.numeric()

# Psychosocial and Capital interaction term
psychosocial_Capital <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi_spill") %>% 
  select(psychosocial_Capital) %>% 
  pull() %>% 
  as.numeric()

# Initialize empty vectors to store descriptive statistics
# These will store mean and standard deviation for each outcome variable
mean_values_pi <- c()  # Vector to store mean values
sd_values_pi <- c()   # Vector to store standard deviation values
 

# Calculate descriptive statistics for each outcome variable
# Loop through the list of outcome variables
for (depvar in control_ipv_vars) {
  # Calculate and round mean, ignoring NA values
  mean_values_pi <- c(mean_values_pi,  round(mean(followup_MRT_hh_spill_control_pi[[depvar]], na.rm = TRUE), 3))

  # Calculate and round standard deviation, ignoring NA values
  sd_values_pi <- c(sd_values_pi,  round(sd(followup_MRT_hh_spill_control_pi[[depvar]], na.rm = TRUE), 3))
}

# Create lists of models for easier processing
models_pi <- list(m21, m22)  # Productive inclusion models
models_pi_pool <- list(m31, m32)  # Productive inclusion models pool

# Create regression tables for Productive Inclusion models
tbl_list_pi <- map(models_pi, ~ tbl_regression(.x, 
                                         exponentiate = FALSE,  # Keep coefficients as-is 
                                         estimate_fun = ~ style_number(.x, digits = 2),
                                         include="treatment_pi_spill")  %>% 
                  add_significance_stars(pattern = "{estimate}{stars} \n ({std.error})",
                         hide_se = TRUE) %>%
  add_glance_table(include = c(nobs, r.squared)))

tbl_list_pi_pool <- map(models_pi_pool, ~ tbl_regression(.x, 
                                         exponentiate = FALSE,  # Keep coefficients as-is 
                                         estimate_fun = ~ style_number(.x, digits = 2),
                                         include="treatment_pi_pool_spill")  %>% 
                  add_significance_stars(pattern = "{estimate}{stars} \n ({std.error})",
                         hide_se = TRUE)%>%
  add_glance_table(include = c(nobs, r.squared)))


# Modify headers for the Productive Inclusion and Cash Transfer models
 
tbl_list_pi[[1]] <- tbl_list_pi[[1]] %>%
   modify_header(estimate = "Binary \n for eco. IPV \n in the last 12 months")

tbl_list_pi_pool[[1]] <- tbl_list_pi_pool[[1]] %>%
   modify_header(estimate = "Binary \n for eco. IPV \n in the last 12 months")
 

tbl_list_pi[[2]] <- tbl_list_pi[[2]] %>%
   modify_header(estimate = "Eco. \n IPV sev. \n index")

tbl_list_pi_pool[[2]] <- tbl_list_pi_pool[[2]] %>%
   modify_header(estimate = "Eco. \n IPV sev. \n index")

# Merge the stacked tables into a single table with column headers

## Productive inclusion
tbl_pi <- tbl_merge(
  tbls = list(tbl_list_pi[[1]], # First models (Refusal = missing)
              tbl_list_pi[[2]] # Second models (Refusal = 0)
              ), # Third models (Refusal = 1)
  tab_spanner = c("(1)", "(2)")
)

## Pool Productive inclusion
tbl_pi_pool <- tbl_merge(
  tbls = list(tbl_list_pi_pool[[1]], # First models (Refusal = missing)
              tbl_list_pi_pool[[2]] # Second models (Refusal = 0)
              ), # Third models (Refusal = 1)
  tab_spanner = c("(1)", "(2)")
)

# Create a list of stacked tables combining Cash Transfer and Productive Inclusion models
# Each list element combines the corresponding models from both treatment types
tbl <- tbl_stack(list(tbl_pi, tbl_pi_pool))

# Modify table body to customize variable labels
tbl <- tbl %>%
  modify_table_body(~ .x %>%
                      mutate(label = case_when(
                        # Rename specific treatment variables
                        variable == "treatment_pi_spillCapital" ~ "Capital",
                        variable == "treatment_pi_spillPsychosocial" ~ "Psychosocial",
                        variable == "treatment_pi_spillFull" ~ "Full",
                        # Label cash transfer and productive inclusion treatments
                        variable == "treatment_pi_spill"& is.na(term_1) ~ "Productive Inclusion",
                        variable == "treatment_pi_pool_spill"& is.na(term_1) ~ "Productive Inclusion (Pool)",
                        TRUE ~ label  # Keep original labels for other variables
                      )))

# Create a tribble (transposed tibble) with additional rows for the table
# These rows include control mean, standard deviation, and interaction terms _csh_trnsfr
additional_rows <- tribble(
  ~variable,  ~var_label, ~label, ~estimate_1, ~estimate_2, 
  "Control mean @ follow up PI","Control mean @ follow up PI","Control mean @ follow up PI",mean_values_pi[1], mean_values_pi[2], 
  "Control SD @ follow up PI","Control SD @ follow up PI","Control SD @ follow up PI",  sd_values_pi[1], sd_values_pi[2], 
  
  "Full - Psychosocial","Full - Psychosocial","Full - Psychosocial",   full_Psychosocial[1], full_Psychosocial[2], 
  "Full - Capital","Full - Capital", "Full - Capital", full_Capital[1], full_Capital[2], 
  "Psychosocial - Capital","Psychosocial - Capital","Psychosocial - Capital",  psychosocial_Capital[1], psychosocial_Capital[2]
)

# Append the additional rows to the table body
tbl$table_body <- bind_rows(tbl$table_body, additional_rows)

# Final table formatting
tbl <- tbl %>%
  # Set table caption
  modify_caption(control_ipv_title) %>%
  # Modify header for the label column
  modify_header(label = "**Outcome**") %>%
  # Remove all existing footnotes
  modify_footnote(everything() ~ NA) %>%
  modify_footnote(all_stat_cols() ~ NA) %>%
  # Add custom footnote with methodological details
  modify_footnote(label = "Notes: Results presented are OLS estimates that include controls for randomization strata (commune) and, where possible, baseline outcomes.  We control for social promotion intervention. Enumerator fixed effects are included in all regression. We estimate the regressions for the productive beneficiaries aged 18-49 only. Robust standard errors are shown in parentheses, clustered at the village proxy level. *** p < 0.01, ** p < 0.05, * p < 0.1.")

# Print the final table
tbl


```


## Any type of violence

```{r}
######################## Fist estimate ##########################################

# Use map_dfr to iterate over each outcome and estimate effects for different treatment variables
mainResults <- map_dfr(treatment_vars, function(curr_treat_var) {
  tempResults <- map_dfr(other_ipv_vars, function(depvar) {    
    bind_rows(
      getEstimateGlobal_spill(depvar, curr_treat_var, control_vars, strata_vars, cluster_vars, followup_MRT_hh_spill) %>%
        mutate(depvar = depvar, curr_treat_var = curr_treat_var)
    )
  })
})

## Productive inclusion regression models
# Extract specific models for productive inclusion from the main results
m21 <- mainResults$results_base[[1]]  # First productive inclusion model
m22 <- mainResults$results_base[[2]]  # Second productive inclusion model
m31 <- mainResults$results_base[[3]]  # First pool productive inclusion model
m32 <- mainResults$results_base[[4]]  # Second pool productive inclusion model
# Alternative way to filter productive inclusion models from the dataset
m2 <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi_spill") %>% 
  select(results_base) %>% 
  as.list()

# Extract interaction terms for productive inclusion treatments
# Full Psychosocial interaction term
full_Psychosocial <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi_spill") %>% 
  select(full_Psychosocial) %>% 
  pull() %>% 
  as.numeric()

# Full Capital interaction term
full_Capital <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi_spill") %>% 
  select(full_Capital) %>% 
  pull() %>% 
  as.numeric()

# Psychosocial and Capital interaction term
psychosocial_Capital <- mainResults %>% 
  filter(curr_treat_var=="treatment_pi_spill") %>% 
  select(psychosocial_Capital) %>% 
  pull() %>% 
  as.numeric()

# Initialize empty vectors to store descriptive statistics
# These will store mean and standard deviation for each outcome variable
mean_values_pi <- c()  # Vector to store mean values
sd_values_pi <- c()   # Vector to store standard deviation values
 

# Calculate descriptive statistics for each outcome variable
# Loop through the list of outcome variables
for (depvar in control_ipv_vars) {
  # Calculate and round mean, ignoring NA values
  mean_values_pi <- c(mean_values_pi,  round(mean(followup_MRT_hh_spill_control_pi[[depvar]], na.rm = TRUE), 3))

  # Calculate and round standard deviation, ignoring NA values
  sd_values_pi <- c(sd_values_pi,  round(sd(followup_MRT_hh_spill_control_pi[[depvar]], na.rm = TRUE), 3))
}

# Create lists of models for easier processing
models_pi <- list(m21, m22)  # Productive inclusion models
models_pi_pool <- list(m31, m32)  # Productive inclusion models pool

# Create regression tables for Productive Inclusion models
tbl_list_pi <- map(models_pi, ~ tbl_regression(.x, 
                                         exponentiate = FALSE,  # Keep coefficients as-is 
                                         estimate_fun = ~ style_number(.x, digits = 2),
                                         include="treatment_pi_spill")  %>% 
                  add_significance_stars(pattern = "{estimate}{stars} \n ({std.error})",
                         hide_se = TRUE) %>%
  add_glance_table(include = c(nobs, r.squared)))

tbl_list_pi_pool <- map(models_pi_pool, ~ tbl_regression(.x, 
                                         exponentiate = FALSE,  # Keep coefficients as-is 
                                         estimate_fun = ~ style_number(.x, digits = 2),
                                         include="treatment_pi_pool_spill")  %>% 
                  add_significance_stars(pattern = "{estimate}{stars} \n ({std.error})",
                         hide_se = TRUE)%>%
  add_glance_table(include = c(nobs, r.squared)))



tbl_list_pi[[1]] <- tbl_list_pi[[1]] %>%
   modify_header(estimate = "Binary for at \n least one type of \n IPV (exclu. eco. and control) \n in the last 12 months")

tbl_list_pi_pool[[1]] <- tbl_list_pi_pool[[1]] %>%
   modify_header(estimate = "Binary for at \n least one type of \n IPV (exclu. eco. and control) \n in the last 12 months")

tbl_list_pi[[2]] <- tbl_list_pi[[2]] %>%
   modify_header(estimate = "All IPV \n sev. index \n")

tbl_list_pi_pool[[2]] <- tbl_list_pi_pool[[2]] %>%
   modify_header(estimate = "All IPV \n sev. index \n")

# Merge the stacked tables into a single table with column headers

## Productive inclusion
tbl_pi <- tbl_merge(
  tbls = list(tbl_list_pi[[1]], # First models (Refusal = missing)
              tbl_list_pi[[2]] # Second models (Refusal = 0)
              ), # Third models (Refusal = 1)
  tab_spanner = c("(1)", "(2)")
)

## Pool Productive inclusion
tbl_pi_pool <- tbl_merge(
  tbls = list(tbl_list_pi_pool[[1]], # First models (Refusal = missing)
              tbl_list_pi_pool[[2]] # Second models (Refusal = 0)
              ), # Third models (Refusal = 1)
  tab_spanner = c("(1)", "(2)")
)

# Create a list of stacked tables combining Cash Transfer and Productive Inclusion models
# Each list element combines the corresponding models from both treatment types
tbl <- tbl_stack(list(tbl_pi, tbl_pi_pool))

# Modify table body to customize variable labels
tbl <- tbl %>%
  modify_table_body(~ .x %>%
                      mutate(label = case_when(
                        # Rename specific treatment variables
                        variable == "treatment_pi_spillCapital" ~ "Capital",
                        variable == "treatment_pi_spillPsychosocial" ~ "Psychosocial",
                        variable == "treatment_pi_spillFull" ~ "Full",
                        # Label cash transfer and productive inclusion treatments
                        variable == "treatment_pi_spill"& is.na(term_1) ~ "Productive Inclusion",
                        variable == "treatment_pi_pool_spill"& is.na(term_1) ~ "Productive Inclusion (Pool)",
                        TRUE ~ label  # Keep original labels for other variables
                      )))

# Create a tribble (transposed tibble) with additional rows for the table
# These rows include control mean, standard deviation, and interaction terms _csh_trnsfr
additional_rows <- tribble(
  ~variable,  ~var_label, ~label, ~estimate_1, ~estimate_2, 
  "Control mean @ follow up PI","Control mean @ follow up PI","Control mean @ follow up PI",mean_values_pi[1], mean_values_pi[2], 
  "Control SD @ follow up PI","Control SD @ follow up PI","Control SD @ follow up PI",  sd_values_pi[1], sd_values_pi[2], 
  
  "Full - Psychosocial","Full - Psychosocial","Full - Psychosocial",   full_Psychosocial[1], full_Psychosocial[2], 
  "Full - Capital","Full - Capital", "Full - Capital", full_Capital[1], full_Capital[2], 
  "Psychosocial - Capital","Psychosocial - Capital","Psychosocial - Capital",  psychosocial_Capital[1], psychosocial_Capital[2]
)

# Append the additional rows to the table body
tbl$table_body <- bind_rows(tbl$table_body, additional_rows)

# Final table formatting
tbl <- tbl %>%
  # Set table caption
  modify_caption(control_ipv_title) %>%
  # Modify header for the label column
  modify_header(label = "**Outcome**") %>%
  # Remove all existing footnotes
  modify_footnote(everything() ~ NA) %>%
  modify_footnote(all_stat_cols() ~ NA) %>%
  # Add custom footnote with methodological details
  modify_footnote(label = "Notes: Results presented are OLS estimates that include controls for randomization strata (commune) and, where possible, baseline outcomes.  We control for social promotion intervention. Enumerator fixed effects are included in all regression. We estimate the regressions for the productive beneficiaries aged 18-49 only. Robust standard errors are shown in parentheses, clustered at the village proxy level. *** p < 0.01, ** p < 0.05, * p < 0.1.")

# Print the final table
tbl













```


```{r}
# remove data to free space
rm(list = ls())
```


