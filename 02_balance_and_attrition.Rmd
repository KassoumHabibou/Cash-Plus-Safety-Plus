---
title: "Cash Plus, Safety Plus? Intimate Partner Violence and Productive Inclusion in Mauritania"
subtitle: "Balance test and attrition"
author: "IBRAHIM KASSOUM Habibou"
date: '`r format (Sys.Date(), "%d %B %Y")`'
output: 
  officedown::rdocx_document:
    mapstyles:
      Normal: ['First Paragraph']
---

```{r setup, include=FALSE}
# Set random seed for reproducibility
set.seed(7654)

# Set number of decimal places to display
options(digits = 3)

# Configure knitr chunk options:
knitr::opts_chunk$set(
 echo = FALSE,          # Don't show R code in output
 message = FALSE,       # Don't show messages
 warning = FALSE,       # Don't show warnings
 cache = FALSE,         # Don't cache results
 fig.align = 'center',  # Center figures
 fig.width = 6,         # Figure width in inches
 fig.asp = 0.618,       # Figure aspect ratio (golden ratio)
 fig.show = "hold"      # Hold multiple plots until end of chunk
)

# Set dplyr print options to show 6 rows max
options(dplyr.print_min = 6, dplyr.print_max = 6)


```


```{r, include=FALSE, results='hide', echo=FALSE}

######################## Importing library and external files ##################
### List of required packages
required_packages <- c("tidyverse", "dplyr","readr","officedown", "officer", "gtsummary", "flextable", "magrittr", "lmtest", "readxl","data.table","stringr","labelled","sandwich","car")

### Check if packages are installed
missing_packages <- setdiff(required_packages, installed.packages()[,"Package"])

### Install missing packages
if (length(missing_packages) > 0) {
  install.packages(missing_packages)
}

### Load all packages
lapply(required_packages, library, character.only = TRUE)

# Remove all objects
rm(list = ls())
```


```{r echo=F}

set_gtsummary_theme(theme_gtsummary_compact())

######### Create default BioAVR table from dataframe
#
# Dependencies : dplyr, flextable, officer
# source link : https://www.r-bloggers.com/2021/11/publication-ready-tables-with-flextable-and-own-theme-in-r/
customtab_defaults <- function(){
set_flextable_defaults(font.family = "Times New Roman",
font.size = 10,
border.color = "black")
}
FitFlextableToPage <- function(ft, pgwidth = 7){

  ft_out <- ft %>% autofit()

  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
}
custom_tab <- function(df, header, footer){
flextable(df) %>%
add_header_lines(header) %>%
add_footer_lines(footer) %>%
bold(i = 1, part = "header") %>%
hline_top(part = "header",
border = fp_border(color = "white",
width = 3,
style = "solid")) %>%
hline(i = 1,
part = "header",
border = fp_border(color = "black",
width = 0.25,
style = "solid")) %>%
hline_top(part = "body",
border = fp_border(color = "black",
width = 0.25,
style = "solid")) %>%
hline_bottom(part = "body",
border = fp_border(color = "black",
width = 0.25,
style = "solid")) %>%
hline_bottom(part = "footer",
border = fp_border(color = "black",
width = 0.25,
style = "solid")) %>%
border_inner_h(part = "body",
border = fp_border(color = "black",
width = 0.25,
style = "dotted")) %>%
autofit(part = "body") %>%
bg(part = "body", bg = "white") %>%
align(part = "all", align = "center") %>%
align(j = 1, part = "all", align = "left")
}
```



```{r echo=F}
# This function aims at providing customized statistics in the table that 
# with be produced using the gtsummary package
# Basically the gtsummary does not include such a function 
add_by_n <- function(data, variable, by, tbl, ...) {
  data %>%
    select(all_of(c(variable, by))) %>%
    dplyr::group_by(.data[[by]]) %>%
    dplyr::summarise_all(~sum(!is.na(.))) %>%
    rlang::set_names(c("by", "variable")) %>%
    dplyr::left_join(
      tbl$df_by %>% select(by, by_col),
      by = "by"
    ) %>%
    mutate(
      by_col = paste0("add_n_", by_col),
      variable = style_number(variable)
    ) %>%
    select(-by) %>%
    tidyr::pivot_wider(names_from = by_col, 
                       values_from = variable)
}

```

```{r}

######################## Loading the datasets ##################################
# Read the file containing the global dataframe into followup_MRT_hh

allrounds_MRT_hh <-  readRDS(paste0(getwd(),"/output/data/allrounds_MRT_hh.rds"))

baseline_MRT_hh <- readRDS(paste0(getwd(),"/output/data/baseline_MRT_hh.rds"))

followup_MRT_hh <- readRDS(paste0(getwd(),"/output/data/followup_MRT_hh.rds"))

ipv_df_all <- readRDS(paste0(getwd(),"/output/data/ipv_df_all.rds"))


followup_MRT_hh <- followup_MRT_hh %>%  # Keep only relevant phases (the followup_MRT_hh)
  filter(phase == 2)

# Convert treatment variables from numeric to factor variables for both datasets
# This is useful for regression analysis and plotting as factors are treated as categorical variables

# For baseline dataset
baseline_MRT_hh$treatment_pi <- haven::as_factor(baseline_MRT_hh$treatment_pi)           # Convert pi treatment to factor
baseline_MRT_hh$treatment_csh_trnsfr <- haven::as_factor(baseline_MRT_hh$treatment_csh_trnsfr) # Convert cash transfer treatment to factor

# For the followup dataset  
followup_MRT_hh$treatment_pi <- haven::as_factor(followup_MRT_hh$treatment_pi)         # Convert pi treatment to factor
followup_MRT_hh$treatment_csh_trnsfr <- haven::as_factor(followup_MRT_hh$treatment_csh_trnsfr) # Convert cash transfer treatment to factor


# For the IPV module 
ipv_df_all$treatment_pi <- haven::as_factor(ipv_df_all$treatment_pi)         # Convert pi treatment to factor
ipv_df_all$treatment_csh_trnsfr <- haven::as_factor(ipv_df_all$treatment_csh_trnsfr) # Convert cash transfer treatment to factor
```

<!---BLOCK_TOC--->

\newpage



<!---BLOCK_LANDSCAPE_START--->

# Introduction:

Governments around the world have expanded cash transfer programs to reach households living in poverty or food insecurity.



![Geographic coverage of the productive inclusion pilot and impact evaluation in Mauritania.](~/Dropbox/PhD thesis/chapitre_5/output/img/CoveragePI.png)

![](~/Dropbox/PhD thesis/chapitre_5/output/img/map_global.png)

\newpage

# Balance

The balance tables examine whether the participation to the survey is evenly distributed across treatment groups. Ensuring balance is essential to confirm the validity of randomization and to minimize potential confounding effects.

## Tekavoul program

The following table presents the balance test for recipients of cash transfers only. It is performed by comparing the control group of the pi (which received only the traditional cash transfer from the *Tekavoul* program) to the remaining surveyed individuals who did not receive any cash transfer.

```{r}
# Create vectors of variable names and their corresponding labels
var_vec = c("same_cb",
            "pben_handicap",
            "hhh_fem",
            "pben_fem",
            "hhh_poly",
            "pben_poly",
            "hhh_age",
            "pben_age",
            "age_gap",
            "hhh_edu",
            "pben_edu",
            "hhh_prim",
            "pben_prim",
            "hhh_lit",
            "pben_lit",
            "ctrl_earn_index_tr_bl", #B.10.5 Control Earnings Z-index at bl,
            "ctrl_hh_index_tr_bl", # B.10.6 Control HH Z-index at bl
            "intrahh_vars_index_tr_bl", # C.2.3.A Intra-HH Dynamics Z-index at Baseline
            "rev_sum_bohh_wemp_98_tr_bl", # beneficiary share of household total rev 98 wins baseline
            "mem_n",
            "hou_room",
            "hou_hea_min",
            "hou_mar_min",
            "hou_wat_min"
            )


# Create corresponding human-readable labels for each variable
label_vec = c("Benef. is HH head",
              "Benef. is handicapped",
              "Female (hh. head)",
              "Female (benef.)",
              "Polygamy (hh. head)",
              "Polygamy (benef.)",
              "Age (Hh. head)",
              "Age (benef.)",
              "Age gap (hh. head - benef.)",
              "Education (years, HH head)",
              "Education (years, benef.)",
              "Primary education (0/1, H-hh. head)",
              "Primary education (0/1, benef.)",
              "Literate (hh. head)",
              "Literate (benef.)",
            "Control over earnings", #B.10.5 Control Earnings Z-index at bl,
            "Control over hh. resources", # B.10.6 Control HH Z-index at bl
            "Intra hh. dynamics index", # C.2.3.A Intra-HH Dynamics Z-index at Baseline
            "Benef. share of total hh. rev.", # beneficiary share of household total rev 98 wins baseline
              "Household size",
              "No. of rooms in house",
              "Minutes to health center",
              "Minutes to market",
              "Minutes to water source")



# # Create vectors of variable names and their corresponding labels
var_vec = c(
            "treatment_csh_trnsfr_bin",
            "treatment_capital_bin",
            "treatment_psychosocial_bin",
            "treatment_full_bin",
            "same_cb_bl",
            "het_married_ben",
            "hhh_fem_bl",
            "pben_fem_bl",
            "hhh_poly_bl",
            "pben_poly_bl",
            "hhh_age_bl",
            "pben_age_bl",
            "age_gap",
            "het_age_gap",
            "age_at_mrrg",
            "age_at_mrrg_above18",
            "het_age_at_mrrg",
            'nbr_adult_mal',
            "het_nbr_adult_mal",
            "shr_adult_mal",
            "het_shr_adult_mal",
            "nbr_adult_mal_tot",
            "het_nbr_adult_mal_tot",
            "nbr_adult_fem",
            "het_nbr_adult_fem",
            "shr_adult_fem",
            "het_shr_adult_fem",
            "nbr_adult_fem_tot",
            "het_nbr_adult_fem_tot",
            "shr_adult_fem_mal",
            "het_shr_adult_fem_mal",
            "het_wtht_adult_mal",
            "het_wtht_adult_mal_tot",
            "nbr_adult",
            "het_nbr_adult",
            "shr_adult",
            "het_shr_adult",
            "nbr_adult_tot",
            "het_nbr_adult_tot",
            "nbr_elder",
            "het_nbr_elder",
            "shr_elder",
            "het_shr_elder",
            "hh_has_kid",
            "nbr_kid",
            "het_nbr_kid",
            "nbr_hh_number",
            "het_nbr_hh_number",
            "hhh_edu_bl",
            "pben_edu_bl",
            "hhh_prim_bl",
            "pben_prim_bl",
            "hhh_lit_bl",
            "pben_lit_bl",
            "ctrl_earn_index_tr_bl", #B.10.5 Control Earnings Z-index at bl,
            "ctrl_hh_index_tr_bl", # B.10.6 Control HH Z-index at bl
            "intrahh_vars_index_tr_bl", # C.2.3.A Intra-HH Dynamics Z-index at Baseline
            "gse_index_tr_bl",
            "soc_cohsn_index_tr_bl",
            "soc_stand_index_bl",
            "los1_bl",
            "los2_bl",
            "rev_sum_bohh",     # Revenue/income sum for household
            "region", # Region
            "tot_hh_rev", # Baseline revenu
            "consum",
            "dec_pow_earn_d_bl",
            "dec_could_earn_d_bl",      # Power/capacity to earn
            "dec_pow_ag_d_bl",
            "dec_pow_liv_d_bl",
            "dec_pow_bus_d_bl",  # Power in productive sectors
            "dec_pow_spend_d_bl",
            "dec_could_spend_d_bl",
            "dec_pow_large_d_bl",
            "dec_could_large_d_bl",
            "dec_pow_fert_d_bl",
            "dec_could_fert_d_bl",
            "dec_pow_edu_d_bl",
            "tot_emp_2rev12_ben_98_ppp_bl", 		#"Wage\n earnings\n (yearly, USD)"
          	"crop_ctrl_dum_bl", 	#"Benef. controls\n crop\n revenue \{0,1\}"
            "na_bus2_op_wn_12_ben_bl", # No. of\n beneficiary\n businesses
            "bus2_ben_dum_bl",	 	#"Beneficiary\n has a\n business \{0,1\}"
            "tot_busmths_uniq_ben_bl", #No. of months benef worked last year
            "div_n_na_12_ben_bl", # Entrepreneurial\n business types\n (yearly)
            "bus2_within_12_dum_ben_bl",	#Beneficiary\n launched a\n business \{0,1\}
            "tot_ben_rev12_98_ppp_bl", # Business\n revenues\n (yearly, USD)
          	"tot_ben_pro12_98_ppp_bl", # Business\n profits\n (yearly, USD)
            "bus_assval_98_ppp_bl", # Business\n asset\n value (USD)
            'tot_ben_rev30_98_ppp_bl',	#"Business revenue\n (beneficiary,\n monthly, USD)"
            "ani_ben_dum_bl", 		#"Benef. owns\n livestock\n \{0,1\}"
            "sleep_prod_dum_bl"	#"Benef. traveled\n for work\n \{0,1\}"

            )

# 
# # Create corresponding human-readable labels for each variable
label_vec = c(
              "Benef. of cash transfert only (0,1)",
              "Benef. of capital (0,1)",
              "Benef. of psychosocial package (0,1)",
              "Benef. of full package (0,1)",
              "Benef. is HH head",
              "Benef. is married (0,1)",
              "Benef. is handicapped",
              "Female (hh. head)",
              "Female (benef.)",
              "Polygamy (hh. head)",
              "Polygamy (benef.)",
              "Age (Hh. head)",
              "Age (benef.)",
              "Age gap (hh. head - benef.)",
              "Age gap (hh. head - benef.) above med. (0,1)",
              "Ben. age at marriage",
              "Ben. married after 18 (0,1)",
              "Ben. married aged above med. (0,1)",
              'Nbr adults males (age 25-65)',
              "Nbr adults males (age 25-65) above med. (0,1)",
              "Shr adults males (age 25-65)",
              "Shr adults males (age 25-65) above med. (0,1)",
              'Nbr males (age 15+)',
              "Nbr males (age 15+) above med. (0,1)",
              'Nbr adults females (age 25-65)',
              "Nbr adults females (age 25-65) above med. (0,1)",
              "Shr adults females (age 25-65)",
              "Shr adults females (age 25-65) above med. (0,1)",
              'Nbr females (age 15+)',
              "Nbr females (age 15+) above med. (0,1)",
              "Shr females (age 15+) in adults",
              "Shr females (age 15+) in adults above med. (0,1)",
              "Shr of hh. without males (age 25-65)",
              "Shr of hh. without males (age 15+)",
              'Nbr adults tot (age 25-65)',
              "Nbr adults tot (age 25-65) above med. (0,1)",
              "Shr adults tot (age 25-65)",
              "Shr adults tot (age 25-65) above med. (0,1)",
              "Nbr members (age 15+) in hh.",
              "Nbr members (age 15+) in hh. above med. (0,1)",
              "Nbr of elders (age 66+)",
              "Nbr of elders (age 66+) above med. (0,1)",
              "Shr of elders (age 66+)",
              "Shr of elders (age 66+) above med. (0,1)",
              "Hh. has a kid (age 0-30 mnth)",
              'Nbr kid (age 0-30 mnth)',
              "Nbr kid (age 0-30 mnth) above med. (0,1)",
              "Nbr hh. members",
              "Nbr hh. members above med. (0,1)",
              "Education (years, HH head)",
              "Education (years, benef.)",
              "Primary education (0/1, H-hh. head)",
              "Primary education (0/1, benef.)",
              "Literate (hh. head)",
              "Literate (benef.)",
              "Control over earnings", #B.10.5 Control Earnings Z-index at bl,
              "Control over hh. resources", # B.10.6 Control HH Z-index at bl
              "Intra hh. dynamics index", # C.2.3.A Intra-HH Dynamics Z-index at Baseline
              "Self efficacy",
              "Social cohesion and closeness to community",
              "Social standing",
              "Partner inclusiveness (1-4)",
              "Community inclusiveness (1-4)",
              "Ben. revenue tot.",     # Revenue/income sum for household
              "Household in Sélibaby (0,1)", # Region
              "Tot. hh. revenue", # Baseline revenu
              "Consumption eq ppp",
              "Own earnings influence (0,1)",
              "Can Decide to Earn Alone (0,1)",
              "Agriculture influence (0,1)",
              "Livestock influence (0,1)",
              "Off-farm business influence (0,1)",
              "Daily spending influence (0,1)",
              "Can Decide to Spend Alone (0,1)",
              "Large purchases influence (0,1)",
              "Can Decide to Spend Large Amounts Alone (0,1)",
              "Family planning influence (0,1)",
              "Can Make Fertility Choices Alone (0,1)",
              "Child education influence (0,1)",
              "Wage earnings (yearly, USD)",
              "Benef. controls crop revenue (0,1)",
              "No. of beneficiary businesses",
              "Beneficiary has a business (0,1)",
              "No. of months benef worked last year",
              "Entrepreneurial business types (yearly)",
              "Beneficiary launched a business (0,1)",
              "Business revenues (yearly, USD)",
              "Business profits (yearly, USD)",
              "Business asset value hh. (USD)",
              "Business revenue (beneficiary, monthly, USD)",
              "Benef. owns livestock (0,1)",
              "Benef. traveled for work (0,1)"
            )

label_var = c("Balance test")

var_lab = c("Balance")

# Filter to get the cash recipient in the followup_MRT_hh that receive Tekavoul programt
# and is in the age transfert
baseline_MRT_hh_csh_trnsfr <- baseline_MRT_hh %>%
  filter(reg_hh_csh_mrt == 1)  %>% 
  mutate(treatment_pool_bin = 0,
  treatment_csh_trnsfr_bin = as.numeric(ifelse(treatment_csh_trnsfr == "Cash Assignment" & reg_hh_csh_mrt==1, 1, 0)),
      treatment_capital_bin = 0,
      treatment_psychosocial_bin = 0,
      treatment_full_bin = 0)  %>% 
  mutate(pben_relation_bin = labelled::unlabelled(pben_relation))

# Convert all variables in var_vec to numeric type
baseline_MRT_hh_csh_trnsfr <- baseline_MRT_hh_csh_trnsfr  %>% 
  dplyr::mutate(across(var_vec, as.numeric))

# Create a tibble mapping variable names to their labels
description = tibble(
  name = var_vec,
  label = label_vec
)

# Create a named list of variable labels
var_labels <- setNames(as.list(description$label), description$name)

# Apply the variable labels to the dataset
baseline_MRT_hh_csh_trnsfr <- baseline_MRT_hh_csh_trnsfr %>%
  set_variable_labels(.labels = var_labels, .strict = FALSE)





# Create summary statistics table grouped by treatment
balance_tab_1 = baseline_MRT_hh_csh_trnsfr %>% 
  dplyr::select(treatment_csh_trnsfr,var_vec) %>%  
  tbl_summary(by = treatment_csh_trnsfr,
              type = (list=var_vec ~ "continuous"),
              statistic = list(all_continuous() ~ "{mean}({sd})"),
              digits = everything() ~ c(2,2), 
              missing = "no") %>% 
  modify_header(label = 'Variable')

# Create vector of treatment binary comparison variables
lst_treatment_bin="treatment_csh_trnsfr"

# Calculate p-values for each treatment comparison and variable
balance_tab_2 <- purrr::map_dfr(lst_treatment_bin, function(treat_var) {
  df_coef_value <- data.frame(variable = character(), 
                       treatment = character(), 
                       coef_val = character(), 
                       stringsAsFactors = FALSE)
  
  # Loop through each variable and run logistic regression
  for (v_name in var_vec) {
    # Fit logistic regression with clustered standard errors
    reg <- glm(as.formula(paste0(treat_var, " ~ ", v_name, " + strata")), 
               family = binomial, 
               data = baseline_MRT_hh_csh_trnsfr)
    
    # Calculate p-value and add significance stars
    coef_val <- round(coeftest(reg, vcovCL(reg, cluster = baseline_MRT_hh_csh_trnsfr$cluster))[2, 1], 3)
    pval <- round(coeftest(reg, vcovCL(reg, cluster = baseline_MRT_hh_csh_trnsfr$cluster))[2, 4], 3)
    
    # Add significance stars based on p-value thresholds
    if (pval < 0.01) {
      coef_val <- paste0(as.character(coef_val), "***")
    } else if (pval < 0.05) {
      coef_val <- paste0(as.character(coef_val), "**")
    } else if (pval < 0.1) {
      coef_val <- paste0(as.character(coef_val), "*")
    }else {
       coef_val <- as.character(coef_val)
    }
    
    df_coef_value <- rbind(df_coef_value, data.frame(variable = v_name, 
                                        treatment = treat_var, 
                                        coef_val = coef_val, 
                                        stringsAsFactors = FALSE))
  }
  
  return(df_coef_value)
})

# Reshape p-value table to wide format with treatment comparisons as columns
balance_tab_2 <- balance_tab_2 %>% 
  pivot_wider(id_cols = "variable", 
              names_from = "treatment", 
              values_from = "coef_val") 

# Rename columns to show treatment group comparisons
names(balance_tab_2) <- c("variable","(1)-(2)")

#Keep the variables of interest
balance_tab_2 <- balance_tab_2 %>% 
  select("(1)-(2)")

# Create table for joint F-tests
  

myfooter <- baseline_MRT_hh_csh_trnsfr %>% 
  dplyr::select(treatment_csh_trnsfr,cluster, strata) %>%  
  group_by(treatment_csh_trnsfr) %>% 
  summarise(nbr_cluster = n_distinct(cluster),
            nbr_strata = n_distinct(strata)) %>% 
  column_to_rownames(var="treatment_csh_trnsfr")

#transpose data frame
myfooter_t <- transpose(myfooter)

#redefine row and column names
rownames(myfooter_t) <- colnames(myfooter)
colnames(myfooter_t) <- balance_tab_1$table_styling$header$label[c(6,7)]

myfooter_t <- tibble::rownames_to_column(myfooter_t, "Variable") %>%
  mutate(Variable=dplyr::recode(Variable, nbr_cluster = "N cluster", nbr_strata = "N strata"))


balance_tab = cbind(
  balance_tab_1,
  balance_tab_2)

# Adding the row on the nbr of cluster and strata
balance_tab <- plyr::rbind.fill(balance_tab,myfooter_t)

header <- str_squish(str_remove("Table : Balance Table ", "\n"))
# Set Table footer
footer <- str_squish(str_remove("Notes: Standard errors for all tests are clustered at the Social Promotion Space level level. Fixed effects using randomization strata are included in all estimation regressions. The joint F-test shows the p-value from a test of equality of treatment arms. While the pooled F-test shows the p-value from a test of pooled treatment (i.e., a regression with a dummy for any treatment arm). *** p < 0.01, ** p < 0.05, * p < 0.1.", "\n"))
# Set custom_tab() defaults
customtab_defaults()
custom_tab(balance_tab, header, footer)


```

## Productive inclusion program

This balance table was created by restricting the sample to recipients of cash transfers and productive measures. Specifically, the table includes all households that are among the poorest and are considered for Tekavoul program program, where the beneficiary in the household is aged between 18 and 49.

```{r}

baseline_MRT_hh_pi <- baseline_MRT_hh %>%
  filter(reg_hh_pi_mrt == 1) %>% 
        mutate(treatment_pool_bin = as.numeric(ifelse(treatment_pi_pool=="Pool" & reg_hh_pi_mrt==1, 1, 0)),
        treatment_csh_trnsfr_bin = as.numeric(ifelse(treatment_pi_pool =="Control" & reg_hh_pi_mrt==1, 1,0)),
        
        treatment_capital_bin = as.numeric(ifelse(treatment_pi=="Capital" & reg_hh_pi_mrt==1, 1, 0)),
        
        treatment_psychosocial_bin = as.numeric(ifelse(treatment_pi=="Psychosocial" & reg_hh_pi_mrt==1, 1, 0)),
        
        treatment_full_bin = as.numeric(ifelse(treatment_pi=="Full" & reg_hh_pi_mrt==1, 1, 0)))

# Convert all variables in var_vec to numeric type
baseline_MRT_hh_pi <- baseline_MRT_hh_pi  %>% 
  dplyr::mutate(across(var_vec, as.numeric))

# Create a tibble mapping variable names to their labels
description = tibble(
  name = var_vec,
  label = label_vec
)

# Create a named list of variable labels
var_labels <- setNames(as.list(description$label), description$name)

# Apply the variable labels to the dataset
baseline_MRT_hh_pi <- baseline_MRT_hh_pi %>%
  set_variable_labels(.labels = var_labels, .strict = FALSE)



# Create summary statistics table grouped by treatment
balance_tab_1 = baseline_MRT_hh_pi %>% 
  dplyr::select(treatment_pi,var_vec) %>%  
  tbl_summary(by = treatment_pi,
              type = (list=var_vec ~ "continuous"),
              statistic = list(all_continuous() ~ "{mean}({sd})"),
              digits = everything() ~ c(2,2), 
              missing = "no") %>% 
  modify_header(label = 'Variable')

# Create vector of treatment binary comparison variables
lst_treatment_bin=paste("treatment_pi_", seq(1,6,1), sep="")

# Adding the variable for the pooled T-test
lst_treatment_bin <- append(lst_treatment_bin, "treat_dum_pi")

# Calculate p-values for each treatment comparison and variable
balance_tab_2 <- purrr::map_dfr(lst_treatment_bin, function(treat_var) {
  df_coef_value <- data.frame(variable = character(), 
                       treatment = character(), 
                       coef_val = character(), 
                       stringsAsFactors = FALSE)
  
  # Loop through each variable and run logistic regression
  for (v_name in var_vec) {
    # Fit logistic regression with clustered standard errors
    reg <- glm(as.formula(paste0(treat_var, " ~ ", v_name, " + strata")), 
               family = binomial, 
               data = baseline_MRT_hh_pi)
    
    # Calculate p-value and add significance stars
    coef_val <- round(coeftest(reg, vcovCL(reg, cluster = baseline_MRT_hh_pi$cluster))[2, 1], 3)
    pval <- round(coeftest(reg, vcovCL(reg, cluster = baseline_MRT_hh_pi$cluster))[2, 4], 3)
    # Add significance stars based on p-value thresholds
    if (pval < 0.01) {
      coef_val <- paste0(as.character(coef_val), "***")
    } else if (pval < 0.05) {
      coef_val <- paste0(as.character(coef_val), "**")
    } else if (pval < 0.1) {
      coef_val <- paste0(as.character(coef_val), "*")
    }else {
       coef_val <- as.character(coef_val)
    }
    
    df_coef_value <- rbind(df_coef_value, data.frame(variable = v_name, 
                                        treatment = treat_var, 
                                        coef_val = coef_val, 
                                        stringsAsFactors = FALSE))
  }
  
  return(df_coef_value)
})

# Reshape p-value table to wide format with treatment comparisons as columns
balance_tab_2 <- balance_tab_2 %>% 
  pivot_wider(id_cols = "variable", 
              names_from = "treatment", 
              values_from = "coef_val") 

# Rename columns to show treatment group comparisons
names(balance_tab_2) <- c("variable","(1)-(2)","(1)-(3)","(1)-(4)",
                     "(2)-(3)","(2)-(4)","(3)-(4)", "Pooled F-test \n P-value")

#Keep the variables of interest
balance_tab_2 <- balance_tab_2 %>% 
  select("(1)-(2)","(1)-(3)","(1)-(4)",
         "(2)-(3)","(2)-(4)","(3)-(4)",
         "Pooled F-test \n P-value")

# Create table for joint F-tests
  
# For each variable, run joint F-test of treatment effects

balance_tab_3 <- purrr::map_dfr(var_vec, function(v_name) { 
  

    # Fit regression model
    model <- lm(as.formula(paste0(v_name, " ~ treatment_pi + strata")), 
                 #family = binomial,
                 data = baseline_MRT_hh_pi)

    # Create hypotheses for joint test of treatment effects
    trtmnt_qult_hpthss <- c(
      paste0("treatment_pi",levels(baseline_MRT_hh_pi$treatment_pi)[-1][1],
             "=","treatment_pi",levels(baseline_MRT_hh_pi$treatment_pi)[-1][2]),
      paste0("treatment_pi",levels(baseline_MRT_hh_pi$treatment_pi)[-1][1],
             "=","treatment_pi",levels(baseline_MRT_hh_pi$treatment_pi)[-1][3]))

    # Perform joint F-test with clustered standard errors
    joint_f_test <- linearHypothesis(model, 
                                    trtmnt_qult_hpthss,
                                    test = "F", 
                                    vcov. = vcovCL(model, baseline_MRT_hh_pi$cluster))

    # Get and format p-value with significance stars
    coef_val_ftest <- round(joint_f_test$`F`[2],3)
    pval <- round(joint_f_test$`Pr(>F)`[2],3)
    if (pval < 0.01) {
      coef_val_ftest <- paste0(as.character(coef_val_ftest), "***")
    } else if (pval < 0.05) {
      coef_val_ftest <- paste0(as.character(coef_val_ftest), "**")
    } else if (pval < 0.1) {
      coef_val_ftest <- paste0(as.character(coef_val_ftest), "*")
    }else {
       coef_val_ftest <- as.character(coef_val_ftest)
    }

    # Add results to balance table
    temp_balance <- tibble(
  "Joint F-test \n P-value" = coef_val_ftest)
    

})
  



myfooter <- baseline_MRT_hh_pi %>% 
  dplyr::select(treatment_pi,cluster, strata) %>%  
  group_by(treatment_pi) %>% 
  summarise(nbr_cluster = n_distinct(cluster),
            nbr_strata = n_distinct(strata)) %>% 
  column_to_rownames(var="treatment_pi")

#transpose data frame
myfooter_t <- transpose(myfooter)

#redefine row and column names
rownames(myfooter_t) <- colnames(myfooter)
colnames(myfooter_t) <- balance_tab_1$table_styling$header$label[seq(6,9,1)]

myfooter_t <- tibble::rownames_to_column(myfooter_t, "Variable") %>%
  mutate(Variable=dplyr::recode(Variable, nbr_cluster = "N cluster", nbr_strata = "N strata"))


balance_tab = cbind(
  balance_tab_1,
  balance_tab_2,
  balance_tab_3) %>% 
  relocate("Pooled F-test \n P-value", .after = "Joint F-test \n P-value")

# Adding the row on the nbr of cluster and strata
balance_tab <- plyr::rbind.fill(balance_tab,myfooter_t)

header <- str_squish(str_remove("Table : Balance Table ", "\n"))
# Set Table footer
footer <- str_squish(str_remove("Notes: Standard errors for all tests are clustered at the Social Promotion Space level level. Fixed effects using randomization strata are included in all estimation regressions. The joint F-test shows the p-value from a test of equality of treatment arms. While the pooled F-test shows the p-value from a test of pooled treatment (i.e., a regression with a dummy for any treatment arm). *** p < 0.01, ** p < 0.05, * p < 0.1.", "\n"))
# Set custom_tab() defaults
customtab_defaults()
custom_tab(balance_tab, header, footer)


```



\newpage

# Attrition
## Tekavoul program
```{r}

# the variable of interest is v_name
var_vec = c("consent_fu2_cond")
label_vec = c("Followup survey")

# Load Baseline Data
baseline <- baseline_MRT_hh_csh_trnsfr %>%
  select(hhid, consent, treatment_csh_trnsfr, strata, cluster) %>%
  rename(consent_bl = consent) # Rename consent variable

# Load Follow-up Data (Phase 3)
# followup_MRT_hh <- followup_MRT_hh %>% 
#   select(hhid, consent) %>%
#   rename(consent_fu = consent) # Rename consent variable

# Merge Follow-up Data with Baseline
merged_data <- baseline %>%
  left_join(followup_MRT_hh %>%            
              select(hhid, consent) %>%
              rename(consent_fu = consent) # Rename consent variable
            , by="hhid") %>%
  mutate(across(starts_with("consent"), ~ replace_na(., 0)))%>%
  mutate(consent_fu2_cond = ifelse((consent_bl == 1) & (consent_fu==1), 1, 0))


# Create a tibble mapping variable names to their labels
description = tibble(
  name = var_vec,
  label = label_vec
)

# Create a named list of variable labels
var_labels <- setNames(as.list(description$label), description$name)

# Apply the variable labels to the dataset
merged_data <- merged_data %>%
  set_variable_labels(.labels = var_labels, .strict = FALSE)

# Create summary statistics table grouped by treatment
attrition_tab_1 = merged_data %>% 
  dplyr::select(treatment_csh_trnsfr,consent_fu2_cond) %>%  
  tbl_summary(by = treatment_csh_trnsfr,
              type = (list=consent_fu2_cond ~ "continuous"),
              statistic = list(all_continuous() ~ "{mean}({sd})"),
              digits = everything() ~ c(2,2), 
              missing = "no") %>% 
  modify_header(label = 'Variable')

# Create vector of treatment binary comparison variables
lst_treatment_bin="treatment_csh_trnsfr"


# Calculate p-values for each treatment comparison and variable
attrition_tab_2 <- purrr::map_dfr(lst_treatment_bin, function(treat_var) {
  df_coef_value <- data.frame(variable = character(), 
                       treatment = character(), 
                       coef_val = character(), 
                       stringsAsFactors = FALSE)
  
  # Loop through each variable and run logistic regression
  for (v_name in var_vec) {
    # Fit logistic regression with clustered standard errors
    reg <- glm(as.formula(paste0(treat_var, " ~ ", v_name, " + strata")), 
               family = binomial, 
               data = merged_data)
    
    # Calculate p-value and add significance stars
    coef_val <- round(coeftest(reg, vcovCL(reg, cluster = merged_data$cluster))[2, 1], 3)
    pval <- round(coeftest(reg, vcovCL(reg, cluster = merged_data$cluster))[2, 4], 3)
    # Add significance stars based on p-value thresholds
    if (pval < 0.01) {
      coef_val <- paste0(as.character(coef_val), "***")
    } else if (pval < 0.05) {
      coef_val <- paste0(as.character(coef_val), "**")
    } else if (pval < 0.1) {
      coef_val <- paste0(as.character(coef_val), "*")
    }else {
       coef_val <- as.character(coef_val)
    }
    
    df_coef_value <- rbind(df_coef_value, data.frame(variable = v_name, 
                                        treatment = treat_var, 
                                        coef_val = coef_val, 
                                        stringsAsFactors = FALSE))
  }
  
  return(df_coef_value)
})

# Reshape p-value table to wide format with treatment comparisons as columns
attrition_tab_2 <- attrition_tab_2 %>% 
  pivot_wider(id_cols = "variable", 
              names_from = "treatment", 
              values_from = "coef_val") 

# Rename columns to show treatment group comparisons
names(attrition_tab_2) <- c("variable","(1)-(2)")

#Keep the variables of interest
attrition_tab_2 <- attrition_tab_2 %>% 
  select("(1)-(2)")



attrition_tab = cbind(
  attrition_tab_1,
  attrition_tab_2)



header <- str_squish(str_remove("Table : Attrition Table ", "\n"))
# Set Table footer
footer <- str_squish(str_remove("Notes: Standard errors for all tests are clustered at the Social Promotion Space level level. Fixed effects using randomization strata are included in all estimation regressions. The joint F-test shows the p-value from a test of equality of treatment arms. While the pooled F-test shows the p-value from a test of pooled treatment (i.e., a regression with a dummy for any treatment arm). *** p < 0.01, ** p < 0.05, * p < 0.1.", "\n"))
# Set custom_tab() defaults
customtab_defaults()
custom_tab(attrition_tab, header, footer)
```

## Productive inclusion program
```{r}


# Load Baseline Data
baseline <- baseline_MRT_hh_pi %>%
  select(hhid, consent, contains('treatment_pi'), treat_dum_pi, strata,cluster) %>%
  rename(consent_bl = consent) # Rename consent variable

# Load Follow-up Data (Phase 3)
# followup_MRT_hh <- followup_MRT_hh %>%  # Keep only relevant phases
#   select(hhid, consent) %>%
#   rename(consent_fu = consent) # Rename consent variable

# Merge Follow-up Data with Baseline
merged_data <- baseline %>%
  left_join(followup_MRT_hh %>%            
              select(hhid, consent) %>%
              rename(consent_fu = consent) # Rename consent variable
            , by = "hhid") %>%
  mutate(across(starts_with("consent"), ~ replace_na(., 0)))%>%
  mutate(consent_fu2_cond = ifelse((consent_bl == 1) & (consent_fu==1), 1, 0))


# Create a tibble mapping variable names to their labels
description = tibble(
  name = var_vec,
  label = label_vec
)

# Create a named list of variable labels
var_labels <- setNames(as.list(description$label), description$name)

# Apply the variable labels to the dataset
merged_data <- merged_data %>%
  set_variable_labels(.labels = var_labels, .strict = FALSE)

# Create summary statistics table grouped by treatment
attrition_tab_1 = merged_data %>% 
  dplyr::select(treatment_pi,consent_fu2_cond) %>%  
  tbl_summary(by = treatment_pi,
              type = (list=consent_fu2_cond ~ "continuous"),
              statistic = list(all_continuous() ~ "{mean}({sd})"),
              digits = everything() ~ c(2,2), 
              missing = "no") %>% 
  modify_header(label = 'Variable')

# Create vector of treatment binary comparison variables
lst_treatment_bin=paste("treatment_pi_", seq(1,6,1), sep="")

# Adding the variable for the pooled T-test
lst_treatment_bin <- append(lst_treatment_bin, "treat_dum_pi")


# Calculate p-values for each treatment comparison and variable
attrition_tab_2 <- purrr::map_dfr(lst_treatment_bin, function(treat_var) {
  df_coef_value <- data.frame(variable = character(), 
                       treatment = character(), 
                       coef_val = character(), 
                       stringsAsFactors = FALSE)
  
  # Loop through each variable and run logistic regression
  for (v_name in var_vec) {
    # Fit logistic regression with clustered standard errors
    reg <- glm(as.formula(paste0(treat_var, " ~ ", v_name, " + strata")), 
               family = binomial, 
               data = merged_data)

    # Calculate p-value and add significance stars
    coef_val <- round(coeftest(reg, vcovCL(reg, cluster = merged_data$cluster))[2, 1], 3)
    pval <- round(coeftest(reg, vcovCL(reg, cluster = merged_data$cluster))[2, 4], 3)
    # Add significance stars based on p-value thresholds
    if (pval < 0.01) {
      coef_val <- paste0(as.character(coef_val), "***")
    } else if (pval < 0.05) {
      coef_val <- paste0(as.character(coef_val), "**")
    } else if (pval < 0.1) {
      coef_val <- paste0(as.character(coef_val), "*")
    }else {
       coef_val <- as.character(coef_val)
    }
    
    df_coef_value <- rbind(df_coef_value, data.frame(variable = v_name, 
                                        treatment = treat_var, 
                                        coef_val = coef_val, 
                                        stringsAsFactors = FALSE))
  }
  
  return(df_coef_value)
})

# Reshape p-value table to wide format with treatment comparisons as columns
attrition_tab_2 <- attrition_tab_2 %>% 
  pivot_wider(id_cols = "variable", 
              names_from = "treatment", 
              values_from = "coef_val") 

# Rename columns to show treatment group comparisons
names(attrition_tab_2) <- c("variable","(1)-(2)","(1)-(3)","(1)-(4)",
                     "(2)-(3)","(2)-(4)","(3)-(4)", "Pooled F-test \n P-value")

#Keep the variables of interest
attrition_tab_2 <- attrition_tab_2 %>% 
  select("(1)-(2)","(1)-(3)","(1)-(4)",
         "(2)-(3)","(2)-(4)","(3)-(4)",
         "Pooled F-test \n P-value")

# Create table for joint F-tests
  
# For each variable, run joint F-test of treatment effects

attrition_tab_3 <- purrr::map_dfr(var_vec, function(v_name) { 
  

    # Fit regression model
    model <- lm(as.formula(paste0(v_name, " ~ treatment_pi + strata")), 
                 #family = binomial,
                 data = merged_data)

    # Create hypotheses for joint test of treatment effects
    trtmnt_qult_hpthss <- c(
      paste0("treatment_pi",levels(merged_data$treatment_pi)[-1][1],
             "=","treatment_pi",levels(merged_data$treatment_pi)[-1][2]),
      paste0("treatment_pi",levels(merged_data$treatment_pi)[-1][1],
             "=","treatment_pi",levels(merged_data$treatment_pi)[-1][3]))

    # Perform joint F-test with clustered standard errors
    joint_f_test <- linearHypothesis(model, 
                                    trtmnt_qult_hpthss,
                                    test = "F", 
                                    vcov. = vcovCL(model, merged_data$cluster))

    # Get and format p-value with significance stars
    coef_val_ftest <- round(joint_f_test$`Pr(>F)`[2],3)
    pval <- round(joint_f_test$`Pr(>F)`[2],3)
    
    if (pval < 0.01) {
      coef_val_ftest <- paste0(as.character(coef_val_ftest), "***")
    } else if (pval < 0.05) {
      coef_val_ftest <- paste0(as.character(coef_val_ftest), "**")
    } else if (pval < 0.1) {
      coef_val_ftest <- paste0(as.character(coef_val_ftest), "*")
    }else {
       coef_val_ftest <- as.character(coef_val_ftest)
    }

    # Add results to balance table
    temp_attrition <- tibble(
  "Joint F-test \n P-value" = coef_val_ftest)
    

})

attrition_tab = cbind(
  attrition_tab_1,
  attrition_tab_2,
  attrition_tab_3) %>% 
  relocate("Pooled F-test \n P-value", .after = "Joint F-test \n P-value") 



header <- str_squish(str_remove("Table : Attrition Table ", "\n"))
# Set Table footer
footer <- str_squish(str_remove("Notes: Standard errors for all tests are clustered at the Social Promotion Space level level. Fixed effects using randomization strata are included in all estimation regressions. The joint F-test shows the p-value from a test of equality of treatment arms. While the pooled F-test shows the p-value from a test of pooled treatment (i.e., a regression with a dummy for any treatment arm). *** p < 0.01, ** p < 0.05, * p < 0.1.", "\n"))
# Set custom_tab() defaults
customtab_defaults()
custom_tab(attrition_tab, header, footer)
```

\newpage

# Compliance

## Tekavoul program
```{r}

# Define list of program components to analyze
stubs <- c("ctrans","coach", "avec", "video", "germe", "acv", "bourse")

# Subsetting to consider only the hh. of interest
followup_MRT_hh_csh_trnsfr <- followup_MRT_hh %>% 
  filter(reg_hh_csh_mrt==1)


# Map through each component to calculate compliance rates
compliance_rates <- purrr::map_dfr(stubs, function(stub){ 
  
  # Calculate overall mean compliance rate across all groups, convert to percentage
  overall <- round(mean(followup_MRT_hh_csh_trnsfr[[paste0("mes_", stub, "_d")]], na.rm = TRUE),3) * 100
  
  # Split data by treatment group and calculate means for each
  temp_balance <- followup_MRT_hh_csh_trnsfr %>% 
    split(.$treatment_csh_trnsfr) %>%
    purrr::map_dfr(., function(splitted_df){
      treatment_mean <- round(mean(splitted_df[[paste0("mes_", stub, "_d")]], na.rm = TRUE),3) * 100
    })
    
  # Create tibble with results
  temp_balance <- tibble(
    Variable = stub, 
    Overall = overall, 
    temp_balance)
  
  return(temp_balance)
})

# Replace short variable names with descriptive labels
compliance_rates <- compliance_rates %>% 
  mutate(
    Variable = dplyr::recode(Variable,
    ctrans = "Percentage of targeted beneficiaries who received the Tekavoul cash transfer",
      coach = "Percentage of targeted beneficiaries who received individual coaching each month",
      avec = "Attendance rates at community savings and loan groups",
      video = "Attendance rates of beneficiaries at community sensitization on aspirations and social norms",
      germe = "Attendance rates at micro-entrepreneurship training",
      acv = "Attendance rates at life skills training", 
      bourse = "Percentage of targeted beneficiaries who received their cash grant"
    ))

# Create table header
header <- str_squish(str_remove("Table : Compliance at Follow-up 3 in percentage ", "\n"))

# Create empty table footer
footer <- str_squish(str_remove("", "\n"))

# Set table formatting defaults
customtab_defaults()

# Generate final formatted table
custom_tab(compliance_rates, header, footer)

```

Low compliance rate because the question are asked 16 months after the treatment take place, people might have forget about some attendance rate but what about the cash grant ?

## Productive inclusion program
```{r}



# Subsetting to consider only the hh. of interest
followup_MRT_hh_pi <- followup_MRT_hh %>% 
  filter(reg_hh_pi_mrt==1)

# Map through each component to calculate compliance rates
compliance_rates <- purrr::map_dfr(stubs, function(stub){ 
  
  # Calculate overall mean compliance rate across all groups, convert to percentage
  overall <- round(mean(followup_MRT_hh_pi[[paste0("mes_", stub, "_d")]], na.rm = TRUE),3) * 100
  
  # Split data by treatment group and calculate means for each
  temp_balance <- followup_MRT_hh_pi %>% 
    split(.$treatment_pi) %>%
    purrr::map_dfr(., function(splitted_df){
      treatment_mean <- round(mean(splitted_df[[paste0("mes_", stub, "_d")]], na.rm = TRUE),3) * 100
    })
    
  # Create tibble with results
  temp_balance <- tibble(
    Variable = stub, 
    Overall = overall, 
    temp_balance)
  
  return(temp_balance)
})

# Replace short variable names with descriptive labels
compliance_rates <- compliance_rates %>% 
  mutate(
    Variable = dplyr::recode(Variable,
      ctrans = "Percentage of targeted beneficiaries who received the Tekavoul cash transfer",
      coach = "Percentage of targeted beneficiaries who received individual coaching each month",
      avec = "Attendance rates at community savings and loan groups",
      video = "Attendance rates of beneficiaries at community sensitization on aspirations and social norms",
      germe = "Attendance rates at micro-entrepreneurship training",
      acv = "Attendance rates at life skills training", 
      bourse = "Percentage of targeted beneficiaries who received their cash grant"
    ))

# Create table header
header <- str_squish(str_remove("Table : Compliance at Follow-up 3 in percentage ", "\n"))

# Create empty table footer
footer <- str_squish(str_remove("", "\n"))

# Set table formatting defaults
customtab_defaults()

# Generate final formatted table
custom_tab(compliance_rates, header, footer)
```



## Cross comparison (Tekavoul and the PI)

```{r}

# Create vectors of variable names and their corresponding labels
var_vec = c("same_cb",
            "pben_handicap",
            "hhh_fem",
            "pben_fem",
            "hhh_poly",
            "pben_poly",
            "hhh_age",
            "pben_age",
            "age_gap",
            "hhh_edu",
            "pben_edu",
            "hhh_prim_bl",
            "pben_prim_bl",
            "hhh_lit",
            "pben_lit",
            "ctrl_earn_index_tr_bl", #B.10.5 Control Earnings Z-index at bl, 
            "ctrl_hh_index_tr_bl", # B.10.6 Control HH Z-index at bl
            "intrahh_vars_index_tr_bl", # C.2.3.A Intra-HH Dynamics Z-index at Baseline
            "rev_sum_bohh_wemp_98_tr_bl", # beneficiary share of household total rev 98 wins baseline
            "mem_n",
            "hou_room_bl",
            "hou_hea_min_bl",
            "hou_mar_min_bl",
            "hou_wat_min_bl"
            )

# Create corresponding human-readable labels for each variable
label_vec = c("Benef. is HH head",
              "Benef. is handicapped",
              "Female (hh. head)",
              "Female (benef.)",
              "Polygamy (hh. head)",
              "Polygamy (benef.)",
              "Age (Hh. head)",
              "Age (benef.)",
              "Age gap (hh. head - benef.)",
              "Education (years, HH head)",
              "Education (years, benef.)",
              "Primary education (0/1, H-hh. head)",
              "Primary education (0/1, benef.)",
              "Literate (hh. head)",
              "Literate (benef.)",
            "Control over earnings", #B.10.5 Control Earnings Z-index at bl, 
            "Control over hh. resources", # B.10.6 Control HH Z-index at bl
            "Intra hh. dynamics index", # C.2.3.A Intra-HH Dynamics Z-index at Baseline
            "Benef. share of total hh. rev.", # beneficiary share of household total rev 98 wins baseline
              "Household size",
              "No. of rooms in house",
              "Minutes to health center",
              "Minutes to market",
              "Minutes to water source")


followup_MRT_hh <- readRDS(paste0(getwd(),"/output/data/followup_MRT_hh_and_ipv_MRT_hh.rds"))

# For all rounds dataset  
followup_MRT_hh$treatment_pi <- haven::as_factor(followup_MRT_hh$treatment_pi)         # Convert PM treatment to factor
followup_MRT_hh$treatment_csh_trnsfr <- haven::as_factor(followup_MRT_hh$treatment_csh_trnsfr) # Convert cash transfer treatment to factor

followup_MRT_hh  <- followup_MRT_hh %>%
  filter(reg_hh_csh_mrt == 1| reg_hh_pi_mrt == 1)

# Convert all variables in var_vec to numeric type
followup_MRT_hh <- followup_MRT_hh  %>% 
  dplyr::mutate(across(var_vec, as.numeric))

# Compute means and p-values
cross_tab <- map_dfr(var_vec, function(v_name) {
  
  # Extract valid data points
  data_csh <- followup_MRT_hh %>%
    filter(reg_hh_csh_mrt == 1) %>%
    pull(!!as.name(v_name)) %>%
    na.omit()
  
  data_pi <- followup_MRT_hh %>%
    filter(reg_hh_pi_mrt == 1) %>%
    pull(!!as.name(v_name)) %>%
    na.omit()
  
  # Compute means
  mean_csh <- round(mean(data_csh),3)
  mean_pi <- round(mean(data_pi),3)
  
  # Perform t-test only if variability exists in both groups
  pval <- if (length(unique(data_csh)) > 1 & length(unique(data_pi)) > 1) {
    t.test(data_csh, data_pi)$p.value
  } else {
    NA  # Return NA if no variability
  }
  
  coef_val <- round(mean_csh - mean_pi, 4)
  
  # Add significance stars
  if (!is.na(pval)) {
    if (pval < 0.01) {
      coef_val <- paste0(as.character(coef_val), "***")
    } else if (pval < 0.05) {
      coef_val <- paste0(as.character(coef_val), "**")
    } else if (pval < 0.1) {
      coef_val <- paste0(as.character(coef_val), "*")
    }
  }
  
  tibble(
    Mean_CSH = round(mean_csh, 3),
    Mean_PI = round(mean_pi, 3),
    coef_val = as.character(coef_val)
  )
})

cross_tab <- cross_tab %>% 
  mutate(Variable = label_vec) %>% 
  rename("Tekavoul" = Mean_CSH, "Productive Inclusion" = Mean_PI, "Diff."=coef_val) %>% 
  select(Variable, Tekavoul, `Productive Inclusion`, `Diff.`)

header <- str_squish(str_remove("Table : Balance Table between the two group", "\n"))
# Set Table footer
footer <- str_squish(str_remove("The Diff column is the difference between the beneficiaries of the two groups. *** p < 0.01, ** p < 0.05, * p < 0.1.", "\n"))
# Set custom_tab() defaults
customtab_defaults()
custom_tab(cross_tab, header, footer)
```

```{r}
# remove data to free space
rm(list = ls())
```
