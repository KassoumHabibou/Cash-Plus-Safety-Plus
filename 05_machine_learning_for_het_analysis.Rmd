---
title: "Cash Plus, Safety Plus? Intimate Partner Violence and Productive Inclusion in Mauritania"
subtitle: "Empirical strategy & Results"
author: "IBRAHIM KASSOUM Habibou"
date: '`r format (Sys.Date(), "%d %B %Y")`'
output: 
  officedown::rdocx_document:
    mapstyles:
      Normal: ['First Paragraph']
---


```{r setup, include=FALSE}
# Set number of decimal places to display
options(digits = 3)

# Configure knitr chunk options:
knitr::opts_chunk$set(
 echo = FALSE,          # Don't show R code in output
 message = FALSE,       # Don't show messages
 warning = FALSE,       # Don't show warnings
 cache = FALSE,         # Don't cache results
 fig.align = 'center',  # Center figures
 fig.width = 6.3,         # Figure width in inches
 fig.height= 7,          # Figure height in inches
 fig.asp = 0.8,       # Figure aspect ratio (golden ratio)
 fig.show = "hold"      # Hold multiple plots until end of chunk
)

# Set dplyr print options to show 6 rows max
options(dplyr.print_min = 6, dplyr.print_max = 6)

# Set max vector size
mem.maxVSize(vsize = Inf)
# Sometimes temporary files accumulate and cause issues. You can clear them manually or use:
#unlink(tempdir(), recursive = TRUE)
```


```{r, include=FALSE, results='hide', echo=FALSE}

######################## Importing library and external files ##################
### List of required packages
required_packages <- c("tidyverse", "dplyr","officedown", "officer", "gtsummary", "flextable", "magrittr", 'VIM', # for Knn imputation
                      "data.table","lfe","labelled","car","broom","purrr","caret","gbm","rlang","glmnet",
                      "tibble","grf","causalweight","randomForest","lmtest","sandwich","grf",'writexl')

### Check if packages are installed
missing_packages <- setdiff(required_packages, installed.packages()[,"Package"])

### Install missing packages
if (length(missing_packages) > 0) {
  install.packages(missing_packages)
}

### Load all packages
lapply(setdiff(required_packages, missing_packages), library, character.only = TRUE)

# Remove all objects
rm(list = ls())

# Source functions from external file
source("functions.R")

# Set random seed for reproducibility
set.seed(13111998)
```


```{r echo=F}

set_gtsummary_theme(theme_gtsummary_compact())

######### Create default BioAVR table from dataframe
#
# Dependencies : dplyr, flextable, officer
# source link : https://www.r-bloggers.com/2021/11/publication-ready-tables-with-flextable-and-own-theme-in-r/
customtab_defaults <- function(){
set_flextable_defaults(font.family = "Times New Roman",
font.size = 10,
border.color = "black")
}
FitFlextableToPage <- function(ft, pgwidth = 8){

  ft_out <- ft %>% autofit()

  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
}
custom_tab <- function(df, header, footer){
flextable(df) %>%
add_header_lines(header) %>%
add_footer_lines(footer) %>%
bold(i = 1, part = "header") %>%
hline_top(part = "header",
border = fp_border(color = "white",
width = 3,
style = "solid")) %>%
hline(i = 1,
part = "header",
border = fp_border(color = "black",
width = 0.25,
style = "solid")) %>%
hline_top(part = "body",
border = fp_border(color = "black",
width = 0.25,
style = "solid")) %>%
hline_bottom(part = "body",
border = fp_border(color = "black",
width = 0.25,
style = "solid")) %>%
hline_bottom(part = "footer",
border = fp_border(color = "black",
width = 0.25,
style = "solid")) %>%
border_inner_h(part = "body",
border = fp_border(color = "black",
width = 0.25,
style = "dotted")) %>%
autofit(part = "body") %>%
bg(part = "body", bg = "white") %>%
align(part = "all", align = "center") %>%
align(j = 1, part = "all", align = "left")
}
```


```{r}

######################## Loading the datasets ##################################
# Read the file containing the global dataframe into followup_MRT_hh
followup_MRT_hh <- readRDS(paste0(getwd(),"/output/data/followup_MRT_hh_and_ipv_MRT_hh.rds"))


# Convert treatment variables from numeric to factor variables for both datasets
# This is useful for regression analysis and plotting as factors are treated as categorical variables

 # Convert PM treatment to factor
followup_MRT_hh$treatment_pi <- haven::as_factor(followup_MRT_hh$treatment_pi)

# Convert cash transfer treatment to factor
followup_MRT_hh$treatment_csh_trnsfr <- haven::as_factor(followup_MRT_hh$treatment_csh_trnsfr)

# Filtering for control data
control_ipv_vars <- c("control_ipv_sev_12m","control_ipv_sev_index")
emotional_ipv_vars <- c("emo_ipv_sev_12m","emo_ipv_sev_index") #"emo_ipv_inten_index",
physical_ipv_vars <- c("phy_ipv_sev_12m","phy_ipv_sev_index") #"phy_ipv_inten_index",
sexual_ipv_vars <- c("sex_ipv_sev_12m","sex_ipv_sev_index") #,"sex_ipv_inten_index"
sexual_physical_ipv_vars  <- c("sex_phy_ipv_sev_12m","sex_phy_ipv_sev_index")
economic_ipv_vars <- c("eco_ipv_sev_12m","eco_ipv_sev_index") #,"eco_ipv_inten_index"
other_ipv_vars <- c("all_ipv_sev_12m","all_ipv_sev_index") # All type of IPV excluding eco

# List of outcome variables
lst_outcome_ml <- c(
  "control_ipv_sev_12m",
  "control_ipv_sev_index",
  "emo_ipv_sev_12m",
  "emo_ipv_sev_index",
  "phy_ipv_sev_12m",
  "phy_ipv_sev_index",
  "sex_ipv_sev_12m",
  "sex_ipv_sev_index",
  "sex_phy_ipv_sev_12m", 
  "sex_phy_ipv_sev_index",
  "eco_ipv_sev_12m",
  "eco_ipv_sev_index",
  "all_ipv_sev_12m",
  "all_ipv_sev_index"
)

# Define the two treatment variables 
#treatment_vars=c("treatment_csh_trnsfr","treatment_pi","treatment_pi_pool","type_treatment")
treatment_vars=c("treatment_csh_trnsfr","treatment_pi","treatment_pi_pool")

# All outcomes variables
listOutcomes=c(control_ipv_vars, emotional_ipv_vars, physical_ipv_vars, sexual_ipv_vars,sexual_physical_ipv_vars, economic_ipv_vars, other_ipv_vars)

# Define controls variables for the regression 
control_vars = c("hhh_fem_bl", 
            "mem_n_bl",
            "same_cb",
            "pben_handicap",
            "hhh_poly",
            "pben_poly",
            "hhh_age",
            "pben_age",
            "age_gap",
            "hhh_edu",
            "pben_edu",
            "hhh_lit",
            "pben_lit")

# Define cluster variables 
cluster_vars <- c("cluster")

# Define strata variables: strata
strata_vars <- c("") 

followup_MRT_hh <- followup_MRT_hh %>%
  # Remove rows with missing values in any of the outcome variables
  dplyr::select(-c(starts_with("ipv"), ends_with("_ever"), ends_with("_index2"))) %>% 
  dplyr::select(-c(deviceid,subscriberid,allows_comment,devicephonenum,duration,surveyor)) 

# Variables that are not common to both baseline and followup surveys then can't be use for the ML model?"mr1", "mr2", "mr3", "mr4", "mr5", "mr6", "mr7",
vars_to_rm_ml <- c(
  "start_msr", 
  "end_msr", "start_ipv", "start_vioeco", "end_vioeco", "start_contj", "end_contj",
  "start_evm", "end_evm", "start_evp", "end_evp", "start_evs", "end_evs", "end_ipv",
  "language", "language_1", "language_2", "language_3", "language_4",
  "formdef_version", "key", "submissiondate",
  "starttime", "endtime",  "f_ipv_agemarr", "f_ipv_polyg", 
  "f_ipv_marrbefore", "f_ipv_everpreg", "f_ipv_preg_nb", "control_ipv_r0_12m",
  "control_ipv_r1_12m", "emo_ipv_r0_12m", "emo_ipv_r1_12m", "phy_ipv_r0_12m",
  "phy_ipv_r1_12m", "sex_ipv_r0_12m", "sex_ipv_r1_12m", "eco_ipv1", "eco_ipv2",
  "eco_ipv3", "eco_ipv_r0_12m", "eco_ipv_r1_12m", 
   "soc_prmtn", "cash_trsfr", 
  "childlist", "childlist15_25", "newkid_n", "newkid_d", "newmem_n",
  "newmem_d", "lostmem_s", "newmem_s", "new_mem1_n", "new_mem2_n", "new_mem4_n",
  "new_kid4_n", "new_mem5_n", "new_kid5_n", "new_mem6_n", "new_kid6_n",
  "new_mem7_n", "new_kid7_n", "new_mem8_n",  "new_mem9_n", #"new_kid8_n",
  "new_kid9_n", "new_mem10_n", "new_kid10_n", "new_mem11_n", "new_kid11_n",
  "new_mem12_n", "new_kid12_n", "new_mem13_n", "new_kid13_n", "new_mem14_n",
  "new_kid14_n", "new_mem15_n", "new_kid15_n", "new_mem16_n", "new_kid16_n",
  "new_mem17_n", "new_mem18_n", "new_kid18_n", "new_mem19_n", "new_mem20_n",
  "new_earlychild_n", "new_olderchild_n", "new_workage1_n", "new_workage2_n",
  "new_workage3_n", "new_workage4_n", "new_workage5_n", "new_elder_n",
  "new_male_n", "new_female_n", "new_workageo_n", "new_workageo_mal_n",
  "new_workageo_fem_n", "new_mem1_d", "new_mem2_d", "new_mem4_d", "new_kid4_d",
  "new_mem5_d", "new_kid5_d", "new_mem6_d", "new_kid6_d", "new_mem7_d",
  "new_kid7_d", "new_mem8_d",  "new_mem9_d", "new_kid9_d", #"new_kid8_d",
  "new_mem10_d", "new_kid10_d", "new_mem11_d", "new_kid11_d", "new_mem12_d",
  "new_kid12_d", "new_mem13_d", "new_kid13_d", "new_mem14_d", "new_kid14_d",
  "new_mem15_d", "new_kid15_d", "new_mem16_d", "new_kid16_d", "new_mem17_d",
  "new_mem18_d", "new_kid18_d", "new_mem19_d", "new_mem20_d", "new_earlychild_d",
  "new_olderchild_d", "new_workage1_d", "new_workage2_d", "new_workage3_d",
  "new_workage4_d", "new_workage5_d", "new_elder_d", "new_male_d", "new_female_d",
  "new_workageo_d", "new_workageo_mal_d", "new_workageo_fem_d", "newmem_y1_n",
  "newmem_y2_n", "newmem_y3_n", "newmem_y4_n", "newmem_y5_n", "newmem_y1_d",
  "newmem_y2_d", "newmem_y3_d", "newmem_y4_d", "newmem_y5_d", "stmem_ynot1_n",
  "stmem_ynot2_n", "stmem_ynot3_n", "stmem_ynot4_n", "stmem_ynot5_n",
  "stmem_ynot6_n", "stmem_ynot7_n", "stmem_ynot8_n", "stmem_ynot9_n",
  "stmem_ynot10_n", "stmem_ynot1_d", "stmem_ynot2_d", "stmem_ynot3_d",
  "stmem_ynot4_d", "stmem_ynot5_d", "stmem_ynot6_d", "stmem_ynot7_d",
  "stmem_ynot8_d", "stmem_ynot9_d", "stmem_ynot10_d", "lostmem_n",
  "lost_earlychild_n", "lost_olderchild_n", "lost_workage1_n", "lost_workage2_n",
  "lost_workage3_n", "lost_workage4_n", "lost_workage5_n", "lost_elder_n",
  "lost_workageo_n", "lostmem_d", "lost_earlychild_d", "lost_olderchild_d",
  "lost_workage1_d", "lost_workage2_d", "lost_workage3_d", "lost_workage4_d",
  "lost_workage5_d", "lost_elder_d", "lost_workageo_d", "gone_mem1_d",
  "gone_mem2_d", "gone_mem3_d", "gone_mem4_d", "gone_mem5_d", "gone_mem6_d",
  "gone_mem7_d", "gone_mem8_d", "gone_mem9_d", "gone_mem10_d", "gone_mem11_d",
  "gone_mem12_d", "gone_mem13_d", "gone_mem14_d", "gone_mem15_d", "gone_mem16_d",
  "gone_mem17_d", "gone_mem1_n", "gone_mem2_n", "gone_mem3_n", "gone_mem4_n",
  "gone_mem5_n", "gone_mem6_n", "gone_mem7_n", "gone_mem8_n", "gone_mem9_n",
  "gone_mem10_n", "gone_mem11_n", "gone_mem12_n", "gone_mem13_n", "gone_mem14_n",
  "gone_mem15_n", "gone_mem16_n", "gone_mem17_n", "gone_mem18_n", "gone_mem19_n",
  "_EMPLOYMENT_", "PAP_b3_5", "PAP_b2_2", "_madult", "_BUSINESS_",
  "act_main_nonag", "_mBus2", "bus2_abandon_24_dum", "bus2_abandon_24_dum_ben",
  "chef_ownmanage", "_mBus_B81_84", "b_fut_stpa", "b_fut_ninv", "b_fut_kinv",
  "_mBus_invest", "_mBus_estim", "_mBus_costs", "_mBus_divrse",
  "hh_has_bus_empl", "_mBus_workers", "bus_assval_ben_90_ppp",
  "bus_assval_ben_95_ppp", "bus_assval_ben_98_ppp", "bus2_invest_ppp",
  "bus2_profits_hh_ppp", "bus2_profits_hh_ppp_ben", "tot_bus_least_ppp",
  "tot_bus_most_ppp", "tot_put_1_ppp", "tot_put_4_ppp", "tot_put_6_ppp",
  "tot_put_others_ppp", "_FINANCE_", "ton_or_avec_hh", "ton_hh", "avec_hh",
  "saving_d", "saving_out_d", "saving_group_d", "dep_out_grp_ratio",
  "save_share_d", "save_goal", "tot_sav3_ppp", "tot_sav24_ppp",
  "tot_dep_out_ppp", "tot_dep_out_grp_ppp", "saving_out_ppp", "saving_ppp",
  "saving_inf_ppp", "saving_for_ppp", "saving_group_ppp", "_HOUSING_",
  "_CASH_TRANSFERS_", "mes_ctrans_d", "ctrans_whoelse", "ctrans_food_d",
  "ctrans_edu_d", "ctrans_hea_d", "ctrans_sav_d", "ctrans_inv_d",
  "ctrans_hh_d", "ctrans_outhh_d", "ctrans_debt_d", "ctrans_oth_d",
  "ctrans_total_90_ppp", "ctrans_total_95_ppp", "ctrans_total_98_ppp",
  "ctrans_food_ppp", "ctrans_edu_ppp", "ctrans_hea_ppp", "ctrans_debt_ppp",
  "_EMPOWERMENT_", "dec_weight_index", "dec_weight_index_1", "dec_pow_care",
  "dw_index_new", "dw_index_new_1_7", "dw_index_new_8_10", "dw_index_n_s",
  "dw_index_s_n", "dw_index_n_n", "dec_pow_care_fam_1", "dw_wid_0_ind",
  "dw_fam_1_ind", "dw_wid_0_ind_7", "dw_fam_1_ind_7", "dec_psblty_index",
  "dec_could_care", "ani_contr_ben_dum", "ani_contr_chef_dum",
  "prod_agency_index", "ctrl_earn_index", "ctrl_hh_index",
  "dec_pow_his_earn_d", "dec_pow_care_d", "dec_could_care_d",
  "dec_weight_index_d", "dec_psblty_index_d", "ctrl_hh_index_d",
  "_PSYCHOLOGY_", "stairs_peace", "health_ment_z", "ment_hlth_index",
  "ment_hlth_f_index", "gse2", "gse_sum", "gse_index", "stair_status_future",
  "stair_satis_future", "stair_status_child", "future_expct_index",
  "future_expct_f_index", "stair_status_child_30", "future_expct_30_index",
  "future_expct_30_f_index", "_SHOCKS_", "shock_worst6", "_PREFERENCE_",
  "_FOODSEC_", "FCS", "_CONSUMPTION_", "__FOOD_1__", "__FOOD_2__",
  "__NONFOOD__", "temp", "__CELEBRATION__", "__EDUCATION__", "__HEALTH__",
  "__EATOUT__", "__TOTAL_CONSUMPTION_1__", "food_1_year_s", "food_1_day_s",
  "food_1_day_pc_s", "food_1_day_eq_s", "__TOTAL_CONSUMPTION_2__",
  "food_2_year_s", "food_2_day_s", "food_2_day_pc_s", "food_2_day_eq_s",
  "health_4weeks_day_ppp", "health_12months_day_ppp", "health_day_ppp",
  "health_year_ppp", "health_day_pc_ppp", "health_day_eq_ppp",
  "eatout_day_ppp", "eatout_year_ppp", "eatout_day_pc_ppp", "eatout_day_eq_ppp",
  "consum_1_year_ppp", "consum_1_day_ppp", "consum_1_day_pc_ppp",
  "consum_1_day_eq_ppp", "consum_2_year_ppp", "consum_2_day_ppp",
  "consum_2_day_pc_ppp", "consum_2_day_eq_ppp", "_ASSETS_", "ag_val_98_ppp",
  "ag_val_95_ppp", "ag_val_90_ppp", "ag_val_ben_98_ppp", "ag_val_ben_95_ppp",
  "ag_val_ben_90_ppp", "_LIVESTOCK_", "PAP_d5", "tot_ani_n_diff_tlu",
  "tot_ani_ago_tlu", "tot_ani_guard_tlu", "tot_ani_gift_tlu",
  "tot_ani_stile_tlu", "tot_ani_cat_tlu", "tot_ani_slau_tlu",
  "tot_ani_bot_tlu", "tot_ani_sold_tlu", "PAP_b3", "PAP_b10_3_4",
  "PAP_b52_asset", "ani_val_bohh_90", "ani_val_bohh_95", "ani_val_bohh_98",
  "PAP_d5_bot_val", "PAP_b2_b1035", "tot_ani_bohh_contr_90",
  "tot_ani_bohh_contr_95", "tot_ani_bohh_contr_98", "_mergBEN",
  "tot_ani_botval_ppp", "tot_ani_ben_contr_98_ppp",
  "tot_ani_ben_contr_95_ppp", "tot_ani_ben_contr_90_ppp",
  "tot_ani_hh_contr_98_ppp", "tot_ani_hh_contr_95_ppp",
  "tot_ani_hh_contr_90_ppp", "tot_ani_hhlb_contr_98_ppp",
  "tot_ani_hhlb_contr_95_ppp", "tot_ani_hhlb_contr_90_ppp",
  "tot_ani_chef_contr_98_ppp", "tot_ani_chef_contr_95_ppp",
  "tot_ani_chef_contr_90_ppp", "ani_val_90_ppp", "ani_val_95_ppp",
  "ani_val_98_ppp", "ani_val_ben_90_ppp", "ani_val_ben_95_ppp",
  "ani_val_ben_98_ppp", "ani_val_hhlb_90_ppp",   "ani_val_hhlb_95_ppp", "ani_val_hhlb_98_ppp", "tot_ani_prod_hh_ppp",
  "ani_val_hh_bov_ppp", "ani_val_hh_equi_ppp", "ani_val_hh_ovi_ppp",
  "ani_val_hh_avi_ppp", "ani_val_ben_bov_ppp", "ani_val_ben_equi_ppp",
  "ani_val_ben_ovi_ppp", "ani_val_ben_avi_ppp", "ani_botval_hh_equi_ppp",
  "ani_botval_hh_ovi_ppp", "ani_botval_hh_avi_ppp", "ani_contr_hh_bov_90_ppp",
  "ani_contr_hh_equi_90_ppp", "ani_contr_hh_ovi_90_ppp",
  "ani_contr_hh_avi_90_ppp", "ani_contr_hh_bov_95_ppp",
  "ani_contr_hh_equi_95_ppp", "ani_contr_hh_ovi_95_ppp",
  "ani_contr_hh_avi_95_ppp", "ani_contr_hh_bov_98_ppp",
  "ani_contr_hh_equi_98_ppp", "ani_contr_hh_ovi_98_ppp",
  "ani_contr_hh_avi_98_ppp", "ani_contr_ben_bov_90_ppp",
  "ani_contr_ben_equi_90_ppp", "ani_contr_ben_ovi_90_ppp",
  "ani_contr_ben_avi_90_ppp", "ani_contr_ben_bov_95_ppp",
  "ani_contr_ben_equi_95_ppp", "ani_contr_ben_ovi_95_ppp",
  "ani_contr_ben_avi_95_ppp", "ani_contr_ben_bov_98_ppp",
  "ani_contr_ben_equi_98_ppp", "ani_contr_ben_ovi_98_ppp",
  "ani_contr_ben_avi_98_ppp", "ihs_tot_ani_botval_ppp",
  "ihs_tot_ani_ben_contr_98_ppp", "ihs_tot_ani_ben_contr_95_ppp",
  "ihs_tot_ani_ben_contr_90_ppp", "ihs_tot_ani_hh_contr_98_ppp",
  "ihs_tot_ani_hh_contr_95_ppp", "ihs_tot_ani_hh_contr_90_ppp",
  "_AGRICULTURE_", "ag_r_c11_comm", "ag_r_c11_comm_chef",
  "ag_r_c11_comm_ben", "ag_c11_hh_d", "ag_c11_chef_d", "ag_c11_ben_d",
  "ag_c11_hrv_qty", "ag_c11_plotsize", "ag_c12_hrv_qty", "ag_c12_plotsize",
  "ag_c16_hrv_qty", "ag_c16_plotsize", "ag_c40_hh_d", "ag_c40_chef_d",
  "ag_c40_ben_d", "ag_c49_hrv_qty", "ag_c49_plotsize", "ag_c11_hrv_qty_adult",
  "ag_c12_hrv_qty_adult", "ag_c16_hrv_qty_adult", "ag_c49_hrv_qty_adult",
  "ag_c11_hrv_imp_ppp", "ag_c40_hrv_imp_ppp", "ag_c11_hrv_chef_imp_ppp",
  "ag_c11_hrv_ben_imp_ppp", "ag_c40_hrv_chef_imp_ppp",
  "ag_c40_hrv_ben_imp_ppp", "ag_c11_sale_imp_ppp",
  "ag_c11_sale_chef_imp_ppp", "ag_c11_sale_ben_imp_ppp",
  "_OTHER_PROGRAMS_", "prog_1_ppp", "prog_2_ppp", "prog_3_ppp",
  "prog_4_ppp", "prog_5_ppp", "prog_6_ppp", "prog_8_ppp", "prog_9_ppp",
  "_TRANSFERS_", "trans_fam_send", "tot_trans_out_ppp", "gross_trans_ppp",
  "_MISC_", "rev_sum_hh_90", "rev_sum_hh_wemp_90", "rev_sum_ben_90",
  "rev_sum_ben_wemp_90", "rev_sum_hhlb_90", "rev_sum_hhlb_wemp_90",
  "rev_sum_chef_90", "rev_sum_chef_wemp_90", "rev_sum_hh_95",
  "rev_sum_hh_wemp_95", "rev_sum_ben_95", "rev_sum_ben_wemp_95",
  "rev_sum_hhlb_95", "rev_sum_hhlb_wemp_95", "rev_sum_chef_95",
  "rev_sum_chef_wemp_95", "rev_sum_hh_98", "rev_sum_hh_wemp_98",
  "rev_sum_ben_98", "rev_sum_ben_wemp_98", "rev_sum_hhlb_98",
  "rev_sum_hhlb_wemp_98", "rev_sum_chef_98", "rev_sum_chef_wemp_98",
  "mycons2_ihs", "mycons2_log", "mysumrev12_hh_ihs_98",
  "mysumrev12_hh_ihs_95", "mysumrev12_hh_ihs_90", "myanirev12_hh_ihs_98",
  "myanirev12_hh_ihs_95", "myanirev12_hh_ihs_90", "mysumrev12_ben_ihs_98",
  "mysumrev12_ben_ihs_95", "mysumrev12_ben_ihs_90", "myanirev12_ben_ihs_98",
  "myanirev12_ben_ihs_95", "myanirev12_ben_ihs_90", "rev_sum_hh_eq_wemp_98",
  "rev_sum_ben_eq_wemp_98", "rev_sum_hh_eq_wemp_95",
  "rev_sum_ben_eq_wemp_95", "rev_sum_hh_eq_wemp_90",
  "rev_sum_ben_eq_wemp_90", "consum_2_day_eq_ppp_std",
  "rev_sum_hh_wemp_98_std", "rev_sum_hh_wemp_95_std",
  "rev_sum_hh_wemp_90_std", "rev_sum_hh_eq_wemp_90_std",
  "rev_sum_hh_eq_wemp_95_std", "rev_sum_hh_eq_wemp_98_std",
  "rev_sum_ben_wemp_98_std", "rev_sum_ben_wemp_95_std",
  "rev_sum_ben_wemp_90_std", "rev_sum_ben_eq_wemp_98_std",
  "rev_sum_ben_eq_wemp_95_std", "rev_sum_ben_eq_wemp_90_std",
  "consum_2_day_eqbl_ppp", "t_exodamtsend_98_ppp",
  "ctrans_total_y_98_ppp", "tot_cash_inflow_ppp", "newmem_sbl",
  "lostmem_sbl", "_childlabHH_", "child_days_bus", "c15_25_days_bus",
  "child_days_ani", "child_lab_index", "_mC_3_2", "child_water_fire_d_hh",
  "child_laundry_d_hh", "child_shop_d_hh", "child_hh_lab_index", "_mC_3_3",
  "_lab_prtcp_", "tot_ben_bus_days", "tot_chef_bus_days", "tot_hh_bus_days",
  "tot_hhlb_bus_days", "_mben_lab3", "tot_hh_liv_days", "tot_chef_liv_days",
  "tot_ben_liv_days", "tot_hhlb_liv_days", "_gender_prcpt_",
  "gender_attitudes_index", "dom_burn_rvrs", "dom_kids_rvrs",
  "ten_violen_rvrs", "ten_men_rvrs", "ten_boys", "dom_relation_index",
  "ten_tension", "vill_burn", "vill_kids", "_social_", #"rel_disagree",
  "rel_interest", "los3", "partner_vars_index", "tens_house_rvrs",
  "hh_vars_index", "intrahh_vars_index", "ten_violen", "ten_men",
  "tens_house", "enemy", "tens_comm", "ten_mentravel", "ten_menown",
  "ten_womentravel", "ten_womenown", "social_support_index", "role",
  "soc_tips", "soc_tips_in", "soc_confl", "soc_confl_in", "other_market",
  "ask_siblings_w", "ask_sum1", "ask_sum2", "ask_sum1_w", "ask_siblings",
  "ask_otherfam", "ask_friends", "ask_otherknown", "ask_sum2_w", "aff_ieff",
  "for_trust_1", "enemy_rvrs", "tens_comm_rvrs", "soc_cohsn_index",
  "aut_fond_ppp", "collective_action_index", "partic", "soc_post",
  "aut_fond_ppp_w", "aut_volu", "soc_norms_index", "dscrptv_norms_index",
  "ten_support", "ten_loan", "ten_new", "ten_travel",
  "prscrptv_norms_index", "ten_mentravel_rvrs", "ten_menown_rvrs",
  "ten_womentravel_rvrs", "ten_womenown_rvrs", "_time_use_",
  "time_ben_nonag_d", "time_wk_ben_nonag", "time_ben_ag_d", "time_wk_ben_ag",
  "time_ben_study_coran_d", "time_wk_ben_study_coran",
  "time_ben_study_trad_d", "time_wk_ben_study_trad", "time_ben_water_d",
  "time_wk_ben_water", "time_ben_firewood_d", "time_wk_ben_firewood",
  "time_ben_laundry_d", "time_wk_ben_laundry", "time_ben_shop_d",
  "time_wk_ben_shop", "time_ben_cook_d", "time_wk_ben_cook",
  "time_ben_clean_d", "time_wk_ben_clean", "time_ben_liv_d",
  "time_wk_ben_liv", "time_ben_child_d", "time_wk_ben_child",
  "time_ben_handicap_d", "time_wk_ben_handicap", "time_ben_family_d",
  "time_wk_ben_family", "time_ben_radio_d", "time_wk_ben_radio",
  "time_ben_rest_d", "time_wk_ben_rest", "time_ben_pray_d",
  "time_wk_ben_pray", "_loans_", "lend_mem_times", "_measures_",
  "mes_video_d", "mes_avec_d", "mes_acv_d", "mes_acv_days", "mes_germe_d",
  "mes_germe_days", "mes_coach_d", "mes_coach_n", "mes_bourse_d", "_m_admin",
  "mes_bourse_ppp", "_fish_", "_exodus_", "t_exodamtsend_90",
  "t_exodamtsend_95", "t_exodamtsend_98", "t_exodamtsend_99",
  "t_exodamtsend_ben_90", "t_exodamtsend_ben_95", "t_exodamtsend_ben_98",
  "t_exodamtsend_ben_99", "t_exode_days", "t_exode_days_ben",
  "t_exodamtsend_90_ppp", "t_exodamtsend_95_ppp", "t_exodamtsend_99_ppp",
  "t_exodamtsend_ben_90_ppp", "t_exodamtsend_ben_95_ppp",
  "t_exode_days_d", "t_exode_days_ben_d", "t_exodamtsend_98_d", "t_exodamtsend_ben_98_d", "t_exodamtsend_95_d", "t_exodamtsend_ben_95_d", "t_exodamtsend_90_d",
  "t_exodamtsend_ben_90_d", "_mid", "_benrel_", "_gpsins_", "_storage_",
  "_childhealth_", "_socpro_", "benef_is_changed",
  "preg_k_breastfeed_childwants_v2", "preg_k_breastfeed_motherready_v2",
  "newborn_k_feeeding_dur_correct", "knowledge_kidi6_2",
  "knowledge_kidi8_2", "knowledge_talktochild", "knowledge_childcry",
  "knowledge_childcry_v2", "knowledge_childsick", "knowledge_ecd_theta",
  "knowledge_ecd_theta2", "rfall_alr_5_d", "temp_blr_25_d",
  "temp_blr_75sd_d", "temp_alr_75sd_d", "rfalldy_alr_5_d",
  "tempdy_alr_10_d", "tempdy_avg_mea_fmju01_lr_pct", "_urban_",
  "consum_2_day_ppp_tr_bd", "consum_2_day_pc_ppp_tr_bd",
  "consum_2_day_eq_ppp_tr_bd", "consum_2_day_eq_ppp_std_tr_bd",
  "nf_util_day_ppp_bd", "nf_util_day_eq_ppp_bd", "nf_trans_day_ppp_bd",
  "nf_trans_day_eq_ppp_bd", "nf_comm_day_ppp_bd", "nf_comm_day_eq_ppp_bd",
  "nf_toil_day_ppp_bd", "nf_toil_day_eq_ppp_bd", "nf_cloth_day_ppp_bd",
  "nf_cloth_day_eq_ppp_bd", "nf_hhmisc_day_ppp_bd",
  "nf_hhmisc_day_eq_ppp_bd", "nf_other_day_ppp_bd",
  "nf_other_day_eq_ppp_bd", "nonfood_day_ppp_bd",
  "nonfood_day_pc_ppp_bd", "nonfood_day_eq_ppp_bd", "treat_dum_pi",
  "treatment_1", "treatment_2", "treatment_3", "regprod_ben",  "hhh_fem_hte",
  "ben_fem_hte", "med_hhsize_dum_hte", "med_hhsize_dum_hte_2",
  "med_adult_fem_s_dum_hte", "med_adult_fem_s_dum_hte_2",
  "med_cons2deq_dum_hte", "med_cons2deq_dum_hte_2", "med_food2deq_dum_hte",
  "med_food2deq_dum_hte_2", "med_discom_dum_hte", "med_discom_dum_hte_2",
  "med_divinc_dum_hte", "med_divinc_dum_hte_2", "med_mendep_dum_hte",
  "med_mendep_dum_hte_2", "med_mendis_dum_hte", "med_mendis_dum_hte_2",
  "med_mendepdis_dum_hte", "med_mendepdis_dum_hte_2", "med_mensat_dum_hte",
  "med_mensat_dum_hte_2", "med_ment_hlth_dum_hte", "med_ment_hlth_dum_hte_2",
  "med_gse_index_dum_hte", "med_gse_index_dum_hte_2", "bus2_dum_hte",
  "pben_age_bins_bl_hte", "pben_edu_bins_bl_hte", "nmem_bins_bl_hte",
  "ru_gpssec_d10", "ru_gpssec_d20", "region_bl_hte", "rev_sum_hh_idle_hte", 
  "mem_n_bl_pct_ctrl", "rural_ag", "ru_lat_bl_tr", "ru_lon_bl_tr","gone_mem18_d","gone_mem19_d", "treatment_group", "het_save_share", "save_share", "country", "ccode","mr9a", "new_mem21_n", "new_kid21_n", "new_mem21_d", "new_kid21_d", "gone_mem20_d", "gone_mem20_n",    "age.x", "emo_severity_12m", "emo_severity_12m_z",
  "phy_severity_12m", "phy_severity_12m_z", "sex_severity_12m",
  "sex_severity_12m_z", "eco_severity_12m", "eco_severity_12m_z",
  "bus1_ben_7_d", "bus_rev12_ben_7_90_ppp", "bus_rev12_ben_7_95_ppp",
  "bus_rev12_ben_7_98_ppp", "bus_pro12_ben_7_90_ppp", "bus_pro12_ben_7_95_ppp",
  "bus_pro12_ben_7_98_ppp", "dec_pow_edu", "dec_pow_care_wid_0",
  "dec_pow_edu_wid_0", "dec_pow_edu_fam_1", "ag_c40_hrv_qty",
  "ag_c40_plotsize", "ag_cother_hrv_qty", "ag_cother_plotsize",
  "ag_c40_hrv_qty_adult", "ag_r_hrv_5_imp_ppp", "rel_disagree",  "mr2", "mr3", "mr4", "mr5", "mr6", "mr7"#,"type_treatment"
  )

# Create the vector of var to remove from the previous list
names_rm <- c("_IDENTIFICATION_", "_DEMOG_", "_EMPLOYMENT_", "_BUSINESS_", "_FINANCE_","_HOUSING_", "_CASH_TRANSFERS_", "_EMPOWERMENT_", "_PSYCHOLOGY_", "_SHOCKS_","_PREFERENCE_", "_FOODSEC_", "_CONSUMPTION_", "__FOOD_1__", "__FOOD_2__","__NONFOOD__", "__CELEBRATION__", "__EDUCATION__", "__HEALTH__", "__EATOUT__","__TOTAL_CONSUMPTION_1__", "__TOTAL_CONSUMPTION_2__", "_ASSETS_", "_LIVESTOCK_", "_AGRICULTURE_","_OTHER_PROGRAMS_", "_TRANSFERS_", "_MISC_", "_childlabHH_", "_lab_prtcp_","_gender_prcpt_", "_social_", "_time_use_", "_loans_", "_measures_", "_fish_", "_exodus_", "_benrel_", "_gpsins_", "_storage_","_childhealth_", "_socpro_", "_urban_", "country", "ccode","age_ipv_module","language__777","language_o","new_kid5_n","new_kid5_d","ag_r_c11_comm","ag_r_c11_comm_chef","ag_r_c11_comm_ben","ag_c40_chef_d","ag_c40_ben_d","ag_c40_hrv_chef_imp_ppp","ag_c40_hrv_ben_imp_ppp","ag_c11_sale_imp_ppp","ag_c11_sale_chef_imp_ppp","ag_c11_sale_ben_imp_ppp","t_exodamtsend_ben_90", "t_exodamtsend_ben_95","t_exodamtsend_ben_98","t_exodamtsend_ben_99","t_exodamtsend_ben_90_ppp","t_exodamtsend_ben_95_ppp", "t_exodamtsend_ben_98_d","t_exodamtsend_ben_95_d","t_exodamtsend_ben_90_d","treatment_group")




vars_to_rm_ml  <-  setdiff(vars_to_rm_ml, names_rm)

vars_to_keep_ml <- c("strata", "cluster", "p_region", "p_commune", 
                  "p_village", "commune", "village","het_pben_lit", "het_hhh_edu","het_pben_edu", "het_ctrl_earn_index",
                  "het_ctrl_hh_index", "het_intrahh_index", "intrahh_index", "het_pben_handicap",
                  "het_pben_poly","age_gap", "het_age_gap","het_hhh_fem",
                  "het_hhh_lit", "reg_hh_pi_mrt", "reg_hh_csh_mrt")


# Get names of variables to keep based on missing values, excluding treatment variables
non_treatment_vars <- setdiff(
  names(followup_MRT_hh),
  treatment_vars
)

# Keep variables with less than or equal to 10% missing (excluding treatment vars)
vars_to_keep <- non_treatment_vars[
  colMeans(is.na(followup_MRT_hh[non_treatment_vars])) <= 0.1
]

# Final dataset including treatment variables
followup_MRT_hh <- followup_MRT_hh %>%
  dplyr::select(
    all_of(vars_to_keep),
    all_of(treatment_vars),
  )



# Remove zero-variance columns (i.e., constants)
followup_MRT_hh <- followup_MRT_hh %>%
  dplyr::select(where(~ length(unique(na.omit(.))) > 1))

# Perform KNN imputation (default k = 10)
# It returns a data.frame with imputed values
#followup_MRT_hh_imptd <- kNN(followup_MRT_hh, k = 10, imp_var = FALSE, impNA = TRUE, numFun=mean)  # Don't keep extra columns showing where imputations happened

#write_rds(followup_MRT_hh_imptd, "followup_MRT_hh_imptd.rds")
followup_MRT_hh_imptd <- readRDS("followup_MRT_hh_imptd.rds")

df_ML_results_final <- readRDS("df_ML_results_final.rds")



# Removing unwanted var
followup_MRT_hh_imptd <- followup_MRT_hh_imptd %>%
  dplyr::select(-all_of(vars_to_rm_ml)) 

followup_MRT_hh_imptd <- followup_MRT_hh_imptd %>%
  mutate(across(all_of(listOutcomes),~as.numeric(as.character(.))))

# Creates a new dataframe 'followup_MRT_hh_cntrl' from 'followup_MRT_hh' that contains only control groups
followup_MRT_hh_cntrl <- followup_MRT_hh_imptd %>%
  # Filters to keep only rows where either 'treatment_pi' or 'treatment_csh_trnsfr' is "Control"
  filter(treatment_pi == "Control" | treatment_csh_trnsfr == "Control") 
  # The commented-out line would select only columns that have no missing values


```

<!---BLOCK_TOC--->




<!---BLOCK_LANDSCAPE_START--->

# Some concerns 
- Why Manuela use the baseline values of the control variables for the IPV instead of the followup-value for the control group (to prevent spill over effect ??)

- I remove the row with missing data in any of the IPV outcome variables.
- All variables can't be used in the algorithm as some can explain the results just by pur chance. With all baseline variables t
- A Recursive Feature Elimination (RFE) is used to select features.
  * RFE is a feature selection technique that iteratively removes features based on their importance, aiming to find the optimal subset of features that provides the best model performance. It starts with a model trained on all features, then calculates feature importances, and removes the least important ones. This process is repeated until the desired number of features is reached or the model performance stops improving. 
  
- I use Knn algorithm to impute missing values in the features of the training dataset. The same algorythm can be use to complete the for the prediction dataset (it is important so that we can adapt the number). The *mean* function is used as the aggregation 
  * the Euclidean distance
  * 10 neigbor
  

  
- source: https://livebook.datascienceheroes.com/selecting-best-variables.html#general_aspects_selecting_best_variables


# Causal Forest for heterogeneity analysis of IPV

## Model estimation and Plot
```{r}

# Define outcomes for regression analysis
treatment_vars = c("treatment_pool","treatment_csh_trnsfr","treatment_capital","treatment_psychosocial","treatment_full")

# Create a new dataframe (df_curr) by transforming the followup_MRT_hh_imptd dataframe
df_curr <- followup_MRT_hh_imptd %>% 
   # Create binary treatment indicator variables (0=Control, 1=Treatment) for different intervention types
   # Only create indicators for households that are registered in the respective MRT (Microfinance Randomized Trial)
   mutate(
     hhid=as.numeric(hhid),
      # Pool treatment indicator: 1 if in Pool treatment and registered in PI MRT, 0 if Control and registered, NA otherwise
      treatment_pool = as.numeric(ifelse(treatment_pi_pool =="Control" & reg_hh_pi_mrt==1, 0,
                             ifelse(treatment_pi_pool=="Pool" & reg_hh_pi_mrt==1, 1, NA))),
      
      # Cash transfer treatment indicator: 1 if received Cash Assignment and registered in cash MRT, 
      # 0 if Control and registered, NA otherwise
      treatment_csh_trnsfr = as.numeric(ifelse(treatment_csh_trnsfr == "Control" & reg_hh_csh_mrt==1, 0,
                                   ifelse(treatment_csh_trnsfr == "Cash Assignment" & reg_hh_csh_mrt==1, 1, NA))),
      
      # Capital treatment indicator: 1 if in Capital treatment and registered in PI MRT, 
      # 0 if Control and registered, NA otherwise
      treatment_capital = as.numeric(ifelse(treatment_pi=="Control" & reg_hh_pi_mrt==1, 0,
                                ifelse(treatment_pi=="Capital" & reg_hh_pi_mrt==1, 1, NA))),
      
      # Psychosocial treatment indicator: 1 if in Psychosocial treatment and registered in PI MRT, 
      # 0 if Control and registered, NA otherwise
      treatment_psychosocial = as.numeric(ifelse(treatment_pi=="Control" & reg_hh_pi_mrt==1, 0,
                                     ifelse(treatment_pi=="Psychosocial" & reg_hh_pi_mrt==1, 1, NA))),
      
      # Full treatment indicator: 1 if in Full treatment and registered in PI MRT, 
      # 0 if Control and registered, NA otherwise
      treatment_full = as.numeric(ifelse(treatment_pi=="Control" & reg_hh_pi_mrt==1, 0,
                             ifelse(treatment_pi=="Full" & reg_hh_pi_mrt==1, 1, NA)))
   ) %>% 
   # Remove all variables that end with "_bl" (likely baseline variables)
   # to focus only on baseline data data
   dplyr::select(hhid, strata, cluster, p_region, p_commune, p_village, region, commune, 
                 village, reg_hh_csh_mrt, reg_hh_pi_mrt, ends_with("_bl"), all_of(lst_outcome_ml), all_of(treatment_vars))



# Assuming df_curr is your dataset
df_one_hot <- df_curr %>%
  # Step 1: Identify which columns are non-numeric
  # Step 2: One-hot encode all non-numeric columns
  mutate(across(where(~!is.numeric(.)), 
                ~as.factor(.))) %>%
  # Step 3: Create one-hot encoded variables and join them back
  # to the original numeric variables
  {
    # Extract numeric columns to preserve them
    numeric_vars <- select(., where(is.numeric), hhid)
    
    # Get non-numeric columns for one-hot encoding
    categorical_vars <- select(., where(~!is.numeric(.))) 
    
    # Skip if no categorical variables exist
    if(ncol(categorical_vars) > 0) {
      # Perform one-hot encoding with model.matrix
      # Remove intercept column (first column)
      categorical_encoded <- as.data.frame(model.matrix(~ . - 1, data = categorical_vars))
      
      # Combine numeric and one-hot encoded variables
      bind_cols(numeric_vars, categorical_encoded)
    } else {
      # Return original numeric data if no categorical variables
      numeric_vars
    }
  }

# Update df_curr with the one-hot encoded dataset
df_curr <- df_one_hot 


# Create a data frame of results examining heterogeneous treatment effects
# across different IPV outcomes, treatment variables, and heterogeneity dimensions
mainResults <- map_dfr(lst_outcome_ml, function(depvar) {
  
    # For each treatment variable...
    tempResults2 <- map_dfr(treatment_vars, function(treat_var) {

      bind_rows(
        # Get estimates for heterogeneous treatment effects using the specified model
        getEstimateGlobal_CF_median(depvar, treat_var, 
                             df_curr %>% 
                               dplyr::select(-c(setdiff(lst_outcome_ml, depvar), setdiff(treatment_vars,treat_var))) %>% 
          filter(!is.na(!!sym(treat_var)))) %>%
          # Add columns identifying which variables were used in this iteration
          mutate(depvar = depvar, treat_var = treat_var)
      )
  }, .progress = TRUE)
}, .progress = TRUE)


# Recode program names and variable labels for PI program
mainResults <- mainResults %>%
  mutate(
    treat_var = dplyr::recode(treat_var,
        treatment_pool = "Pool",
        treatment_csh_trnsfr = "Cash transfert",
        treatment_capital = "Capital",
        treatment_psychosocial = "Psychosocial",
        treatment_full = 'Full'),
    depvar = dplyr::recode(depvar,
        control_ipv_sev_12m = "Bin. for cntrl IPV in the last 12m",
        control_ipv_sev_index = "Cntrl IPV inten. index z-scr",
        emo_ipv_sev_12m = "Bin. for emo. IPV in the last 12m",
        emo_ipv_sev_index = "Emo. IPV sever. index z-scr",
        phy_ipv_sev_12m = "Bin. for phy. IPV in the last 12m",
        phy_ipv_sev_index = "Phy. IPV sever. index z-scr",
        sex_ipv_sev_12m = "Bin. for sex. IPV in the last 12m",
        sex_ipv_sev_index = "Sex. IPV sever. index z-scr",
        sex_phy_ipv_sev_12m = "Bin. for sex. or phy. IPV in the last 12m",
        sex_phy_ipv_sev_index = "Sex. or phy. IPV sever. index z-scr",
        eco_ipv_sev_12m = "Bin. for eco. IPV in the last 12m",
        eco_ipv_sev_index = "Eco. IPV sever. index z-scr",
        all_ipv_sev_12m = "Bin. for at least one type of IPV (exclud. eco.) in the last 12m",
        all_ipv_sev_index = "All IPV sev. index z-scr")
  )  %>% 
  mutate(
    CI2.5 = estimated_ate_value - 1.96 * estimated_ate_std,
    CI97.5 = estimated_ate_value + 1.96 * estimated_ate_std,
    CI5 = estimated_ate_value - 2.576 * estimated_ate_std,
    CI95 = estimated_ate_value + 2.576 * estimated_ate_std
  )



# Numeric index
mainResults %>%
  filter(depvar %in% c("Cntrl IPV inten. index z-scr","Emo. IPV sever. index z-scr","Phy. IPV sever. index z-scr","Sex. IPV sever. index z-scr", "Sex. or phy. IPV sever. index z-scr","Eco. IPV sever. index z-scr","All IPV sev. index z-scr")) %>%
  filter(treat_var=="Pool" | treat_var=="Cash transfert") %>% 
# Create a histogram of the counterfactual predictions
  ggplot(aes(x=estimated_ate_value)) +
  geom_histogram(bins = 40, fill="#69b3a2", color="#e9ecef", alpha=0.9) +
  geom_vline(xintercept = 0, lty = "dotted") +
  facet_grid(depvar~treat_var, scales = "free", shrink=TRUE, drop=TRUE) +
  labs(
    x = "Estimated CATE", y = "Count",
    caption = sprintf("N = %s.", nrow(mainResults %>% filter(depvar=="Cntrl IPV inten. index z-scr")%>% filter(treat_var=="Pool" | treat_var=="Cash transfert")))
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), legend.direction = "horizontal")
# Save the  plot
ggsave(paste0("output/heterogeneity/causal forest/causal forest_Estimated CATE_freq_index.jpeg"), width = 9, height = 16, units = "cm")

# Non numeric index plot
mainResults %>%
  filter(depvar %in% c("Bin. for cntrl IPV in the last 12m","Bin. for emo. IPV in the last 12m","Bin. for phy. IPV in the last 12m","Bin. for sex. IPV in the last 12m", "Sex. or phy. IPV sever. index z-scr","Bin. for eco. IPV in the last 12m","Bin. for at least one type of IPV (exclud. eco.) in the last 12m")) %>% 
  filter(treat_var=="Pool" | treat_var=="Cash transfert") %>% 
# Create a histogram of the counterfactual predictions
  ggplot(aes(x=estimated_ate_value)) +
  geom_histogram(bins = 40, fill="#69b3a2", color="#e9ecef", alpha=0.9) +
  geom_vline(xintercept = 0, lty = "dotted") +
  facet_grid(depvar~treat_var, scales = "free", shrink=TRUE, drop=TRUE) +
  labs(
    x = "Estimated CATE", y = "Count",
    caption = sprintf("N = %s.", nrow(mainResults %>% filter(depvar=="Cntrl IPV inten. index z-scr")%>% filter(treat_var=="Pool" | treat_var=="Cash transfert")))
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), legend.direction = "horizontal")
# Save the  plot
ggsave(paste0("output/heterogeneity/causal forest/causal forest_Estimated CATE_freq_12m.jpeg"), width = 9, height = 16, units = "cm")
  
# Add predicted CATEs to your dataset
```

## Estimated values

```{r}

# Step 1: Summarize ATE at group level
cf_summary <- mainResults %>%
  group_by(depvar, treat_var) %>%
  summarise(
    estimate = mean(estimated_ate_value, na.rm = TRUE),
    std_error = sd(estimated_ate_value, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  ) %>%
  mutate(
    p_value = 2 * pnorm(-abs(estimate / std_error)),
    significance = case_when(
      p_value < 0.01 ~ "***",
      p_value < 0.05 ~ "**",
      p_value < 0.10 ~ "*",
      TRUE ~ ""
    ),
    estimate_str = paste0(round(estimate, 3), significance),
    std_error_str = paste0("(", round(std_error, 3), ")")
  )

# Define your desired order
treatment_levels <- c("Cash transfert", "Capital", "Psychosocial", "Full", "Pool")

# Create per-outcome table
tables_by_outcome <- purrr::map(unique(cf_summary$depvar), function(outcome_name) {
  cf_summary %>%
    filter(depvar == outcome_name) %>%
    mutate(
      Treatment = factor(treat_var, levels = treatment_levels)
    ) %>%
    arrange(Treatment) %>%
    select(Treatment, estimate_str, std_error_str) %>%
    rename(
      `ATE Estimate` = estimate_str,
      `Std. Error` = std_error_str
    ) %>%
    mutate(`Outcome Variable` = outcome_name, .before = 1)
})
# Step 3: Name each table with its outcome variable
names(tables_by_outcome) <- unique(cf_summary$depvar)


# Optional: Print all tables
for (name in names(tables_by_outcome)) {

  header <- str_squish(str_remove(paste0("Table : Outcome variable ", name), "\n"))

  # Set Table footer
  footer <- str_squish(str_remove("Notes: *** p < 0.01, ** p < 0.05, * p < 0.1.", "\n"))
  
  # Set custom_tab() defaults
  customtab_defaults()
  custom_tab(tables_by_outcome[[name]], header, footer)
    
#      print(tables_by_outcome[[name]])
}


# Loop over each outcome table and export to Excel
for (dep in names(tables_by_outcome)) {
  table <- tables_by_outcome[[dep]]

  # Define output file name
  file_name <- paste0("output/heterogeneity/causal forest/regression_results_ML_", dep, ".xlsx")

  # Write the table to Excel
  write_xlsx(table, path = file_name)

  cat("Exported:", file_name, "\n")
}
```


## Heterogeneity estimates

```{r}
# Creating the data for reg 
df_curr1 <- mainResults %>%
  filter(treat_var=="Cash transfert") %>% 
  filter(depvar == "Sex. or phy. IPV sever. index z-scr") %>%  # Keep only baseline predictions and  keeps rows of interest.
  dplyr::select(hhid, treat_var, estimated_ate_value, estimated_ate_std, CI5, CI2.5, CI97.5, CI95, depvar) %>%  # Pivot 
  mutate(hhid=as.character(hhid)) %>% 
  distinct(.keep_all = TRUE) %>% 
  inner_join(
    followup_MRT_hh_imptd %>%
      dplyr::select(hhid, strata, cluster, p_region, p_commune, p_village, region, commune, 
                    ends_with("_bl"), starts_with(c("het_","shr_",'nbr_')), all_of(cluster_vars), all_of(listOutcomes), age_at_mrrg, age_at_mrrg_above18, hh_has_kid, treatment_csh_trnsfr, all_of(control_vars),  reg_hh_csh_mrt, 
                    reg_hh_pi_mrt, village, treatment_pi_pool, treatment_csh_trnsfr, treatment_pi) %>%  
    filter(reg_hh_csh_mrt==1)%>% 
      # Pool treatment indicator: 1 if in Pool treatment and registered in PI MRT, 0 if Control and registered, NA otherwise
      mutate(treatment_pool_bin = 0,
      
      treatment_csh_trnsfr_bin = as.numeric(ifelse(treatment_csh_trnsfr == "Cash Assignment" & reg_hh_csh_mrt==1, 1, 0)),
      
      treatment_capital_bin = 0,
      
      treatment_psychosocial_bin = 0,
      
      treatment_full_bin = 0) %>% 
    distinct(.keep_all = TRUE),  # Select some variables
    by = 'hhid',  # Merge on household ID
    multiple = "first"
  ) 

# Creating the data for reg 
df_curr2 <- mainResults %>%
  filter(treat_var=="Pool") %>% 
  filter(depvar == "Sex. or phy. IPV sever. index z-scr") %>%  # Keep only baseline predictions and  keeps rows of interest.
  dplyr::select(hhid, treat_var, estimated_ate_value, estimated_ate_std, CI5, CI2.5, CI97.5, CI95, depvar) %>%  # Pivot 
  mutate(hhid=as.character(hhid)) %>% 
  distinct(.keep_all = TRUE) %>%
  inner_join(
    followup_MRT_hh_imptd %>%
      dplyr::select(hhid, strata, cluster, p_region, p_commune, p_village, region, commune, 
                    ends_with("_bl"), starts_with(c("het_","shr_",'nbr_')), all_of(cluster_vars), all_of(listOutcomes), age_at_mrrg, age_at_mrrg_above18, hh_has_kid, treatment_csh_trnsfr, all_of(control_vars),  reg_hh_csh_mrt, 
                    reg_hh_pi_mrt, village, treatment_pi_pool, treatment_csh_trnsfr, treatment_pi) %>% 
          filter(reg_hh_pi_mrt==1)%>%       
      mutate(treatment_pool_bin = as.numeric(ifelse(treatment_pi_pool=="Pool" & reg_hh_pi_mrt==1, 1, 0)),
      
      treatment_csh_trnsfr_bin = as.numeric(ifelse(treatment_pi_pool =="Control" & reg_hh_pi_mrt==1, 1,0)),
      
      treatment_capital_bin = as.numeric(ifelse(treatment_pi=="Capital" & reg_hh_pi_mrt==1, 1, 0)),
      
      treatment_psychosocial_bin = as.numeric(ifelse(treatment_pi=="Psychosocial" & reg_hh_pi_mrt==1, 1, 0)),
      
      treatment_full_bin = as.numeric(ifelse(treatment_pi=="Full" & reg_hh_pi_mrt==1, 1, 0))) %>% 
    distinct(.keep_all = TRUE),  # Select some variables
    by = 'hhid',  # Merge on household ID
    multiple = "first"
  ) 


df_curr1 <- df_curr1 %>%
  mutate(
    decile_cate_csh = as.factor(ntile(estimated_ate_value, 10)),   # Create decile factor based on predicted IPV at baseline
    quartile_cate_csh = as.factor(ntile(estimated_ate_value, 5)),  # Create quartile factor
    median_cate_csh = as.factor(ntile(estimated_ate_value, 2))     # Create median (binary high/low) factor
  )

# Create df_curr2 by filtering households registered for the productive inclusion program (reg_hh_pi_mrt == 1)
df_curr2 <- df_curr2 %>%
  mutate(
    decile_cate_pool = as.factor(ntile(estimated_ate_value, 10)),   # Create decile factor based on predicted IPV at baseline
    quartile_cate_pool = as.factor(ntile(estimated_ate_value, 5)),  # Create quartile factor
    median_cate_pool = as.factor(ntile(estimated_ate_value, 2))     # Create median (binary high/low) factor
  )


# Combine the two filtered datasets into a single dataframe (stacking them)

summary_csh <- 
  bind_rows(
   df_curr1 %>%
     group_by(decile_cate_csh, treatment_csh_trnsfr) %>% 
     summarise(n = n(), 
          estimated_ate_value = mean(estimated_ate_value, na.rm=TRUE), 
          CI5 = mean(CI5, na.rm=TRUE), 
          CI2.5 = mean(CI2.5, na.rm=TRUE), 
          CI97.5 = mean(CI97.5, na.rm=TRUE), 
          CI95 = mean(CI95, na.rm=TRUE)) %>%
     ungroup() %>% 
     rename(quintile = decile_cate_csh) %>% 
     mutate(group_type = "decile"),
   df_curr1 %>%
     group_by(quartile_cate_csh, treatment_csh_trnsfr) %>% 
     summarise(n=n(), 
          estimated_ate_value = mean(estimated_ate_value, na.rm=TRUE), 
          CI5 = mean(CI5, na.rm=TRUE), 
          CI2.5 = mean(CI2.5, na.rm=TRUE), 
          CI97.5 = mean(CI97.5, na.rm=TRUE), 
          CI95 = mean(CI95, na.rm=TRUE)) %>%
     ungroup() %>% 
     rename(quintile = quartile_cate_csh) %>% 
     mutate(group_type = "quartile"),
   df_curr1 %>%
     group_by(median_cate_csh, treatment_csh_trnsfr) %>% 
     summarise(n=n(),
          estimated_ate_value = mean(estimated_ate_value, na.rm=TRUE), 
          CI5 = mean(CI5, na.rm=TRUE), 
          CI2.5 = mean(CI2.5, na.rm=TRUE), 
          CI97.5 = mean(CI97.5, na.rm=TRUE), 
          CI95 = mean(CI95, na.rm=TRUE)) %>%
     ungroup() %>% 
     rename(quintile = median_cate_csh) %>% 
     mutate(group_type = "median")
 )  %>%
  mutate(treatment = "Cash transfer")


summary_pool <- 
  bind_rows(
   df_curr2 %>% 
     group_by(decile_cate_pool, treatment_pi_pool) %>% 
     summarise(n = n(),
          estimated_ate_value = mean(estimated_ate_value, na.rm=TRUE), 
          CI5 = mean(CI5, na.rm=TRUE), 
          CI2.5 = mean(CI2.5, na.rm=TRUE), 
          CI97.5 = mean(CI97.5, na.rm=TRUE), 
          CI95 = mean(CI95, na.rm=TRUE)) %>%
     ungroup() %>% 
     rename(quintile = decile_cate_pool) %>% 
     mutate(group_type = "decile"),
   df_curr2 %>%
     group_by(quartile_cate_pool, treatment_pi_pool) %>% 
     summarise(n=n(),
          estimated_ate_value = mean(estimated_ate_value, na.rm=TRUE), 
          CI5 = mean(CI5, na.rm=TRUE), 
          CI2.5 = mean(CI2.5, na.rm=TRUE), 
          CI97.5 = mean(CI97.5, na.rm=TRUE), 
          CI95 = mean(CI95, na.rm=TRUE)) %>%
     ungroup() %>% 
     rename(quintile = quartile_cate_pool) %>% 
     mutate(group_type = "quartile"),
   df_curr2 %>%
     group_by(median_cate_pool, treatment_pi_pool) %>% 
     summarise(n=n(),
          estimated_ate_value = mean(estimated_ate_value, na.rm=TRUE), 
          CI5 = mean(CI5, na.rm=TRUE), 
          CI2.5 = mean(CI2.5, na.rm=TRUE), 
          CI97.5 = mean(CI97.5, na.rm=TRUE), 
          CI95 = mean(CI95, na.rm=TRUE)) %>%
     ungroup() %>% 
     rename(quintile = median_cate_pool) %>% 
     mutate(group_type = "median")
 )  %>%
  mutate(treatment = "Pool")


# Compute treatment group sizes and proportions for Tekavoul (cash)
summary_csh <- summary_csh %>%
  group_by(group_type, quintile) %>%
  mutate(N = sum(n)) %>%  # Total number treated in each group
  ungroup() %>%
  mutate(prop = round(n * 100 / N, 2))  # Proportion of treated out of total group

# Compute treatment group sizes and proportions for PI
summary_pool <- summary_pool %>%
  group_by(group_type, quintile) %>%
  mutate(N = sum(n)) %>%  # Total number treated in each group
  ungroup() %>%
  mutate(prop = round(n * 100 / N, 2))  # Proportion of treated out of total group



summary_csh <- inner_join(
  summary_csh %>% 
  group_by(group_type, quintile) %>%
  mutate(
    lab = sprintf(
      "%s %s \n N : %s \n N treat (pct): %s (%s) \n N control (pct): %s (%s)",
      first(group_type),
      first(quintile),
      first(N),
      scales::comma(last(n)),
      scales::comma(last(prop)),
      scales::comma(first(n)),
      scales::comma(first(prop))
    )
  ) %>%
  ungroup() %>% 
  distinct(group_type, quintile, .keep_all = TRUE) %>% 
  select(group_type, quintile, treatment, lab),

 summary_csh %>% 
   group_by(group_type, quintile) %>%
   summarise(    
    estimated_ate_value = mean(estimated_ate_value, na.rm=TRUE), 
    CI5 = mean(CI5, na.rm=TRUE), 
    CI2.5 = mean(CI2.5, na.rm=TRUE), 
    CI97.5 = mean(CI97.5, na.rm=TRUE), 
    CI95 = mean(CI95, na.rm=TRUE)))

summary_pool <- inner_join(
  summary_pool %>% 
  group_by(group_type, quintile) %>%
  mutate(
    lab = sprintf(
      "%s %s \n N : %s \n N treat (pct): %s (%s) \n N control (pct): %s (%s)",
      #"%s %s \n N : %s \n N treat (pct): %s (%s)",
      first(group_type),
      first(quintile),
      first(N),
      scales::comma(last(n)),
      scales::comma(last(prop)),
      scales::comma(first(n)),
      scales::comma(first(prop))
    )
  ) %>%
  ungroup() %>% 
  distinct(group_type, quintile, .keep_all = TRUE) %>% 
  select(group_type, quintile, treatment, lab),

 summary_pool %>% 
   group_by(group_type, quintile) %>%
   summarise(    
    estimated_ate_value = mean(estimated_ate_value, na.rm=TRUE), 
    CI5 = mean(CI5, na.rm=TRUE), 
    CI2.5 = mean(CI2.5, na.rm=TRUE), 
    CI97.5 = mean(CI97.5, na.rm=TRUE), 
    CI95 = mean(CI95, na.rm=TRUE)))



summary_csh$lab[-c(1)] <- gsub("N :", "", summary_csh$lab[-c(1)], fixed = T)
summary_csh$lab[-c(1)] <- gsub("decile", "", summary_csh$lab[-c(1)], fixed = T)
summary_csh$lab[-c(1)] <- gsub("quartile", "", summary_csh$lab[-c(1)], fixed = T)
summary_csh$lab[-c(1)] <- gsub("median", "", summary_csh$lab[-c(1)], fixed = T)
summary_csh$lab[-c(1)] <- gsub("N treat (pct): ", "", summary_csh$lab[-c(1)], fixed = T)
summary_csh$lab[-c(1)] <- gsub("N control (pct): ", "", summary_csh$lab[-c(1)], fixed = T)

summary_pool$lab[-c(1)] <- gsub("N :", "", summary_pool$lab[-c(1)], fixed = T)
summary_pool$lab[-c(1)] <- gsub("decile", "", summary_pool$lab[-c(1)], fixed = T)
summary_pool$lab[-c(1)] <- gsub("quartile", "", summary_pool$lab[-c(1)], fixed = T)
summary_pool$lab[-c(1)] <- gsub("median", "", summary_pool$lab[-c(1)], fixed = T)
summary_pool$lab[-c(1)] <- gsub("N treat (pct): ", "", summary_pool$lab[-c(1)], fixed = T)
summary_pool$lab[-c(1)] <- gsub("N control (pct): ", "", summary_pool$lab[-c(1)], fixed = T)

# Convert labels and factor variables to ordered factors for plotting
summary_csh$lab <- fct_inorder(summary_csh$lab)
summary_csh$quintile <- fct_inorder(summary_csh$quintile)
summary_csh$group_type <- fct_inorder(summary_csh$group_type)

summary_pool$lab <- fct_inorder(summary_pool$lab)
summary_pool$quintile <- fct_inorder(summary_pool$quintile)
summary_pool$group_type <- fct_inorder(summary_pool$group_type)

# Create plot for Tekavoul program

g1 <- summary_csh %>%
  ggplot(aes(x = lab, y = estimated_ate_value)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = `CI2.5`, ymax = `CI97.5`), lwd = 1, position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95),  position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_wrap(~group_type, scales = "free_x", shrink=TRUE, drop=TRUE) +
  labs(
    x = "", y = "Effect",
    subtitle = first(summary_csh$treatment)
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), legend.direction = "horizontal")

# Save plot for Tekavoul
ggsave(paste0("output/heterogeneity/causal forest/causal forest_tekavoul_est_",first(summary_csh$treatment),".jpeg"), g1, width = 27, height = 16, units = "cm")

# Create plot for PI program
g2 <- summary_pool %>%
  ggplot(aes(x = lab, y = estimated_ate_value)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = `CI2.5`, ymax = `CI97.5`), lwd = 1, position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95),  position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_wrap(~group_type, scales = "free_x", shrink=TRUE, drop=TRUE) +
  labs(
    x = "", y = "Effect",
    subtitle = first(summary_pool$treatment)
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), legend.direction = "horizontal")

# Save plot for PI
ggsave(paste0("output/heterogeneity/causal forest/causal forest_PI_est_",first(summary_pool$treatment),".jpeg"), g2, width = 27, height = 16, units = "cm")

# Combine the two plots into a single figure
arrange_plot <- ggpubr::ggarrange(g1, g2, common.legend = FALSE, nrow = 2, ncol = 1)

# Printing the plot
arrange_plot

# Save the combined plot
ggsave(paste0("output/heterogeneity/causal forest/causal forest_all_estimates.jpeg"), arrange_plot, width = 27, height = 16, units = "cm")


```

## Random forest for variable importance

```{r}
# Create vectors of variable names and their corresponding labels
# Create vectors of variable names and their corresponding labels

# Create vectors of variable names and their corresponding labels
var_vec = c(
            "same_cb_bl",
            "pben_handicap_bl",
            "hhh_fem_bl",
            "pben_fem_bl",
            "hhh_poly_bl",
            "pben_poly_bl",
            "hhh_age_bl",
            "pben_age_bl",
            "age_gap",
            "het_age_gap",
            "age_at_mrrg",
            "age_at_mrrg_above18",
            'nbr_adult_mal', 
            "het_nbr_adult_mal", 
            "shr_adult_mal", 
            "het_shr_adult_mal", 
            "nbr_adult_mal_tot",
            "het_nbr_adult_mal_tot",
            "nbr_adult_fem", 
            "het_nbr_adult_fem", 
            "shr_adult_fem", 
            "het_shr_adult_fem", 
            "nbr_adult_fem_tot",
            "het_nbr_adult_fem_tot",            
            "shr_adult_fem_mal",
            "het_shr_adult_fem_mal",
            "het_wtht_adult_mal",
            "het_wtht_adult_mal_tot",
            "nbr_adult", 
            "het_nbr_adult", 
            "shr_adult", 
            "het_shr_adult", 
            "nbr_adult_tot",
            "het_nbr_adult_tot", 
            "nbr_elder",
            "het_nbr_elder",
            "shr_elder",
            "het_shr_elder",
            "hh_has_kid", 
            "nbr_kid", 
            "het_nbr_kid", 
            "nbr_hh_number",
            "het_nbr_hh_number",
            "hhh_edu_bl",
            "pben_edu_bl",
            "hhh_prim_bl",
            "pben_prim_bl",
            "hhh_lit_bl",
            "pben_lit_bl",
            "ctrl_earn_index_tr_bl", #B.10.5 Control Earnings Z-index at bl, 
            "ctrl_hh_index_tr_bl", # B.10.6 Control HH Z-index at bl
            "intrahh_vars_index_tr_bl", # C.2.3.A Intra-HH Dynamics Z-index at Baseline
            "gse_index_tr_bl",
            "soc_cohsn_index_tr_bl",
            "soc_stand_index_bl", 
            "los1_bl", 
            "los2_bl", 
            "rev_sum_bohh",     # Revenue/income sum for household
            "het_region", # Region
            "tot_hh_rev", # Baseline revenu
            "consum",
            "dec_pow_earn_d_bl", 
            "dec_could_earn_d_bl",      # Power/capacity to earn
            "dec_pow_ag_d_bl", 
            "dec_pow_liv_d_bl", 
            "dec_pow_bus_d_bl",  # Power in productive sectors
            "dec_pow_spend_d_bl", 
            "dec_could_spend_d_bl", 
            "dec_pow_large_d_bl", 
            "dec_could_large_d_bl",
            "dec_pow_fert_d_bl", 
            "dec_could_fert_d_bl", 
            "dec_pow_edu_d_bl",
            "tot_emp_2rev12_ben_98_ppp_bl", 		#"Wage\n earnings\n (yearly, USD)"
          	"crop_ctrl_dum_bl", 	#"Benef. controls\n crop\n revenue \{0,1\}"
            "na_bus2_op_wn_12_ben_bl", # No. of\n beneficiary\n businesses
            "bus2_ben_dum_bl",	 	#"Beneficiary\n has a\n business \{0,1\}"
            "tot_busmths_uniq_ben_bl", #No. of months benef worked last year
            "div_n_na_12_ben_bl", # Entrepreneurial\n business types\n (yearly)
            "bus2_within_12_dum_ben_bl",	#Beneficiary\n launched a\n business \{0,1\}				
            "tot_ben_rev12_98_ppp_bl", # Business\n revenues\n (yearly, USD)    	
          	"tot_ben_pro12_98_ppp_bl", # Business\n profits\n (yearly, USD)
            "bus_assval_98_ppp_bl", # Business\n asset\n value (USD)
            'tot_ben_rev30_98_ppp_bl',	#"Business revenue\n (beneficiary,\n monthly, USD)" 
            "ani_ben_dum_bl", 		#"Benef. owns\n livestock\n \{0,1\}"
            "sleep_prod_dum_bl"	#"Benef. traveled\n for work\n \{0,1\}"

            )

# Create corresponding human-readable labels for each variable
label_vec = c(
              "Benef. is HH head",
              "Benef. is handicapped",
              "Female (hh. head)",
              "Female (benef.)",
              "Polygamy (hh. head)",
              "Polygamy (benef.)",
              "Age (Hh. head)",
              "Age (benef.)",
              "Age gap (hh. head - benef.)",
              "Age gap (hh. head - benef.) above med. (0,1)",
              "Ben. age at marriage",
              "Ben. married after 18 (0,1)",
              'Nbr adults males (age 25-65)', 
              "Nbr adults males (age 25-65) above med. (0,1)", 
              "Shr adults males (age 25-65)", 
              "Shr adults males (age 25-65) above med. (0,1)", 
              'Nbr males (age 15+)', 
              "Nbr males (age 15+) above med. (0,1)", 
              'Nbr adults females (age 25-65)', 
              "Nbr adults females (age 25-65) above med. (0,1)", 
              "Shr adults females (age 25-65)", 
              "Shr adults females (age 25-65) above med. (0,1)", 
              'Nbr females (age 15+)', 
              "Nbr females (age 15+) above med. (0,1)", 
              "Shr females (age 15+) in adults",
              "Shr females (age 15+) in adults above med. (0,1)",
              "Shr of hh. without males (age 25-65)",
              "Shr of hh. without males (age 15+)",
              'Nbr adults tot (age 25-65)', 
              "Nbr adults tot (age 25-65) above med. (0,1)", 
              "Shr adults tot (age 25-65)", 
              "Shr adults tot (age 25-65) above med. (0,1)", 
              "Nbr members (age 15+) in hh.",
              "Nbr members (age 15+) in hh. above med. (0,1)",
              "Nbr of elders (age 66+)",
              "Nbr of elders (age 66+) above med. (0,1)",
              "Shr of elders (age 66+)",
              "Shr of elders (age 66+) above med. (0,1)",
              "Hh. has a kid (age 0-30 mnth)", 
              'Nbr kid (age 0-30 mnth)', 
              "Nbr kid (age 0-30 mnth) above med. (0,1)", 
              "Nbr hh. members",
              "Nbr hh. members above med. (0,1)",
              "Education (years, HH head)",
              "Education (years, benef.)",
              "Primary education (0/1, H-hh. head)",
              "Primary education (0/1, benef.)",
              "Literate (hh. head)",
              "Literate (benef.)",
              "Control over earnings", #B.10.5 Control Earnings Z-index at bl, 
              "Control over hh. resources", # B.10.6 Control HH Z-index at bl
              "Intra hh. dynamics index", # C.2.3.A Intra-HH Dynamics Z-index at Baseline
              "Self efficacy",
              "Social cohesion and closeness to community",
              "Social standing",
              "Partner inclusiveness (1-4)", 
              "Community inclusiveness (1-4)", 
              "Ben. revenue tot.",     # Revenue/income sum for household
              "Household in Sélibaby (0,1)", # Region
              "Tot. hh. revenue", # Baseline revenu
              "Consumption eq ppp",
              "Own earnings influence (0,1)",
              "Can Decide to Earn Alone (0,1)",
              "Agriculture influence (0,1)",
              "Livestock influence (0,1)",
              "Off-farm business influence (0,1)",
              "Daily spending influence (0,1)",
              "Can Decide to Spend Alone (0,1)",
              "Large purchases influence (0,1)",
              "Can Decide to Spend Large Amounts Alone (0,1)",
              "Family planning influence (0,1)",
              "Can Make Fertility Choices Alone (0,1)",
              "Child education influence (0,1)",
              "Wage earnings (yearly, USD)",
              "Benef. controls crop revenue (0,1)",
              "No. of beneficiary businesses",
              "Beneficiary has a business (0,1)",
              "No. of months benef worked last year",
              "Entrepreneurial business types (yearly)",
              "Beneficiary launched a business (0,1)",
              "Business revenues (yearly, USD)",
              "Business profits (yearly, USD)",
              "Business asset value hh. (USD)",
              "Business revenue (beneficiary, monthly, USD)",
              "Benef. owns livestock (0,1)",
              "Benef. traveled for work (0,1)"
            )

label_var = c("Balance test")

var_lab = c("Balance")



df_curr1 <- df_curr1 %>% 
  mutate(region = ifelse(region_bl==2, 0, 1),
         rev_sum_bohh = as.numeric(rev_sum_ben_wemp_98_tr_bl),
         tot_hh_rev = as.numeric(tot_hh_rev12_98_ppp_bl),
         consum = as.numeric(consum_2_day_eq_ppp_tr_bl),
         het_ctrl_earn_index = as.numeric(het_ctrl_earn_index),
         het_ctrl_hh_index = as.numeric(het_ctrl_hh_index),
         het_intrahh_index = as.numeric(het_intrahh_index),
         het_age_gap = as.numeric(het_age_gap)) %>% 
  mutate(het_ctrl_earn_index = ifelse(het_ctrl_earn_index==1, 0, 1),
         het_ctrl_hh_index = ifelse(het_ctrl_hh_index==1, 0, 1),
         het_intrahh_index = ifelse(het_intrahh_index==1, 0, 1),
         het_age_gap = ifelse(het_age_gap==1, 0, 1),
         het_married_ben =as.numeric(married_ben_bl))

df_curr2 <- df_curr2 %>% 
  mutate(region = ifelse(region_bl==2, 0, 1),
         rev_sum_bohh = as.numeric(rev_sum_ben_wemp_98_tr_bl),
         tot_hh_rev = as.numeric(tot_hh_rev12_98_ppp_bl),
         consum = as.numeric(consum_2_day_eq_ppp_tr_bl),
         het_ctrl_earn_index = as.numeric(het_ctrl_earn_index),
         het_ctrl_hh_index = as.numeric(het_ctrl_hh_index),
         het_intrahh_index = as.numeric(het_intrahh_index),
         het_age_gap = as.numeric(het_age_gap)) %>% 
  mutate(het_ctrl_earn_index = ifelse(het_ctrl_earn_index==1, 0, 1),
         het_ctrl_hh_index = ifelse(het_ctrl_hh_index==1, 0, 1),
         het_intrahh_index = ifelse(het_intrahh_index==1, 0, 1),
         het_age_gap = ifelse(het_age_gap==1, 0, 1),
         het_married_ben =as.numeric(married_ben_bl))


randomf_csh_trnsfrt = randomForest(estimated_ate_value~., data=df_curr1 %>% select(var_vec,estimated_ate_value))
randomf_pool = randomForest(estimated_ate_value~.,  data=df_curr2 %>% select(var_vec,estimated_ate_value))

importance_rf_csh <- varImp(randomf_csh_trnsfrt, scale=FALSE)
importance_rf_pool <- varImp(randomf_pool, scale=FALSE)

randomForest::varImpPlot(randomf_csh_trnsfrt,
                         sort=TRUE,
                         main="Variable Importance Plot (cash transfert)")

randomForest::varImpPlot(randomf_pool,
                         sort=TRUE,
                         main="Variable Importance Plot (pool)")

```


## Correlation between variables

```{r}

important_vars_all <- c(
  "ctrl_hh_index_tr_bl",
  "consum",
  "ctrl_earn_index_tr_bl",
  "tot_hh_rev",
  "hhh_age_bl",
  "soc_cohsn_index_tr_bl",
  "intrahh_vars_index_tr_bl",
  "soc_stand_index_bl",
  "rev_sum_bohh",
  "pben_age_bl",
  "age_gap",
  "nbr_hh_number",
  "age_at_mrrg",
  "region"
)

# Subset the data to keep only the relevant variables
df_subset <- df_curr2[, important_vars_all]

# Optionally: remove rows with NA (or use pairwise complete obs in cor())
df_subset <- na.omit(df_subset)

# Compute the correlation matrix
cor_matrix <- cor(df_subset, use = "pairwise.complete.obs")

# View the matrix
#print(cor_matrix)

# Optionally: visualize
library(corrplot)
corrplot(cor_matrix, method = "color", type = "upper", tl.cex = 0.7)

```

Adding theses variables in the baseline regression as control don't have any effect on the estimates of the overall effect of the transfert on hh transfert


### Tekavoul
```{r}
df_curr1 <- df_curr1 %>% 
  mutate(median_cate_csh_treat=ifelse(treatment_csh_trnsfr=="Cash Assignment",median_cate_csh,3)) %>% 
  mutate(
         median_1 = ifelse(median_cate_csh_treat==3,1,ifelse(median_cate_csh_treat==1,0,NA)),
         median_2 = ifelse(median_cate_csh_treat==3,1,ifelse(median_cate_csh_treat==2,0,NA)),
         median_3 = ifelse(median_cate_csh_treat==2,1,ifelse(median_cate_csh_treat==1,0,NA)),
         treat_dum = ifelse(median_cate_csh_treat==3,0,1))

# Convert cash transfer treatment to factor
df_curr1$median_cate_csh_treat <- factor(df_curr1$median_cate_csh_treat, levels = c("1", "2","3"), labels = c("(2) \n Below Med.", "(3) \n Above Med.", "(1) \n Control")) 
df_curr1$median_cate_csh_treat <- relevel(df_curr1$median_cate_csh_treat, ref = "(1) \n Control") # Set the reference var.

# Convert all variables in var_vec to numeric type
df_curr1 <- df_curr1  %>% 
  dplyr::mutate(across(var_vec, as.numeric)) 
  
# Create a tibble mapping variable names to their labels
description = tibble(
  name = var_vec,
  label = label_vec
)

# Create a named list of variable labels
var_labels <- setNames(as.list(description$label), description$name)

# Apply the variable labels to the dataset
df_curr1 <- df_curr1 %>%
  set_variable_labels(.labels = var_labels, .strict = FALSE)

# Create summary statistics table grouped by treatment
balance_tab_1 = df_curr1 %>% 
  dplyr::select(median_cate_csh_treat,var_vec) %>%  
  tbl_summary(by = median_cate_csh_treat,
              type = (list=var_vec ~ "continuous"),
              statistic = list(all_continuous() ~ "{mean}({sd})"),
              digits = everything() ~ c(2,2), 
              missing = "no") %>% 
  modify_header(label = 'Variable')

# Create vector of treatment binary comparison variables
lst_treatment_bin=paste("median_", seq(1,3,1), sep="")

# Adding the variable for the pooled T-test
lst_treatment_bin <- append(lst_treatment_bin, "treat_dum")

# Calculate p-values for each treatment comparison and variable
balance_tab_2 <- purrr::map_dfr(lst_treatment_bin, function(treat_var) {
  df_coef_value <- data.frame(variable = character(), 
                       treatment = character(), 
                       coef_val = character(), 
                       stringsAsFactors = FALSE)
  
  # Loop through each variable and run logistic regression
  for (v_name in var_vec) {
    
    result <- tryCatch({
      reg <- lm(as.formula(paste0(treat_var, " ~ ", v_name, " ")), data = df_curr1)
      test <- coeftest(reg, vcovCL(reg, cluster = df_curr1$hhid))
      
      coef_val <- round(test[2, 1], 3)
      pval <- round(test[2, 4], 3)
      
      # Add significance stars
      coef_val <- if (pval < 0.01) {
        paste0(pval, "***")
      } else if (pval < 0.05) {
        paste0(pval, "**")
      } else if (pval < 0.1) {
        paste0(pval, "*")
      } else {
        as.character(pval)
      }
      
      data.frame(variable = v_name,
                 treatment = treat_var,
                 coef_val = coef_val,
                 stringsAsFactors = FALSE)
      
    }, error = function(e) {
      # Return NA if model fails
      data.frame(variable = v_name,
                 treatment = treat_var,
                 coef_val = '',
                 stringsAsFactors = FALSE)
    })
    
    df_coef_value <- bind_rows(df_coef_value, result)
  }
  
  return(df_coef_value)
})

# Reshape p-value table to wide format with treatment comparisons as columns
balance_tab_2 <- balance_tab_2 %>% 
  pivot_wider(id_cols = "variable", 
              names_from = "treatment", 
              values_from = "coef_val") 

# Rename columns to show treatment group comparisons
names(balance_tab_2) <- c("variable","(1)-(2)","(1)-(3)","(3)-(2)", "Pooled F-test \n P-value")

#Keep the variables of interest
balance_tab_2 <- balance_tab_2 %>% 
  select("(1)-(2)","(1)-(3)","(3)-(2)",
         "Pooled F-test \n P-value")

# Create table for joint F-tests
  
# For each variable, run joint F-test of treatment effects

balance_tab_3 <- purrr::map_dfr(var_vec, function(v_name) { 
  
# Safe joint F-test computation
temp_balance <- tryCatch({

  # Fit regression model
  model <- lm(as.formula(paste0(v_name, " ~ median_cate_csh_treat")), 
              data = df_curr1)

  # Create hypothesis for joint F-test
  trtmnt_qult_hpthss <- c(
    paste0("median_cate_csh_treat", 
           levels(df_curr1$median_cate_csh_treat)[-1][1], 
           " = median_cate_csh_treat", 
           levels(df_curr1$median_cate_csh_treat)[-1][2])
  )

  # Perform joint F-test with clustered standard errors
  joint_f_test <- linearHypothesis(
    model, 
    trtmnt_qult_hpthss, 
    test = "F", 
    vcov. = vcovCL(model, df_curr1$hhid)
  )

  # Extract F-stat and p-value
  coef_val_ftest <- round(joint_f_test$`F`[2], 3)
  pval <- round(joint_f_test$`Pr(>F)`[2], 3)

  # Add significance stars
  coef_val_ftest <- if (pval < 0.01) {
    paste0(pval, "***")
  } else if (pval < 0.05) {
    paste0(pval, "**")
  } else if (pval < 0.1) {
    paste0(pval, "*")
  } else {
    as.character(pval)
  }

  # Return as tibble
  tibble("Joint F-test \n P-value" = coef_val_ftest)

}, error = function(e) {
  # Return NA on error
  tibble("Joint F-test \n P-value" = '')
})
    

})
  


myfooter <- df_curr1 %>% 
  dplyr::select(median_cate_csh_treat,cluster, strata) %>%  
  group_by(median_cate_csh_treat) %>% 
  summarise(nbr_cluster = n_distinct(cluster),
            nbr_strata = n_distinct(strata)) %>% 
  column_to_rownames(var="median_cate_csh_treat")

#transpose data frame
myfooter_t <- as.data.frame(t(myfooter))

#redefine row and column names
rownames(myfooter_t) <- colnames(myfooter)
colnames(myfooter_t) <- balance_tab_1$table_styling$header$label[seq(6,8,1)]

myfooter_t <- tibble::rownames_to_column(myfooter_t, "Variable") %>%
  mutate(Variable=dplyr::recode(Variable, nbr_cluster = "N cluster", nbr_strata = "N strata"))


balance_tab = cbind(
  balance_tab_1,
  balance_tab_2,
  balance_tab_3) %>% 
  relocate("Pooled F-test \n P-value", .after = "Joint F-test \n P-value")

# Adding the row on the nbr of cluster and strata
balance_tab <- plyr::rbind.fill(balance_tab,myfooter_t)

header <- str_squish(str_remove("Table : Balance Table ", "\n"))
# Set Table footer
footer <- str_squish(str_remove("Notes: Standard errors for all tests are clustered at the Social Promotion Space level level. Fixed effects using randomization strata are included in all estimation regressions. The joint F-test shows the p-value from a test of equality of treatment arms. While the pooled F-test shows the p-value from a test of pooled treatment (i.e., a regression with a dummy for any treatment arm). *** p < 0.01, ** p < 0.05, * p < 0.1.", "\n"))
# Set custom_tab() defaults
customtab_defaults()
custom_tab(balance_tab, header, footer)


```

### Productive inclusion

```{r}

df_curr2 <- df_curr2 %>% 
  mutate(median_cate_pool_treat=ifelse(treatment_pi_pool =="Pool",median_cate_pool,3)) %>% 
  mutate(
         median_1 = ifelse(median_cate_pool_treat==3,1,ifelse(median_cate_pool_treat==1,0,NA)),
         median_2 = ifelse(median_cate_pool_treat==3,1,ifelse(median_cate_pool_treat==2,0,NA)),
         median_3 = ifelse(median_cate_pool_treat==2,1,ifelse(median_cate_pool_treat==1,0,NA)),
         treat_dum = ifelse(median_cate_pool_treat==3,0,1))

# Convert cash transfer treatment to factor
df_curr2$median_cate_pool_treat <- factor(df_curr2$median_cate_pool_treat, levels = c("1", "2","3"), labels = c("(2) \n Below Med.", "(3) \n Above Med.", "(1) \n Control")) 
df_curr2$median_cate_pool_treat <- relevel(df_curr2$median_cate_pool_treat, ref = "(1) \n Control") # Set the reference var.




# Convert all variables in var_vec to numeric type
df_curr2 <- df_curr2  %>% 
  dplyr::mutate(across(var_vec, as.numeric)) 

# Create a tibble mappoolng variable names to their labels
description = tibble(
  name = var_vec,
  label = label_vec
)

# Create a named list of variable labels
var_labels <- setNames(as.list(description$label), description$name)

# Apply the variable labels to the dataset
df_curr2 <- df_curr2 %>%
  set_variable_labels(.labels = var_labels, .strict = FALSE)

# Create summary statistics table grouped by treatment
balance_tab_1 = df_curr2 %>% 
  dplyr::select(median_cate_pool_treat,var_vec) %>%  
  tbl_summary(by = median_cate_pool_treat,
              type = (list=var_vec ~ "continuous"),
              statistic = list(all_continuous() ~ "{mean}({sd})"),
              digits = everything() ~ c(2,2), 
              missing = "no") %>% 
  modify_header(label = 'Variable')

# Create vector of treatment binary comparison variables
lst_treatment_bin=paste("median_", seq(1,3,1), sep="")

# Adding the variable for the pooled T-test
lst_treatment_bin <- append(lst_treatment_bin, "treat_dum")

# Calculate p-values for each treatment comparison and variable
balance_tab_2 <- purrr::map_dfr(lst_treatment_bin, function(treat_var) {
  df_coef_value <- data.frame(variable = character(), 
                       treatment = character(), 
                       coef_val = character(), 
                       stringsAsFactors = FALSE)
  
  # Loop through each variable and run logistic regression
for (v_name in var_vec) {
    
    result <- tryCatch({
      reg <- lm(as.formula(paste0(treat_var, " ~ ", v_name, " ")), data = df_curr2)
      test <- coeftest(reg, vcovCL(reg, cluster = df_curr2$village))
      
      coef_val <- round(test[2, 1], 3)
      pval <- round(test[2, 4], 3)
      
      # Add significance stars
      coef_val <- if (pval < 0.01) {
        paste0(pval, "***")
      } else if (pval < 0.05) {
        paste0(pval, "**")
      } else if (pval < 0.1) {
        paste0(pval, "*")
      } else {
        as.character(pval)
      }
      
      data.frame(variable = v_name,
                 treatment = treat_var,
                 coef_val = coef_val,
                 stringsAsFactors = FALSE)
      
    }, error = function(e) {
      # Return NA if model fails
      data.frame(variable = v_name,
                 treatment = treat_var,
                 coef_val = '',
                 stringsAsFactors = FALSE)
    })
    
    df_coef_value <- bind_rows(df_coef_value, result)
  }
  
  return(df_coef_value)
})

# Reshape p-value table to wide format with treatment comparisons as columns
balance_tab_2 <- balance_tab_2 %>% 
  pivot_wider(id_cols = "variable", 
              names_from = "treatment", 
              values_from = "coef_val") 

# Rename columns to show treatment group comparisons
names(balance_tab_2) <- c("variable","(1)-(2)","(1)-(3)","(3)-(2)", "Pooled F-test \n P-value")

#Keep the variables of interest
balance_tab_2 <- balance_tab_2 %>% 
  select("(1)-(2)","(1)-(3)","(3)-(2)",
         "Pooled F-test \n P-value")

# Create table for joint F-tests
  
# For each variable, run joint F-test of treatment effects

balance_tab_3 <- purrr::map_dfr(var_vec, function(v_name) { 
  
# Safe joint F-test computation
temp_balance <- tryCatch({

 # Fit regression model
    model <- lm(as.formula(paste0(v_name, " ~ median_cate_pool_treat")), 
                 #family = binomial,
                 data = df_curr2)

    # Create hypotheses for joint test of treatment effects
    trtmnt_qult_hpthss <- c(
      paste0("median_cate_pool_treat",levels(df_curr2$median_cate_pool_treat)[-1][1],
             "=","median_cate_pool_treat",levels(df_curr2$median_cate_pool_treat)[-1][2]))

    # Perform joint F-test with clustered standard errors
    joint_f_test <- linearHypothesis(model, 
                                    trtmnt_qult_hpthss,
                                    test = "F", 
                                    vcov. = vcovCL(model, df_curr2$village))

    # Get and format p-value with significance stars
    coef_val_ftest <- round(joint_f_test$`F`[2],3)
    pval <- round(joint_f_test$`Pr(>F)`[2],3)
    if (pval < 0.01) {
      coef_val_ftest <- paste0(as.character(pval), "***")
    } else if (pval < 0.05) {
      coef_val_ftest <- paste0(as.character(pval), "**")
    } else if (pval < 0.1) {
      coef_val_ftest <- paste0(as.character(pval), "*")
    }else {
       coef_val_ftest <- as.character(pval)
    }

    # Add results to balance table
    temp_balance <- tibble(
  "Joint F-test \n P-value" = coef_val_ftest)

}, error = function(e) {
  # Return NA on error
  tibble("Joint F-test \n P-value" = '')
})
   
})
  

myfooter <- df_curr2 %>% 
  dplyr::select(median_cate_pool_treat,cluster, strata) %>%  
  group_by(median_cate_pool_treat) %>% 
  summarise(nbr_cluster = n_distinct(cluster),
            nbr_strata = n_distinct(strata)) %>% 
  column_to_rownames(var="median_cate_pool_treat")

#transpose data frame
myfooter_t <- as.data.frame(t(myfooter))

#redefine row and column names
rownames(myfooter_t) <- colnames(myfooter)
colnames(myfooter_t) <- balance_tab_1$table_styling$header$label[seq(6,8,1)]

myfooter_t <- tibble::rownames_to_column(myfooter_t, "Variable") %>%
  mutate(Variable=dplyr::recode(Variable, nbr_cluster = "N cluster", nbr_strata = "N strata"))


balance_tab = cbind(
  balance_tab_1,
  balance_tab_2,
  balance_tab_3) %>% 
  relocate("Pooled F-test \n P-value", .after = "Joint F-test \n P-value")

# Adding the row on the nbr of cluster and strata
balance_tab <- plyr::rbind.fill(balance_tab,myfooter_t)

header <- str_squish(str_remove("Table : Balance Table ", "\n"))
# Set Table footer
footer <- str_squish(str_remove("Notes: Standard errors for all tests are clustered at the Social Promotion Space level level. Fixed effects using randomization strata are included in all estimation regressions. The joint F-test shows the p-value from a test of equality of treatment arms. While the pooled F-test shows the p-value from a test of pooled treatment (i.e., a regression with a dummy for any treatment arm). *** p < 0.01, ** p < 0.05, * p < 0.1.", "\n"))
# Set custom_tab() defaults
customtab_defaults()
custom_tab(balance_tab, header, footer)

```
### Other tables 





## Estimates of treatment effect 

```{r}

####################### Second estimate #########################################
# lst_outcomes=c("olderchild_s","earlychild_s", "adult_fem_s")

# Define a list of heterogeneity variables to examine for differential treatment effects
lst_het_var <- c(
  "median_cate_csh",          # Household head is female
  "median_cate_pool"
)
treatment_vars = c("treatment_pi_pool","treatment_pi","treatment_csh_trnsfr")
# Data combine
df_curr1 <- df_curr1 %>%
  dplyr::mutate(median_cate_csh = as.factor(ifelse(median_cate_csh==1,1,0)))

df_curr2 <- df_curr2 %>%
  dplyr::mutate(median_cate_pool = as.factor(ifelse(median_cate_pool==1,1,0)))


other_ipv_vars <- c("all_ipv_sev_12m","all_ipv_sev_index") #,"all2_ipv_12m"

# Create a data frame of results examining heterogeneous treatment effects
# across different economic IPV outcomes, treatment variables, and heterogeneity dimensions
mainResults_het1 <- map_dfr(listOutcomes, function(depvar) {
 
   # For each heterogeneity variable...
  tempResults1 <- map_dfr("median_cate_csh", function(het_var) { 
  
    # For each treatment variable...
    tempResults2 <- map_dfr("treatment_csh_trnsfr", function(treat_var) {

      bind_rows(
        # Get estimates for heterogeneous treatment effects using the specified model
        getEstimateGlobal_het(depvar, treat_var, het_var, control_vars, strata_vars, cluster_vars, df_curr1) %>%
          # Add columns identifying which variables were used in this iteration
          mutate(depvar = depvar, outcome = depvar, treat_var = treat_var, het_var = het_var)
        )
    })
  })
})

mainResults_het2 <- map_dfr(listOutcomes, function(depvar) {
 
   # For each heterogeneity variable...
  tempResults1 <- map_dfr("median_cate_pool", function(het_var) { 
  
    # For each treatment variable...
    tempResults2 <- map_dfr(c("treatment_pi_pool","treatment_pi"), function(treat_var) {

      bind_rows(
        # Get estimates for heterogeneous treatment effects using the specified model
        getEstimateGlobal_het(depvar, treat_var, het_var, control_vars, strata_vars, cluster_vars, df_curr2) %>%
          # Add columns identifying which variables were used in this iteration
          mutate(depvar = depvar, outcome = depvar, treat_var = treat_var, het_var = het_var)
        )
    })
  })
})


mainResults_het <- plyr::rbind.fill(mainResults_het1 %>% mutate(het_var="median_cate"),
                                    mainResults_het2 %>% mutate(het_var="median_cate"))

#  Mutate and recode variables for better readability
mainResults_het <- mainResults_het %>%
    mutate(
        # Recode 'name' variable
      name = dplyr::recode(name,
        cash = "(a) Tekavoul program",
        pi = "(b) Productive inclusion program"
      ),
      het_var = dplyr::recode(het_var,
                      median_cate="Below median CATE"
      ),
        # Recode 'estimate' variable
      estimate = dplyr::recode(
        estimate,
        No = "low",
        Yes = "high"
      ),
        depvar = dplyr::recode(depvar,
        control_ipv_sev_12m = "Bin. for cntrl IPV in the last 12m",
        control_ipv_sev_index = "Cntrl IPV inten. index z-scr",
        emo_ipv_sev_12m = "Bin. for emo. IPV in the last 12m",
        emo_ipv_sev_index = "Emo. IPV sever. index z-scr",
        phy_ipv_sev_12m = "Bin. for phy. IPV in the last 12m",
        phy_ipv_sev_index = "Phy. IPV sever. index z-scr",
        sex_ipv_sev_12m = "Bin. for sex. IPV in the last 12m",
        sex_ipv_sev_index = "Sex. IPV sever. index z-scr",
        sex_phy_ipv_sev_12m = "Bin. for sex. or phy. IPV in the last 12m",
        sex_phy_ipv_sev_index = "Sex. or phy. IPV sever. index z-scr",
        eco_ipv_sev_12m = "Bin. for eco. IPV in the last 12m",
        eco_ipv_sev_index = "Eco. IPV sever. index z-scr",
        all_ipv_sev_12m = "Bin. for at least one type of IPV (exclud. eco.) in the last 12m",
        all_ipv_sev_index = "All IPV sev. index z-scr")
      )


    # Compute proportions by category
mainResults_het <- mainResults_het %>%
  group_by(depvar, name, typeTreat, het_var) %>%
  mutate(N_treat = sum(Ntype_treat)) %>%
  ungroup() %>%
  mutate(prop = round(Ntype_treat * 100 / N_treat, 2))

# Generate labels for the plot
  mainResults_het <- mainResults_het %>%
    group_by(depvar, name, het_var, typeTreat) %>%
    mutate(
      lab = sprintf(
        "%s \n N high treat (pct): %s (%s)\n N low treat (pct): %s (%s)",
        first(typeTreat),
        scales::comma(last(Ntype_treat)),
        scales::comma(last(prop)),
        scales::comma(first(Ntype_treat)),
        scales::comma(first(prop))
      )
    ) %>%
    ungroup()


  # Generate unique label for every one
  mainResults_het <- mainResults_het %>%
    group_by(name, het_var, typeTreat) %>%
    mutate(
      lab = first(lab)
      )%>%
    ungroup()
  

```


### Controlling Behavior 


```{r}

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% control_ipv_vars) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))

# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()

# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

        mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
    
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_grid(depvar~name, scales = "free_x", space="free", shrink=TRUE, drop=TRUE) +
  #facet_wrap(depvar, scales = "free_x", nrow = 2, strip.position = "top") +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s Tekavoul, %s productive inclusion."), 
                     first(mainResults_reg_group$N), last(mainResults_reg_group$N))
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/CATE_het_",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"),  width = 10, height = 14, units = "cm")
```

### Emotional Violence


```{r}

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% emotional_ipv_vars) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))

# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()

# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

        mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
    
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_grid(depvar~name, scales = "free_x", space="free", shrink=TRUE, drop=TRUE) +
  #facet_wrap(depvar, scales = "free_x", nrow = 2, strip.position = "top") +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s Tekavoul, %s productive inclusion."), 
                     first(mainResults_reg_group$N), last(mainResults_reg_group$N))
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/CATE_het_",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"),  width = 10, height = 14, units = "cm")
```

### Physical violence


```{r}

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% physical_ipv_vars) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))

# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()

# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

        mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
    
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_grid(depvar~name, scales = "free_x", space="free", shrink=TRUE, drop=TRUE) +
  #facet_wrap(depvar, scales = "free_x", nrow = 2, strip.position = "top") +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s Tekavoul, %s productive inclusion."), 
                     first(mainResults_reg_group$N), last(mainResults_reg_group$N))
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/CATE_het_",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"),  width = 10, height = 14, units = "cm")
```

### Sexual Violence 


```{r}

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% sexual_ipv_vars) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))

# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()

# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

        mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
    
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_grid(depvar~name, scales = "free_x", space="free", shrink=TRUE, drop=TRUE) +
  #facet_wrap(depvar, scales = "free_x", nrow = 2, strip.position = "top") +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s Tekavoul, %s productive inclusion."), 
                     first(mainResults_reg_group$N), last(mainResults_reg_group$N))
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/CATE_het_",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"),  width = 10, height = 14, units = "cm")
```


### Sexual and Physical violence 


```{r}

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% sexual_physical_ipv_vars) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))

# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()

# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

        mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
    
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_grid(depvar~name, scales = "free_x", space="free", shrink=TRUE, drop=TRUE) +
  #facet_wrap(depvar, scales = "free_x", nrow = 2, strip.position = "top") +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s Tekavoul, %s productive inclusion."), 
                     first(mainResults_reg_group$N), last(mainResults_reg_group$N))
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/CATE_het_",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"),  width = 10, height = 14, units = "cm")
```


### Economic Violence 


```{r}

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% economic_ipv_vars) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))

# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()

# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

        mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
    
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_grid(depvar~name, scales = "free_x", space="free", shrink=TRUE, drop=TRUE) +
  #facet_wrap(depvar, scales = "free_x", nrow = 2, strip.position = "top") +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s Tekavoul, %s productive inclusion."), 
                     first(mainResults_reg_group$N), last(mainResults_reg_group$N))
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/CATE_het_",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"),  width = 10, height = 14, units = "cm")
```


### Any type of violence

```{r}

mainResults_reg_group <- mainResults_het %>% 
  filter(outcome %in% other_ipv_vars) %>% 
  arrange(name, typeTreat) %>% 
  arrange(factor(typeTreat, levels = c('Cash Assignment', 'Capital', 'Psychosocial', 'Full', 'Pool')))%>% 
  mutate(estimate = dplyr::recode(estimate, low="no", high = "yes"))

# Order 'typeTreat' and 'depvar' factors
mainResults_reg_group$typeTreat <- mainResults_reg_group$typeTreat %>%
      fct_inorder()

mainResults_reg_group$depvar <- mainResults_reg_group$depvar %>%
    fct_inorder()

# Remove unnecessary prefixes in labels
mainResults_reg_group$lab[-c(1:4)] <- gsub("N high treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)


    mainResults_reg_group$lab[-c(1:4)] <- gsub("N low treat (pct): ", "",
                                                             mainResults_reg_group$lab[-c(1:4)], fixed = T)

        mainResults_reg_group$lab <- gsub("high", "yes",mainResults_reg_group$lab, fixed = T)
    mainResults_reg_group$lab <- gsub("low", "no",mainResults_reg_group$lab, fixed = T)
    
#  After all your data preparation and before creating the ggplot
# Convert lab to a factor maintaining the original order in the dataframe
mainResults_reg_group$lab <- factor(mainResults_reg_group$lab, 
                                   levels = unique(mainResults_reg_group$lab))

# Create a ggplot for visualization
mainResults_reg_group %>%
  ggplot(aes(x = lab, y = pe, color = estimate, ymin = `CI2.5`, ymax = `CI97.5`)) +
  geom_point(position = position_dodge(.5)) +
  geom_linerange(position = position_dodge(.5)) +
  geom_linerange(aes(ymin = CI5, ymax = CI95), lwd = 1, position = position_dodge(.5)) +
  geom_hline(yintercept = 0, lty = "dotted") +
  facet_grid(depvar~name, scales = "free_x", space="free", shrink=TRUE, drop=TRUE) +
  #facet_wrap(depvar, scales = "free_x", nrow = 2, strip.position = "top") +
  scale_color_manual(values = c("yes" = "grey69", "no" = "black")) +
  labs(
    x = "",
    y = "Effect",
    color = first(mainResults_reg_group$het_var),
    caption = sprintf(paste0("N = %s Tekavoul, %s productive inclusion."), 
                     first(mainResults_reg_group$N), last(mainResults_reg_group$N))
  ) +
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2))+
  theme_light(base_size = 8) +
  theme(legend.position = 'bottom', text = element_text(size = 8), 
        legend.direction = "horizontal")
    #Save the plot as an image
    ggsave(paste0("output/heterogeneity/",first(mainResults_reg_group$het_var),"_",first(mainResults_reg_group$depvar),".jpeg"),  width = 10, height = 14, units = "cm")
```
```{r}
# remove data to free space
rm(list = ls())
```

